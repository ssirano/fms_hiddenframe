<!-- HiddenFrame íƒ­ìš© ì‚¬ì—…ì¥ì •ë³´ í˜ì´ì§€ - JSP ë™ì¼ ë™ì‘ -->
<link rel="stylesheet" href="/static/css/common.css">
<style>
    /* ì‚¬ì—…ì¥ì •ë³´ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
    .prop-row { 
        cursor: pointer; 
        transition: background-color 0.15s ease-in-out;
    }
    
    .prop-row:hover { 
        background-color: #f0f7fc !important; 
    }
    
    .prop-row.selected { 
        background-color: #e3f2fd !important; 
        border-left: 3px solid #007bff;
    }
    
    .detail-section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .prop-layout {
        display: grid; 
        grid-template-columns: 1fr; 
        gap: 20px;
        margin-top: 20px;
    }
    
    .prop-list-container {
        position: relative;
    }
    
    .prop-count-info {
        margin-bottom: 10px;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 13px;
        color: #495057;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
        font-style: italic;
    }
    
    .tab-loading {
        text-align: center; 
        padding: 50px; 
        color: #6c757d;
    }
    
    .tab-error {
        text-align: center; 
        padding: 50px; 
        color: #dc3545;
    }
    
    @media (max-width: 992px) {
        .prop-count-info {
            flex-direction: column;
            gap: 5px;
            text-align: center;
        }
    }
    
    @media (max-width: 768px) {
        .detail-section {
            padding: 10px;
        }
        
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .data-table {
            min-width: 800px;
        }
    }
</style>

<div id="prop-list-container">
    <h2>ğŸ¢ ì‚¬ì—…ì¥ì •ë³´</h2>

    <!-- ê²€ìƒ‰ í¼ - JSPì™€ ë™ì¼í•˜ê²Œ ìˆ˜ì • -->
    <div style="width: 100%; margin-bottom: 20px;">
        <table width="100%" border="0">
            <tr>
                <td height="35px" align="right">
                    <input type="text" id="tb_prop_table" size="12" value="" style="text-align:left; padding: 6px 8px; border: 1px solid #ced4da; border-radius: 4px;">
                    <button type="button" class="btn btn-primary" onclick="PropListModule.searchProps()">ê²€ìƒ‰</button>
                    <button type="button" class="btn btn-secondary" onclick="PropListModule.showAllProps()">ëª©ë¡ë³´ê¸°</button>
                </td>
            </tr>
        </table>
    </div>

    <div class="prop-layout">
        <!-- ì‚¬ì—…ì¥ ëª©ë¡ -->
        <div class="prop-list-container">
            <div class="prop-count-info">
                <span id="prop-count-text">ì´ 0ê°œ</span>
                <span id="prop-page-text">1 / 1 í˜ì´ì§€</span>
                <span id="prop-bl-count-text">ê±´ë¬¼ í•©ê³„: 0ê°œ</span>
            </div>

            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th onclick="PropListModule.sortBy('city_name')" style="width:10%; cursor:pointer;">ì§€ì—­ â†•</th>
                            <th onclick="PropListModule.sortBy('prop_name')" style="width:20%; cursor:pointer;">ì‚¬ì—…ì¥ â†•</th>
                            <th onclick="PropListModule.sortBy('address1')" style="width:30%; cursor:pointer;">ì£¼ì†Œ â†•</th>
                            <th onclick="PropListModule.sortBy('contact1')" style="width:10%; cursor:pointer;">ë‹´ë‹¹ì â†•</th>
                            <th onclick="PropListModule.sortBy('use1')" style="width:20%; cursor:pointer;">ìš©ë„ â†•</th>
                            <th onclick="PropListModule.sortBy('bl_cnt')" style="width:10%;">ê±´ë¬¼ìˆ˜</th>
                        </tr>
                    </thead>
                    <tbody id="prop-table-body">
                        <tr><td colspan="6" class="text-center">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- í˜ì´ì§• -->
            <div class="pagination" id="prop-pagination">
                <button onclick="PropListModule.changePage(1)" id="btn-first">ì²˜ìŒ</button>
                <button onclick="PropListModule.changePage(PropListModule.data.currentPage-1)" id="btn-prev">â—€ ì´ì „</button>
                <span id="page-info">1 / 1</span>
                <button onclick="PropListModule.changePage(PropListModule.data.currentPage+1)" id="btn-next">ë‹¤ìŒ â–¶</button>
                <button onclick="PropListModule.changePage(PropListModule.data.totalPages)" id="btn-last">ë§ˆì§€ë§‰</button>
            </div>
        </div>
    </div>
</div>

<script>
// ğŸ›¡ï¸ HiddenFrame ì „ìš© ìŠ¤ì½”í”„ ë¶„ë¦¬ - ë³€ìˆ˜ ì¶©ëŒ ë°©ì§€
(function() {
    'use strict';
    
    console.log('ğŸ¢ prop_list.html HiddenFrame ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');
    
    // ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± - ì¤‘ë³µ ë°©ì§€
    if (typeof window.PropListModule !== 'undefined') {
        console.log('ğŸ¢ ê¸°ì¡´ PropListModule ì¬ì‚¬ìš©');
        return; // ì´ë¯¸ ë¡œë“œë¨
    }
    
    // ğŸ†• HiddenFrame ì „ìš© ëª¨ë“ˆ ìƒì„±
    window.PropListModule = {
        // ë°ì´í„° ì €ì¥ì†Œ
        data: {
            selectedPropId: null,
            currentSort: { field: 'basic', direction: 'asc' },
            currentPage: 1,
            totalPages: 1,
            totalCount: 0,
            searchParams: {
                tb_prop_table: '',
                order: 'basic',
                desc: 'asc',
                page_no: 1
            },
            isInitialized: false
        },
        
        // ğŸ†• HiddenFrame ìƒíƒœ í™•ì¸
        isVisible: function() {
            const container = document.getElementById('prop-list-container');
            if (!container) return false;
            
            // ë¶€ëª¨ íƒ­ ì»¨í…Œì´ë„ˆê°€ í‘œì‹œë˜ê³  ìˆëŠ”ì§€ í™•ì¸
            let current = container;
            while (current) {
                if (current.style && current.style.display === 'none') {
                    return false;
                }
                current = current.parentElement;
                if (current && current.classList && current.classList.contains('tab-container')) {
                    break;
                }
            }
            return true;
        },
        
        // ì´ˆê¸°í™”
        init: function() {
            console.log('ğŸ¢ ì‚¬ì—…ì¥ì •ë³´ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘ (HiddenFrame)');
            
            // ğŸ†• HiddenFrame: ìˆ¨ê²¨ì§„ ìƒíƒœì—ì„œëŠ” ì´ˆê¸°í™” í•˜ì§€ ì•ŠìŒ
            if (!this.isVisible()) {
                console.log('ğŸ¢ ìˆ¨ê²¨ì§„ ìƒíƒœì´ë¯€ë¡œ ì´ˆê¸°í™” ëŒ€ê¸°');
                return;
            }
            
            if (this.data.isInitialized) {
                console.log('ğŸ¢ ì´ë¯¸ ì´ˆê¸°í™”ë¨, ê²€ìƒ‰ë§Œ ì¬ì‹¤í–‰');
                this.searchProps();
                return;
            }
            
            const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
            console.log('ğŸ¢ ë°›ì€ ë°ì´í„°:', { em_id });
            
            if (!em_id) {
                console.error('ğŸ¢ em_idê°€ ì—†ìŠµë‹ˆë‹¤.');
                this.showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            this.data.isInitialized = true;
            
            // ğŸ†• HiddenFrame ì´ë²¤íŠ¸ ë°”ì¸ë”©
            this.bindHiddenFrameEvents();
            this.bindKeyboardEvents();
            
            setTimeout(() => {
                this.searchProps();
            }, 300);
        },
        
        // ğŸ†• HiddenFrame ì´ë²¤íŠ¸ ë°”ì¸ë”©
        bindHiddenFrameEvents: function() {
            const container = document.getElementById('prop-list-container');
            if (!container) return;
            
            // íƒ­ì´ visible ë  ë•Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
            container.addEventListener('tabVisible', (e) => {
                console.log('ğŸ¢ ì‚¬ì—…ì¥ì •ë³´ íƒ­ì´ ë‹¤ì‹œ í‘œì‹œë¨');
                if (!this.data.isInitialized) {
                    this.init();
                }
            });
        },
        
        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        bindKeyboardEvents: function() {
            const searchInput = document.getElementById('tb_prop_table');
            if (searchInput) {
                // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±°
                searchInput.removeEventListener('keypress', this.handleKeyPress);
                // ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€
                searchInput.addEventListener('keypress', this.handleKeyPress.bind(this));
            }
        },
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬
        handleKeyPress: function(e) {
            if (e.keyCode === 13) {
                this.searchProps();
            }
        },
        
        // ì‚¬ì—…ì¥ ê²€ìƒ‰
        searchProps: function() {
            console.log('ğŸ¢ ì‚¬ì—…ì¥ ê²€ìƒ‰ ì‹¤í–‰ ì‹œì‘ (HiddenFrame)');
            
            // HiddenFrame: ìˆ¨ê²¨ì§„ ìƒíƒœì—ì„œëŠ” ê²€ìƒ‰í•˜ì§€ ì•ŠìŒ
            if (!this.isVisible()) {
                console.log('ğŸ¢ ìˆ¨ê²¨ì§„ ìƒíƒœì´ë¯€ë¡œ ê²€ìƒ‰ ì¤‘ë‹¨');
                return;
            }
            
            const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
            if (!em_id) {
                this.showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const searchInput = document.getElementById('tb_prop_table');
            this.data.searchParams = {
                tb_prop_table: searchInput ? searchInput.value : '',
                order: this.data.currentSort.field,
                desc: this.data.currentSort.direction,
                page_no: this.data.currentPage
            };
            
            console.log('ğŸ¢ ìµœì¢… ê²€ìƒ‰ íŒŒë¼ë¯¸í„°:', this.data.searchParams);
            
            this.showLoading();
            
            fetch('/fm/prop_entry', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    c_type: 'list',
                    ...this.data.searchParams
                })
            })
            .then(response => {
                console.log('ğŸ¢ ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('ğŸ¢ ì„œë²„ ì‘ë‹µ ë°ì´í„°:', data);
                
                if (data.success) {
                    console.log('ğŸ¢ ì‚¬ì—…ì¥ ë°ì´í„° ìˆ˜ì‹  ì„±ê³µ, ê±´ìˆ˜:', data.data.length);
                    this.renderPropList(data.data);
                    this.updatePagination(data.total_count, data.total_pages, data.current_page);
                    this.updateBlCount(data.total_bl_cnt || 0);
                } else {
                    this.showError('ê²€ìƒ‰ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ğŸ¢ ì‚¬ì—…ì¥ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                this.showError('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            });
        },
        
        // ë¡œë”© í‘œì‹œ
        showLoading: function() {
            const tbody = document.getElementById('prop-table-body');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">ê²€ìƒ‰ ì¤‘...</td></tr>';
            }
        },
        
        // ì˜¤ë¥˜ í‘œì‹œ
        showError: function(message) {
            const tbody = document.getElementById('prop-table-body');
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">${message}</td></tr>`;
            }
        },
        
        // ì „ì²´ ëª©ë¡ ë³´ê¸°
        showAllProps: function() {
            const searchInput = document.getElementById('tb_prop_table');
            if (searchInput) {
                searchInput.value = '';
            }
            this.data.currentPage = 1;
            this.searchProps();
        },
        
        // ì‚¬ì—…ì¥ ëª©ë¡ ë Œë”ë§
        renderPropList: function(props) {
            const tbody = document.getElementById('prop-table-body');
            if (!tbody) return;
            
            if (props.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center"><b>ê²€ìƒ‰í•œ ê²°ê³¼ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</b></td></tr>';
                return;
            }

            let html = '';
            props.forEach(prop => {
                const cityDisplay = prop.city_name ? `${prop.city_name}(${prop.city_id})` : '&nbsp;';
                const propDisplay = `${prop.prop_name}(${prop.prop_id})`;
                
                html += `
                    <tr class="prop-row" onclick="PropListModule.selectProp('${prop.prop_id}', this)">
                        <td style="text-align:left; padding-left:5px;" title="${cityDisplay}">${cityDisplay}</td>
                        <td style="text-align:left; padding-left:5px;" title="${propDisplay}">${propDisplay}</td>
                        <td style="text-align:left; padding-left:5px;" title="${prop.address1 || ''}">${prop.address1 || '&nbsp;'}</td>
                        <td style="text-align:left; padding-left:5px;" title="${prop.contact1 || ''}">${prop.contact1 || '&nbsp;'}</td>
                        <td style="text-align:left; padding-left:5px;" title="${prop.use1 || ''}">${prop.use1 || '&nbsp;'}</td>
                        <td style="text-align:right; padding-right:5px;">${prop.bl_cnt || 0}</td>
                    </tr>
                `;
            });
            
            // í•©ê³„ í–‰ ì¶”ê°€
            if (props.length > 0) {
                const totalBlCnt = props.reduce((sum, prop) => sum + (prop.bl_cnt || 0), 0);
                html += `
                    <tr>
                        <td colspan="5" style="text-align:left; padding-left:5px;">&nbsp;</td>
                        <td style="text-align:right; padding-right:5px;" title="ì‚¬ì—…ì¥ì „ì²´ìˆ˜:${totalBlCnt}">í•©ê³„ : ${totalBlCnt}</td>
                    </tr>
                `;
            }
            
            tbody.innerHTML = html;
        },
        
        // í˜ì´ì§• ì •ë³´ ì—…ë°ì´íŠ¸
        updatePagination: function(total, pages, current) {
            this.data.totalCount = total;
            this.data.totalPages = pages;
            this.data.currentPage = current;

            const countText = document.getElementById('prop-count-text');
            const pageText = document.getElementById('prop-page-text');
            const pageInfo = document.getElementById('page-info');
            
            if (countText) countText.textContent = `ì´ ${total}ê°œ`;
            if (pageText) pageText.textContent = `${current} / ${pages} í˜ì´ì§€`;
            if (pageInfo) pageInfo.textContent = `${current} / ${pages}`;

            const btnFirst = document.getElementById('btn-first');
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            const btnLast = document.getElementById('btn-last');
            
            if (btnFirst) btnFirst.disabled = current <= 1;
            if (btnPrev) btnPrev.disabled = current <= 1;
            if (btnNext) btnNext.disabled = current >= pages;
            if (btnLast) btnLast.disabled = current >= pages;
        },
        
        // ê±´ë¬¼ í•©ê³„ ì—…ë°ì´íŠ¸
        updateBlCount: function(totalBlCnt) {
            const blCountText = document.getElementById('prop-bl-count-text');
            if (blCountText) {
                blCountText.textContent = `ê±´ë¬¼ í•©ê³„: ${totalBlCnt}ê°œ`;
            }
        },
        
        // ì‚¬ì—…ì¥ ì„ íƒ
        selectProp: function(prop_id, element) {
            document.querySelectorAll('.prop-row').forEach(row => {
                row.classList.remove('selected');
            });
            
            element.classList.add('selected');
            this.data.selectedPropId = prop_id;
            
            console.log('ğŸ¢ ì„ íƒëœ ì‚¬ì—…ì¥:', prop_id);
            this.navigateToPropUpdate(prop_id);
        },
        
        // ğŸ†• HiddenFrame: ì‚¬ì—…ì¥ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
        navigateToPropUpdate: function(propId) {
            // ì „ì—­ ë³€ìˆ˜ì— ì„ íƒëœ ì‚¬ì—…ì¥ ì €ì¥
            window.selected_prop_id = propId;
            
            if (typeof window.loadContent === 'function') {
                window.loadContent('/fm/prop_update.html', `ğŸ¢ ì‚¬ì—…ì¥ìˆ˜ì •(${propId})`);
                window.showStatus && window.showStatus(`ì‚¬ì—…ì¥ ìˆ˜ì • í˜ì´ì§€ë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
                console.error('ğŸ¢ loadContent í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        },
        
        // ì •ë ¬
        sortBy: function(field) {
            if (this.data.currentSort.field === field) {
                this.data.currentSort.direction = this.data.currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                this.data.currentSort.field = field;
                this.data.currentSort.direction = 'asc';
            }
            
            this.data.currentPage = 1;
            this.searchProps();
        },
        
        // í˜ì´ì§€ ë³€ê²½
        changePage: function(pageNo) {
            if (pageNo < 1 || pageNo > this.data.totalPages) return;
            this.data.currentPage = pageNo;
            this.searchProps();
        },
        
        // ğŸ†• HiddenFrame: ì‚¬ì—…ì¥ ë“±ë¡
        insertProp: function() {
            if (typeof window.loadContent === 'function') {
                window.loadContent('/fm/prop_insert.html', 'ğŸ¢ ì‚¬ì—…ì¥ë“±ë¡');
                window.showStatus && window.showStatus('ì‚¬ì—…ì¥ ë“±ë¡ í˜ì´ì§€ë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                console.error('ğŸ¢ loadContent í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
    };
    
    // ì „ì—­ ì´ˆê¸°í™” í•¨ìˆ˜ ë“±ë¡
    window.initPropListPage = function() {
        window.PropListModule.init();
    };
    
    // ğŸ†• HiddenFrame: ìë™ ì´ˆê¸°í™” (ì¦‰ì‹œ ì‹¤í–‰)
    setTimeout(() => {
        if (!window.PropListModule.data.isInitialized) {
            console.log('ğŸ¢ ìë™ ì´ˆê¸°í™” ì‹œì‘ (HiddenFrame)');
            window.PropListModule.init();
        }
    }, 500);
    
    console.log('ğŸ¢ PropListModule ë¡œë“œ ì™„ë£Œ (HiddenFrame)');
    
})(); // ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ ë
</script>