<!-- SPA íƒ­ìš© ì‚¬ì—…ì¥ì •ë³´ í˜ì´ì§€ -->
<link rel="stylesheet" href="/static/css/common.css">
<style>
    /* ì‚¬ì—…ì¥ì •ë³´ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
    .prop-row { 
        cursor: pointer; 
        transition: background-color 0.15s ease-in-out;
    }
    
    .prop-row:hover { 
        background-color: #f0f7fc !important; 
    }
    
    .prop-row.selected { 
        background-color: #e3f2fd !important; 
        border-left: 3px solid #007bff;
    }
    
    .detail-section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .prop-layout {
        display: grid; 
        grid-template-columns: 1fr; 
        gap: 20px;
        margin-top: 20px;
    }
    
    .prop-list-container {
        position: relative;
    }
    
    .prop-count-info {
        margin-bottom: 10px;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 13px;
        color: #495057;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
        font-style: italic;
    }
    
    .tab-loading {
        text-align: center; 
        padding: 50px; 
        color: #6c757d;
    }
    
    .tab-error {
        text-align: center; 
        padding: 50px; 
        color: #dc3545;
    }
    
    @media (max-width: 992px) {
        .prop-count-info {
            flex-direction: column;
            gap: 5px;
            text-align: center;
        }
    }
    
    @media (max-width: 768px) {
        .detail-section {
            padding: 10px;
        }
        
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .data-table {
            min-width: 800px;
        }
    }
</style>

<div id="prop-list-container">
    <h2>ğŸ¢ ì‚¬ì—…ì¥ì •ë³´ ê´€ë¦¬</h2>

    <!-- ê²€ìƒ‰ í¼ -->
    <div class="search-form">
        <div class="form-row">
            <div class="form-group col-4">
                <label>ê²€ìƒ‰ì–´:</label>
                <input type="text" id="keyword_sch" class="form-control" onkeypress="if(event.keyCode==13) searchProps()" placeholder="ì§€ì—­, ì‚¬ì—…ì¥ëª…, ì£¼ì†Œ, ì—°ë½ì²˜ ë“± ê²€ìƒ‰">
            </div>
            <div class="form-group col-8" style="text-align: right; display: flex; align-items: end; gap: 5px;">
                <button type="button" class="btn btn-primary" onclick="searchProps()">ê²€ìƒ‰</button>
                <button type="button" class="btn btn-success" onclick="insertProp()">ë“±ë¡</button>
                <button type="button" class="btn btn-info" onclick="exportExcel()">ì—‘ì…€ì €ì¥</button>
            </div>
        </div>
    </div>

    <div class="prop-layout">
        <!-- ì‚¬ì—…ì¥ ëª©ë¡ -->
        <div class="prop-list-container">
            <div class="prop-count-info">
                <span id="prop-count-text">ì´ 0ê°œ</span>
                <span id="prop-page-text">1 / 1 í˜ì´ì§€</span>
                <span id="prop-bl-count-text">ê±´ë¬¼ í•©ê³„: 0ê°œ</span>
            </div>

            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th onclick="sortBy('city_name')">ì§€ì—­ â†•</th>
                            <th onclick="sortBy('prop_name')">ì‚¬ì—…ì¥ â†•</th>
                            <th onclick="sortBy('address1')">ì£¼ì†Œ â†•</th>
                            <th onclick="sortBy('contact1')">ì—°ë½ì²˜ â†•</th>
                            <th onclick="sortBy('use1')">ìš©ë„ â†•</th>
                            <th onclick="sortBy('bl_cnt')">ê±´ë¬¼ìˆ˜ â†•</th>
                        </tr>
                    </thead>
                    <tbody id="prop-table-body">
                        <tr><td colspan="6" class="text-center">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- í˜ì´ì§• -->
            <div class="pagination" id="prop-pagination">
                <button onclick="changePage(1)" id="btn-first">ì²˜ìŒ</button>
                <button onclick="changePage(currentPage-1)" id="btn-prev">â—€ ì´ì „</button>
                <span id="page-info">1 / 1</span>
                <button onclick="changePage(currentPage+1)" id="btn-next">ë‹¤ìŒ â–¶</button>
                <button onclick="changePage(totalPages)" id="btn-last">ë§ˆì§€ë§‰</button>
            </div>
        </div>
    </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜
console.log('ğŸ¢ prop_list.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');

let selectedPropId = null;
let currentSort = { field: 'basic', direction: 'asc' };
let currentPage = 1;
let totalPages = 1;
let totalCount = 0;
let searchParams = {
    keyword: '',
    order: 'basic',
    desc: 'asc',
    page_no: 1
};

// ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ í”Œë˜ê·¸
let isPropPageInitialized = false;

// í˜ì´ì§€ ì´ˆê¸°í™” - base.htmlì˜ em_id ì§ì ‘ ì‚¬ìš©
function initPropListPage() {
    console.log('ğŸ¢ ì‚¬ì—…ì¥ì •ë³´ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
    
    // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (isPropPageInitialized) {
        console.log('ğŸ¢ ì´ë¯¸ ì´ˆê¸°í™”ë¨, ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€');
        return;
    }
    
    // base.htmlì—ì„œ em_id ê°€ì ¸ì˜¤ê¸°
    const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
    
    console.log('ğŸ¢ ë°›ì€ ë°ì´í„°:', { em_id });
    
    if (!em_id) {
        console.error('ğŸ¢ em_idê°€ ì—†ìŠµë‹ˆë‹¤.');
        document.getElementById('prop-table-body').innerHTML = 
            '<tr><td colspan="6" class="text-center text-danger">ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }
    
    // ì´ˆê¸°í™” í”Œë˜ê·¸ ì„¤ì •
    isPropPageInitialized = true;
    
    console.log('ğŸ¢ ì‚¬ì—…ì¥ ê²€ìƒ‰ ì‹¤í–‰ ì‹œì‘');
    
    // ê²€ìƒ‰ ì‹¤í–‰
    setTimeout(() => {
        searchProps();
    }, 500);
}

// ì‚¬ì—…ì¥ ê²€ìƒ‰
function searchProps() {
    console.log('ğŸ¢ ì‚¬ì—…ì¥ ê²€ìƒ‰ ì‹¤í–‰ ì‹œì‘');
    
    // em_id í™•ì¸
    const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
    if (!em_id) {
        console.error('ğŸ¢ em_idë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        document.getElementById('prop-table-body').innerHTML = 
            '<tr><td colspan="6" class="text-center text-danger">ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }
    
    // ê²€ìƒ‰ ì¡°ê±´ ìˆ˜ì§‘
    searchParams = {
        keyword: document.getElementById('keyword_sch').value,
        order: currentSort.field,
        desc: currentSort.direction,
        page_no: currentPage
    };

    console.log('ğŸ¢ ìµœì¢… ê²€ìƒ‰ íŒŒë¼ë¯¸í„°:', searchParams);

    // ë¡œë”© í‘œì‹œ
    document.getElementById('prop-table-body').innerHTML = 
        '<tr><td colspan="6" class="text-center">ê²€ìƒ‰ ì¤‘...</td></tr>';

    // AJAX ìš”ì²­
    fetch('/fm/prop_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            c_type: 'list',
            ...searchParams
        })
    })
    .then(response => {
        console.log('ğŸ¢ ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('ğŸ¢ ì„œë²„ ì‘ë‹µ ë°ì´í„°:', data);
        
        if (data.success) {
            console.log('ğŸ¢ ì‚¬ì—…ì¥ ë°ì´í„° ìˆ˜ì‹  ì„±ê³µ, ê±´ìˆ˜:', data.data.length);
            renderPropList(data.data);
            updatePagination(data.total_count, data.total_pages, data.current_page);
            updateBlCount(data.total_bl_cnt || 0);
        } else {
            console.error('ğŸ¢ ê²€ìƒ‰ ì‹¤íŒ¨:', data.message);
            document.getElementById('prop-table-body').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">ê²€ìƒ‰ ì‹¤íŒ¨: ' + data.message + '</td></tr>';
        }
    })
    .catch(error => {
        console.error('ğŸ¢ ì‚¬ì—…ì¥ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        document.getElementById('prop-table-body').innerHTML = 
            '<tr><td colspan="6" class="text-center text-danger">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</td></tr>';
    });
}

// ì‚¬ì—…ì¥ ëª©ë¡ ë Œë”ë§
function renderPropList(props) {
    const tbody = document.getElementById('prop-table-body');
    
    if (props.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }

    let html = '';
    props.forEach(prop => {
        const cityDisplay = prop.city_name ? `${prop.city_name} (${prop.city_id})` : '';
        const propDisplay = `${prop.prop_name} (${prop.prop_id})`;
        
        html += `
            <tr class="prop-row" onclick="selectProp('${prop.prop_id}', this)">
                <td>${cityDisplay}</td>
                <td>${propDisplay}</td>
                <td>${prop.address1 || ''}</td>
                <td>${prop.contact1 || ''}</td>
                <td>${prop.use1 || ''}</td>
                <td>${prop.bl_cnt || 0}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// í˜ì´ì§• ì •ë³´ ì—…ë°ì´íŠ¸
function updatePagination(total, pages, current) {
    totalCount = total;
    totalPages = pages;
    currentPage = current;

    // ì¹´ìš´íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
    document.getElementById('prop-count-text').textContent = `ì´ ${total}ê°œ`;
    document.getElementById('prop-page-text').textContent = `${current} / ${pages} í˜ì´ì§€`;
    document.getElementById('page-info').textContent = `${current} / ${pages}`;

    // í˜ì´ì§• ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    document.getElementById('btn-first').disabled = current <= 1;
    document.getElementById('btn-prev').disabled = current <= 1;
    document.getElementById('btn-next').disabled = current >= pages;
    document.getElementById('btn-last').disabled = current >= pages;
}

// ê±´ë¬¼ í•©ê³„ ì •ë³´ ì—…ë°ì´íŠ¸
function updateBlCount(totalBlCnt) {
    document.getElementById('prop-bl-count-text').textContent = `ê±´ë¬¼ í•©ê³„: ${totalBlCnt}ê°œ`;
}

// ì‚¬ì—…ì¥ ì„ íƒ
function selectProp(prop_id, element) {
    // ê¸°ì¡´ ì„ íƒ ì œê±°
    document.querySelectorAll('.prop-row').forEach(row => {
        row.classList.remove('selected');
    });
    
    // ìƒˆë¡œ ì„ íƒ
    element.classList.add('selected');
    selectedPropId = prop_id;
    
    console.log('ğŸ¢ ì„ íƒëœ ì‚¬ì—…ì¥:', prop_id);
    
    // ì‚¬ì—…ì¥ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
    navigateToPropUpdate(prop_id);
}

// ì‚¬ì—…ì¥ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
function navigateToPropUpdate(propId) {
    // ì„ íƒëœ ì‚¬ì—…ì¥ ì •ë³´ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
    window.selected_prop_id = propId;
    
    // prop_update íƒ­ ì¶”ê°€
    if (typeof window.loadContent === 'function') {
        window.loadContent('/fm/prop_update.html', `ì‚¬ì—…ì¥ìˆ˜ì •(${propId})`);
        window.showStatus(`ì‚¬ì—…ì¥ ìˆ˜ì • í˜ì´ì§€ë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤.`);
    } else {
        console.error('ğŸ¢ loadContent í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
}

// ì •ë ¬
function sortBy(field) {
    if (currentSort.field === field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.field = field;
        currentSort.direction = 'asc';
    }
    
    currentPage = 1; // ì •ë ¬ ì‹œ ì²« í˜ì´ì§€ë¡œ
    searchProps();
}

// í˜ì´ì§€ ë³€ê²½
function changePage(pageNo) {
    if (pageNo < 1 || pageNo > totalPages) return;
    currentPage = pageNo;
    searchProps();
}

// ì‚¬ì—…ì¥ ë“±ë¡
function insertProp() {
    if (window.showStatus) {
        window.showStatus('ì‚¬ì—…ì¥ ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    } else {
        alert('ì‚¬ì—…ì¥ ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    }
}

// ì—‘ì…€ ì €ì¥
function exportExcel() {
    if (window.showStatus) {
        window.showStatus('ì—‘ì…€ ì €ì¥ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    } else {
        alert('ì—‘ì…€ ì €ì¥ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    }
}

// í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤í–‰
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ¢ prop_list DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
    
    // base.html ë°ì´í„° í™•ì¸ í•¨ìˆ˜
    function checkBaseData() {
        const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
        
        console.log('ğŸ¢ base.html ë°ì´í„° í™•ì¸ ê²°ê³¼:', { em_id });
        
        if (em_id && !isPropPageInitialized) {
            console.log('ğŸ¢ âœ… base.html ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘');
            initPropListPage();
            return true;
        }
        
        return false;
    }
    
    // ì¦‰ì‹œ í™•ì¸
    if (checkBaseData()) {
        return;
    }
    
    console.log('ğŸ¢ ë°ì´í„° ëŒ€ê¸° ì‹œì‘...');
    
    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ëŒ€ê¸°
    const checkUserInfo = setInterval(() => {
        if (checkBaseData()) {
            clearInterval(checkUserInfo);
        }
    }, 200);
    
    // 5ì´ˆ í›„ íƒ€ì„ì•„ì›ƒ
    setTimeout(() => {
        clearInterval(checkUserInfo);
        if (!isPropPageInitialized && !window.currentEmId) {
            console.error('ğŸ¢ 5ì´ˆ ëŒ€ê¸° í›„ì—ë„ base.html ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í•¨');
            document.getElementById('prop-table-body').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.</td></tr>';
        }
    }, 5000);
});

// ì´ˆê¸°í™” í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (íƒ­ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
window.initPropListPage = initPropListPage;
window.searchProps = searchProps;

// ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í™•ì¸
console.log('ğŸ¢ prop_list.html ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
console.log('ğŸ¢ initPropListPage í•¨ìˆ˜ ì¡´ì¬:', typeof initPropListPage);
</script>