<!-- SPA íƒ­ìš© ì‚¬ì—…ì¥ë“±ë¡ í˜ì´ì§€ - JSP ë™ì¼ ë™ì‘ -->
<link rel="stylesheet" href="/static/css/common.css">
<style>
    /* ì‚¬ì—…ì¥ë“±ë¡ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
    .prop-insert-container {
        padding: 20px;
        max-width: 1000px;
        margin: 0 auto;
    }
    
    .page-title {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #666666;
    }
    
    .page-title img {
        margin-right: 10px;
    }
    
    .title-text {
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }
    
    .breadcrumb {
        font-size: 12px;
        color: #666;
        text-align: right;
        margin-top: 5px;
    }
    
    .form-table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #CCCCCC;
        margin-bottom: 20px;
        font-size: 12px;
    }
    
    .form-table td {
        padding: 8px;
        border: 1px solid #CCCCCC;
        vertical-align: middle;
    }
    
    .form-label {
        background-color: #f8f9fa;
        text-align: center;
        width: 25%;
        font-weight: bold;
        color: #495057;
    }
    
    .form-input {
        padding: 8px;
        background-color: #fff;
        width: 25%;
    }
    
    .form-input input,
    .form-input textarea {
        width: 100%;
        padding: 4px 6px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        font-size: 12px;
    }
    
    .form-input input:focus,
    .form-input textarea:focus {
        border-color: #007bff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .button-row {
        text-align: right;
        padding: 8px;
    }
    
    .button-row button {
        margin-left: 5px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: bold;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }
    
    .btn-back {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-back:hover {
        background-color: #5a6268;
    }
    
    .btn-submit {
        background-color: #007bff;
        color: white;
    }
    
    .btn-submit:hover {
        background-color: #0056b3;
    }
    
    .required {
        color: #dc3545;
    }
    
    @media (max-width: 768px) {
        .prop-insert-container {
            padding: 10px;
        }
        
        .form-table {
            font-size: 11px;
        }
        
        .form-label,
        .form-input {
            width: 50%;
        }
        
        .breadcrumb {
            text-align: center;
            margin-top: 10px;
        }
    }
</style>

<div class="prop-insert-container">
    <!-- í˜ì´ì§€ ì œëª© -->
    <div class="page-title">
        <div style="width: 32px; height: 35px; background: linear-gradient(135deg, #007bff, #0056b3); display: inline-block; border-radius: 4px; margin-right: 10px;"></div>
        <div>
            <div class="title-text">ì‚¬ì—…ì¥ ì •ë³´</div>
            <div class="breadcrumb">Home > ê³µê°„ë°ì¡°ì§ì •ë³´ > ì‚¬ì—…ì¥ì •ë³´</div>
        </div>
    </div>

    <!-- ë“±ë¡ í¼ -->
    <form id="prop-insert-form">
        <table class="form-table">
            <tr>
                <td class="form-label">
                    <b>ì‚¬ì—…ì¥ ì½”ë“œ</b> <span class="required">*</span>
                </td>
                <td class="form-input">
                    <input type="text" id="prop_id" name="prop_id" maxlength="20" placeholder="ì‚¬ì—…ì¥ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
                </td>
                <td class="form-label">
                    <b>ì‚¬ì—…ì¥ ì´ë¦„</b> <span class="required">*</span>
                </td>
                <td class="form-input">
                    <input type="text" id="prop_name" name="prop_name" maxlength="50" placeholder="ì‚¬ì—…ì¥ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </td>
            </tr>
            <tr>
                <td class="form-label">
                    <b>ë„ì‹œëª…</b>
                </td>
                <td class="form-input">
                    <select id="city_id" name="city_id">
                        <option value="">-- ë„ì‹œ ì„ íƒ --</option>
                    </select>
                </td>
                <td class="form-label">
                    <b>ìš©ë„</b>
                </td>
                <td class="form-input">
                    <input type="text" id="use1" name="use1" maxlength="50" placeholder="ìš©ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </td>
            </tr>
            <tr>
                <td class="form-label">
                    <b>ì£¼ì†Œ</b>
                </td>
                <td class="form-input">
                    <input type="text" id="address1" name="address1" maxlength="200" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </td>
                <td class="form-label">
                    <b>ë‹´ë‹¹ì</b>
                </td>
                <td class="form-input">
                    <input type="text" id="contact1" name="contact1" maxlength="50" placeholder="ë‹´ë‹¹ìë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </td>
            </tr>
            <tr>
                <td class="form-label">
                    <b>ì—°ë½ì²˜</b>
                </td>
                <td class="form-input">
                    <input type="text" id="phone" name="phone" maxlength="50" placeholder="ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </td>
                <td class="form-label">
                    <b>ì—°ì²´ì´ììœ¨(ì›”)</b>
                </td>
                <td class="form-input">
                    <input type="number" id="overdue_monthly_rate" name="overdue_monthly_rate" step="0.01" placeholder="0.00">
                </td>
            </tr>
            <tr>
                <td class="form-label">
                    <b>ë¹„ ê³ </b>
                </td>
                <td colspan="3" class="form-input">
                    <textarea id="description" name="description" rows="8" placeholder="ë¹„ê³ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </td>
            </tr>
            <tr>
                <td colspan="4" class="button-row">
                    <button type="button" class="btn-back" onclick="goBack()">ë’¤ë¡œ</button>
                    <button type="button" class="btn-submit" onclick="submitForm()">ì‘ì„±</button>
                </td>
            </tr>
        </table>
    </form>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜
console.log('ğŸ“ prop_insert.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');

let isPropInsertPageInitialized = false;

// í˜ì´ì§€ ì´ˆê¸°í™”
function initPropInsertPage() {
    console.log('ğŸ“ ì‚¬ì—…ì¥ë“±ë¡ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
    
    // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (isPropInsertPageInitialized) {
        console.log('ğŸ“ ì´ë¯¸ ì´ˆê¸°í™”ë¨, ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€');
        return;
    }
    
    // ì´ˆê¸°í™” í”Œë˜ê·¸ ì„¤ì •
    isPropInsertPageInitialized = true;
    
    // ë„ì‹œ ëª©ë¡ ë¡œë“œ
    loadCityOptions();
    
    // ì‚¬ì—…ì¥ ì½”ë“œ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
    document.getElementById('prop_id').focus();
    
    // ì‚¬ì—…ì¥ ì½”ë“œ ì¤‘ë³µ ì²´í¬ ì´ë²¤íŠ¸
    document.getElementById('prop_id').addEventListener('blur', checkPropIdDuplicate);
    
    console.log('ğŸ“ ì‚¬ì—…ì¥ë“±ë¡ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
}

// ë„ì‹œ ëª©ë¡ ë¡œë“œ
function loadCityOptions() {
    console.log('ğŸ“ ë„ì‹œ ëª©ë¡ ë¡œë“œ ì‹œì‘');
    
    fetch('/common/get_select_options', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            table: 'city',
            id_field: 'city_id',
            text_field: 'name',
            order_by: 'city_id ASC'
        })
    })
    .then(response => response.json())
    .then(data => {
        const select = document.getElementById('city_id');
        select.innerHTML = '<option value="">-- ë„ì‹œ ì„ íƒ --</option>';
        
        if (data.success) {
            data.data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.text} (${item.id})`;
                select.appendChild(option);
            });
            console.log('ğŸ“ ë„ì‹œ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', data.data.length, 'ê°œ');
        } else {
            console.error('ğŸ“ ë„ì‹œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', data.message);
        }
    })
    .catch(error => {
        console.error('ğŸ“ ë„ì‹œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
    });
}

// ì‚¬ì—…ì¥ ì½”ë“œ ì¤‘ë³µ ì²´í¬
function checkPropIdDuplicate() {
    const propId = document.getElementById('prop_id').value.trim();
    if (!propId) return;
    
    console.log('ğŸ“ ì‚¬ì—…ì¥ ì½”ë“œ ì¤‘ë³µ ì²´í¬:', propId);
    
    fetch('/fm/prop_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            c_type: 'check_duplicate',
            prop_id: propId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.exists) {
            alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ì—…ì¥ ì½”ë“œì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            document.getElementById('prop_id').focus();
            document.getElementById('prop_id').select();
        }
    })
    .catch(error => {
        console.error('ğŸ“ ì¤‘ë³µ ì²´í¬ ì˜¤ë¥˜:', error);
    });
}

// í¼ ì œì¶œ
function submitForm() {
    console.log('ğŸ“ ì‚¬ì—…ì¥ ë“±ë¡ ì‹œì‘');
    
    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    const propId = document.getElementById('prop_id').value.trim();
    const propName = document.getElementById('prop_name').value.trim();
    
    if (!propId) {
        alert('ì‚¬ì—…ì¥ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        document.getElementById('prop_id').focus();
        return;
    }
    
    if (!propName) {
        alert('ì‚¬ì—…ì¥ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        document.getElementById('prop_name').focus();
        return;
    }
    
    // í¼ ë°ì´í„° ìˆ˜ì§‘
    const formData = new FormData(document.getElementById('prop-insert-form'));
    const data = Object.fromEntries(formData.entries());
    
    console.log('ğŸ“ ë“±ë¡í•  ë°ì´í„°:', data);
    
    // ë¡œë”© í‘œì‹œ
    const submitBtn = document.querySelector('.btn-submit');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'ë“±ë¡ ì¤‘...';
    submitBtn.disabled = true;
    
    // ì„œë²„ì— ë“±ë¡ ìš”ì²­
    fetch('/fm/prop_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            c_type: 'insert',
            ...data
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('ì‚¬ì—…ì¥ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // ë“±ë¡ ì„±ê³µ í›„ ëª©ë¡ìœ¼ë¡œ ì´ë™
            goToPropList();
        } else {
            alert('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message);
            
            // ë²„íŠ¼ ë³µì›
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        console.error('ğŸ“ ë“±ë¡ ì˜¤ë¥˜:', error);
        
        // ë²„íŠ¼ ë³µì›
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

// ë’¤ë¡œ ê°€ê¸° - JSPì˜ back() í•¨ìˆ˜ì™€ ë™ì¼
function goBack() {
    goToPropList();
}

// ì‚¬ì—…ì¥ ëª©ë¡ìœ¼ë¡œ ì´ë™
function goToPropList() {
    // ì„ íƒëœ ì‚¬ì—…ì¥ ì •ë³´ ì´ˆê¸°í™”
    window.selected_prop_id = null;
    
    // prop_list íƒ­ìœ¼ë¡œ ì´ë™
    if (typeof window.loadContent === 'function') {
        window.loadContent('/fm/prop_list.html', 'ì‚¬ì—…ì¥ì •ë³´');
        window.showStatus('ì‚¬ì—…ì¥ ëª©ë¡ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.');
    } else {
        console.error('ğŸ“ loadContent í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
}

// íŠ¹ìˆ˜ë¬¸ì ì…ë ¥ ì œí•œ (JSPì˜ spacipic í•¨ìˆ˜ì™€ ìœ ì‚¬)
function validatePropId(event) {
    const char = String.fromCharCode(event.which);
    const pattern = /[a-zA-Z0-9]/;
    
    if (!pattern.test(char)) {
        event.preventDefault();
        return false;
    }
    return true;
}

// í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤í–‰
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ“ prop_insert DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
    
    // base.html ë°ì´í„° í™•ì¸ í•¨ìˆ˜
    function checkBaseData() {
        const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
        
        console.log('ğŸ“ base.html ë°ì´í„° í™•ì¸ ê²°ê³¼:', { em_id });
        
        if (em_id && !isPropInsertPageInitialized) {
            console.log('ğŸ“ âœ… base.html ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘');
            initPropInsertPage();
            return true;
        }
        
        return false;
    }
    
    // ì¦‰ì‹œ í™•ì¸
    if (checkBaseData()) {
        return;
    }
    
    console.log('ğŸ“ ë°ì´í„° ëŒ€ê¸° ì‹œì‘...');
    
    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ëŒ€ê¸°
    const checkUserInfo = setInterval(() => {
        if (checkBaseData()) {
            clearInterval(checkUserInfo);
        }
    }, 200);
    
    // 5ì´ˆ í›„ íƒ€ì„ì•„ì›ƒ
    setTimeout(() => {
        clearInterval(checkUserInfo);
        if (!isPropInsertPageInitialized) {
            console.error('ğŸ“ 5ì´ˆ ëŒ€ê¸° í›„ì—ë„ base.html ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í•¨');
            // ê·¸ë˜ë„ ì´ˆê¸°í™” ì‹œë„
            initPropInsertPage();
        }
    }, 5000);
});

// ì‚¬ì—…ì¥ ì½”ë“œ ì…ë ¥ ì œí•œ ì´ë²¤íŠ¸ ì¶”ê°€
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const propIdInput = document.getElementById('prop_id');
        if (propIdInput) {
            propIdInput.addEventListener('keypress', validatePropId);
        }
    }, 100);
});

// base.htmlì˜ íƒ­ ì‹œìŠ¤í…œì—ì„œ í˜¸ì¶œë  ìˆ˜ ìˆë„ë¡ ì¶”ê°€
setTimeout(() => {
    if (typeof window.initPropInsertPage !== 'function' && !isPropInsertPageInitialized) {
        console.log('ğŸ“ íƒ­ ë¡œë“œ ê°ì§€ - ê°•ì œ ì´ˆê¸°í™” ì‹œì‘');
        initPropInsertPage();
    }
}, 500);

// ì´ˆê¸°í™” í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (íƒ­ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
window.initPropInsertPage = initPropInsertPage;

// ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í™•ì¸
console.log('ğŸ“ prop_insert.html ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
console.log('ğŸ“ initPropInsertPage í•¨ìˆ˜ ì¡´ì¬:', typeof initPropInsertPage);
</script>