<!-- SPA 탭용 사업장등록 페이지 - JSP 동일 동작 -->
<link rel="stylesheet" href="/static/css/common.css">
<style>
    /* 사업장등록 페이지 전용 스타일 */
    .prop-insert-container {
        padding: 20px;
        max-width: 1000px;
        margin: 0 auto;
    }
    
    .page-title {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #666666;
    }
    
    .page-title img {
        margin-right: 10px;
    }
    
    .title-text {
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }
    
    .breadcrumb {
        font-size: 12px;
        color: #666;
        text-align: right;
        margin-top: 5px;
    }
    
    .form-table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #CCCCCC;
        margin-bottom: 20px;
        font-size: 12px;
    }
    
    .form-table td {
        padding: 8px;
        border: 1px solid #CCCCCC;
        vertical-align: middle;
    }
    
    .form-label {
        background-color: #f8f9fa;
        text-align: center;
        width: 25%;
        font-weight: bold;
        color: #495057;
    }
    
    .form-input {
        padding: 8px;
        background-color: #fff;
        width: 25%;
    }
    
    .form-input input,
    .form-input textarea {
        width: 100%;
        padding: 4px 6px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        font-size: 12px;
    }
    
    .form-input input:focus,
    .form-input textarea:focus {
        border-color: #007bff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .button-row {
        text-align: right;
        padding: 8px;
    }
    
    .button-row button {
        margin-left: 5px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: bold;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }
    
    .btn-back {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-back:hover {
        background-color: #5a6268;
    }
    
    .btn-submit {
        background-color: #007bff;
        color: white;
    }
    
    .btn-submit:hover {
        background-color: #0056b3;
    }
    
    .required {
        color: #dc3545;
    }
    
    @media (max-width: 768px) {
        .prop-insert-container {
            padding: 10px;
        }
        
        .form-table {
            font-size: 11px;
        }
        
        .form-label,
        .form-input {
            width: 50%;
        }
        
        .breadcrumb {
            text-align: center;
            margin-top: 10px;
        }
    }
</style>

<div class="prop-insert-container">
    <!-- 페이지 제목 -->
    <div class="page-title">
        <div style="width: 32px; height: 35px; background: linear-gradient(135deg, #007bff, #0056b3); display: inline-block; border-radius: 4px; margin-right: 10px;"></div>
        <div>
            <div class="title-text">사업장 정보</div>
            <div class="breadcrumb">Home > 공간및조직정보 > 사업장정보</div>
        </div>
    </div>

    <!-- 등록 폼 -->
    <form id="prop-insert-form">
        <table class="form-table">
            <tr>
                <td class="form-label">
                    <b>사업장 코드</b> <span class="required">*</span>
                </td>
                <td class="form-input">
                    <input type="text" id="prop_id" name="prop_id" maxlength="20" placeholder="사업장 코드를 입력하세요" required>
                </td>
                <td class="form-label">
                    <b>사업장 이름</b> <span class="required">*</span>
                </td>
                <td class="form-input">
                    <input type="text" id="prop_name" name="prop_name" maxlength="50" placeholder="사업장 이름을 입력하세요" required>
                </td>
            </tr>
            <tr>
                <td class="form-label">
                    <b>도시명</b>
                </td>
                <td class="form-input">
                    <select id="city_id" name="city_id">
                        <option value="">-- 도시 선택 --</option>
                    </select>
                </td>
                <td class="form-label">
                    <b>용도</b>
                </td>
                <td class="form-input">
                    <input type="text" id="use1" name="use1" maxlength="50" placeholder="용도를 입력하세요">
                </td>
            </tr>
            <tr>
                <td class="form-label">
                    <b>주소</b>
                </td>
                <td class="form-input">
                    <input type="text" id="address1" name="address1" maxlength="200" placeholder="주소를 입력하세요">
                </td>
                <td class="form-label">
                    <b>담당자</b>
                </td>
                <td class="form-input">
                    <input type="text" id="contact1" name="contact1" maxlength="50" placeholder="담당자를 입력하세요">
                </td>
            </tr>
            <tr>
                <td class="form-label">
                    <b>연락처</b>
                </td>
                <td class="form-input">
                    <input type="text" id="phone" name="phone" maxlength="50" placeholder="연락처를 입력하세요">
                </td>
                <td class="form-label">
                    <b>연체이자율(월)</b>
                </td>
                <td class="form-input">
                    <input type="number" id="overdue_monthly_rate" name="overdue_monthly_rate" step="0.01" placeholder="0.00">
                </td>
            </tr>
            <tr>
                <td class="form-label">
                    <b>비 고</b>
                </td>
                <td colspan="3" class="form-input">
                    <textarea id="description" name="description" rows="8" placeholder="비고사항을 입력하세요"></textarea>
                </td>
            </tr>
            <tr>
                <td colspan="4" class="button-row">
                    <button type="button" class="btn-back" onclick="goBack()">뒤로</button>
                    <button type="button" class="btn-submit" onclick="submitForm()">작성</button>
                </td>
            </tr>
        </table>
    </form>
</div>

<script>
// 전역 변수
console.log('📝 prop_insert.html 스크립트 시작!');

let isPropInsertPageInitialized = false;

// 페이지 초기화
function initPropInsertPage() {
    console.log('📝 사업장등록 페이지 초기화 시작');
    
    // 중복 실행 방지
    if (isPropInsertPageInitialized) {
        console.log('📝 이미 초기화됨, 중복 실행 방지');
        return;
    }
    
    // 초기화 플래그 설정
    isPropInsertPageInitialized = true;
    
    // 도시 목록 로드
    loadCityOptions();
    
    // 사업장 코드 입력 필드에 포커스
    document.getElementById('prop_id').focus();
    
    // 사업장 코드 중복 체크 이벤트
    document.getElementById('prop_id').addEventListener('blur', checkPropIdDuplicate);
    
    console.log('📝 사업장등록 페이지 초기화 완료');
}

// 도시 목록 로드
function loadCityOptions() {
    console.log('📝 도시 목록 로드 시작');
    
    fetch('/common/get_select_options', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            table: 'city',
            id_field: 'city_id',
            text_field: 'name',
            order_by: 'city_id ASC'
        })
    })
    .then(response => response.json())
    .then(data => {
        const select = document.getElementById('city_id');
        select.innerHTML = '<option value="">-- 도시 선택 --</option>';
        
        if (data.success) {
            data.data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.text} (${item.id})`;
                select.appendChild(option);
            });
            console.log('📝 도시 목록 로드 완료:', data.data.length, '개');
        } else {
            console.error('📝 도시 목록 로드 실패:', data.message);
        }
    })
    .catch(error => {
        console.error('📝 도시 목록 로드 오류:', error);
    });
}

// 사업장 코드 중복 체크
function checkPropIdDuplicate() {
    const propId = document.getElementById('prop_id').value.trim();
    if (!propId) return;
    
    console.log('📝 사업장 코드 중복 체크:', propId);
    
    fetch('/fm/prop_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            c_type: 'check_duplicate',
            prop_id: propId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.exists) {
            alert('이미 존재하는 사업장 코드입니다. 다른 코드를 입력해주세요.');
            document.getElementById('prop_id').focus();
            document.getElementById('prop_id').select();
        }
    })
    .catch(error => {
        console.error('📝 중복 체크 오류:', error);
    });
}

// 폼 제출
function submitForm() {
    console.log('📝 사업장 등록 시작');
    
    // 필수 필드 검증
    const propId = document.getElementById('prop_id').value.trim();
    const propName = document.getElementById('prop_name').value.trim();
    
    if (!propId) {
        alert('사업장 코드를 입력해주세요.');
        document.getElementById('prop_id').focus();
        return;
    }
    
    if (!propName) {
        alert('사업장 이름을 입력해주세요.');
        document.getElementById('prop_name').focus();
        return;
    }
    
    // 폼 데이터 수집
    const formData = new FormData(document.getElementById('prop-insert-form'));
    const data = Object.fromEntries(formData.entries());
    
    console.log('📝 등록할 데이터:', data);
    
    // 로딩 표시
    const submitBtn = document.querySelector('.btn-submit');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = '등록 중...';
    submitBtn.disabled = true;
    
    // 서버에 등록 요청
    fetch('/fm/prop_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            c_type: 'insert',
            ...data
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('사업장이 성공적으로 등록되었습니다.');
            
            // 등록 성공 후 목록으로 이동
            goToPropList();
        } else {
            alert('등록에 실패했습니다: ' + result.message);
            
            // 버튼 복원
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        alert('등록 중 오류가 발생했습니다.');
        console.error('📝 등록 오류:', error);
        
        // 버튼 복원
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

// 뒤로 가기 - JSP의 back() 함수와 동일
function goBack() {
    goToPropList();
}

// 사업장 목록으로 이동
function goToPropList() {
    // 선택된 사업장 정보 초기화
    window.selected_prop_id = null;
    
    // prop_list 탭으로 이동
    if (typeof window.loadContent === 'function') {
        window.loadContent('/fm/prop_list.html', '사업장정보');
        window.showStatus('사업장 목록으로 이동했습니다.');
    } else {
        console.error('📝 loadContent 함수를 찾을 수 없습니다.');
    }
}

// 특수문자 입력 제한 (JSP의 spacipic 함수와 유사)
function validatePropId(event) {
    const char = String.fromCharCode(event.which);
    const pattern = /[a-zA-Z0-9]/;
    
    if (!pattern.test(char)) {
        event.preventDefault();
        return false;
    }
    return true;
}

// 페이지 초기화 실행
document.addEventListener('DOMContentLoaded', function() {
    console.log('📝 prop_insert DOMContentLoaded 이벤트 발생');
    
    // base.html 데이터 확인 함수
    function checkBaseData() {
        const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
        
        console.log('📝 base.html 데이터 확인 결과:', { em_id });
        
        if (em_id && !isPropInsertPageInitialized) {
            console.log('📝 ✅ base.html 데이터 준비 완료, 초기화 시작');
            initPropInsertPage();
            return true;
        }
        
        return false;
    }
    
    // 즉시 확인
    if (checkBaseData()) {
        return;
    }
    
    console.log('📝 데이터 대기 시작...');
    
    // 사용자 정보 로드 대기
    const checkUserInfo = setInterval(() => {
        if (checkBaseData()) {
            clearInterval(checkUserInfo);
        }
    }, 200);
    
    // 5초 후 타임아웃
    setTimeout(() => {
        clearInterval(checkUserInfo);
        if (!isPropInsertPageInitialized) {
            console.error('📝 5초 대기 후에도 base.html 데이터를 받지 못함');
            // 그래도 초기화 시도
            initPropInsertPage();
        }
    }, 5000);
});

// 사업장 코드 입력 제한 이벤트 추가
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const propIdInput = document.getElementById('prop_id');
        if (propIdInput) {
            propIdInput.addEventListener('keypress', validatePropId);
        }
    }, 100);
});

// base.html의 탭 시스템에서 호출될 수 있도록 추가
setTimeout(() => {
    if (typeof window.initPropInsertPage !== 'function' && !isPropInsertPageInitialized) {
        console.log('📝 탭 로드 감지 - 강제 초기화 시작');
        initPropInsertPage();
    }
}, 500);

// 초기화 함수를 전역으로 노출 (탭에서 호출 가능)
window.initPropInsertPage = initPropInsertPage;

// 스크립트 로드 완료 확인
console.log('📝 prop_insert.html 스크립트 로드 완료');
console.log('📝 initPropInsertPage 함수 존재:', typeof initPropInsertPage);
</script>