<!-- HiddenFrame íƒ­ìš© ì‚¬ì—…ì¥ìˆ˜ì • í˜ì´ì§€ - JSP ë™ì¼ ë™ì‘ -->
<link rel="stylesheet" href="/static/css/common.css">
<style>
    /* ì‚¬ì—…ì¥ìˆ˜ì • í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
    .prop-update-container {
        padding: 20px;
        max-width: 1000px;
        margin: 0 auto;
    }
    
    .page-title {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #666666;
    }
    
    .page-title img {
        margin-right: 10px;
    }
    
    .title-text {
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }
    
    .breadcrumb {
        font-size: 12px;
        color: #666;
        text-align: right;
        margin-top: 5px;
    }
    
    .form-table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #CCCCCC;
        margin-bottom: 20px;
        font-size: 12px;
    }
    
    .form-table td {
        padding: 8px;
        border: 1px solid #CCCCCC;
        vertical-align: middle;
    }
    
    .form-label {
        background-color: #f8f9fa;
        text-align: center;
        width: 25%;
        font-weight: bold;
        color: #495057;
    }
    
    .form-input {
        padding: 8px;
        background-color: #fff;
        width: 25%;
    }
    
    .form-input input,
    .form-input textarea,
    .form-input select {
        width: 100%;
        padding: 4px 6px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        font-size: 12px;
    }
    
    .form-input input:focus,
    .form-input textarea:focus,
    .form-input select:focus {
        border-color: #007bff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .form-input input:disabled {
        background-color: #e9ecef;
        opacity: 1;
    }
    
    .button-row {
        text-align: right;
        padding: 8px;
    }
    
    .button-row button {
        margin-left: 5px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: bold;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }
    
    .btn-back {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-back:hover {
        background-color: #5a6268;
    }
    
    .btn-submit {
        background-color: #007bff;
        color: white;
    }
    
    .btn-submit:hover {
        background-color: #0056b3;
    }
    
    .required {
        color: #dc3545;
    }
    
    .loading-message {
        text-align: center;
        padding: 50px;
        color: #6c757d;
        font-size: 14px;
    }
    
    .error-message {
        text-align: center;
        padding: 50px;
        color: #dc3545;
        font-size: 14px;
    }
    
    @media (max-width: 768px) {
        .prop-update-container {
            padding: 10px;
        }
        
        .form-table {
            font-size: 11px;
        }
        
        .form-label,
        .form-input {
            width: 50%;
        }
        
        .breadcrumb {
            text-align: center;
            margin-top: 10px;
        }
    }
</style>

<div class="prop-update-container" id="prop-update-container">
    <!-- ë¡œë”© ë©”ì‹œì§€ -->
    <div id="loading-section" class="loading-message">
        <div class="spinner" style="margin: 0 auto 20px;"></div>
        <p>ì‚¬ì—…ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
    
    <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ -->
    <div id="error-section" class="error-message" style="display: none;">
        <h3>âŒ ì˜¤ë¥˜ ë°œìƒ</h3>
        <p id="error-message-text">ì‚¬ì—…ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        <button class="btn btn-primary" onclick="PropUpdateModule.retry()">ë‹¤ì‹œ ì‹œë„</button>
        <button class="btn btn-secondary" onclick="PropUpdateModule.goBack()">ë’¤ë¡œ ê°€ê¸°</button>
    </div>
    
    <!-- ìˆ˜ì • í¼ -->
    <div id="form-section" style="display: none;">
        <!-- í˜ì´ì§€ ì œëª© -->
        <div class="page-title">
            <div style="width: 32px; height: 35px; background: linear-gradient(135deg, #28a745, #20c997); display: inline-block; border-radius: 4px; margin-right: 10px;"></div>
            <div>
                <div class="title-text">ì‚¬ì—…ì¥ ìˆ˜ì • <span id="prop-id-display"></span></div>
                <div class="breadcrumb">Home > ê³µê°„ë°ì¡°ì§ì •ë³´ > ì‚¬ì—…ì¥ì •ë³´ > ìˆ˜ì •</div>
            </div>
        </div>

        <!-- ìˆ˜ì • í¼ -->
        <form id="prop-update-form">
            <input type="hidden" id="prop_id" name="prop_id">
            
            <table class="form-table">
                <tr>
                    <td class="form-label">
                        <b>ì‚¬ì—…ì¥ ì½”ë“œ</b>
                    </td>
                    <td class="form-input">
                        <input type="text" id="prop_id_display" disabled>
                    </td>
                    <td class="form-label">
                        <b>ì‚¬ì—…ì¥ ì´ë¦„</b>
                    </td>
                    <td class="form-input">
                        <input type="text" id="prop_name_display" disabled>
                    </td>
                </tr>
                <tr>
                    <td class="form-label">
                        <b>ë„ì‹œëª…</b>
                    </td>
                    <td class="form-input">
                        <select id="city_id" name="city_id">
                            <option value="">-- ë„ì‹œ ì„ íƒ --</option>
                        </select>
                    </td>
                    <td class="form-label">
                        <b>ìš©ë„</b>
                    </td>
                    <td class="form-input">
                        <input type="text" id="use1" name="use1" maxlength="50" placeholder="ìš©ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </td>
                </tr>
                <tr>
                    <td class="form-label">
                        <b>ì£¼ì†Œ</b>
                    </td>
                    <td class="form-input">
                        <input type="text" id="address1" name="address1" maxlength="200" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </td>
                    <td class="form-label">
                        <b>ë‹´ë‹¹ì</b>
                    </td>
                    <td class="form-input">
                        <input type="text" id="contact1" name="contact1" maxlength="50" placeholder="ë‹´ë‹¹ìë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </td>
                </tr>
                <tr>
                    <td class="form-label">
                        <b>ì—°ë½ì²˜</b>
                    </td>
                    <td class="form-input">
                        <input type="text" id="phone" name="phone" maxlength="50" placeholder="ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </td>
                    <td class="form-label">
                        <b>ì—°ì²´ì´ììœ¨(ì›”)</b>
                    </td>
                    <td class="form-input">
                        <input type="number" id="overdue_monthly_rate" name="overdue_monthly_rate" step="0.01" placeholder="0.00">
                    </td>
                </tr>
                <tr>
                    <td class="form-label">
                        <b>ì—°ì²´ì´ììœ¨(ì¼)</b>
                    </td>
                    <td class="form-input">
                        <input type="number" id="overdue_daily_rate" name="overdue_daily_rate" step="0.01" placeholder="0.00">
                    </td>
                    <td class="form-label">
                        <b>ê±´ë¬¼ ìˆ˜</b>
                    </td>
                    <td class="form-input">
                        <input type="text" id="bl_cnt" disabled>
                    </td>
                </tr>
                <tr>
                    <td class="form-label">
                        <b>ë¹„ ê³ </b>
                    </td>
                    <td colspan="3" class="form-input">
                        <textarea id="description" name="description" rows="8" placeholder="ë¹„ê³ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </td>
                </tr>
                <tr>
                    <td colspan="4" class="button-row">
                        <button type="button" class="btn-back" onclick="PropUpdateModule.goBack()">ëª©ë¡ë³´ê¸°</button>
                        <button type="button" class="btn-submit" onclick="PropUpdateModule.submitForm()">ìˆ˜ì •</button>
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>

<script>
// ğŸ›¡ï¸ HiddenFrame ì „ìš© ìŠ¤ì½”í”„ ë¶„ë¦¬
(function() {
    'use strict';
    
    console.log('ğŸ¢ prop_update.html HiddenFrame ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');
    
    // ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± - ì¤‘ë³µ ë°©ì§€
    if (typeof window.PropUpdateModule !== 'undefined') {
        console.log('ğŸ¢ ê¸°ì¡´ PropUpdateModule ì¬ì‚¬ìš©');
        return; // ì´ë¯¸ ë¡œë“œë¨
    }
    
    // ğŸ†• HiddenFrame ì „ìš© ëª¨ë“ˆ ìƒì„±
    window.PropUpdateModule = {
        // ë°ì´í„° ì €ì¥ì†Œ
        data: {
            propId: null,
            propData: null,
            isInitialized: false,
            isLoading: false
        },
        
        // ğŸ†• HiddenFrame ìƒíƒœ í™•ì¸
        isVisible: function() {
            const container = document.getElementById('prop-update-container');
            if (!container) return false;
            
            // ë¶€ëª¨ íƒ­ ì»¨í…Œì´ë„ˆê°€ í‘œì‹œë˜ê³  ìˆëŠ”ì§€ í™•ì¸
            let current = container;
            while (current) {
                if (current.style && current.style.display === 'none') {
                    return false;
                }
                current = current.parentElement;
                if (current && current.classList && current.classList.contains('tab-container')) {
                    break;
                }
            }
            return true;
        },
        
        // ì´ˆê¸°í™”
        init: function() {
            console.log('ğŸ¢ ì‚¬ì—…ì¥ìˆ˜ì • í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘ (HiddenFrame)');
            
            // ğŸ†• HiddenFrame: ìˆ¨ê²¨ì§„ ìƒíƒœì—ì„œëŠ” ì´ˆê¸°í™” í•˜ì§€ ì•ŠìŒ
            if (!this.isVisible()) {
                console.log('ğŸ¢ ìˆ¨ê²¨ì§„ ìƒíƒœì´ë¯€ë¡œ ì´ˆê¸°í™” ëŒ€ê¸°');
                return;
            }
            
            if (this.data.isInitialized) {
                console.log('ğŸ¢ ì´ë¯¸ ì´ˆê¸°í™”ë¨');
                return;
            }
            
            // ì„ íƒëœ ì‚¬ì—…ì¥ ID í™•ì¸
            const propId = window.selected_prop_id;
            console.log('ğŸ¢ ì„ íƒëœ ì‚¬ì—…ì¥ ID:', propId);
            
            if (!propId) {
                this.showError('ì‚¬ì—…ì¥ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            this.data.propId = propId;
            this.data.isInitialized = true;
            
            // ğŸ†• HiddenFrame ì´ë²¤íŠ¸ ë°”ì¸ë”©
            this.bindHiddenFrameEvents();
            
            // ë°ì´í„° ë¡œë“œ
            this.loadPropData();
        },
        
        // ğŸ†• HiddenFrame ì´ë²¤íŠ¸ ë°”ì¸ë”©
        bindHiddenFrameEvents: function() {
            const container = document.getElementById('prop-update-container');
            if (!container) return;
            
            // íƒ­ì´ visible ë  ë•Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
            container.addEventListener('tabVisible', (e) => {
                console.log('ğŸ¢ ì‚¬ì—…ì¥ìˆ˜ì • íƒ­ì´ ë‹¤ì‹œ í‘œì‹œë¨');
                if (!this.data.isInitialized) {
                    this.init();
                }
            });
        },
        
        // ì‚¬ì—…ì¥ ë°ì´í„° ë¡œë“œ
        loadPropData: function() {
            if (this.data.isLoading) return;
            
            console.log('ğŸ¢ ì‚¬ì—…ì¥ ë°ì´í„° ë¡œë“œ ì‹œì‘:', this.data.propId);
            
            this.data.isLoading = true;
            this.showLoading();
            
            // ë„ì‹œ ëª©ë¡ê³¼ ì‚¬ì—…ì¥ ì •ë³´ë¥¼ ë³‘ë ¬ë¡œ ë¡œë“œ
            Promise.all([
                this.loadCityOptions(),
                this.loadPropDetail()
            ])
            .then(() => {
                console.log('ğŸ¢ ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                this.showForm();
                this.data.isLoading = false;
            })
            .catch((error) => {
                console.error('ğŸ¢ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                this.showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                this.data.isLoading = false;
            });
        },
        
        // ë„ì‹œ ëª©ë¡ ë¡œë“œ
        loadCityOptions: function() {
            return fetch('/common/get_select_options', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    table: 'city',
                    id_field: 'city_id',
                    text_field: 'name',
                    order_by: 'city_id ASC'
                })
            })
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('city_id');
                if (select) {
                    select.innerHTML = '<option value="">-- ë„ì‹œ ì„ íƒ --</option>';
                    
                    if (data.success) {
                        data.data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = `${item.text} (${item.id})`;
                            select.appendChild(option);
                        });
                        console.log('ğŸ¢ ë„ì‹œ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', data.data.length, 'ê°œ');
                    }
                }
            });
        },
        
        // ì‚¬ì—…ì¥ ìƒì„¸ ì •ë³´ ë¡œë“œ
        loadPropDetail: function() {
            return fetch('/fm/prop_update_entry', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    c_type: 'detail',
                    prop_id: this.data.propId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.data.propData = data.data;
                    console.log('ğŸ¢ ì‚¬ì—…ì¥ ì •ë³´ ë¡œë“œ ì™„ë£Œ:', data.data);
                    this.fillForm(data.data);
                } else {
                    throw new Error(data.message || 'ì‚¬ì—…ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            });
        },
        
        // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        fillForm: function(propData) {
            // ê¸°ë³¸ ì •ë³´ í‘œì‹œ
            this.setElementValue('prop_id', propData.prop_id);
            this.setElementValue('prop_id_display', propData.prop_id);
            this.setElementValue('prop_name_display', propData.prop_name);
            
            // ì œëª© ì—…ë°ì´íŠ¸
            const titleDisplay = document.getElementById('prop-id-display');
            if (titleDisplay) {
                titleDisplay.textContent = `(${propData.prop_id})`;
            }
            
            // ìˆ˜ì • ê°€ëŠ¥í•œ í•„ë“œë“¤
            this.setElementValue('city_id', propData.city_id);
            this.setElementValue('use1', propData.use1);
            this.setElementValue('address1', propData.address1);
            this.setElementValue('contact1', propData.contact1);
            this.setElementValue('phone', propData.phone);
            this.setElementValue('overdue_monthly_rate', propData.overdue_monthly_rate);
            this.setElementValue('overdue_daily_rate', propData.overdue_daily_rate);
            this.setElementValue('description', propData.description);
            this.setElementValue('bl_cnt', propData.bl_cnt || 0);
            
            console.log('ğŸ¢ í¼ ë°ì´í„° ì±„ìš°ê¸° ì™„ë£Œ');
        },
        
        // í—¬í¼ í•¨ìˆ˜: ìš”ì†Œ ê°’ ì„¤ì •
        setElementValue: function(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.value = value || '';
            }
        },
        
        // í™”ë©´ í‘œì‹œ ì œì–´
        showLoading: function() {
            document.getElementById('loading-section').style.display = 'block';
            document.getElementById('error-section').style.display = 'none';
            document.getElementById('form-section').style.display = 'none';
        },
        
        showError: function(message) {
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('error-section').style.display = 'block';
            document.getElementById('form-section').style.display = 'none';
            
            const errorText = document.getElementById('error-message-text');
            if (errorText) {
                errorText.textContent = message;
            }
        },
        
        showForm: function() {
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('error-section').style.display = 'none';
            document.getElementById('form-section').style.display = 'block';
        },
        
        // í¼ ì œì¶œ
        submitForm: function() {
            console.log('ğŸ¢ ì‚¬ì—…ì¥ ìˆ˜ì • ì‹œì‘');
            
            // í¼ ë°ì´í„° ìˆ˜ì§‘
            const formData = new FormData(document.getElementById('prop-update-form'));
            const data = Object.fromEntries(formData.entries());
            
            console.log('ğŸ¢ ìˆ˜ì •í•  ë°ì´í„°:', data);
            
            // ë¡œë”© í‘œì‹œ
            const submitBtn = document.querySelector('.btn-submit');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'ìˆ˜ì • ì¤‘...';
            submitBtn.disabled = true;
            
            // ì„œë²„ì— ìˆ˜ì • ìš”ì²­
            fetch('/fm/prop_update_entry', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    c_type: 'save',
                    ...data
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('ì‚¬ì—…ì¥ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // ìˆ˜ì • ì„±ê³µ í›„ ëª©ë¡ìœ¼ë¡œ ì´ë™
                    this.goToPropList();
                } else {
                    alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message);
                    
                    // ë²„íŠ¼ ë³µì›
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            })
            .catch(error => {
                alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error('ğŸ¢ ìˆ˜ì • ì˜¤ë¥˜:', error);
                
                // ë²„íŠ¼ ë³µì›
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        },
        
        // ë’¤ë¡œ ê°€ê¸°
        goBack: function() {
            this.goToPropList();
        },
        
        // ë‹¤ì‹œ ì‹œë„
        retry: function() {
            this.data.isLoading = false;
            this.loadPropData();
        },
        
        // ğŸ†• HiddenFrame: ì‚¬ì—…ì¥ ëª©ë¡ìœ¼ë¡œ ì´ë™
        goToPropList: function() {
            // ì„ íƒëœ ì‚¬ì—…ì¥ ì •ë³´ ì´ˆê¸°í™”
            window.selected_prop_id = null;
            
            // prop_list íƒ­ìœ¼ë¡œ ì´ë™
            if (typeof window.loadContent === 'function') {
                window.loadContent('/fm/prop_list.html', 'ğŸ¢ ì‚¬ì—…ì¥ì •ë³´');
                window.showStatus && window.showStatus('ì‚¬ì—…ì¥ ëª©ë¡ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.');
            } else {
                console.error('ğŸ¢ loadContent í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
    };
    
    // ì „ì—­ ì´ˆê¸°í™” í•¨ìˆ˜ ë“±ë¡
    window.initPropUpdatePage = function() {
        window.PropUpdateModule.init();
    };
    
    // ğŸ†• HiddenFrame: ìë™ ì´ˆê¸°í™” (ì¦‰ì‹œ ì‹¤í–‰)
    setTimeout(() => {
        if (!window.PropUpdateModule.data.isInitialized) {
            console.log('ğŸ¢ ìë™ ì´ˆê¸°í™” ì‹œì‘ (HiddenFrame)');
            window.PropUpdateModule.init();
        }
    }, 500);
    
    console.log('ğŸ¢ PropUpdateModule ë¡œë“œ ì™„ë£Œ (HiddenFrame)');
    
})(); // ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ ë
</script>