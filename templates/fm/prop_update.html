<!-- SPA íƒ­ìš© ì‚¬ì—…ì¥ìˆ˜ì • í˜ì´ì§€ -->
<link rel="stylesheet" href="/static/css/common.css">
<style>
    /* ì‚¬ì—…ì¥ìˆ˜ì • í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
    .prop-update-layout {
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 20px;
        margin-top: 20px;
    }
    
    .prop-info-section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .history-section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .history-row { 
        cursor: pointer; 
        transition: background-color 0.15s ease-in-out;
    }
    
    .history-row:hover { 
        background-color: #f0f7fc !important; 
    }
    
    .history-row.selected { 
        background-color: #e3f2fd !important; 
        border-left: 3px solid #007bff;
    }
    
    .history-count-info {
        margin-bottom: 10px;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 13px;
        color: #495057;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .prop-detail-placeholder {
        text-align: center; 
        line-height: 300px; 
        color: #6c757d;
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        font-size: 14px;
    }
    
    .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
        font-style: italic;
    }
    
    .tab-loading {
        text-align: center; 
        padding: 50px; 
        color: #6c757d;
    }
    
    .tab-error {
        text-align: center; 
        padding: 50px; 
        color: #dc3545;
    }
    
    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .upload-area:hover {
        border-color: #007bff;
        background: #e3f2fd;
    }
    
    .upload-area.dragover {
        border-color: #007bff;
        background: #e3f2fd;
        transform: scale(1.02);
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .form-grid.full-width {
        grid-template-columns: 1fr;
    }
    
    @media (max-width: 992px) {
        .prop-update-layout {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .history-count-info {
            flex-direction: column;
            gap: 5px;
            text-align: center;
        }
        
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
    
    @media (max-width: 768px) {
        .prop-info-section,
        .history-section {
            padding: 10px;
        }
        
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .data-table {
            min-width: 600px;
        }
    }
</style>

<div id="prop-update-container">
    <h2>ğŸ—ï¸ ì‚¬ì—…ì¥ì •ë³´ ìˆ˜ì •</h2>

    <div class="prop-update-layout">
        <!-- ì‚¬ì—…ì¥ ì •ë³´ ìˆ˜ì • -->
        <div class="prop-info-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4>ğŸ“ ê¸°ë³¸ ì •ë³´</h4>
                <div>
                    <button type="button" class="btn btn-primary" onclick="savePropData()">ì €ì¥</button>
                    <button type="button" class="btn btn-secondary" onclick="goToPropList()">ëª©ë¡</button>
                </div>
            </div>

            <form id="prop-update-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>ì‚¬ì—…ì¥:</label>
                        <input type="text" id="prop_name" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>ì§€ì—­:</label>
                        <input type="text" id="city_name" class="form-control" readonly>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>ìš©ë„:</label>
                        <input type="text" id="use1" name="use1" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>ë‹´ë‹¹ì:</label>
                        <input type="text" id="contact1" name="contact1" class="form-control">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>ê±´ë¬¼ìˆ˜:</label>
                        <input type="text" id="bl_cnt" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>ì—°ë½ì²˜:</label>
                        <input type="text" id="phone" name="phone" class="form-control">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>ì—°ì²´ì´ììœ¨(ì›”):</label>
                        <input type="number" id="overdue_monthly_rate" name="overdue_monthly_rate" class="form-control" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>ì—°ì²´ì´ììœ¨(ì¼):</label>
                        <input type="number" id="overdue_daily_rate" name="overdue_daily_rate" class="form-control" step="0.01">
                    </div>
                </div>

                <div class="form-grid full-width">
                    <div class="form-group">
                        <label>ì£¼ì†Œ:</label>
                        <input type="text" id="address1" name="address1" class="form-control">
                    </div>
                </div>

                <div class="form-grid full-width">
                    <div class="form-group">
                        <label>ë¹„ê³ :</label>
                        <textarea id="description" name="description" class="form-control" rows="3"></textarea>
                    </div>
                </div>
            </form>

            <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜ì—­ -->
            <div style="margin-top: 20px;">
                <h5>ğŸ“· ì´ë¯¸ì§€ ì—…ë¡œë“œ</h5>
                <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                    <p>ğŸ“ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                    <small>PNG, JPG, JPEG, GIF íŒŒì¼ë§Œ ì§€ì›ë©ë‹ˆë‹¤</small>
                </div>
                <input type="file" id="file-input" accept="image/*" multiple style="display: none;">
            </div>
        </div>

        <!-- ì´ë¯¸ì§€/ì´ë ¥ ê´€ë¦¬ -->
        <div class="history-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4>ğŸ“‚ ì´ë¯¸ì§€ ê´€ë¦¬</h4>
                <div>
                    <button type="button" class="btn btn-info" onclick="registerHistory()">ë“±ë¡</button>
                    <button type="button" class="btn btn-secondary" onclick="refreshHistory()">ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>

            <!-- ê²€ìƒ‰ í¼ -->
            <div class="search-form" style="margin-bottom: 15px;">
                <div class="form-row" style="align-items: end;">
                    <div class="form-group col-3">
                        <label>ì‹œì‘ì¼:</label>
                        <input type="date" id="start_date" class="form-control">
                    </div>
                    <div class="form-group col-3">
                        <label>ì¢…ë£Œì¼:</label>
                        <input type="date" id="end_date" class="form-control">
                    </div>
                    <div class="form-group col-4">
                        <label>ê²€ìƒ‰ì–´:</label>
                        <input type="text" id="history_keyword" class="form-control" onkeypress="if(event.keyCode==13) searchHistory()" placeholder="ì œëª©, ë“±ë¡ì ë“±">
                    </div>
                    <div class="form-group col-2">
                        <button type="button" class="btn btn-primary" onclick="searchHistory()">ê²€ìƒ‰</button>
                    </div>
                </div>
            </div>

            <div class="history-count-info">
                <span id="history-count-text">ì´ 0ê±´</span>
                <span id="history-page-text">1 / 1 í˜ì´ì§€</span>
            </div>

            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th onclick="sortBy('auto_number')">ë²ˆí˜¸ â†•</th>
                            <th onclick="sortBy('title')">ì œëª© â†•</th>
                            <th onclick="sortBy('em_name')">ë“±ë¡ì â†•</th>
                            <th onclick="sortBy('reg_date')">ë“±ë¡ì¼ â†•</th>
                            <th onclick="sortBy('file')">íŒŒì¼ â†•</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                        <tr><td colspan="5" class="text-center">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- í˜ì´ì§• -->
            <div class="pagination" id="history-pagination">
                <button onclick="changePage(1)" id="btn-first">ì²˜ìŒ</button>
                <button onclick="changePage(currentPage-1)" id="btn-prev">â—€ ì´ì „</button>
                <span id="page-info">1 / 1</span>
                <button onclick="changePage(currentPage+1)" id="btn-next">ë‹¤ìŒ â–¶</button>
                <button onclick="changePage(totalPages)" id="btn-last">ë§ˆì§€ë§‰</button>
            </div>
        </div>
    </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜
console.log('ğŸ—ï¸ prop_update.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');

let selectedHistoryId = null;
let currentSort = { field: 'auto_number', direction: 'desc' };
let currentPage = 1;
let totalPages = 1;
let totalCount = 0;
let searchParams = {
    prop_id: '',
    keyword: '',
    start_date: '',
    end_date: '',
    order: 'auto_number',
    desc: 'desc',
    page_no: 1
};

// ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ í”Œë˜ê·¸
let isPropUpdatePageInitialized = false;

// í˜ì´ì§€ ì´ˆê¸°í™”
function initPropUpdatePage() {
    console.log('ğŸ—ï¸ ì‚¬ì—…ì¥ìˆ˜ì • í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
    
    // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (isPropUpdatePageInitialized) {
        console.log('ğŸ—ï¸ ì´ë¯¸ ì´ˆê¸°í™”ë¨, ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€');
        return;
    }
    
    // ì„ íƒëœ ì‚¬ì—…ì¥ í™•ì¸
    if (!window.selected_prop_id) {
        console.log('ğŸ—ï¸ ì„ íƒëœ ì‚¬ì—…ì¥ì´ ì—†ì–´ì„œ ë¹ˆ í¼ í‘œì‹œ');
        initializeEmptyForm();
        return;
    }
    
    // ì´ˆê¸°í™” í”Œë˜ê·¸ ì„¤ì •
    isPropUpdatePageInitialized = true;
    
    console.log('ğŸ—ï¸ ë°›ì€ ë°ì´í„°:', { prop_id: window.selected_prop_id });
    
    // ê²€ìƒ‰ íŒŒë¼ë¯¸í„°ì— ì„¤ì •
    searchParams.prop_id = window.selected_prop_id;
    
    // ë‚ ì§œ ì„¤ì •
    setDefaultDates();
    
    // ì‚¬ì—…ì¥ ì •ë³´ ë¡œë“œ
    loadPropInfo();
    
    // ì´ë ¥ ëª©ë¡ ë¡œë“œ
    setTimeout(() => {
        console.log('ğŸ—ï¸ ì´ë ¥ ê²€ìƒ‰ ì‹¤í–‰ ì‹œì‘');
        searchHistory();
    }, 500);
    
    // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì´ˆê¸°í™”
    initializeImageUpload();
}

// ì‚¬ì—…ì¥ ë³€ê²½ ê°ì§€ (ì „ì—­ í•¨ìˆ˜)
window.onPropUpdatePagePropChange = function(newPropId) {
    console.log('ğŸ—ï¸ ì‚¬ì—…ì¥ ë³€ê²½ ê°ì§€:', newPropId);
    
    if (!newPropId) {
        console.warn('ğŸ—ï¸ ìƒˆë¡œìš´ prop_idê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ì´ˆê¸°í™” í”Œë˜ê·¸ ë¦¬ì…‹
    isPropUpdatePageInitialized = false;
    
    searchParams.prop_id = newPropId;
    window.selected_prop_id = newPropId;
    
    // ì„ íƒëœ ì´ë ¥ ì´ˆê¸°í™”
    selectedHistoryId = null;
    
    // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
    loadPropInfo();
    setDefaultDates();
    
    setTimeout(() => {
        console.log('ğŸ—ï¸ ì‚¬ì—…ì¥ ë³€ê²½ í›„ ì´ë ¥ ê²€ìƒ‰ ì‹¤í–‰');
        searchHistory();
    }, 300);
};

// ë¹ˆ í¼ ì´ˆê¸°í™”
function initializeEmptyForm() {
    // ìƒë‹¨ ì…ë ¥ í•„ë“œë“¤ ì´ˆê¸°í™”
    document.getElementById('prop_name').value = '';
    document.getElementById('city_name').value = '';
    document.getElementById('use1').value = '';
    document.getElementById('contact1').value = '';
    document.getElementById('bl_cnt').value = '0';
    document.getElementById('phone').value = '';
    document.getElementById('overdue_monthly_rate').value = '';
    document.getElementById('overdue_daily_rate').value = '';
    document.getElementById('address1').value = '';
    document.getElementById('description').value = '';

    // í•˜ë‹¨ ëª©ë¡ ì´ˆê¸°í™”
    const tbody = document.getElementById('history-table-body');
    tbody.innerHTML = '<tr><td colspan="5" class="text-center">ì‚¬ì—…ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</td></tr>';
    
    setDefaultDates();
}

// ê¸°ë³¸ ë‚ ì§œ ì„¤ì •
function setDefaultDates() {
    const today = new Date();
    const startDate = new Date('2009-01-01');
    
    document.getElementById('start_date').value = startDate.toISOString().split('T')[0];
    document.getElementById('end_date').value = today.toISOString().split('T')[0];
}

// ì‚¬ì—…ì¥ ì •ë³´ ë¡œë“œ
function loadPropInfo() {
    if (!window.selected_prop_id) {
        console.warn('ğŸ—ï¸ ì„ íƒëœ ì‚¬ì—…ì¥ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
        initializeEmptyForm();
        return;
    }

    console.log('ğŸ—ï¸ ì‚¬ì—…ì¥ ì •ë³´ ë¡œë“œ, prop_id:', window.selected_prop_id);

    fetch('/fm/prop_update_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            c_type: 'detail', 
            prop_id: window.selected_prop_id 
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('ğŸ—ï¸ ì‚¬ì—…ì¥ ì •ë³´ ì‘ë‹µ:', data);
        
        if (data.success && data.data) {
            const info = data.data;

            // ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ ê´„í˜¸ì™€ í•¨ê»˜ í‘œì‹œ
            const propDisplay = info.prop_name ? `${info.prop_name} (${info.prop_id})` : '';
            const cityDisplay = info.city_name ? `${info.city_name} (${info.city_id})` : '';

            document.getElementById('prop_name').value = propDisplay;
            document.getElementById('city_name').value = cityDisplay;
            document.getElementById('use1').value = info.use1 || '';
            document.getElementById('contact1').value = info.contact1 || '';
            document.getElementById('bl_cnt').value = info.bl_cnt || '';
            document.getElementById('phone').value = info.phone || '';
            document.getElementById('overdue_monthly_rate').value = info.overdue_monthly_rate || '';
            document.getElementById('overdue_daily_rate').value = info.overdue_daily_rate || '';
            document.getElementById('address1').value = info.address1 || '';
            document.getElementById('description').value = info.description || '';
            
            console.log('ğŸ—ï¸ ì‚¬ì—…ì¥ ì •ë³´ ì„¤ì • ì™„ë£Œ');
        } else {
            console.log('ğŸ—ï¸ ì‚¬ì—…ì¥ ì •ë³´ ì‘ë‹µì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            initializeEmptyForm();
        }
    })
    .catch(error => {
        console.error('ğŸ—ï¸ ì‚¬ì—…ì¥ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
        initializeEmptyForm();
    });
}

// ì´ë ¥ ê²€ìƒ‰
function searchHistory() {
    console.log('ğŸ—ï¸ ì´ë ¥ ê²€ìƒ‰ ì‹¤í–‰ ì‹œì‘');
    
    if (!searchParams.prop_id) {
        console.warn('ğŸ—ï¸ prop_idê°€ ì—†ìŠµë‹ˆë‹¤.');
        const tbody = document.getElementById('history-table-body');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">ì‚¬ì—…ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</td></tr>';
        return;
    }
    
    // ê²€ìƒ‰ ì¡°ê±´ ìˆ˜ì§‘
    searchParams = {
        prop_id: searchParams.prop_id,
        keyword: document.getElementById('history_keyword').value,
        start_date: document.getElementById('start_date').value,
        end_date: document.getElementById('end_date').value,
        order: currentSort.field,
        desc: currentSort.direction,
        page_no: currentPage
    };

    console.log('ğŸ—ï¸ ìµœì¢… ê²€ìƒ‰ íŒŒë¼ë¯¸í„°:', searchParams);

    // ë¡œë”© í‘œì‹œ
    document.getElementById('history-table-body').innerHTML = 
        '<tr><td colspan="5" class="text-center">ê²€ìƒ‰ ì¤‘...</td></tr>';

    // AJAX ìš”ì²­
    fetch('/fm/prop_update_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            c_type: 'history',
            ...searchParams
        })
    })
    .then(response => {
        console.log('ğŸ—ï¸ ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('ğŸ—ï¸ ì„œë²„ ì‘ë‹µ ë°ì´í„°:', data);
        
        if (data.success) {
            console.log('ğŸ—ï¸ ì´ë ¥ ë°ì´í„° ìˆ˜ì‹  ì„±ê³µ, ê±´ìˆ˜:', data.data.length);
            renderHistoryList(data.data, data.default_photo_t);
            updatePagination(data.total_count, data.total_pages, data.current_page);
        } else {
            console.error('ğŸ—ï¸ ê²€ìƒ‰ ì‹¤íŒ¨:', data.message);
            document.getElementById('history-table-body').innerHTML = 
                '<tr><td colspan="5" class="text-center text-danger">ê²€ìƒ‰ ì‹¤íŒ¨: ' + data.message + '</td></tr>';
        }
    })
    .catch(error => {
        console.error('ğŸ—ï¸ ì´ë ¥ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        document.getElementById('history-table-body').innerHTML = 
            '<tr><td colspan="5" class="text-center text-danger">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</td></tr>';
    });
}

// ì´ë ¥ ëª©ë¡ ë Œë”ë§
function renderHistoryList(history, defaultPhotoT) {
    const tbody = document.getElementById('history-table-body');
    
    if (history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }

    let html = '';
    history.forEach(item => {
        // ê¸°ë³¸ ì‚¬ì§„ í‘œì‹œ
        let titleDisplay = item.title || '';
        if (item.maskname === defaultPhotoT) {
            titleDisplay = `â˜… ê¸°ë³¸ì‚¬ì§„ - ${titleDisplay}`;
        }
        
        html += `
            <tr class="history-row" onclick="selectHistory('${item.auto_number}', this)">
                <td>${item.auto_number || ''}</td>
                <td>${titleDisplay}</td>
                <td>${item.em_name || ''}</td>
                <td>${item.reg_date || ''}</td>
                <td>ë³´ê¸°</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// í˜ì´ì§• ì •ë³´ ì—…ë°ì´íŠ¸
function updatePagination(total, pages, current) {
    totalCount = total;
    totalPages = pages;
    currentPage = current;

    // ì¹´ìš´íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
    document.getElementById('history-count-text').textContent = `ì´ ${total}ê±´`;
    document.getElementById('history-page-text').textContent = `${current} / ${pages} í˜ì´ì§€`;
    document.getElementById('page-info').textContent = `${current} / ${pages}`;

    // í˜ì´ì§• ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    document.getElementById('btn-first').disabled = current <= 1;
    document.getElementById('btn-prev').disabled = current <= 1;
    document.getElementById('btn-next').disabled = current >= pages;
    document.getElementById('btn-last').disabled = current >= pages;
}

// ì´ë ¥ ì„ íƒ
function selectHistory(historyId, element) {
    // ê¸°ì¡´ ì„ íƒ ì œê±°
    document.querySelectorAll('.history-row').forEach(row => {
        row.classList.remove('selected');
    });
    
    // ìƒˆë¡œ ì„ íƒ
    element.classList.add('selected');
    selectedHistoryId = historyId;
    
    console.log('ğŸ—ï¸ ì„ íƒëœ ì´ë ¥:', historyId);
}

// ì •ë ¬
function sortBy(field) {
    if (currentSort.field === field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.field = field;
        currentSort.direction = 'asc';
    }
    
    currentPage = 1; // ì •ë ¬ ì‹œ ì²« í˜ì´ì§€ë¡œ
    searchHistory();
}

// í˜ì´ì§€ ë³€ê²½
function changePage(pageNo) {
    if (pageNo < 1 || pageNo > totalPages) return;
    currentPage = pageNo;
    searchHistory();
}

// ì‚¬ì—…ì¥ ì •ë³´ ì €ì¥
function savePropData() {
    if (!window.selected_prop_id) {
        alert('ì‚¬ì—…ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    // í¼ ë°ì´í„° ìˆ˜ì§‘
    const formData = new FormData(document.getElementById('prop-update-form'));
    const data = Object.fromEntries(formData.entries());
    data.prop_id = window.selected_prop_id;

    // ì„œë²„ì— ì €ì¥ ìš”ì²­
    fetch('/fm/prop_update_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            c_type: 'save',
            ...data
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadPropInfo(); // ì •ë³´ ìƒˆë¡œê³ ì¹¨
        } else {
            alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message);
        }
    })
    .catch(error => {
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        console.error('ì €ì¥ ì˜¤ë¥˜:', error);
    });
}

// ì´ë¯¸ì§€ ì—…ë¡œë“œ ì´ˆê¸°í™”
function initializeImageUpload() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        handleFileUpload(files);
    });

    // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
    fileInput.addEventListener('change', (e) => {
        const files = e.target.files;
        handleFileUpload(files);
        fileInput.value = ''; // ì´ˆê¸°í™”
    });
}

// íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
function handleFileUpload(files) {
    if (!window.selected_prop_id) {
        alert('ì‚¬ì—…ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    if (files.length === 0) return;

    const formData = new FormData();
    formData.append('prop_id', window.selected_prop_id);

    for (let file of files) {
        formData.append('images[]', file);
    }

    fetch('/fm/upload_images', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            searchHistory(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
            alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message);
        }
    })
    .catch(error => {
        alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
    });
}

// ëª©ë¡ìœ¼ë¡œ ì´ë™
function goToPropList() {
    // ì„ íƒëœ ì‚¬ì—…ì¥ ì •ë³´ ì´ˆê¸°í™”
    window.selected_prop_id = null;
    
    // prop_list íƒ­ìœ¼ë¡œ ì´ë™
    if (typeof window.loadContent === 'function') {
        window.loadContent('/fm/prop_list.html', 'ì‚¬ì—…ì¥ì •ë³´');
        window.showStatus('ì‚¬ì—…ì¥ ëª©ë¡ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.');
    } else {
        console.error('ğŸ—ï¸ loadContent í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
}

// ì´ë ¥ ë“±ë¡
function registerHistory() {
    if (window.showStatus) {
        window.showStatus('ì´ë ¥ ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    } else {
        alert('ì´ë ¥ ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    }
}

// ìƒˆë¡œê³ ì¹¨
function refreshHistory() {
    searchHistory();
}

// í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤í–‰
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ—ï¸ prop_update DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
    
    // base.html ë°ì´í„° í™•ì¸ í•¨ìˆ˜
    function checkBaseData() {
        const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
        
        console.log('ğŸ—ï¸ base.html ë°ì´í„° í™•ì¸ ê²°ê³¼:', { em_id, selected_prop_id: window.selected_prop_id });
        
        if (em_id && !isPropUpdatePageInitialized) {
            console.log('ğŸ—ï¸ âœ… base.html ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘');
            initPropUpdatePage();
            return true;
        }
        
        return false;
    }
    
    // ì¦‰ì‹œ í™•ì¸
    if (checkBaseData()) {
        return;
    }
    
    console.log('ğŸ—ï¸ ë°ì´í„° ëŒ€ê¸° ì‹œì‘...');
    
    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ëŒ€ê¸°
    const checkUserInfo = setInterval(() => {
        if (checkBaseData()) {
            clearInterval(checkUserInfo);
        }
    }, 200);
    
    // 5ì´ˆ í›„ íƒ€ì„ì•„ì›ƒ
    setTimeout(() => {
        clearInterval(checkUserInfo);
        if (!isPropUpdatePageInitialized) {
            console.error('ğŸ—ï¸ 5ì´ˆ ëŒ€ê¸° í›„ì—ë„ base.html ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í•¨');
            initializeEmptyForm();
        }
    }, 5000);
});

// ì´ˆê¸°í™” í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (íƒ­ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
window.initPropUpdatePage = initPropUpdatePage;
window.searchHistory = searchHistory;

// ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í™•ì¸
console.log('ğŸ—ï¸ prop_update.html ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
console.log('ğŸ—ï¸ initPropUpdatePage í•¨ìˆ˜ ì¡´ì¬:', typeof initPropUpdatePage);
</script>