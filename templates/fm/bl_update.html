<!-- SPA íƒ­ìš© ê±´ë¬¼ìˆ˜ì • í˜ì´ì§€ -->
<link rel="stylesheet" href="/static/css/common.css">
<style>
    /* bl_update ìŠ¤íƒ€ì¼ - ë‹¤ë¥¸ í˜ì´ì§€ì™€ ì¼ê´€ì„± ë§ì¶¤ */
    #bl_update_outer {
        padding: 20px;
        padding-bottom: 0;
        overflow-y: auto;
        background-color: #f8f9fa;
        font-size: 12px;
    }

    #bl_update_outer .button-area {
        text-align: right;
        margin-bottom: 15px;
        padding: 15px;
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    #bl_update_outer .button-area button {
        margin-left: 5px;
        padding: 6px 12px;
        background: #fff;
        color: #333;
        border: 1px solid #ced4da;
        font-size: 12px;
        font-family: inherit;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s ease-in-out;
    }

    #bl_update_outer .button-area button:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
    }

    #bl_update_outer .button-area button.btn-primary {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }

    #bl_update_outer .button-area button.btn-primary:hover {
        background: #0056b3;
        border-color: #004085;
    }

    #bl_update_outer .selection-area {
        margin-bottom: 15px;
    }

    #bl_update_outer .selection-area .table {
        margin-bottom: 0;
        background-color: white;
        border-collapse: collapse;
        font-size: 12px;
    }

    #bl_update_outer .selection-area .table td {
        padding: 8px;
        border: 1px solid #dee2e6;
        vertical-align: middle;
    }

    #bl_update_outer .selection-area .table-header {
        background-color: #f8f9fa;
        font-weight: bold;
        text-align: center;
        width: 10%;
    }

    #bl_update_outer .tab-area {
        margin-bottom: 15px;
    }

    #bl_update_outer .tab-area .nav-tabs {
        border-bottom: 1px solid #dee2e6;
        background-color: white;
        display: flex;
        margin: 0;
        padding: 0;
        list-style: none;
    }

    #bl_update_outer .tab-area .nav-link {
        font-size: 13px;
        font-weight: 500;
        color: #666;
        padding: 10px 16px;
        cursor: pointer;
        border: none;
        border-bottom: 2px solid transparent;
        background-color: #f8f9fa;
        margin-right: 2px;
        border-radius: 4px 4px 0 0;
        text-decoration: none;
        display: block;
        transition: all 0.15s ease-in-out;
    }

    #bl_update_outer .tab-area .nav-link:hover {
        background-color: #e9ecef;
        border-color: transparent;
    }

    #bl_update_outer .tab-area .nav-link.active {
        color: #495057;
        background-color: white;
        border-color: #007bff;
        font-weight: bold;
    }

    #bl_update_outer .content-area {
        background-color: white;
        border-radius: 5px;
        border: 1px solid #dee2e6;
        min-height: 500px;
    }

    #bl_update_outer .tab-content {
        display: none;
        padding: 20px;
    }

    #bl_update_outer .tab-content.active {
        display: block;
    }

    #bl_update_outer .form-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        font-size: 12px;
    }

    #bl_update_outer .form-table td {
        padding: 8px;
        border: 1px solid #dee2e6;
        vertical-align: middle;
    }

    #bl_update_outer .form-table .label {
        background-color: #f8f9fa;
        font-weight: bold;
        text-align: center;
        width: 12%;
        min-width: 80px;
    }

    #bl_update_outer .form-table input,
    #bl_update_outer .form-table select,
    #bl_update_outer .form-table textarea {
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 4px 6px;
        font-size: 12px;
        width: 100%;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    #bl_update_outer .form-table input:focus,
    #bl_update_outer .form-table select:focus,
    #bl_update_outer .form-table textarea:focus {
        border-color: #007bff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    #bl_update_outer .form-table .text-right {
        text-align: right;
    }

    #bl_update_outer .form-table input[readonly] {
        background-color: #e9ecef;
    }

    #bl_update_outer .form-table label {
        margin-right: 8px;
        margin-bottom: 0;
        font-weight: normal;
        font-size: 12px;
    }

    #bl_update_outer .form-table input[type="radio"] {
        width: auto;
        margin-right: 4px;
    }

    /* ì´ë ¥/ì‚¬ì§„ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
    #bl_update_outer .search-area {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
        flex-wrap: wrap;
    }

    #bl_update_outer .search-area select,
    #bl_update_outer .search-area input {
        padding: 4px 8px;
        border: 1px solid #ced4da;
        font-size: 12px;
        border-radius: 4px;
    }

    #bl_update_outer .search-area select {
        width: 120px;
    }

    #bl_update_outer .search-area input[type="date"] {
        width: 120px;
    }

    #bl_update_outer .search-area input[type="text"] {
        width: 150px;
    }

    #bl_update_outer .search-area button {
        padding: 4px 12px;
        background: #fff;
        color: #333;
        border: 1px solid #ced4da;
        font-size: 12px;
        border-radius: 4px;
        cursor: pointer;
    }

    #bl_update_outer .search-area button:hover {
        background: #e9ecef;
    }

    #bl_update_outer .data-table {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        overflow: hidden;
        margin-bottom: 15px;
    }

    #bl_update_outer .data-table .table {
        margin-bottom: 0;
        border-collapse: collapse;
        width: 100%;
        font-size: 12px;
    }

    #bl_update_outer .data-table .table th {
        background-color: #f8f9fa;
        font-weight: bold;
        text-align: center;
        vertical-align: middle;
        border: 1px solid #dee2e6;
        padding: 8px;
    }

    #bl_update_outer .data-table .table td {
        vertical-align: middle;
        border: 1px solid #dee2e6;
        padding: 8px;
        cursor: pointer;
    }

    #bl_update_outer .data-table .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    #bl_update_outer .data-table .table tbody tr.table-active {
        background-color: #e3f2fd;
        border-left: 3px solid #2196f3;
    }

    #bl_update_outer .photo-viewer {
        position: fixed;
        right: 20px;
        top: 120px;
        width: 300px;
        height: 400px;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 15px;
        display: flex;
        flex-direction: column;
        z-index: 1000;
    }

    #bl_update_outer .photo-title {
        font-weight: bold;
        margin-bottom: 10px;
        text-align: center;
        color: #495057;
        font-size: 13px;
    }

    #bl_update_outer .photo-display {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        overflow: hidden;
    }

    #bl_update_outer .photo-display img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    #bl_update_outer .photo-controls {
        text-align: center;
    }

    #bl_update_outer .photo-controls button {
        margin: 0 4px;
        padding: 4px 8px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
    }

    #bl_update_outer .photo-controls button:hover {
        background-color: #0056b3;
    }

    .main-photo-indicator {
        color: #dc3545;
        font-weight: bold;
        font-size: 11px;
    }

    /* ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ */
    .error-message {
        background-color: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        border: 1px solid #f5c6cb;
        font-size: 12px;
    }

    .success-message {
        background-color: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        border: 1px solid #c3e6cb;
        font-size: 12px;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 1200px) {
        #bl_update_outer .photo-viewer {
            position: relative;
            right: auto;
            top: auto;
            width: 100%;
            height: 300px;
            margin-top: 15px;
        }
    }

    @media (max-width: 768px) {
        #bl_update_outer {
            padding: 10px;
        }
        
        #bl_update_outer .search-area {
            flex-direction: column;
            align-items: stretch;
        }
        
        #bl_update_outer .search-area select,
        #bl_update_outer .search-area input {
            width: 100%;
            margin-bottom: 5px;
        }
    }
</style>

<div id="bl_update_outer">
    <!-- ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ -->
    <div class="button-area">
        <button type="button" id="btn_delete_photo" onclick="BlUpdateModule.deleteMainPhoto()">ë©”ì¸ì‚¬ì§„ì‚­ì œ</button>
        <button type="button" id="btn_print" onclick="BlUpdateModule.printBl()">ì¸ì‡„</button>
        <button type="button" id="btn_save" class="btn-primary" onclick="BlUpdateModule.saveBlData()">ì €ì¥</button>
        <button type="button" id="btn_excel" onclick="BlUpdateModule.exportExcel()">ì—‘ì…€ì €ì¥</button>
        <button type="button" id="btn_list" onclick="BlUpdateModule.goToBlList()">ëª©ë¡ë³´ê¸°</button>
    </div>

    <!-- ì‚¬ì—…ì¥/ê±´ë¬¼ ì„ íƒ ì˜ì—­ -->
    <div class="selection-area">
        <table class="table">
            <tr>
                <td class="table-header">ì‚¬ì—…ì¥</td>
                <td id="prop_info">ë¡œë”© ì¤‘...</td>
                <td class="table-header">ê±´ë¬¼</td>
                <td>
                    <select id="bl_select" onchange="BlUpdateModule.changeBlSelection()">
                        <option value="">--ê±´ë¬¼ì„ íƒ--</option>
                    </select>
                </td>
            </tr>
        </table>
    </div>

    <!-- íƒ­ ì˜ì—­ -->
    <div class="tab-area">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-tab="1" onclick="BlUpdateModule.showTab(1, this)">ê±´ë¬¼ê°œìš”</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-tab="2" onclick="BlUpdateModule.showTab(2, this)">ê¸°íƒ€ì •ë³´</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-tab="3" onclick="BlUpdateModule.showTab(3, this)">ê±´ë¬¼ì´ë ¥</a>
            </li>
        </ul>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
    <div class="content-area">
        <!-- íƒ­ 1: ê±´ë¬¼ê°œìš” -->
        <div id="tab1_content" class="tab-content active">
            <table class="form-table">
                <tr>
                    <td class="label">ê±´ë¬¼ëª…</td>
                    <td><input type="text" id="name"></td>
                    <td class="label">ì†Œìœ ì£¼</td>
                    <td><input type="text" id="landlord"></td>
                </tr>
                <tr>
                    <td class="label">ì„¤ê³„ì</td>
                    <td><input type="text" id="design"></td>
                    <td class="label">ì‹œê³µì‚¬</td>
                    <td><input type="text" id="builder"></td>
                </tr>
                <tr>
                    <td class="label">ì†Œì¬ì§€</td>
                    <td colspan="3"><input type="text" id="address1"></td>
                </tr>
                <tr>
                    <td class="label">ì—°ë©´ì (ã¡)</td>
                    <td>
                        <input type="text" id="area_total" class="text-right" onkeyup="BlUpdateModule.calculatePyeong()"> ã¡
                        <input type="text" id="area_total_pyeong" class="text-right" readonly> í‰
                    </td>
                    <td class="label">ì§€ëª©</td>
                    <td><input type="text" id="class_land"></td>
                </tr>
                <tr>
                    <td class="label">ì§€ì—­</td>
                    <td><input type="text" id="district"></td>
                    <td class="label">ì§€êµ¬</td>
                    <td><input type="text" id="section"></td>
                </tr>
                <tr>
                    <td class="label">ê±´ì¶•ë©´ì </td>
                    <td><input type="text" id="area_bl" class="text-right"> ã¡</td>
                    <td class="label">ëŒ€ì§€ë©´ì </td>
                    <td><input type="text" id="parcel" class="text-right"> ã¡</td>
                </tr>
                <tr>
                    <td class="label">ê±´íìœ¨</td>
                    <td><input type="text" id="bl_to_land_ratio" class="text-right"> %</td>
                    <td class="label">ì „ìš©ìœ¨</td>
                    <td><input type="text" id="exclusive_ratio" class="text-right" readonly> %</td>
                </tr>
                <tr>
                    <td class="label">ìš©ì ìœ¨</td>
                    <td><input type="text" id="fl_space_index" class="text-right"> %</td>
                    <td class="label">ì „ìš©ë©´ì </td>
                    <td><input type="text" id="area_usable" class="text-right"> ã¡</td>
                </tr>
                <tr>
                    <td class="label">ê±´ì¶•êµ¬ì¡°</td>
                    <td><input type="text" id="construction_type"></td>
                    <td class="label">ì§€ë¶•í˜•íƒœ</td>
                    <td><input type="text" id="roof_type"></td>
                </tr>
                <tr>
                    <td class="label">ì¸µìˆ˜<br>ì§€ìƒ/ì§€í•˜</td>
                    <td>
                        <input type="text" id="count_fl" class="text-right" style="width:45%; display:inline-block"> ì¸µ /
                        <input type="text" id="count_bf" class="text-right" style="width:45%; display:inline-block"> ì¸µ
                    </td>
                    <td class="label">ìµœê³ ë†’ì´<br>ì§€ìƒ/ì§€í•˜</td>
                    <td>
                        <input type="text" id="bl_height" class="text-right" style="width:45%; display:inline-block"> m /
                        <input type="text" id="bl_depth" class="text-right" style="width:45%; display:inline-block"> m
                    </td>
                </tr>
                <tr>
                    <td class="label">ì£¼ìš©ë„</td>
                    <td><input type="text" id="use1"></td>
                    <td class="label">ì¤€ê³µì¼</td>
                    <td><input type="date" id="date_bl"></td>
                </tr>
                <tr>
                    <td class="label">ì£¼ì°¨ì„¤ë¹„</td>
                    <td colspan="3"><input type="text" id="parking_type"></td>
                </tr>
                <tr>
                    <td class="label">ìŠ¹ê°•ì„¤ë¹„</td>
                    <td colspan="3"><input type="text" id="elev_type"></td>
                </tr>
                <tr>
                    <td class="label">ìˆ˜ì „ì„¤ë¹„</td>
                    <td colspan="3"><input type="text" id="elec_type"></td>
                </tr>
                <tr>
                    <td class="label">ë°œì „ì„¤ë¹„</td>
                    <td colspan="3"><input type="text" id="generator_type"></td>
                </tr>
                <tr>
                    <td class="label">ë‚œë°©ì„¤ë¹„</td>
                    <td colspan="3"><input type="text" id="heating_type"></td>
                </tr>
                <tr>
                    <td class="label">ëƒ‰ë°©ì„¤ë¹„</td>
                    <td colspan="3"><input type="text" id="cooling_type"></td>
                </tr>
                <tr>
                    <td class="label">ë‹´ë‹¹ì</td>
                    <td><input type="text" id="contact_name"></td>
                    <td class="label">ëŒ€í‘œë²ˆí˜¸</td>
                    <td><input type="text" id="contact_phone"></td>
                </tr>
                <tr>
                    <td class="label">FAX</td>
                    <td><input type="text" id="contact_fax"></td>
                    <td class="label">ìš°í¸ë²ˆí˜¸</td>
                    <td><input type="text" id="zip"></td>
                </tr>
            </table>
        </div>

        <!-- íƒ­ 2: ê¸°íƒ€ì •ë³´ -->
        <div id="tab2_content" class="tab-content">
            <table class="form-table">
                <tr>
                    <td class="label">ë“±ê¸°ì—¬ë¶€</td>
                    <td>
                        <label><input type="radio" name="regist" value="1"> ìœ </label>
                        <label><input type="radio" name="regist" value="0"> ë¬´</label>
                    </td>
                    <td class="label">ê±´ë¬¼ì·¨ë“ì¼</td>
                    <td><input type="date" id="date_buy"></td>
                </tr>
                <tr>
                    <td class="label">ëŒ€ì§€ì·¨ë“ì¼</td>
                    <td><input type="date" id="date_buy_land"></td>
                    <td class="label">ë§¤ê°ì¼ì</td>
                    <td><input type="date" id="date_sailed"></td>
                </tr>
                <tr>
                    <td class="label">ê´€ë¦¬ê°œì‹œì¼</td>
                    <td><input type="date" id="date_manage_start"></td>
                    <td class="label">ê³µì‹œì§€ê°€</td>
                    <td><input type="text" id="price_pa_land" class="text-right"> ì›</td>
                </tr>
                <tr>
                    <td class="label">ì§€ìƒì¸µë©´ì </td>
                    <td><input type="text" id="area_fl" class="text-right"> ã¡</td>
                    <td class="label">ì§€í•˜ì¸µë©´ì </td>
                    <td><input type="text" id="area_bf" class="text-right"> ã¡</td>
                </tr>
                <tr>
                    <td class="label">ì„ëŒ€ê°€ëŠ¥ë©´ì </td>
                    <td><input type="text" id="area_rentable" class="text-right"> ã¡</td>
                    <td class="label">ì¡°ê²½ë©´ì </td>
                    <td><input type="text" id="area_garden" class="text-right"> ã¡</td>
                </tr>
                <tr>
                    <td class="label">ì¥ë¶€ê°€</td>
                    <td><input type="text" id="price_book_value" class="text-right"> ì›</td>
                    <td class="label">ì„ëŒ€ê°€ í™˜ì‚°ìœ¨</td>
                    <td><input type="text" id="base_rate" class="text-right"> %</td>
                </tr>
                <tr>
                    <td class="label">4ì¸µ ì‚¬ìš©</td>
                    <td>
                        <label><input type="radio" name="use_fl_4" value="1"> ìœ </label>
                        <label><input type="radio" name="use_fl_4" value="0"> ë¬´</label>
                    </td>
                    <td class="label">13ì¸µì‚¬ìš©</td>
                    <td>
                        <label><input type="radio" name="use_fl_13" value="1"> ìœ </label>
                        <label><input type="radio" name="use_fl_13" value="0"> ë¬´</label>
                    </td>
                </tr>
                <tr>
                    <td class="label">ì „ë©´ë„ë¡œí­</td>
                    <td><input type="text" id="width_front_road" class="text-right"> m</td>
                    <td class="label">í›„ë©´ë„ë¡œí­</td>
                    <td><input type="text" id="width_back_road" class="text-right"> m</td>
                </tr>
                <tr>
                    <td class="label">ì¸¡ë©´ë„ë¡œí­</td>
                    <td><input type="text" id="width_side_road" class="text-right"> m</td>
                    <td class="label">ì˜¥ë‚´ì£¼ì°¨ëŒ€ìˆ˜</td>
                    <td><input type="text" id="parking_unit_inner" class="text-right"> ëŒ€</td>
                </tr>
                <tr>
                    <td class="label">ì˜¥íƒ‘ìœ ë¬´</td>
                    <td>
                        <label><input type="radio" name="ph" value="1"> ìœ </label>
                        <label><input type="radio" name="ph" value="0"> ë¬´</label>
                    </td>
                    <td class="label">ì˜¥ì™¸ì£¼ì°¨ëŒ€ìˆ˜</td>
                    <td><input type="text" id="parking_unit_outdoor" class="text-right"> ëŒ€</td>
                </tr>
                <tr>
                    <td class="label">E/LëŒ€ìˆ˜</td>
                    <td><input type="text" id="el_unit" class="text-right"> ëŒ€</td>
                    <td class="label">E/SëŒ€ìˆ˜</td>
                    <td><input type="text" id="es_unit" class="text-right"> ëŒ€</td>
                </tr>
                <tr>
                    <td class="label">ë¹„ê³ </td>
                    <td colspan="3"><textarea id="comments" rows="3"></textarea></td>
                </tr>
            </table>
        </div>

        <!-- íƒ­ 3: ê±´ë¬¼ì´ë ¥ -->
        <div id="tab3_content" class="tab-content">
            <div class="search-area">
                <select id="history_type" onchange="BlUpdateModule.loadHistoryData(); BlUpdateModule.toggleFileViewer();">
                    <option value="2">ì´ë ¥ê´€ë¦¬</option>
                    <option value="3">íŒŒì¼ê´€ë¦¬</option>
                </select>
                <input type="date" id="history_date_start" onchange="BlUpdateModule.loadHistoryData()">
                ~
                <input type="date" id="history_date_end" onchange="BlUpdateModule.loadHistoryData()">
                <input type="text" id="history_search" placeholder="ë“±ë¡ì,ì œëª©,ë‚´ìš©" onkeypress="if(event.keyCode==13) BlUpdateModule.loadHistoryData()">
                <button type="button" id="btn_history_search" onclick="BlUpdateModule.loadHistoryData()">ì¡°íšŒ</button>
                <button type="button" id="btn_history_register" onclick="BlUpdateModule.registerHistory()">ë“±ë¡</button>
            </div>
            
            <div style="display: flex; gap: 15px;">
                <div class="data-table" style="flex: 1;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th width="55%">ì œëª©</th>
                                <th width="15%">ë“±ë¡ì</th>
                                <th width="15%">ë“±ë¡ì¼ì</th>
                                <th width="15%">íŒŒì¼</th>
                            </tr>
                        </thead>
                        <tbody id="history_table_body">
                            <tr><td colspan="4" class="text-center">ì´ë ¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- íŒŒì¼ ë·°ì–´ ì˜ì—­ (íŒŒì¼ê´€ë¦¬ ì„ íƒì‹œì—ë§Œ í‘œì‹œ) -->
                <div id="file_viewer_area" class="photo-viewer" style="display: none; position: relative; right: auto; top: auto; width: 300px; height: 400px;">
                    <div class="photo-title" id="file_title">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
                    <div class="photo-display">
                        <div id="file_preview" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                            <div class="no-image">íŒŒì¼ ì—†ìŒ</div>
                        </div>
                    </div>
                    <!--<div class="photo-controls" style="margin-top: 10px;">
                        <button type="button" onclick="BlUpdateModule.downloadSelectedFile()">ë‹¤ìš´ë¡œë“œ</button>
                    </div>-->
                </div>
            </div>
        </div>

        <!-- íƒ­ 4: ì‚¬ì§„ -->
        <div id="tab4_content" class="tab-content">
            <div class="search-area">
                <input type="date" id="photo_date_start" onchange="BlUpdateModule.loadPhotoData()">
                ~
                <input type="date" id="photo_date_end" onchange="BlUpdateModule.loadPhotoData()">
                <input type="text" id="photo_search" placeholder="ë“±ë¡ì,ì œëª©,ë‚´ìš©" onkeypress="if(event.keyCode==13) BlUpdateModule.loadPhotoData()">
                <button type="button" id="btn_photo_search" onclick="BlUpdateModule.loadPhotoData()">ì¡°íšŒ</button>
                <button type="button" id="btn_photo_register" onclick="BlUpdateModule.registerPhoto()">ë“±ë¡</button>
            </div>
            
            <div class="data-table">
                <table class="table">
                    <thead>
                        <tr>
                            <th width="55%">ì œëª©</th>
                            <th width="15%">ë“±ë¡ì</th>
                            <th width="15%">ë“±ë¡ì¼ì</th>
                            <th width="15%">íŒŒì¼</th>
                        </tr>
                    </thead>
                    <tbody id="photo_table_body">
                        <tr><td colspan="4" class="text-center">ì‚¬ì§„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="photo-viewer">
                <div class="photo-title" id="photo_title">ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”</div>
                <div class="photo-display">
                    <img id="photo_image" src="/static/images/common/no_image.png" alt="ì‚¬ì§„">
                </div>
                <div class="photo-controls">
                    <button type="button" id="btn_prev_photo" onclick="BlUpdateModule.prevPhoto()">â—€â—€â—€</button>
                    <button type="button" id="btn_next_photo" onclick="BlUpdateModule.nextPhoto()">â–¶â–¶â–¶</button>
                </div>
            </div>
        </div>
    </div>

    <!-- íˆë“  í•„ë“œë“¤ -->
    <input type="hidden" id="current_bl_id" value="">
    <input type="hidden" id="current_prop_id" value="">
    <input type="hidden" id="current_tab" value="1">
</div>

<script>
// ğŸ›¡ï¸ ì™„ì „í•œ ìŠ¤ì½”í”„ ë¶„ë¦¬ - ë³€ìˆ˜ ì¶©ëŒ ë°©ì§€
(function() {
    'use strict';
    
    console.log('ğŸ¢ bl_update.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');
    
    // ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± - ì¤‘ë³µ ë°©ì§€
    if (typeof window.BlUpdateModule !== 'undefined') {
        console.log('ğŸ¢ ê¸°ì¡´ ëª¨ë“ˆ ì¬ì‚¬ìš©');
        return; // ì´ë¯¸ ë¡œë“œë¨
    }
    
    // ëª¨ë“ˆ ìƒì„±
    window.BlUpdateModule = {
        // ë°ì´í„° ì €ì¥ì†Œ
        data: {
            currentBlId: null,
            currentPropId: null,
            currentTab: 1,
            blList: [],
            historyData: [],
            photoData: [],
            selectedPhotoIndex: 0,
            isInitialized: false,
            hasPermission: false
        },
        
        // ì´ˆê¸°í™”
        init: function() {
            console.log('ğŸ¢ ê±´ë¬¼ìˆ˜ì • í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
            
            const new_bl_id = window.selected_bl_id;
            if (this.data.isInitialized && this.data.currentBlId === new_bl_id) {
                console.log('ğŸ¢ ë™ì¼í•œ ê±´ë¬¼ë¡œ ì´ë¯¸ ì´ˆê¸°í™”ë¨');
                return;
            }

            // ìƒˆë¡œìš´ ê±´ë¬¼ì´ë©´ ì¬ì´ˆê¸°í™”
            if (new_bl_id && this.data.currentBlId !== new_bl_id) {
                console.log('ğŸ¢ ìƒˆë¡œìš´ ê±´ë¬¼ë¡œ ì¬ì´ˆê¸°í™”:', new_bl_id);
                this.data.isInitialized = false;
                this.data.currentBlId = null;
            }
            
            const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
            const prop_id = window.currentPropId;
            const bl_id = window.selected_bl_id;
            
            console.log('ğŸ¢ ë°›ì€ ë°ì´í„°:', { em_id, prop_id, bl_id });
            
            if (!em_id) {
                console.error('ğŸ¢ em_idê°€ ì—†ìŠµë‹ˆë‹¤.');
                this.showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!prop_id) {
                console.error('ğŸ¢ prop_idê°€ ì—†ìŠµë‹ˆë‹¤.');
                this.showError('ì‚¬ì—…ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            this.data.currentPropId = prop_id;
            this.data.isInitialized = true;
            
            // ì‚¬ì—…ì†Œ ì •ë³´ í‘œì‹œ
            this.displayPropInfo();
            
            // ê±´ë¬¼ ëª©ë¡ ë¡œë“œ
            this.loadBlSelectOptions();
            
            // bl_idê°€ ì§€ì •ëœ ê²½ìš° í•´ë‹¹ ê±´ë¬¼ ë¡œë“œ
            if (bl_id) {
                setTimeout(() => {
                    this.loadBlData(bl_id);
                }, 500);
            }
        },
        
        // ì‚¬ì—…ì†Œ ì •ë³´ í‘œì‹œ
        displayPropInfo: function() {
            const prop_id = this.data.currentPropId;
            if (prop_id && window.propList) {
                const prop = window.propList.find(p => p.prop_id === prop_id);
                if (prop) {
                    document.getElementById('prop_info').textContent = `${prop.prop_name} (${prop.prop_id})`;
                }
            }
        },
        
        // ê±´ë¬¼ ì„ íƒ ì˜µì…˜ ë¡œë“œ
        loadBlSelectOptions: function() {
            const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
            const prop_id = this.data.currentPropId;
            
            if (!em_id || !prop_id) return;
            
            fetch('/common/get_bl_list', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ em_id: em_id, prop_id: prop_id })
            })
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('bl_select');
                select.innerHTML = '<option value="">--ê±´ë¬¼ì„ íƒ--</option>';
                
                if (data.success && data.data) {
                    this.data.blList = data.data;
                    data.data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.bl_id;
                        option.textContent = item.bl_name;
                        select.appendChild(option);
                    });
                    console.log('ğŸ¢ ê±´ë¬¼ ì„ íƒ ì˜µì…˜ ë¡œë“œ ì™„ë£Œ:', data.data.length, 'ê°œ');
                    
                    // selected_bl_idê°€ ìˆìœ¼ë©´ ì„ íƒ
                    if (window.selected_bl_id) {
                        select.value = window.selected_bl_id;
                    }
                }
            })
            .catch(error => {
                console.error('ğŸ¢ ê±´ë¬¼ ì„ íƒ ì˜µì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
            });
        },
        
        // ê±´ë¬¼ ì„ íƒ ë³€ê²½
        changeBlSelection: function() {
            const select = document.getElementById('bl_select');
            const bl_id = select.value;
            
            if (bl_id) {
                this.loadBlData(bl_id);
            } else {
                this.clearForm();
            }
        },
        forceRefresh: function(blId) {
            console.log('ğŸ¢ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰:', blId);
            
            this.data.isInitialized = false;
            this.data.currentBlId = null;
            window.selected_bl_id = blId;
            
            // ê±´ë¬¼ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
            this.loadBlData(blId);
        },
        
        // ê±´ë¬¼ ë°ì´í„° ë¡œë“œ
        loadBlData: function(bl_id) {
            console.log('ğŸ¢ ê±´ë¬¼ ë°ì´í„° ë¡œë“œ ì‹œì‘:', bl_id);
            
            if (!bl_id) return;
            
            this.data.currentBlId = bl_id;
            document.getElementById('current_bl_id').value = bl_id;
            
            const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
            
            this.showLoading('ê±´ë¬¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            
            fetch('/fm/bl_update/get_bl_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bl_id: bl_id, em_id: em_id })
            })
            .then(response => response.json())
            .then(data => {
                console.log('ğŸ¢ ê±´ë¬¼ ë°ì´í„° ì‘ë‹µ:', data);
                
                if (data.success) {
                    this.data.hasPermission = data.has_permission;
                    this.populateForm(data.data);
                    this.hideLoading();
                    
                    // í˜„ì¬ íƒ­ì— ë”°ë¼ ì¶”ê°€ ë°ì´í„° ë¡œë“œ
                    if (this.data.currentTab === 3) {
                        this.loadHistoryData();
                    } else if (this.data.currentTab === 4) {
                        this.loadPhotoData();
                    }
                    
                    // ê¶Œí•œ ì²´í¬
                    this.updatePermissionUI();
                } else {
                    this.showError('ê±´ë¬¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ğŸ¢ ê±´ë¬¼ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                this.showError('ê±´ë¬¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        },
        
        // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        populateForm: function(data) {
            // ê±´ë¬¼ê°œìš” ë°ì´í„°
            const fields = [
                'name', 'landlord', 'design', 'builder', 'address1', 'area_total', 'class_land',
                'district', 'section', 'area_bl', 'parcel', 'bl_to_land_ratio', 'fl_space_index',
                'area_usable', 'construction_type', 'roof_type', 'count_fl', 'count_bf',
                'bl_height', 'bl_depth', 'use1', 'date_bl', 'parking_type', 'elev_type',
                'elec_type', 'generator_type', 'heating_type', 'cooling_type', 'contact_name',
                'contact_phone', 'contact_fax', 'zip'
            ];
            
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.value = data[field] || '';
                }
            });
            
            // ê¸°íƒ€ì •ë³´ ë°ì´í„°
            const otherFields = [
                'date_buy', 'date_buy_land', 'date_sailed', 'date_manage_start', 'price_pa_land',
                'area_fl', 'area_bf', 'area_rentable', 'area_garden', 'price_book_value',
                'base_rate', 'width_front_road', 'width_back_road', 'width_side_road',
                'parking_unit_inner', 'parking_unit_outdoor', 'el_unit', 'es_unit', 'comments'
            ];
            
            otherFields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.value = data[field] || '';
                }
            });
            
            // ë¼ë””ì˜¤ ë²„íŠ¼ ì²˜ë¦¬
            this.setRadioValue('regist', data.regist);
            this.setRadioValue('use_fl_4', data.use_fl_4);
            this.setRadioValue('use_fl_13', data.use_fl_13);
            this.setRadioValue('ph', data.ph);
            
            // í‰ìˆ˜ ê³„ì‚°
            this.calculatePyeong();
        },
        
        // ë¼ë””ì˜¤ ë²„íŠ¼ ê°’ ì„¤ì •
        setRadioValue: function(name, value) {
            const radios = document.querySelectorAll(`input[name="${name}"]`);
            radios.forEach(radio => {
                radio.checked = radio.value === String(value);
            });
        },
        
        // í‰ìˆ˜ ê³„ì‚°
        calculatePyeong: function() {
            const areaTotalInput = document.getElementById('area_total');
            const areaTotalPyeongInput = document.getElementById('area_total_pyeong');
            
            if (areaTotalInput && areaTotalPyeongInput) {
                const areaTotal = parseFloat(areaTotalInput.value.replace(/,/g, '')) || 0;
                const pyeong = areaTotal / 3.3058;
                areaTotalPyeongInput.value = pyeong > 0 ? pyeong.toFixed(2) : '';
            }
        },
        // BlUpdateModule ê°ì²´ ë‚´ì— ì¶”ê°€
        toggleFileViewer: function() {
            const historyType = document.getElementById('history_type').value;
            const fileViewerArea = document.getElementById('file_viewer_area');
            
            if (historyType === '3') { // íŒŒì¼ê´€ë¦¬
                fileViewerArea.style.display = 'block';
            } else {
                fileViewerArea.style.display = 'none';
            }
        },

        selectHistoryFile: function(data) {
            const fileTitle = document.getElementById('file_title');
            const filePreview = document.getElementById('file_preview');

            fileTitle.textContent = data.title || 'ì œëª© ì—†ìŒ';
            filePreview.innerHTML = '';  // â­ ê¸°ì¡´ ë‚´ìš© ì™„ì „ ì´ˆê¸°í™”

            if (data.filename && data.maskname) {
                const extension = data.filename.split('.').pop().toLowerCase();
                const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'];

                if (imageExtensions.includes(extension)) {
                    const imageUrl = `/bl_pds/${data.maskname}`;

                    console.log('ğŸ¢ [bl_update] ì´ë¯¸ì§€ íŒŒì¼ ì²˜ë¦¬ - URL:', imageUrl);

                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = 'ì´ë¯¸ì§€';
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '100%';
                    img.style.objectFit = 'contain';
                    img.onload = function() {
                        console.log('âœ… [bl_update] ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', imageUrl);
                        console.log('âœ… [bl_update] ì´ë¯¸ì§€ í¬ê¸°:', img.naturalWidth + 'x' + img.naturalHeight);
                    };
                    img.onerror = function() {
                        console.log('ğŸ”´ [bl_update] ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', imageUrl);
                        filePreview.innerHTML = '<div style="text-align: center; color: #999;">ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤<br>ğŸ“·</div>';
                    };

                    filePreview.appendChild(img);
                } else {
                    const fileIcon = this.getFileIcon(extension);
                    filePreview.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">${fileIcon}</div>
                            <div style="font-size: 12px; color: #666; word-break: break-word;">${data.filename}</div>
                            <div style="font-size: 11px; color: #999; margin-top: 5px;">${extension.toUpperCase()} íŒŒì¼</div>
                            <div style="font-size: 10px; color: #999; margin-top: 5px;">ì‹¤ì œíŒŒì¼: ${data.maskname}</div>
                        </div>`;
                }
            } else {
                console.log('ğŸ”´ [bl_update] filename ë˜ëŠ” maskname ì—†ìŒ');
                filePreview.innerHTML = '<div style="text-align: center; color: #999;">íŒŒì¼ ì—†ìŒ</div>';
            }

            this.selectedFileData = {
                ...data,
                auto_number: parseInt(data.auto_number, 10)
            };

            console.log('ğŸ¢ [bl_update] íŒŒì¼ ì„ íƒ ì™„ë£Œ:', this.selectedFileData);
        },

        testBl_PdsFileFromBlUpdate: function(maskname) {
            if (!maskname) return;
            
            console.log('ğŸ§ª [bl_update] bl_pds íŒŒì¼ í…ŒìŠ¤íŠ¸ ì‹œì‘:', maskname);
            
            // íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            fetch(`/debug/check_bl_pds_file/${maskname}`)
                .then(response => response.json())
                .then(data => {
                    console.log('ğŸ” [bl_update] bl_pds íŒŒì¼ ì²´í¬ ê²°ê³¼:', data);
                })
                .catch(error => {
                    console.error('ğŸ”´ [bl_update] bl_pds íŒŒì¼ ì²´í¬ ì‹¤íŒ¨:', error);
                });
        },


        // íŒŒì¼ ì•„ì´ì½˜ ë°˜í™˜ í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€)
        getFileIcon: function(extension) {
            const iconMap = {
                'pdf': 'ğŸ“„',
                'doc': 'ğŸ“', 'docx': 'ğŸ“',
                'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š',
                'ppt': 'ğŸ“‹', 'pptx': 'ğŸ“‹',
                'txt': 'ğŸ“ƒ',
                'zip': 'ğŸ—œï¸', 'rar': 'ğŸ—œï¸', '7z': 'ğŸ—œï¸',
                'mp4': 'ğŸ¬', 'avi': 'ğŸ¬', 'mov': 'ğŸ¬',
                'mp3': 'ğŸµ', 'wav': 'ğŸµ',
                'default': 'ğŸ“'
            };
            return iconMap[extension.toLowerCase()] || iconMap['default'];
        },


        downloadSelectedFile: function() {
            if (this.selectedFileData && this.selectedFileData.auto_number) {
                // ì •ìˆ˜ë¡œ ë³€í™˜ëœ auto_number ì‚¬ìš©
                const autoNumber = parseInt(this.selectedFileData.auto_number, 10);
                const downloadUrl = `/fm/bl_update/view_file?auto_number=${autoNumber}`;
                
                // ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•œ ì„ì‹œ ë§í¬ ìƒì„±
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = this.selectedFileData.filename || 'file';
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('ğŸ¢ íŒŒì¼ ë‹¤ìš´ë¡œë“œ:', downloadUrl);
            } else {
                alert('ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            }
        },
        
        // íƒ­ ì „í™˜
        showTab: function(tabNumber, element) {
            // ê¸°ì¡´ íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ìƒˆ íƒ­ í™œì„±í™”
            if (element) element.classList.add('active');
            const tabContent = document.getElementById(`tab${tabNumber}_content`);
            if (tabContent) tabContent.classList.add('active');
            
            this.data.currentTab = tabNumber;
            document.getElementById('current_tab').value = tabNumber;
            
            // íƒ­ë³„ ë°ì´í„° ë¡œë“œ
            if (this.data.currentBlId) {
                if (tabNumber === 3) {
                    this.loadHistoryData();
                } else if (tabNumber === 4) {
                    this.loadPhotoData();
                }
            }
        },
        
        // ì´ë ¥ ë°ì´í„° ë¡œë“œ
        loadHistoryData: function() {
            if (!this.data.currentBlId) return;
            
            const historyType = document.getElementById('history_type').value;
            const dateStart = document.getElementById('history_date_start').value;
            const dateEnd = document.getElementById('history_date_end').value;
            const keyword = document.getElementById('history_search').value;
            
            // íŒŒì¼ê´€ë¦¬ ì„ íƒì‹œ ì´ë¯¸ì§€(1)ì™€ íŒŒì¼(3) ëª¨ë‘ ì¡°íšŒ
            let typeParam;
            if (historyType === '3') {
                typeParam = 'file_all';  // íŒŒì¼ê´€ë¦¬ ì „ìš© í”Œë˜ê·¸
            } else {
                typeParam = historyType;  // ê¸°ì¡´ëŒ€ë¡œ
            }
            
            fetch('/fm/bl_update/get_history_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    bl_id: this.data.currentBlId,
                    type: typeParam,
                    date_start: dateStart,
                    date_end: dateEnd,
                    keyword: keyword
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('ğŸ¢ ì´ë ¥ ë°ì´í„° ì‘ë‹µ:', data);
                
                if (data.success) {
                    this.data.historyData = data.data;
                    this.renderHistoryTable(data.data);
                } else {
                    this.showHistoryError('ì´ë ¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ğŸ¢ ì´ë ¥ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                this.showHistoryError('ì´ë ¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        },
        
        // ì´ë ¥ í…Œì´ë¸” ë Œë”ë§
        renderHistoryTable: function(data) {
            const tbody = document.getElementById('history_table_body');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">ë“±ë¡ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            let html = '';
            const historyType = document.getElementById('history_type').value;

            data.forEach(item => {
                const safeItem = {
                    auto_number: item.auto_number || 0,
                    title: (item.title || '').replace(/'/g, "\\'").replace(/"/g, '\\"'),
                    filename: (item.filename || '').replace(/'/g, "\\'").replace(/"/g, '\\"'),
                    maskname: (item.maskname || '').replace(/'/g, "\\'").replace(/"/g, '\\"'),  
                    reg_man_name: (item.reg_man_name || '').replace(/'/g, "\\'").replace(/"/g, '\\"'),
                    reg_date: item.reg_date || ''
                };


                let clickEvent = `BlUpdateModule.openHistoryDetail(${safeItem.auto_number}, '${this.data.currentBlId}', '${historyType}')`;
                
                // íŒŒì¼ê´€ë¦¬ì¸ ê²½ìš° selectHistoryFile ë¨¼ì € ì‹¤í–‰
                if (historyType === '3' || historyType === 'file_all') {
                    const selectEvent = `BlUpdateModule.selectHistoryFile(${JSON.stringify(safeItem).replace(/"/g, '&quot;')})`;
                    clickEvent = `${selectEvent}; ${clickEvent}`;
                }
                
                // íŒŒì¼ ì•„ì´ì½˜ í‘œì‹œ ê°œì„ 
                let fileIcon = '';
                if (item.filename) {
                    const extension = item.filename.split('.').pop().toLowerCase();
                    const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'];
                    fileIcon = imageExtensions.includes(extension) ? 'ğŸ–¼ï¸' : 'ğŸ“';
                }
                
                html += `
                <tr style="cursor: pointer;">
                    <td style="text-align:left; padding-left:5px;" onclick="${clickEvent}">${item.title || ''}</td>
                    <td style="text-align:center;" onclick="${clickEvent}">${item.reg_man_name || item.reg_man || ''}</td>
                    <td style="text-align:center;" onclick="${clickEvent}">${item.reg_date || ''}</td>
                    <td style="text-align:center;" onclick="BlUpdateModule.selectHistoryFile(${JSON.stringify(safeItem).replace(/"/g, '&quot;')})">${fileIcon}</td>
                </tr>
            `;
            });

            
            tbody.innerHTML = html;
        },

            
        
        // ì‚¬ì§„ ë°ì´í„° ë¡œë“œ
        loadPhotoData: function() {
            if (!this.data.currentBlId) return;
            
            const dateStart = document.getElementById('photo_date_start').value;
            const dateEnd = document.getElementById('photo_date_end').value;
            const keyword = document.getElementById('photo_search').value;
            
            fetch('/fm/bl_update/get_photo_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    bl_id: this.data.currentBlId,
                    date_start: dateStart,
                    date_end: dateEnd,
                    keyword: keyword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.data.photoData = data.data;
                    this.renderPhotoTable(data.data);
                } else {
                    this.showPhotoError('ì‚¬ì§„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('ğŸ¢ ì‚¬ì§„ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                this.showPhotoError('ì‚¬ì§„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        },
        
        // ì‚¬ì§„ í…Œì´ë¸” ë Œë”ë§
        renderPhotoTable: function(data) {
            const tbody = document.getElementById('photo_table_body');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">ë“±ë¡ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            let html = '';
            data.forEach((item, index) => {
                const mainIndicator = item.is_main_photo ? '<span class="main-photo-indicator">[ë©”ì¸]</span> ' : '';
                html += `
                    <tr onclick="BlUpdateModule.selectPhoto(${index})" style="cursor: pointer;">
                        <td style="text-align:left; padding-left:5px;">${mainIndicator}${item.title || ''}</td>
                        <td style="text-align:center;">${item.reg_man_name || item.reg_man || ''}</td>
                        <td style="text-align:center;">${item.reg_date || ''}</td>
                        <td style="text-align:center;">${item.filename ? 'ğŸ“·' : ''}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        },
        
        // ì‚¬ì§„ ì„ íƒ
        selectPhoto: function(index) {
            if (index >= 0 && index < this.data.photoData.length) {
                this.data.selectedPhotoIndex = index;
                const photo = this.data.photoData[index];
                
                document.getElementById('photo_title').textContent = photo.title || 'ì œëª© ì—†ìŒ';
                
                if (photo.maskname) {
                    document.getElementById('photo_image').src = `/fm/bl_update/view_file?auto_number=${photo.auto_number}`;
                } else {
                    document.getElementById('photo_image').src = '/static/images/common/no_image.png';
                }
            }
        },
        
        // ì´ì „ ì‚¬ì§„
        prevPhoto: function() {
            if (this.data.selectedPhotoIndex > 0) {
                this.selectPhoto(this.data.selectedPhotoIndex - 1);
            }
        },
        
        // ë‹¤ìŒ ì‚¬ì§„
        nextPhoto: function() {
            if (this.data.selectedPhotoIndex < this.data.photoData.length - 1) {
                this.selectPhoto(this.data.selectedPhotoIndex + 1);
            }
        },
        
        // ê±´ë¬¼ ë°ì´í„° ì €ì¥
        saveBlData: function() {
            if (!this.data.currentBlId) {
                alert('ì €ì¥í•  ê±´ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!this.data.hasPermission) {
                alert('í•´ë‹¹ ê±´ë¬¼ì˜ ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // í¼ ë°ì´í„° ìˆ˜ì§‘
            const formData = this.collectFormData();
            formData.bl_id = this.data.currentBlId;
            formData.em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
            
            console.log('ğŸ¢ ì €ì¥í•  ë°ì´í„°:', formData);
            
            // ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
            const saveBtn = document.getElementById('btn_save');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'ì €ì¥ ì¤‘...';
            saveBtn.disabled = true;
            
            fetch('/fm/bl_update/save_bl_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showSuccess('ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ğŸ¢ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            })
            .finally(() => {
                // ì €ì¥ ë²„íŠ¼ ë³µì›
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            });
        },
        
        // í¼ ë°ì´í„° ìˆ˜ì§‘
        collectFormData: function() {
            const data = {};
            
            // ëª¨ë“  ì…ë ¥ í•„ë“œ
            const inputs = document.querySelectorAll('#bl_update_outer input, #bl_update_outer select, #bl_update_outer textarea');
            inputs.forEach(input => {
                if (input.type === 'radio') {
                    if (input.checked) {
                        data[input.name] = input.value;
                    }
                } else if (input.id && input.id !== 'current_bl_id' && input.id !== 'current_prop_id' && input.id !== 'current_tab') {
                    data[input.id] = input.value;
                }
            });
            
            return data;
        },
        
        // ë©”ì¸ì‚¬ì§„ ì‚­ì œ
        deleteMainPhoto: function() {
            if (!this.data.currentBlId) {
                alert('ê±´ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!confirm('ë©”ì¸ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            fetch('/fm/bl_update/delete_main_photo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bl_id: this.data.currentBlId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showSuccess('ë©”ì¸ì‚¬ì§„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    // ì‚¬ì§„ íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
                    if (this.data.currentTab === 4) {
                        this.loadPhotoData();
                    }
                } else {
                    alert('ë©”ì¸ì‚¬ì§„ ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ğŸ¢ ë©”ì¸ì‚¬ì§„ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ë©”ì¸ì‚¬ì§„ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        },
        
        // ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
        exportExcel: function() {
            if (!this.data.currentBlId) {
                alert('ì—‘ì…€ë¡œ ë‚´ë³´ë‚¼ ê±´ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            console.log('ğŸ“Š ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì‹œì‘');
            
            // í˜„ì¬ í¼ì˜ ëª¨ë“  ë°ì´í„° ìˆ˜ì§‘
            const formData = this.collectFormData();
            formData.bl_id = this.data.currentBlId;
            formData.em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
            
            // ê±´ë¬¼ëª… ì¶”ê°€ (íŒŒì¼ëª…ìš©)
            const blNameElement = document.getElementById('name');
            const blName = blNameElement ? blNameElement.value : 'ê±´ë¬¼ì •ë³´';
            formData.bl_name = blName;
            
            // ì´ë ¥ ë°ì´í„°ë„ í¬í•¨í• ì§€ í™•ì¸
            const includeHistory = confirm('ê±´ë¬¼ ì´ë ¥ ì •ë³´ë„ ì—‘ì…€ì— í¬í•¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì˜ˆ: ê±´ë¬¼ì •ë³´ + ì´ë ¥ì •ë³´\nì•„ë‹ˆì˜¤: ê±´ë¬¼ì •ë³´ë§Œ');
            
            // ì—‘ì…€ ìƒì„± ìš”ì²­
            const exportBtn = document.getElementById('btn_excel');
            const originalText = exportBtn.textContent;
            exportBtn.textContent = 'ì—‘ì…€ ìƒì„± ì¤‘...';
            exportBtn.disabled = true;
            
            // POST ìš”ì²­ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ìƒì„¸ ë°ì´í„° ì „ì†¡
            fetch('/fm/bl_update/export_excel_detailed', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ...formData,
                    include_history: includeHistory
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('ì—‘ì…€ ìƒì„± ì‹¤íŒ¨');
                }
            })
            .then(blob => {
                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                const currentDate = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const fileName = `ê±´ë¬¼ì •ë³´_${blName}_${currentDate}.xlsx`;
                link.download = fileName;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                this.showSuccess(`ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤: ${fileName}`);
                console.log('ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', fileName);
            })
            .catch(error => {
                console.error('ğŸ“Š ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                alert('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            })
            .finally(() => {
                // ë²„íŠ¼ ë³µì›
                exportBtn.textContent = originalText;
                exportBtn.disabled = false;
            });
        },
        
        // ì¸ì‡„
        printBl: function() {
            if (!this.data.currentBlId) {
                alert('ì¸ì‡„í•  ê±´ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            console.log('ğŸ–¨ï¸ ë°ì´í„° í¬í•¨ ì¸ì‡„ ì‹œì‘');
            
            // 1. ì¸ì‡„í•  ë©”ì¸ ì»¨í…Œì´ë„ˆ ì°¾ê¸°
            const blUpdateOuter = document.getElementById('bl_update_outer');
            if (!blUpdateOuter) {
                alert('ì¸ì‡„í•  ì»¨í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // 2. í˜„ì¬ í™œì„± íƒ­ê³¼ ìƒíƒœ ì €ì¥
            const originalActiveTab = this.data.currentTab;
            const allTabContents = blUpdateOuter.querySelectorAll('.tab-content');
            const tabHeaders = document.querySelectorAll('.nav-link');
            
            // ê±´ë¬¼ê°œìš”(íƒ­1)ê³¼ ê¸°íƒ€ì •ë³´(íƒ­2)ë§Œ ê°€ì ¸ì˜¤ê¸°
            const tab1Content = document.getElementById('tab1_content');
            const tab2Content = document.getElementById('tab2_content');
            
            if (!tab1Content || !tab2Content) {
                alert('ì¸ì‡„í•  íƒ­ ì»¨í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // 3. ëª¨ë“  íƒ­ ìƒíƒœ ì €ì¥
            const originalTabStates = [];
            allTabContents.forEach(content => {
                originalTabStates.push({
                    element: content,
                    display: content.style.display,
                    classList: Array.from(content.classList)
                });
            });
            
            const originalHeaderStates = [];
            tabHeaders.forEach(header => {
                originalHeaderStates.push({
                    element: header,
                    classList: Array.from(header.classList)
                });
            });
            
            // 4. ê±´ë¬¼ëª… ê°€ì ¸ì˜¤ê¸°
            const blNameElement = tab1Content.querySelector('#name');
            const blName = blNameElement ? blNameElement.value || 'ê±´ë¬¼ì •ë³´' : 'ê±´ë¬¼ì •ë³´';
            
            // 5. input ê°’ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
            const convertInputsToText = function(container) {
                const clone = container.cloneNode(true);
                
                // ëª¨ë“  input, select, textarea ìš”ì†Œ ì°¾ê¸°
                const inputs = clone.querySelectorAll('input, select, textarea');
                
                inputs.forEach(input => {
                    let value = '';
                    
                    if (input.type === 'radio' || input.type === 'checkbox') {
                        // ë¼ë””ì˜¤ë²„íŠ¼/ì²´í¬ë°•ìŠ¤ì¸ ê²½ìš°
                        if (input.checked) {
                            // ì²´í¬ëœ í•­ëª©ì˜ ë¼ë²¨ í…ìŠ¤íŠ¸ ì°¾ê¸°
                            const label = clone.querySelector(`label[for="${input.id}"]`) || 
                                        input.closest('label') || 
                                        input.nextElementSibling;
                            value = label ? label.textContent.trim() : (input.value || 'ì„ íƒë¨');
                        } else {
                            value = '';
                        }
                    } else if (input.tagName === 'SELECT') {
                        // select ìš”ì†Œì¸ ê²½ìš°
                        const selectedOption = input.options[input.selectedIndex];
                        value = selectedOption ? selectedOption.textContent : input.value;
                    } else {
                        // ì¼ë°˜ input, textareaì¸ ê²½ìš°
                        value = input.value || '';
                    }
                    
                    // input ìš”ì†Œë¥¼ spanìœ¼ë¡œ êµì²´
                    const span = document.createElement('span');
                    span.textContent = value;
                    span.style.cssText = `
                        display: inline-block;
                        min-height: 12px;
                        padding: 1px 3px;
                        border-bottom: 1px dotted #999;
                        font-weight: normal;
                        color: black;
                    `;
                    
                    // ë¹ˆ ê°’ì¸ ê²½ìš° ìµœì†Œ ê³µê°„ í™•ë³´
                    if (!value.trim()) {
                        span.innerHTML = '&nbsp;';
                        span.style.borderBottom = '1px dotted #ccc';
                    }
                    
                    input.parentNode.replaceChild(span, input);
                });
                
                // ë¼ë””ì˜¤ë²„íŠ¼ ê·¸ë£¹ ì²˜ë¦¬
                const radioGroups = {};
                clone.querySelectorAll('input[type="radio"]').forEach(radio => {
                    if (!radioGroups[radio.name]) {
                        radioGroups[radio.name] = [];
                    }
                    radioGroups[radio.name].push(radio);
                });
                
                // ê° ë¼ë””ì˜¤ ê·¸ë£¹ì—ì„œ ì²´í¬ëœ í•­ëª©ë§Œ í‘œì‹œ
                Object.keys(radioGroups).forEach(groupName => {
                    const radios = radioGroups[groupName];
                    let checkedValue = '';
                    
                    radios.forEach(radio => {
                        if (radio.checked) {
                            const label = radio.closest('label') || radio.nextElementSibling;
                            checkedValue = label ? label.textContent.replace(radio.value, '').trim() : radio.value;
                        }
                    });
                    
                    // ë¼ë””ì˜¤ ê·¸ë£¹ ì „ì²´ë¥¼ í•˜ë‚˜ì˜ spanìœ¼ë¡œ êµì²´
                    if (radios.length > 0) {
                        const firstRadio = radios[0];
                        const container = firstRadio.closest('td') || firstRadio.parentNode;
                        
                        // ê¸°ì¡´ ë¼ë””ì˜¤ ë²„íŠ¼ë“¤ê³¼ ë¼ë²¨ë“¤ ì œê±°
                        radios.forEach(radio => {
                            const label = radio.closest('label');
                            if (label) label.remove();
                            else radio.remove();
                        });
                        
                        // ì„ íƒëœ ê°’ì„ í‘œì‹œí•˜ëŠ” span ì¶”ê°€
                        const span = document.createElement('span');
                        span.textContent = checkedValue || 'ì„ íƒë˜ì§€ ì•ŠìŒ';
                        span.style.cssText = `
                            display: inline-block;
                            padding: 1px 3px;
                            border-bottom: 1px dotted #999;
                            font-weight: normal;
                            color: black;
                        `;
                        container.appendChild(span);
                    }
                });
                
                return clone;
            };
            
            // 6. ì¸ì‡„ìš© ì»¨í…Œì´ë„ˆ ìƒì„±
            const printContainer = document.createElement('div');
            printContainer.id = 'print-only-container';
            printContainer.style.cssText = 'position: absolute; top: -9999px; left: -9999px; width: 100%; background: white;';
            
            // 7. ì¸ì‡„ìš© í—¤ë” ìƒì„±
            const printHeader = `
                <div style="text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #333;">
                    <h1 style="margin: 0; font-size: 20px; font-weight: bold; color: black;">ê±´ë¬¼ ì •ë³´ ìƒì„¸</h1>
                    <h2 style="margin: 10px 0 0 0; font-size: 16px; color: #333;">${blName}</h2>
                    <p style="margin: 5px 0 0 0; font-size: 11px; color: #666;">ì¶œë ¥ì¼: ${new Date().toLocaleDateString('ko-KR')}</p>
                </div>
            `;
            
            // 8. ê±´ë¬¼ê°œìš”ì™€ ê¸°íƒ€ì •ë³´ë¥¼ ë°ì´í„°ì™€ í•¨ê»˜ ìƒì„±
            let printContent = printHeader;
            
            // ê±´ë¬¼ê°œìš” (íƒ­1) - input ê°’ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
            printContent += `
                <div style="margin: 20px 0 12px 0;">
                    <h3 style="margin: 0; padding-bottom: 5px; border-bottom: 1px solid #666; font-size: 14px; font-weight: bold; color: black;">
                        â–  ê±´ë¬¼ ê°œìš” ì •ë³´
                    </h3>
                </div>
            `;
            
            const tab1Converted = convertInputsToText(tab1Content);
            // ë¶ˆí•„ìš”í•œ ìš”ì†Œë“¤ ì œê±°
            const tab1ElementsToRemove = tab1Converted.querySelectorAll('script, .search-area, .photo-controls, button, .button-area');
            tab1ElementsToRemove.forEach(el => el.remove());
            printContent += tab1Converted.innerHTML;
            
            // ê¸°íƒ€ì •ë³´ (íƒ­2) - input ê°’ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
            printContent += `
                <div style="margin: 25px 0 12px 0; page-break-before: avoid;">
                    <h3 style="margin: 0; padding-bottom: 5px; border-bottom: 1px solid #666; font-size: 14px; font-weight: bold; color: black;">
                        â–  ê¸°íƒ€ ì •ë³´
                    </h3>
                </div>
            `;
            
            const tab2Converted = convertInputsToText(tab2Content);
            // ë¶ˆí•„ìš”í•œ ìš”ì†Œë“¤ ì œê±°
            const tab2ElementsToRemove = tab2Converted.querySelectorAll('script, .search-area, .photo-controls, button, .button-area');
            tab2ElementsToRemove.forEach(el => el.remove());
            printContent += tab2Converted.innerHTML;
            
            printContainer.innerHTML = printContent;
            document.body.appendChild(printContainer);
            
            // 9. ì¸ì‡„ìš© ìŠ¤íƒ€ì¼ ìƒì„±
            const printStyle = document.createElement('style');
            printStyle.id = 'print-only-style';
            printStyle.textContent = `
                @media print {
                    @page {
                        margin: 12mm;
                        size: A4;
                    }
                    
                    /* ê¸°ì¡´ ëª¨ë“  ìš”ì†Œ ìˆ¨ê¹€ */
                    body > *:not(#print-only-container) {
                        display: none !important;
                        visibility: hidden !important;
                    }
                    
                    /* ì¸ì‡„ ì»¨í…Œì´ë„ˆë§Œ í‘œì‹œ */
                    #print-only-container {
                        position: static !important;
                        top: auto !important;
                        left: auto !important;
                        width: 100% !important;
                        height: auto !important;
                        background: white !important;
                        color: black !important;
                        font-family: Arial, sans-serif !important;
                        font-size: 9pt !important;
                        line-height: 1.3 !important;
                        padding: 0 !important;
                        margin: 0 !important;
                        display: block !important;
                        visibility: visible !important;
                    }
                    
                    /* í˜ì´ì§€ ë‚˜ëˆ„ê¸° ë°©ì§€ */
                    #print-only-container * {
                        page-break-inside: avoid !important;
                    }
                    
                    /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
                    #print-only-container .form-table {
                        width: 100% !important;
                        border-collapse: collapse !important;
                        margin-bottom: 8px !important;
                        font-size: 8pt !important;
                    }
                    
                    #print-only-container .form-table td {
                        border: 0.5pt solid #333 !important;
                        padding: 3pt 5pt !important;
                        font-size: 8pt !important;
                        vertical-align: top !important;
                        line-height: 1.2 !important;
                    }
                    
                    #print-only-container .form-table .label {
                        background: #f8f8f8 !important;
                        font-weight: bold !important;
                        text-align: center !important;
                        width: 15% !important;
                    }
                    
                    /* ë³€í™˜ëœ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
                    #print-only-container span {
                        color: black !important;
                        font-size: 8pt !important;
                        font-weight: normal !important;
                        background: transparent !important;
                    }
                    
                    /* ì œëª© ìŠ¤íƒ€ì¼ */
                    #print-only-container h1 {
                        font-size: 16pt !important;
                        margin: 0 !important;
                    }
                    
                    #print-only-container h2 {
                        font-size: 13pt !important;
                        margin: 6px 0 !important;
                    }
                    
                    #print-only-container h3 {
                        font-size: 11pt !important;
                        margin: 12px 0 6px 0 !important;
                    }
                }
            `;
            document.head.appendChild(printStyle);
            
            // 10. í˜ì´ì§€ ì œëª© ì„¤ì •
            const originalTitle = document.title;
            document.title = `${blName} - ê±´ë¬¼ì •ë³´ìƒì„¸`;
            
            // 11. ì¸ì‡„ ì‹¤í–‰
            setTimeout(() => {
                try {
                    window.print();
                    console.log('ğŸ–¨ï¸ ë°ì´í„° í¬í•¨ ì¸ì‡„ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ë¦¼');
                } catch (error) {
                    console.error('ğŸ–¨ï¸ ì¸ì‡„ ì˜¤ë¥˜:', error);
                    alert('ì¸ì‡„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
                
                // 12. ì¸ì‡„ í›„ ì™„ì „ ë³µì›
                setTimeout(() => {
                    // ì¸ì‡„ìš© ìš”ì†Œë“¤ ì œê±°
                    const printContainer = document.getElementById('print-only-container');
                    if (printContainer) printContainer.remove();
                    
                    const printStyle = document.getElementById('print-only-style');
                    if (printStyle) printStyle.remove();
                    
                    // í˜ì´ì§€ ì œëª© ë³µì›
                    document.title = originalTitle;
                    
                    // íƒ­ ìƒíƒœ ì™„ì „ ë³µì›
                    originalTabStates.forEach(({element, display, classList}) => {
                        element.style.display = display;
                        element.className = '';
                        classList.forEach(cls => element.classList.add(cls));
                    });
                    
                    originalHeaderStates.forEach(({element, classList}) => {
                        element.className = '';
                        classList.forEach(cls => element.classList.add(cls));
                    });
                    
                    // ëª¨ë“ˆ ë°ì´í„° ì¬ì„¤ì •
                    this.data.currentTab = originalActiveTab;
                    document.getElementById('current_tab').value = originalActiveTab;
                    
                    // ì •ìƒì ì¸ íƒ­ ì „í™˜ìœ¼ë¡œ ì™„ì „í•œ ìƒíƒœ ë³µì›
                    setTimeout(() => {
                        const originalTabHeader = document.querySelector(`[data-tab="${originalActiveTab}"]`);
                        if (originalTabHeader) {
                            this.showTab(originalActiveTab, originalTabHeader);
                        } else {
                            const tab1Header = document.querySelector('[data-tab="1"]');
                            if (tab1Header) {
                                this.showTab(1, tab1Header);
                            }
                        }
                        
                        console.log('ğŸ–¨ï¸ ë°ì´í„° í¬í•¨ ì¸ì‡„ ì™„ë£Œ ë° ë³µì›');
                    }, 100);
                    
                }, 1000);
            }, 300);
        },
        
        // ëª©ë¡ìœ¼ë¡œ ì´ë™
        goToBlList: function() {
            if (typeof window.loadContent === 'function') {
                window.loadContent('/fm/bl_list.html', 'ê±´ë¬¼ì •ë³´');
                window.showStatus && window.showStatus('ê±´ë¬¼ ëª©ë¡ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.');
            }
        },
        
        registerHistory: function() {
            if (!this.data.currentBlId) {
                alert('ê±´ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            this.createInsertPopup('2'); // í…ìŠ¤íŠ¸ ì´ë ¥
        },

        registerPhoto: function() {
            if (!this.data.currentBlId) {
                alert('ê±´ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            this.createInsertPopup('1'); // ì´ë¯¸ì§€ ì´ë ¥
        },

        // íŒì—… ìƒì„± ë° ì—´ê¸° (ìƒˆë¡œ ì¶”ê°€)
        createInsertPopup: function(type) {
            // ì´ë¯¸ íŒì—…ì´ ìˆìœ¼ë©´ ì œê±°
            const existingPopup = document.getElementById('blpds_insert_popup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            // íŒì—… HTML ìƒì„±
            const popupHTML = this.getPopupHTML();
            
            // bodyì— ì¶”ê°€
            document.body.insertAdjacentHTML('beforeend', popupHTML);
            
            // íŒì—… JavaScript ì´ˆê¸°í™”
            this.initializePopup(type);
        },

        // íŒì—… HTML ë°˜í™˜ (ìƒˆë¡œ ì¶”ê°€)
        getPopupHTML: function() {
            return `
                <!-- íŒì—… ì˜¤ë²„ë ˆì´ -->
                <div id="blpds_insert_popup" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background-color: rgba(0, 0, 0, 0.5); z-index: 10000; display: block;">
                    
                    <div id="blpds_insert_content" style="
                        position: absolute; top: 10%; left: 50%; transform: translateX(-50%);
                        width: 800px; min-width: 600px; max-width: 95%; 
                        background-color: white; border-radius: 8px;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); 
                        max-height: 80vh; overflow: hidden; resize: both;
                        border: 2px solid #007bff;">
                        
                        <!-- íŒì—… í—¤ë” (ë“œë˜ê·¸ í•¸ë“¤) -->
                        <div id="blpds_insert_header" style="
                            background-color: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #dee2e6;
                            border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; 
                            align-items: center; cursor: move; user-select: none;">
                            
                            <h3 id="popup_title" style="margin: 0; font-size: 16px; font-weight: bold; color: #495057;">
                                ê±´ë¬¼ì´ë ¥ ë“±ë¡
                            </h3>
                            
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button type="button" id="popup_maximize" style="
                                    background: none; border: none; font-size: 16px; cursor: pointer; 
                                    color: #6c757d; padding: 2px 6px;" title="ìµœëŒ€í™”">â¬œ</button>
                                <button type="button" id="blpds_insert_close" style="
                                    background: none; border: none; font-size: 20px; cursor: pointer; 
                                    color: #6c757d; padding: 2px 6px;" title="ë‹«ê¸°">&times;</button>
                            </div>
                        </div>

                        <!-- íŒì—… ë‚´ìš© (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
                        <div id="blpds_insert_body" style="padding: 20px; overflow-y: auto; max-height: calc(80vh - 120px);">
                            <form id="blpds_insert_form">
                                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px;">
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #dee2e6; background-color: #f8f9fa; 
                                            font-weight: bold; text-align: center; width: 15%; min-width: 80px;">ì œëª©</td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6; width: 35%;">
                                            <input type="text" id="insert_title" name="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" 
                                                style="border: 1px solid #ced4da; border-radius: 4px; padding: 4px 6px; 
                                                font-size: 12px; width: 100%;" required>
                                        </td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6; background-color: #f8f9fa; 
                                            font-weight: bold; text-align: center; width: 15%;">í˜•ì‹</td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6; width: 35%;">
                                            <select id="insert_type" name="type" style="border: 1px solid #ced4da; 
                                                border-radius: 4px; padding: 4px 6px; font-size: 12px; width: 100%;">
                                                <option value="1">ì´ë¯¸ì§€ ì´ë ¥</option>
                                                <option value="2">í…ìŠ¤íŠ¸ ì´ë ¥</option>
                                                <option value="3">íŒŒì¼ ì´ë ¥</option>
                                            </select>
                                        </td>
                                    </tr>
                                    
                                    <!-- íŒŒì¼ ì—…ë¡œë“œ í–‰ -->
                                    <tr id="file_row">
                                        <td style="padding: 8px; border: 1px solid #dee2e6; background-color: #f8f9fa; 
                                            font-weight: bold; text-align: center;">
                                            <span id="file_label">ê±´ë¬¼ì‚¬ì§„ ì²¨ë¶€</span>
                                        </td>
                                        <td colspan="3" style="padding: 8px; border: 1px solid #dee2e6;">
                                            <input type="file" id="insert_filename" name="filename" accept="image/*"
                                                style="border: 1px solid #ced4da; border-radius: 4px; padding: 4px 6px; 
                                                font-size: 12px; width: 100%;">
                                            <div id="file_info" style="margin-top: 5px; font-size: 11px; color: #6c757d;"></div>
                                        </td>
                                    </tr>
                                    
                                    <!-- ë‚´ìš© ì…ë ¥ -->
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #dee2e6; background-color: #f8f9fa; 
                                            font-weight: bold; text-align: center; vertical-align: top;">ë‚´ìš©</td>
                                        <td colspan="3" style="padding: 8px; border: 1px solid #dee2e6;">
                                            <textarea id="insert_contents" name="contents" rows="5" 
                                                placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="border: 1px solid #ced4da; 
                                                border-radius: 4px; padding: 4px 6px; font-size: 12px; width: 100%; 
                                                resize: vertical; min-height: 80px;"></textarea>
                                        </td>
                                    </tr>
                                </table>

                                <!-- íˆë“  í•„ë“œë“¤ -->
                                <input type="hidden" id="insert_bl_id" name="bl_id" value="">
                                <input type="hidden" id="insert_prop_id" name="prop_id" value="">
                                <input type="hidden" id="insert_reg_man" name="reg_man" value="">
                            </form>
                        </div>

                        <!-- íŒì—… í‘¸í„° -->
                        <div id="blpds_insert_footer" style="
                            background-color: #f8f9fa; padding: 15px 20px; border-top: 1px solid #dee2e6;
                            border-radius: 0 0 6px 6px; text-align: right;">
                            
                            <button type="button" id="popup_save_btn" style="
                                margin-left: 5px; padding: 6px 12px; background: #007bff; color: white;
                                border: 1px solid #007bff; font-size: 12px; border-radius: 4px; 
                                cursor: pointer;">ì €ì¥</button>
                                
                            <button type="button" id="popup_cancel_btn" style="
                                margin-left: 5px; padding: 6px 12px; background: #fff; color: #333;
                                border: 1px solid #ced4da; font-size: 12px; border-radius: 4px; 
                                cursor: pointer;">ì·¨ì†Œ</button>
                        </div>
                        
                        <!-- ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ -->
                        <div id="resize_handle" style="
                            position: absolute; bottom: 0; right: 0; width: 20px; height: 20px;
                            cursor: se-resize; background: linear-gradient(-45deg, transparent 40%, #ccc 40%, #ccc 60%, transparent 60%);
                            border-radius: 0 0 6px 0;">
                        </div>
                    </div>
                </div>
            `;
        },

        // íŒì—… JavaScript ì´ˆê¸°í™” (ìƒˆë¡œ ì¶”ê°€)
        initializePopup: function(type) {
            const self = this;
            
            // ë°ì´í„° ì„¤ì •
            document.getElementById('insert_bl_id').value = this.data.currentBlId || '';
            document.getElementById('insert_prop_id').value = this.data.currentPropId || '';
            document.getElementById('insert_reg_man').value = window.currentEmId || '';
            
            // íƒ€ì… ì„¤ì •
            document.getElementById('insert_type').value = type;
            this.updatePopupUI(type);
            
            // íŒì—… ì œëª© ì—…ë°ì´íŠ¸
            let title = 'ê±´ë¬¼ì´ë ¥ ë“±ë¡';
            if (type === '1') title = 'ê±´ë¬¼ì‚¬ì§„ ë“±ë¡';
            else if (type === '2') title = 'ê±´ë¬¼ì´ë ¥ ë“±ë¡';
            else if (type === '3') title = 'íŒŒì¼ ë“±ë¡';
            document.getElementById('popup_title').textContent = title;
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.getElementById('blpds_insert_close').onclick = function() {
                self.closePopup();
            };
            
            document.getElementById('popup_cancel_btn').onclick = function() {
                self.closePopup();
            };
            
            document.getElementById('popup_save_btn').onclick = function() {
                self.savePopupData();
            };
            
            document.getElementById('insert_type').onchange = function() {
                self.updatePopupUI(this.value);
            };
            
            // ìµœëŒ€í™” ë²„íŠ¼
            document.getElementById('popup_maximize').onclick = function() {
                self.toggleMaximize();
            };
            
            // íŒŒì¼ ì„ íƒ ì‹œ ì •ë³´ í‘œì‹œ
            document.getElementById('insert_filename').onchange = function() {
                self.showFileInfo(this);
            };
            
            // ì˜¤ë²„ë ˆì´ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
            document.getElementById('blpds_insert_popup').onclick = function(event) {
                if (event.target === this) {
                    self.closePopup();
                }
            };
            
            // ë“œë˜ê·¸ ê¸°ëŠ¥ ì´ˆê¸°í™”
            this.initializeDrag();
            
            // ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì´ˆê¸°í™”
            this.initializeResize();
            
            // ESC í‚¤ë¡œ ë‹«ê¸°
            this.popupKeyHandler = function(event) {
                if (event.key === 'Escape') {
                    self.closePopup();
                }
            };
            document.addEventListener('keydown', this.popupKeyHandler);
            
            // ì œëª© ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                document.getElementById('insert_title').focus();
            }, 100);
        },

        // ë“œë˜ê·¸ ê¸°ëŠ¥ ì´ˆê¸°í™” (ìƒˆë¡œ ì¶”ê°€)
        initializeDrag: function() {
            const header = document.getElementById('blpds_insert_header');
            const popup = document.getElementById('blpds_insert_content');
            let isDragging = false;
            let startX, startY, startLeft, startTop;
            
            header.onmousedown = function(e) {
                if (e.target.tagName === 'BUTTON') return; // ë²„íŠ¼ í´ë¦­ì€ ì œì™¸
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                
                const rect = popup.getBoundingClientRect();
                startLeft = rect.left;
                startTop = rect.top;
                
                document.onmousemove = function(e) {
                    if (!isDragging) return;
                    
                    const newLeft = startLeft + (e.clientX - startX);
                    const newTop = startTop + (e.clientY - startY);
                    
                    // í™”ë©´ ê²½ê³„ ì²´í¬
                    const maxLeft = window.innerWidth - popup.offsetWidth;
                    const maxTop = window.innerHeight - popup.offsetHeight;
                    
                    popup.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + 'px';
                    popup.style.top = Math.max(0, Math.min(newTop, maxTop)) + 'px';
                    popup.style.transform = 'none'; // transform ì œê±°
                };
                
                document.onmouseup = function() {
                    isDragging = false;
                    document.onmousemove = null;
                    document.onmouseup = null;
                };
            };
        },

        // ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì´ˆê¸°í™” (ìƒˆë¡œ ì¶”ê°€)
        initializeResize: function() {
            const popup = document.getElementById('blpds_insert_content');
            const handle = document.getElementById('resize_handle');
            let isResizing = false;
            let startX, startY, startWidth, startHeight;
            
            handle.onmousedown = function(e) {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = popup.offsetWidth;
                startHeight = popup.offsetHeight;
                
                document.onmousemove = function(e) {
                    if (!isResizing) return;
                    
                    const newWidth = startWidth + (e.clientX - startX);
                    const newHeight = startHeight + (e.clientY - startY);
                    
                    // ìµœì†Œ/ìµœëŒ€ í¬ê¸° ì œí•œ
                    const minWidth = 600;
                    const minHeight = 400;
                    const maxWidth = window.innerWidth - 50;
                    const maxHeight = window.innerHeight - 50;
                    
                    popup.style.width = Math.max(minWidth, Math.min(newWidth, maxWidth)) + 'px';
                    popup.style.height = Math.max(minHeight, Math.min(newHeight, maxHeight)) + 'px';
                    
                    // ë‚´ìš© ì˜ì—­ ë†’ì´ ì¡°ì •
                    const bodyHeight = popup.offsetHeight - 120; // í—¤ë”+í‘¸í„° ì œì™¸
                    document.getElementById('blpds_insert_body').style.maxHeight = bodyHeight + 'px';
                };
                
                document.onmouseup = function() {
                    isResizing = false;
                    document.onmousemove = null;
                    document.onmouseup = null;
                };
            };
        },

        // ìµœëŒ€í™”/ë³µì› í† ê¸€ (ìƒˆë¡œ ì¶”ê°€)
        toggleMaximize: function() {
            const popup = document.getElementById('blpds_insert_content');
            const maximizeBtn = document.getElementById('popup_maximize');
            
            if (popup.getAttribute('data-maximized') === 'true') {
                // ë³µì›
                popup.style.width = popup.getAttribute('data-original-width');
                popup.style.height = popup.getAttribute('data-original-height');
                popup.style.left = popup.getAttribute('data-original-left');
                popup.style.top = popup.getAttribute('data-original-top');
                popup.style.transform = popup.getAttribute('data-original-transform') || 'none';
                popup.setAttribute('data-maximized', 'false');
                maximizeBtn.innerHTML = 'â¬œ';
                maximizeBtn.title = 'ìµœëŒ€í™”';
                
                // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ í‘œì‹œ
                document.getElementById('resize_handle').style.display = 'block';
            } else {
                // ìµœëŒ€í™”
                popup.setAttribute('data-original-width', popup.style.width || '800px');
                popup.setAttribute('data-original-height', popup.style.height || 'auto');
                popup.setAttribute('data-original-left', popup.style.left || '50%');
                popup.setAttribute('data-original-top', popup.style.top || '10%');
                popup.setAttribute('data-original-transform', popup.style.transform || 'translateX(-50%)');
                
                popup.style.width = '95vw';
                popup.style.height = '90vh';
                popup.style.left = '2.5vw';
                popup.style.top = '5vh';
                popup.style.transform = 'none';
                popup.setAttribute('data-maximized', 'true');
                maximizeBtn.innerHTML = 'ğŸ——';
                maximizeBtn.title = 'ë³µì›';
                
                // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ìˆ¨ê¹€
                document.getElementById('resize_handle').style.display = 'none';
            }
            
            // ë‚´ìš© ì˜ì—­ ë†’ì´ ì¬ì¡°ì •
            const bodyHeight = popup.offsetHeight - 120;
            document.getElementById('blpds_insert_body').style.maxHeight = bodyHeight + 'px';
        },

        // íŒŒì¼ ì •ë³´ í‘œì‹œ (ìƒˆë¡œ ì¶”ê°€)
        showFileInfo: function(fileInput) {
            const fileInfo = document.getElementById('file_info');
            
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                const size = (file.size / 1024 / 1024).toFixed(2); // MB
                fileInfo.innerHTML = `ì„ íƒëœ íŒŒì¼: ${file.name} (${size} MB)`;
                fileInfo.style.color = '#28a745';
            } else {
                fileInfo.innerHTML = '';
            }
        },

        // íŒì—… UI ì—…ë°ì´íŠ¸ (ìƒˆë¡œ ì¶”ê°€)
        updatePopupUI: function(type) {
            const fileRow = document.getElementById('file_row');
            const fileLabel = document.getElementById('file_label');
            const fileInput = document.getElementById('insert_filename');
            const contentsTextarea = document.getElementById('insert_contents');
            
            if (type === '1') {
                // ì´ë¯¸ì§€ ì´ë ¥
                fileRow.style.display = 'table-row';
                fileLabel.textContent = 'ê±´ë¬¼ì‚¬ì§„ ì²¨ë¶€';
                fileInput.accept = 'image/*';
                contentsTextarea.rows = 5;
            } else if (type === '2') {
                // í…ìŠ¤íŠ¸ ì´ë ¥
                fileRow.style.display = 'none';
                contentsTextarea.rows = 15;
            } else if (type === '3') {
                // íŒŒì¼ ì´ë ¥
                fileRow.style.display = 'table-row';
                fileLabel.textContent = 'íŒŒì¼ ì²¨ë¶€';
                fileInput.accept = '*/*';
                contentsTextarea.rows = 5;
            }
        },

        // íŒì—… ë‹«ê¸° (ìƒˆë¡œ ì¶”ê°€)
        closePopup: function() {
            const popup = document.getElementById('blpds_insert_popup');
            if (popup) {
                popup.remove();
            }
            
            // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            if (this.popupKeyHandler) {
                document.removeEventListener('keydown', this.popupKeyHandler);
                this.popupKeyHandler = null;
            }
        },

        // íŒì—… ë°ì´í„° ì €ì¥ (ìƒˆë¡œ ì¶”ê°€)
        savePopupData: function() {
            const title = document.getElementById('insert_title').value.trim();
            const contents = document.getElementById('insert_contents').value.trim();
            const blId = document.getElementById('insert_bl_id').value;
            const type = document.getElementById('insert_type').value;
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (!title) {
                alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                document.getElementById('insert_title').focus();
                return;
            }
            
            if (type === '2' && !contents) {
                alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                document.getElementById('insert_contents').focus();
                return;
            }
            
            // FormData ìƒì„±
            const formData = new FormData();
            formData.append('bl_id', blId);
            formData.append('title', title);
            formData.append('contents', contents);
            formData.append('type', type);
            formData.append('reg_man', document.getElementById('insert_reg_man').value);
            
            // íŒŒì¼ ì²¨ë¶€ (type=1 ë˜ëŠ” type=3ì¸ ê²½ìš°)
            if (type === '1' || type === '3') {
                const fileInput = document.getElementById('insert_filename');
                if (fileInput.files[0]) {
                    formData.append('file', fileInput.files[0]);
                }
            }
            
            console.log('ğŸ¢ ì €ì¥í•  ë°ì´í„°:', Object.fromEntries(formData));
            
            // ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
            const saveButton = document.getElementById('popup_save_btn');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'ì €ì¥ ì¤‘...';
            saveButton.disabled = true;
            
            // ì €ì¥ ìš”ì²­
            fetch('/fm/blpds_insert/save_data', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    this.closePopup();
                    
                    // ì´ë ¥ ë°ì´í„° ê°•ì œ ìƒˆë¡œê³ ì¹¨
                    setTimeout(() => {
                        this.loadHistoryData();
                        
                        // íŒŒì¼ê´€ë¦¬ íƒ€ì…ì¸ ê²½ìš° íŒŒì¼ ë·°ì–´ë„ ì—…ë°ì´íŠ¸
                        this.toggleFileViewer();
                    }, 500);
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            })
            .catch(error => {
                console.error('ğŸ¢ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            })
            .finally(() => {
                // ì €ì¥ ë²„íŠ¼ ë³µì›
                saveButton.textContent = originalText;
                saveButton.disabled = false;
            });
        },
        
        // ê¶Œí•œ UI ì—…ë°ì´íŠ¸
        updatePermissionUI: function() {
            const saveBtn = document.getElementById('btn_save');
            const deleteBtn = document.getElementById('btn_delete_photo');
            
            if (!this.data.hasPermission) {
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.title = 'ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
                }
                if (deleteBtn) {
                    deleteBtn.disabled = true;
                    deleteBtn.title = 'ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
                }
                
                // ì…ë ¥ í•„ë“œ ì½ê¸° ì „ìš© ì„¤ì •
                const inputs = document.querySelectorAll('#bl_update_outer input, #bl_update_outer select, #bl_update_outer textarea');
                inputs.forEach(input => {
                    if (input.type !== 'button' && input.type !== 'submit') {
                        input.readOnly = true;
                    }
                });
            }
        },
        
        // í¼ ì´ˆê¸°í™”
        clearForm: function() {
            this.data.currentBlId = null;
            document.getElementById('current_bl_id').value = '';
            
            // ëª¨ë“  ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            const inputs = document.querySelectorAll('#bl_update_outer input, #bl_update_outer select, #bl_update_outer textarea');
            inputs.forEach(input => {
                if (input.type === 'radio' || input.type === 'checkbox') {
                    input.checked = false;
                } else if (input.type !== 'button' && input.type !== 'submit') {
                    input.value = '';
                }
            });
        },
        
        // ë¡œë”© í‘œì‹œ
        showLoading: function(message = 'ë¡œë”© ì¤‘...') {
            // ê°„ë‹¨í•œ ë¡œë”© í‘œì‹œ
            console.log('ğŸ¢ ë¡œë”©:', message);
        },
        
        // ë¡œë”© ìˆ¨ê¹€
        hideLoading: function() {
            console.log('ğŸ¢ ë¡œë”© ì™„ë£Œ');
        },
        
        // ì˜¤ë¥˜ í‘œì‹œ
        showError: function(message) {
            console.error('ğŸ¢ ì˜¤ë¥˜:', message);
            alert(message);
        },
        
        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        showSuccess: function(message) {
            console.log('ğŸ¢ ì„±ê³µ:', message);
            if (window.showStatus) {
                window.showStatus(message);
            } else {
                alert(message);
            }
        },
        
        // ì´ë ¥ í…Œì´ë¸” ì˜¤ë¥˜ í‘œì‹œ
        showHistoryError: function(message) {
            const tbody = document.getElementById('history_table_body');
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">${message}</td></tr>`;
        },
        
        // ì‚¬ì§„ í…Œì´ë¸” ì˜¤ë¥˜ í‘œì‹œ
        showPhotoError: function(message) {
            const tbody = document.getElementById('photo_table_body');
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">${message}</td></tr>`;
        },
        // ì‚¬ì§„ í…Œì´ë¸” ì˜¤ë¥˜ í‘œì‹œ
        showPhotoError: function(message) {
            const tbody = document.getElementById('photo_table_body');
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">${message}</td></tr>`;
        },
        
        openHistoryDetail: function(autoNumber, blId, type) {
            console.log('ğŸ¢ [bl_update] openHistoryDetail í˜¸ì¶œ ì›ë³¸ ê°’:', { autoNumber, blId, type });

            // autoNumberë¥¼ ì •ìˆ˜ë¡œ ë³€í™˜í•˜ì—¬ ì‚¬ìš©
            const parsedAutoNumber = parseInt(autoNumber, 10);

            if (isNaN(parsedAutoNumber) || parsedAutoNumber === 0) {
                alert('ì˜ëª»ëœ ì´ë ¥ ì •ë³´ì…ë‹ˆë‹¤. autoNumberê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                console.error('ğŸ¢ [bl_update] openHistoryDetail: íŒŒì‹±ëœ autoNumberê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ:', parsedAutoNumber);
                return;
            }

            // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
            window.selected_auto_number = parsedAutoNumber;
            window.selected_bl_id = blId || this.data.currentBlId;
            window.selected_file_type = type || '2';

            // URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ìƒì„±: ì •ìˆ˜í˜•ìœ¼ë¡œ ì „ë‹¬
            const queryParams = new URLSearchParams({
                auto_number: parsedAutoNumber,
                bl_id: blId || this.data.currentBlId,
                type: type || '2',
                prop_search: window.currentPropId
            }).toString();

            const urlWithParams = `/fm/blpds_update.html?${queryParams}`;
            console.log('ğŸ¢ [bl_update] ì´ë™í•  URL (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° í¬í•¨):', urlWithParams);

            // í•µì‹¬: ê¸°ì¡´ blpds_update íƒ­ì„ ë¨¼ì € ì œê±°í•˜ê³  ìƒˆë¡œ ìƒì„±
            if (window.tabManager && typeof window.tabManager.removeTab === 'function') {
                // ê¸°ì¡´ íƒ­ ID ê³„ì‚° (base.htmlì˜ generateTabId ë¡œì§ê³¼ ë™ì¼)
                const existingTabId = 'tab__fm_blpds_update_html';
                
                console.log('ğŸ¢ [bl_update] ê¸°ì¡´ íƒ­ ì œê±° ì‹œë„:', existingTabId);
                window.tabManager.removeTab(existingTabId);
                
                // ì§§ì€ ì§€ì—° í›„ ìƒˆ íƒ­ ìƒì„±
                setTimeout(() => {
                    console.log('ğŸ¢ [bl_update] ìƒˆ íƒ­ ìƒì„±:', urlWithParams);
                    window.tabManager.addTab(urlWithParams, `ê±´ë¬¼ì´ë ¥ìƒì„¸(${parsedAutoNumber})`);
                    
                    if (window.showStatus) {
                        window.showStatus(`ê±´ë¬¼ì´ë ¥ ìƒì„¸(${parsedAutoNumber})ë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤.`);
                    }
                }, 100);
                
                return; // ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë¨
            }

            // Fallback: tabManagerê°€ ì—†ê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš°
            console.log('ğŸ¢ [bl_update] tabManager ë¯¸ì‚¬ìš©, ì§ì ‘ ì½˜í…ì¸  ë¡œë“œ ì‹œë„');
            
            // í˜„ì¬ dynamic-content ì˜ì—­ì˜ ëª¨ë“  íƒ­ ì»¨í…Œì´ë„ˆ ì°¾ê¸°
            const dynamicContent = document.getElementById('dynamic-content');
            if (dynamicContent) {
                // ê¸°ì¡´ blpds_update ê´€ë ¨ íƒ­ ì»¨í…Œì´ë„ˆ ì œê±°
                const existingContainers = dynamicContent.querySelectorAll('[id*="blpds_update"], [id*="tab-container-tab__fm_blpds_update"]');
                existingContainers.forEach(container => {
                    console.log('ğŸ¢ [bl_update] ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì œê±°:', container.id);
                    container.remove();
                });
                
                // ìƒˆ ì»¨í…Œì´ë„ˆ ìƒì„± ë° ì½˜í…ì¸  ë¡œë“œ
                const newContainer = document.createElement('div');
                newContainer.id = `tab-container-${Date.now()}`;
                newContainer.className = 'tab-container';
                newContainer.style.cssText = 'display: block; width: 100%; height: 100%; overflow: auto; padding: 20px;';
                
                // ë¡œë”© í‘œì‹œ
                newContainer.innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                        <p>ê±´ë¬¼ì´ë ¥ ìƒì„¸(${parsedAutoNumber})ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                `;
                
                // ê¸°ì¡´ ì»¨í…Œì´ë„ˆë“¤ ìˆ¨ê¸°ê¸°
                dynamicContent.querySelectorAll('.tab-container').forEach(container => {
                    container.style.display = 'none';
                });
                
                // ìƒˆ ì»¨í…Œì´ë„ˆ ì¶”ê°€
                dynamicContent.appendChild(newContainer);
                
                // ì½˜í…ì¸  ë¡œë“œ
                fetch('/common/load_container', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ menuUrl: urlWithParams })
                })
                .then(response => response.text())
                .then(html => {
                    newContainer.innerHTML = html;
                    
                    // ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
                    setTimeout(() => {
                        const scripts = newContainer.querySelectorAll('script');
                        scripts.forEach(script => {
                            const newScript = document.createElement('script');
                            if (script.src) {
                                newScript.src = script.src;
                                newScript.async = false;
                            } else {
                                newScript.textContent = script.textContent;
                            }
                            script.parentNode.replaceChild(newScript, script);
                        });
                        
                        console.log('ğŸ¢ [bl_update] ìƒˆ ì½˜í…ì¸  ë¡œë“œ ì™„ë£Œ');
                    }, 100);
                })
                .catch(error => {
                    console.error('ğŸ¢ [bl_update] ì½˜í…ì¸  ë¡œë“œ ì‹¤íŒ¨:', error);
                    newContainer.innerHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <h3 style="color: #dc3545;">í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p style="color: #6c757d; margin: 20px 0;">URL: ${urlWithParams}</p>
                            <button class="btn btn-primary" onclick="window.location.reload()">ë‹¤ì‹œ ì‹œë„</button>
                        </div>
                    `;
                });
                
                if (window.showStatus) {
                    window.showStatus(`ê±´ë¬¼ì´ë ¥ ìƒì„¸(${parsedAutoNumber})ë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤.`);
                }
                
                return; // ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë¨
            }

            //  ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°
            console.log('ğŸ¢ [bl_update] ëª¨ë“  ë°©ë²• ì‹¤íŒ¨, ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°');
            const newWindow = window.open(urlWithParams, `history_detail_${parsedAutoNumber}`, 
                'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            if (newWindow) {
                if (window.showStatus) {
                    window.showStatus(`ê±´ë¬¼ì´ë ¥ ìƒì„¸(${parsedAutoNumber})ë¥¼ ìƒˆ ì°½ì—ì„œ ì—´ì—ˆìŠµë‹ˆë‹¤.`);
                }
            } else {
                alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        },
        
        // ì‚¬ì§„ í…Œì´ë¸” ë Œë”ë§ (ê¸°ì¡´ì— ì—†ë˜ í•¨ìˆ˜)
        renderPhotoTable: function(data) {
            const tbody = document.getElementById('photo_table_body');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">ë“±ë¡ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            let html = '';
            data.forEach((item, index) => {
                const mainIndicator = item.is_main_photo ? '<span class="main-photo-indicator">[ë©”ì¸]</span> ' : '';
                html += `
                    <tr onclick="BlUpdateModule.selectPhoto(${index})" ondblclick="BlUpdateModule.openHistoryDetail(${item.auto_number || int }, '${this.data.currentBlId}', '1')" style="cursor: pointer;">
                        <td style="text-align:left; padding-left:5px;">${mainIndicator}${item.title || ''}</td>
                        <td style="text-align:center;">${item.reg_man_name || item.reg_man || ''}</td>
                        <td style="text-align:center;">${item.reg_date || ''}</td>
                        <td style="text-align:center;">${item.filename ? 'ğŸ“·' : ''}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
    
    };
    
    // ì „ì—­ ì´ˆê¸°í™” í•¨ìˆ˜ ë“±ë¡
    window.initBlUpdatePage = function() {
        window.BlUpdateModule.init();
    };
    
    // ìë™ ì´ˆê¸°í™” (ì¦‰ì‹œ ì‹¤í–‰)
    setTimeout(() => {
        if (!window.BlUpdateModule.data.isInitialized) {
            console.log('ğŸ¢ ìë™ ì´ˆê¸°í™” ì‹œì‘');
            window.BlUpdateModule.init();
        }
    }, 500);
    
    console.log('ğŸ¢ BlUpdateModule ë¡œë“œ ì™„ë£Œ');
    
})(); // ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ ë
</script>