{% extends "base.html" %}

{% block title %}ì§ì›ì •ë³´ - FMS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
<style>
    /* ì§ì›ì •ë³´ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
    
    /* ì§ì› ëª©ë¡ í–‰ ìŠ¤íƒ€ì¼ */
    .employee-row { 
        cursor: pointer; 
        transition: background-color 0.15s ease-in-out;
    }
    
    .employee-row:hover { 
        background-color: #f0f7fc !important; 
    }
    
    .employee-row.selected { 
        background-color: #e3f2fd !important; 
        border-left: 3px solid #007bff;
    }
    
    /* ì§ì› ìƒì„¸ ì •ë³´ ì„¹ì…˜ */
    .detail-section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    /* ì§ì›ì •ë³´ ë ˆì´ì•„ì›ƒ */
    .employee-layout {
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 20px;
        margin-top: 20px;
    }
    
    /* ì§ì› ëª©ë¡ ì»¨í…Œì´ë„ˆ */
    .employee-list-container {
        position: relative;
    }
    
    .employee-count-info {
        margin-bottom: 10px;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 13px;
        color: #495057;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* ì§ì› ìƒì„¸ ì •ë³´ í”Œë ˆì´ìŠ¤í™€ë” */
    .employee-detail-placeholder {
        text-align: center; 
        line-height: 300px; 
        color: #6c757d;
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        font-size: 14px;
    }
    
    /* ì§ì› ìƒì„¸ ì •ë³´ í™œì„±í™” ìƒíƒœ */
    #employee-detail-content {
        animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ ë©”ì‹œì§€ */
    .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
        font-style: italic;
    }
    
    /* íƒ­ ì»¨í…ì¸  ë¡œë”© ìƒíƒœ */
    .tab-loading {
        text-align: center; 
        padding: 50px; 
        color: #6c757d;
    }
    
    .tab-error {
        text-align: center; 
        padding: 50px; 
        color: #dc3545;
    }
    
    /* ì§ì› ì‚¬ì§„ ìŠ¤íƒ€ì¼ */
    .employee-photo {
        max-width: 100px;
        max-height: 100px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    .employee-signature {
        max-width: 100px;
        max-height: 60px;
        object-fit: contain;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    /* ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ */
    @media (max-width: 992px) {
        .employee-layout {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .employee-count-info {
            flex-direction: column;
            gap: 5px;
            text-align: center;
        }
    }
    
    @media (max-width: 768px) {
        .detail-section {
            padding: 10px;
        }
        
        .employee-detail-placeholder {
            line-height: 200px;
            font-size: 12px;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ í…Œì´ë¸” ìŠ¤í¬ë¡¤ */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .data-table {
            min-width: 600px;
        }
    }
</style>
{% endblock %}
{% block sidebar_menu %}
<a href="{{ url_for('em.em_list') }}" class="menu-item active">
    ğŸ“ ì§ì›ì •ë³´

{% endblock %}

{% block content %}
<div>
    <h2>ğŸ“ ì§ì›ì •ë³´ ê´€ë¦¬</h2>

    <form id="employee-search-form" method="GET">
        <div class="form-row">
            <div class="form-group col-2">
                <label>ì‚¬ì—…ì†Œ:</label>
                <select name="prop_id_chk" class="form-control" onchange="this.form.submit()">
                    {% for p in prop_list %}
                    <option value="{{ p.prop_id }}" {% if search_params.prop_id_chk==p.prop_id %}selected{% endif %}>
                        {{ p.prop_id }} {{ p.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group col-2">
                <label>íŒŒíŠ¸:</label>
                <select name="emclass_id" class="form-control" onchange="this.form.submit()">
                    <option value="">-ì „ì²´-</option>
                    {% for c in emclass_list %}
                    <option value="{{ c.emclass_id }}" {% if search_params.emclass_id==c.emclass_id %}selected{% endif %}>
                        {{ c.emclass_id }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group col-2">
                <label>ì§ê¸‰:</label>
                <select name="emstd_id" class="form-control" onchange="this.form.submit()">
                    <option value="">-ì „ì²´-</option>
                    {% for s in emstd_list %}
                    <option value="{{ s.emstd_id }}" {% if search_params.emstd_id==s.emstd_id %}selected{% endif %}>
                        {{ s.emstd_id }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group col-2">
                <label>ìƒíƒœ:</label>
                <select name="status" class="form-control" onchange="this.form.submit()">
                    <option value="">-ì „ì²´-</option>
                    {% for s in status_list %}
                    <option value="{{ s.status }}" {% if search_params.status==s.status %}selected{% endif %}>
                        {{ s.status }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group col-3">
                <label>ì´ë¦„:</label>
                <input type="text" name="name_sch" class="form-control" value="{{ search_params.name_sch }}" onkeypress="if(event.keyCode==13) this.form.submit()">
            </div>
        </div>
        <input type="hidden" name="order" value="{{ search_params.order }}">
        <input type="hidden" name="desc" value="{{ search_params.desc }}">
        <input type="hidden" name="page_no" value="{{ current_page }}">
    </form>

    <div class="employee-count-info">
        <span>ì´ {{ total_count }}ëª…</span>
        <span>{{ current_page }} / {{ total_pages }} í˜ì´ì§€</span>
    </div>

    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th onclick="sortBy('name')">ì´ë¦„</th>
                    <th onclick="sortBy('emstd_id')">ì§ê¸‰</th>
                    <th onclick="sortBy('emclass_id')">íŒŒíŠ¸</th>
                    <th onclick="sortBy('status')">ìƒíƒœ</th>
                    <th onclick="sortBy('mobile_phone')">í•¸ë“œí°</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in em_list %}
                <tr class="employee-row" onclick="selectEmployee('{{ emp.em_id }}', this)">
                    <td>{{ emp.name }}</td>
                    <td>{{ emp.emstd_id }}</td>
                    <td>{{ emp.emclass_id }}</td>
                    <td>{{ emp.status }}</td>
                    <td>{{ emp.mobile_phone }}</td>
                </tr>
                {% else %}
                <tr><td colspan="5">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- í˜ì´ì§• -->
    <div class="pagination">
        {% set prev = current_page-1 if current_page>1 else 1 %}
        {% set nxt = current_page+1 if current_page<total_pages else total_pages %}
        <button {% if current_page==1 %}disabled{% endif %} onclick="changePage('{{ prev }}')">â—€ ì´ì „</button>
        <span>{{ current_page }} / {{ total_pages }}</span>
        <button {% if current_page == total_pages %}disabled{% endif %} onclick="changePage('{{ nxt }}')">ë‹¤ìŒ â–¶</button>
    </div>
</div>

<script>
function sortBy(field) {
    const form = document.getElementById('employee-search-form');
    let desc = form.order.value===field && form.desc.value==='asc' ? 'desc' : 'asc';
    form.order.value = field;
    form.desc.value = desc;
    form.page_no.value = 1;
    form.submit();
}
function changePage(page) {
    const form = document.getElementById('employee-search-form');
    form.page_no.value = page;
    form.submit();
}
</script>
<script>
let selectedEmployeeId = null;
let currentSort = { field: 'basic', direction: 'asc' };

// ì§ì› ì„ íƒ
function selectEmployee(em_id, element) {
    // ê¸°ì¡´ ì„ íƒ ì œê±°
    document.querySelectorAll('.employee-row').forEach(row => {
        row.classList.remove('selected');
    });
    
    // ìƒˆë¡œ ì„ íƒ
    element.classList.add('selected');
    selectedEmployeeId = em_id;
    
    // ìƒì„¸ ì •ë³´ í‘œì‹œ
    document.getElementById('employee-detail-placeholder').style.display = 'none';
    document.getElementById('employee-detail-content').style.display = 'block';
    
    // ê¸°ë³¸ì ìœ¼ë¡œ ì§ì›ì •ë³´ íƒ­ í‘œì‹œ
    showTab('info');
}

// íƒ­ í‘œì‹œ
function showTab(tabType, element) {
    // íƒ­ í™œì„±í™”
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    if (element) element.classList.add('active');
    
    const tabContent = document.getElementById('tab-content');
    if (!selectedEmployeeId) {
        tabContent.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">ì§ì›ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
        return;
    }
    
    tabContent.innerHTML = '<div style="text-align: center; padding: 50px;">ë¡œë”© ì¤‘...</div>';
    
    if (tabType === 'info') {
        loadEmployeeInfo();
    } else if (tabType === 'history') {
        loadEmployeeHistory();
    } else if (tabType === 'license') {
        loadEmployeeLicense();
    }
}

// ì§ì› ìƒì„¸ ì •ë³´ ë¡œë“œ
function loadEmployeeInfo() {
    fetch(`/em/em_detail/${selectedEmployeeId}`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('tab-content').innerHTML = html;
        })
        .catch(error => {
            console.error('ì§ì› ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
            document.getElementById('tab-content').innerHTML = 
                '<div style="text-align: center; padding: 50px; color: #dc3545;">ì§ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        });
}

// ì§ì› ì´ë ¥ ë¡œë“œ
function loadEmployeeHistory() {
    fetch('/em/em_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ c_type: 'history', em_id: selectedEmployeeId })
    })
    .then(response => response.json())
    .then(data => {
        let html = `
            <div style="margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="addHistory()">ì´ë ¥ ë“±ë¡</button>
            </div>
            <table class="employee-table">
                <thead>
                    <tr><th>ë²ˆí˜¸</th><th>ì„¤ëª…</th><th>íŒŒì¼</th><th>ë“±ë¡ì¼</th></tr>
                </thead>
                <tbody>
        `;
        
        if (data.success && data.data.length > 0) {
            data.data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.auto_number || ''}</td>
                        <td>${(item.filetype || '') + ' ' + (item.comments || '')}</td>
                        <td>${item.filename || ''}</td>
                        <td>${item.reg_date || ''}</td>
                    </tr>
                `;
            });
        } else {
            html += '<tr><td colspan="4">ë“±ë¡ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
        
        html += '</tbody></table>';
        document.getElementById('tab-content').innerHTML = html;
    })
    .catch(error => {
        console.error('ì§ì› ì´ë ¥ ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('tab-content').innerHTML = 
            '<div style="text-align: center; padding: 50px; color: #dc3545;">ì´ë ¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    });
}

// ì§ì› ìê²©ì¦ ë¡œë“œ
function loadEmployeeLicense() {
    fetch('/em/em_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ c_type: 'license', em_id: selectedEmployeeId })
    })
    .then(response => response.json())
    .then(data => {
        let html = `
            <table class="employee-table">
                <thead>
                    <tr><th>ë²ˆí˜¸</th><th>ì§ì›ID</th><th>ìê²©ì¦ëª…</th><th>ì·¨ë“ì¼ì</th><th>ë¹„ê³ </th></tr>
                </thead>
                <tbody>
        `;
        
        if (data.success && data.data.length > 0) {
            data.data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.licenceem_id || ''}</td>
                        <td>${item.em_id || ''}</td>
                        <td>${item.licence_id || ''}</td>
                        <td>${item.certici_date || ''}</td>
                        <td>${item.description || ''}</td>
                    </tr>
                `;
            });
        } else {
            html += '<tr><td colspan="5">ë“±ë¡ëœ ìê²©ì¦ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
        
        html += '</tbody></table>';
        document.getElementById('tab-content').innerHTML = html;
    })
    .catch(error => {
        console.error('ì§ì› ìê²©ì¦ ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('tab-content').innerHTML = 
            '<div style="text-align: center; padding: 50px; color: #dc3545;">ìê²©ì¦ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    });
}

// ì •ë ¬
function sortBy(field) {
    if (currentSort.field === field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.field = field;
        currentSort.direction = 'asc';
    }
    
    const form = document.getElementById('employee-search-form');
    form.querySelector('input[name="order"]').value = field;
    form.querySelector('input[name="desc"]').value = currentSort.direction;
    form.querySelector('input[name="page_no"]').value = '1';
    form.submit();
}

// í˜ì´ì§€ ë³€ê²½
function changePage(pageNo) {
    const form = document.getElementById('employee-search-form');
    form.querySelector('input[name="page_no"]').value = pageNo;
    form.submit();
}

// ê²€ìƒ‰ ì´ˆê¸°í™”
function resetSearch() {
    const form = document.getElementById('employee-search-form');
    form.reset();
    form.querySelector('input[name="page_no"]').value = '1';
    form.submit();
}

// ê¸°íƒ€ í•¨ìˆ˜ë“¤
function exportExcel() {
    if (window.showStatus) {
        window.showStatus('ì—‘ì…€ ì €ì¥ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    } else {
        alert('ì—‘ì…€ ì €ì¥ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    }
}

function addEmployee() {
    if (window.showStatus) {
        window.showStatus('ì§ì› ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    } else {
        alert('ì§ì› ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    }
}

function addHistory() {
    if (window.showStatus) {
        window.showStatus('ì´ë ¥ ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    } else {
        alert('ì´ë ¥ ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    }
}
</script>
{% endblock %}