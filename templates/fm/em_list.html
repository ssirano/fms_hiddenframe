<!-- HiddenFrame íƒ­ìš© ì§ì›ì •ë³´ í˜ì´ì§€ -->
<link rel="stylesheet" href="/static/css/common.css">
<style>
    /* ì§ì›ì •ë³´ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
    .employee-row { 
        cursor: pointer; 
        transition: background-color 0.15s ease-in-out;
    }
    
    .employee-row:hover { 
        background-color: #f0f7fc !important; 
    }
    
    .employee-row.selected { 
        background-color: #e3f2fd !important; 
        border-left: 3px solid #007bff;
    }
    
    .detail-section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .employee-layout {
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 20px;
        margin-top: 20px;
    }
    
    .employee-list-container {
        position: relative;
    }
    
    .employee-count-info {
        margin-bottom: 10px;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 13px;
        color: #495057;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .employee-detail-placeholder {
        text-align: center; 
        line-height: 300px; 
        color: #6c757d;
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        font-size: 14px;
    }
    
    #employee-detail-content {
        animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
        font-style: italic;
    }
    
    .tab-loading {
        text-align: center; 
        padding: 50px; 
        color: #6c757d;
    }
    
    .tab-error {
        text-align: center; 
        padding: 50px; 
        color: #dc3545;
    }
    
    .employee-photo {
        max-width: 100px;
        max-height: 100px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    .employee-signature {
        max-width: 100px;
        max-height: 60px;
        object-fit: contain;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    @media (max-width: 992px) {
        .employee-layout {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .employee-count-info {
            flex-direction: column;
            gap: 5px;
            text-align: center;
        }
    }
    
    @media (max-width: 768px) {
        .detail-section {
            padding: 10px;
        }
        
        .employee-detail-placeholder {
            line-height: 200px;
            font-size: 12px;
        }
        
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .data-table {
            min-width: 600px;
        }
    }
</style>

<div id="em-list-container">
    <h2>ğŸ“ ì§ì›ì •ë³´ ê´€ë¦¬</h2>

    <!-- ê²€ìƒ‰ í¼ - ì‚¬ì—…ì†Œ ì„ íƒ ì œê±° -->
    <div class="search-form">
        <div class="form-row">
            <div class="form-group col-2">
                <label>íŒŒíŠ¸:</label>
                <select id="emclass_id" class="form-control" onchange="searchEmployees()">
                    <option value="">-ì „ì²´-</option>
                </select>
            </div>
            <div class="form-group col-2">
                <label>ì§ê¸‰:</label>
                <select id="emstd_id" class="form-control" onchange="searchEmployees()">
                    <option value="">-ì „ì²´-</option>
                </select>
            </div>
            <div class="form-group col-2">
                <label>ìƒíƒœ:</label>
                <select id="status" class="form-control" onchange="searchEmployees()">
                    <option value="">-ì „ì²´-</option>
                    <option value="ì¬ì§ì¤‘">ì¬ì§ì¤‘</option>
                    <option value="ì‹ ì²­ì¤‘">ì‹ ì²­ì</option>
                    <option value="í‡´ì§ì">í‡´ì§ì</option>
                    <option value="ê´€ë¦¬ì">ê´€ë¦¬ì</option>
                </select>
            </div>
            <div class="form-group col-3">
                <label>ì´ë¦„:</label>
                <input type="text" id="name_sch" class="form-control" onkeypress="if(event.keyCode==13) searchEmployees()" placeholder="ì´ë¦„ ê²€ìƒ‰">
            </div>
            <div class="form-group col-3" style="text-align: right; display: flex; align-items: end; gap: 5px;">
                <button type="button" class="btn btn-primary" onclick="searchEmployees()">ê²€ìƒ‰</button>
                <button type="button" class="btn btn-success" onclick="insertEmployee()">ë“±ë¡</button>
                <button type="button" class="btn btn-info" onclick="exportExcel()">ì—‘ì…€ì €ì¥</button>
            </div>
        </div>
    </div>

    <div class="employee-layout">
        <!-- ì§ì› ëª©ë¡ -->
        <div class="employee-list-container">
            <div class="employee-count-info">
                <span id="employee-count-text">ì´ 0ëª…</span>
                <span id="employee-page-text">1 / 1 í˜ì´ì§€</span>
            </div>

            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th onclick="sortBy('name')">ì´ë¦„ â†•</th>
                            <th onclick="sortBy('emstd_id')">ì§ê¸‰ â†•</th>
                            <th onclick="sortBy('emclass_id')">íŒŒíŠ¸ â†•</th>
                            <th onclick="sortBy('status')">ìƒíƒœ â†•</th>
                            <th onclick="sortBy('mobile_phone')">í•¸ë“œí° â†•</th>
                        </tr>
                    </thead>
                    <tbody id="employee-table-body">
                        <tr><td colspan="5" class="text-center">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- í˜ì´ì§• -->
            <div class="pagination" id="employee-pagination">
                <button onclick="changePage(1)" id="btn-first">ì²˜ìŒ</button>
                <button onclick="changePage(currentPage-1)" id="btn-prev">â—€ ì´ì „</button>
                <span id="page-info">1 / 1</span>
                <button onclick="changePage(currentPage+1)" id="btn-next">ë‹¤ìŒ â–¶</button>
                <button onclick="changePage(totalPages)" id="btn-last">ë§ˆì§€ë§‰</button>
            </div>
        </div>

        <!-- ì§ì› ìƒì„¸ ì •ë³´ -->
        <div class="detail-section">
            <div id="employee-detail-placeholder" class="employee-detail-placeholder">
                ì§ì›ì„ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤
            </div>
            <div id="employee-detail-content" style="display: none;">
                <!-- íƒ­ ë©”ë‰´ -->
                <div class="nav-tabs">
                    <div class="nav-tab active" onclick="showTab('info', this)">ì§ì›ì •ë³´</div>
                    <div class="nav-tab" onclick="showTab('history', this)">ì´ë ¥ê´€ë¦¬</div>
                    <div class="nav-tab" onclick="showTab('license', this)">ìê²©ì¦</div>
                </div>
                
                <!-- íƒ­ ë‚´ìš© -->
                <div class="tab-content" id="tab-content">
                    <!-- ì„ íƒëœ íƒ­ì˜ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ğŸ›¡ï¸ HiddenFrame ì „ìš© ìŠ¤ì½”í”„ ë¶„ë¦¬ (ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì¶©ëŒ ë°©ì§€)
(function() {
    'use strict';
    
    console.log('ğŸ“ em_list.html HiddenFrame ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');
    
    // ğŸ†• HiddenFrame ì „ìš© ëª¨ë“ˆ ìƒì„±
    if (typeof window.EmployeeModule !== 'undefined') {
        console.log('ğŸ“ ê¸°ì¡´ EmployeeModule ì¬ì‚¬ìš©');
        return; // ì´ë¯¸ ë¡œë“œë¨
    }
    
    window.EmployeeModule = {
        // ë°ì´í„° ì €ì¥ì†Œ
        data: {
            selectedEmployeeId: null,
            currentSort: { field: 'basic', direction: 'asc' },
            currentPage: 1,
            totalPages: 1,
            totalCount: 0,
            searchParams: {
                prop_id_chk: '',
                emclass_id: '',
                emstd_id: '',
                status: '',
                name_sch: '',
                order: 'basic',
                desc: 'asc',
                page_no: 1
            },
            isInitialized: false
        },
        
        // ğŸ†• HiddenFrame ìƒíƒœ í™•ì¸
        isVisible: function() {
            const container = document.getElementById('em-list-container');
            if (!container) return false;
            
            // ë¶€ëª¨ íƒ­ ì»¨í…Œì´ë„ˆê°€ í‘œì‹œë˜ê³  ìˆëŠ”ì§€ í™•ì¸
            let current = container;
            while (current) {
                if (current.style && current.style.display === 'none') {
                    return false;
                }
                current = current.parentElement;
                if (current && current.classList && current.classList.contains('tab-container')) {
                    break;
                }
            }
            return true;
        },
        
        // ì´ˆê¸°í™”
        init: function() {
            console.log('ğŸ“ ì§ì›ì •ë³´ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘ (HiddenFrame)');
            
            // ğŸ†• HiddenFrame: ìˆ¨ê²¨ì§„ ìƒíƒœì—ì„œëŠ” ì´ˆê¸°í™” í•˜ì§€ ì•ŠìŒ
            if (!this.isVisible()) {
                console.log('ğŸ“ ìˆ¨ê²¨ì§„ ìƒíƒœì´ë¯€ë¡œ ì´ˆê¸°í™” ëŒ€ê¸°');
                return;
            }
            
            if (this.data.isInitialized) {
                console.log('ğŸ“ ì´ë¯¸ ì´ˆê¸°í™”ë¨, ê²€ìƒ‰ë§Œ ì¬ì‹¤í–‰');
                this.searchEmployees();
                return;
            }
            
            const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
            const prop_id = window.currentPropId;
            
            console.log('ğŸ“ ë°›ì€ ë°ì´í„°:', { em_id, prop_id });
            
            if (!em_id) {
                this.showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!prop_id) {
                this.showError('ì‚¬ì—…ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            this.data.isInitialized = true;
            this.data.searchParams.prop_id_chk = prop_id;
            
            // ğŸ†• HiddenFrame ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            this.bindHiddenFrameEvents();
            
            this.loadFilterOptions();
            
            setTimeout(() => {
                this.searchEmployees();
            }, 300);
        },
        
        // ğŸ†• HiddenFrame ì´ë²¤íŠ¸ ë°”ì¸ë”©
        bindHiddenFrameEvents: function() {
            const container = document.getElementById('em-list-container');
            if (!container) return;
            
            // íƒ­ì´ visible ë  ë•Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
            container.addEventListener('tabVisible', (e) => {
                console.log('ğŸ“ ì§ì›ì •ë³´ íƒ­ì´ ë‹¤ì‹œ í‘œì‹œë¨');
                if (!this.data.isInitialized) {
                    this.init();
                }
            });
            
            // ì‚¬ì—…ì†Œ ë³€ê²½ ì´ë²¤íŠ¸ ì²˜ë¦¬
            container.addEventListener('propChanged', (e) => {
                console.log('ğŸ“ ì‚¬ì—…ì†Œ ë³€ê²½ ê°ì§€:', e.detail);
                this.onPropChanged(e.detail.propId);
            });
        },
        
        // ì‚¬ì—…ì†Œ ë³€ê²½ ì²˜ë¦¬
        onPropChanged: function(newPropId) {
            console.log('ğŸ“ ì‚¬ì—…ì†Œ ë³€ê²½ ì²˜ë¦¬:', newPropId);
            
            if (!newPropId) return;
            
            this.data.searchParams.prop_id_chk = newPropId;
            
            // ì„ íƒëœ ì§ì› ì´ˆê¸°í™”
            this.data.selectedEmployeeId = null;
            const placeholder = document.getElementById('employee-detail-placeholder');
            const content = document.getElementById('employee-detail-content');
            if (placeholder) placeholder.style.display = 'block';
            if (content) content.style.display = 'none';
            
            // í•„í„° ì˜µì…˜ ë‹¤ì‹œ ë¡œë“œ
            this.loadFilterOptions();
            
            // ê²€ìƒ‰ ë‹¤ì‹œ ì‹¤í–‰
            setTimeout(() => {
                this.searchEmployees();
            }, 300);
        },
        
        // í•„í„° ì˜µì…˜ ë¡œë“œ
        loadFilterOptions: function() {
            const propId = this.data.searchParams.prop_id_chk;
            if (!propId) return;

            // íŒŒíŠ¸ ëª©ë¡
            fetch('/common/get_select_options', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    table: 'emclass',
                    id_field: 'emclass_id',
                    text_field: 'emclass_id',
                    conditions: { prop_id: propId },
                    order_by: 'vieworder ASC'
                })
            })
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('emclass_id');
                if (select) {
                    select.innerHTML = '<option value="">-ì „ì²´-</option>';
                    if (data.success) {
                        data.data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = item.text;
                            select.appendChild(option);
                        });
                    }
                }
            });

            // ì§ê¸‰ ëª©ë¡
            fetch('/common/get_select_options', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    table: 'emstd',
                    id_field: 'emstd_id',
                    text_field: 'emstd_id',
                    conditions: { prop_id: propId },
                    order_by: 'vieworder ASC'
                })
            })
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('emstd_id');
                if (select) {
                    select.innerHTML = '<option value="">-ì „ì²´-</option>';
                    if (data.success) {
                        data.data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = item.text;
                            select.appendChild(option);
                        });
                    }
                }
            });
        },
        
        // ì§ì› ê²€ìƒ‰
        searchEmployees: function() {
            console.log('ğŸ“ ì§ì› ê²€ìƒ‰ ì‹¤í–‰ ì‹œì‘ (HiddenFrame)');
            
            // HiddenFrame: ìˆ¨ê²¨ì§„ ìƒíƒœì—ì„œëŠ” ê²€ìƒ‰í•˜ì§€ ì•ŠìŒ
            if (!this.isVisible()) {
                console.log('ğŸ“ ìˆ¨ê²¨ì§„ ìƒíƒœì´ë¯€ë¡œ ê²€ìƒ‰ ì¤‘ë‹¨');
                return;
            }
            
            if (!this.data.searchParams.prop_id_chk) {
                const prop_id = window.currentPropId;
                if (prop_id) {
                    this.data.searchParams.prop_id_chk = prop_id;
                } else {
                    this.showError('ì‚¬ì—…ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
            }
            
            // ê²€ìƒ‰ ì¡°ê±´ ìˆ˜ì§‘
            this.data.searchParams = {
                prop_id_chk: this.data.searchParams.prop_id_chk,
                emclass_id: this.getElementValue('emclass_id'),
                emstd_id: this.getElementValue('emstd_id'),
                status: this.getElementValue('status'),
                name_sch: this.getElementValue('name_sch'),
                order: this.data.currentSort.field,
                desc: this.data.currentSort.direction,
                page_no: this.data.currentPage
            };

            console.log('ğŸ“ ìµœì¢… ê²€ìƒ‰ íŒŒë¼ë¯¸í„°:', this.data.searchParams);

            this.showLoading();

            fetch('/fm/em_entry', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    c_type: 'list',
                    ...this.data.searchParams
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.renderEmployeeList(data.data);
                    this.updatePagination(data.total_count, data.total_pages, data.current_page);
                } else {
                    this.showError('ê²€ìƒ‰ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ğŸ“ ì§ì› ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                this.showError('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            });
        },
        
        // í—¬í¼ í•¨ìˆ˜ë“¤
        getElementValue: function(id) {
            const element = document.getElementById(id);
            return element ? element.value : '';
        },
        
        showLoading: function() {
            const tbody = document.getElementById('employee-table-body');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">ê²€ìƒ‰ ì¤‘...</td></tr>';
            }
        },
        
        showError: function(message) {
            const tbody = document.getElementById('employee-table-body');
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">${message}</td></tr>`;
            }
        },
        
        // ì§ì› ëª©ë¡ ë Œë”ë§
        renderEmployeeList: function(employees) {
            const tbody = document.getElementById('employee-table-body');
            if (!tbody) return;
            
            if (employees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            let html = '';
            employees.forEach(emp => {
                html += `
                    <tr class="employee-row" onclick="EmployeeModule.selectEmployee('${emp.em_id}', this)">
                        <td>${emp.name || ''}</td>
                        <td>${emp.emstd_id || ''}</td>
                        <td>${emp.emclass_id || ''}</td>
                        <td>${emp.status || ''}</td>
                        <td>${emp.mobile_phone || ''}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        },
        
        // í˜ì´ì§• ì •ë³´ ì—…ë°ì´íŠ¸
        updatePagination: function(total, pages, current) {
            this.data.totalCount = total;
            this.data.totalPages = pages;
            this.data.currentPage = current;

            const countText = document.getElementById('employee-count-text');
            const pageText = document.getElementById('employee-page-text');
            const pageInfo = document.getElementById('page-info');
            
            if (countText) countText.textContent = `ì´ ${total}ëª…`;
            if (pageText) pageText.textContent = `${current} / ${pages} í˜ì´ì§€`;
            if (pageInfo) pageInfo.textContent = `${current} / ${pages}`;

            const btnFirst = document.getElementById('btn-first');
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            const btnLast = document.getElementById('btn-last');
            
            if (btnFirst) btnFirst.disabled = current <= 1;
            if (btnPrev) btnPrev.disabled = current <= 1;
            if (btnNext) btnNext.disabled = current >= pages;
            if (btnLast) btnLast.disabled = current >= pages;
        },
        
        // ì§ì› ì„ íƒ
        selectEmployee: function(em_id, element) {
            document.querySelectorAll('.employee-row').forEach(row => {
                row.classList.remove('selected');
            });
            
            element.classList.add('selected');
            this.data.selectedEmployeeId = em_id;
            
            const placeholder = document.getElementById('employee-detail-placeholder');
            const content = document.getElementById('employee-detail-content');
            if (placeholder) placeholder.style.display = 'none';
            if (content) content.style.display = 'block';
            
            this.showTab('info');
        },
        
        // íƒ­ í‘œì‹œ
        showTab: function(tabType, element) {
            if (element) {
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                element.classList.add('active');
            }
            
            const tabContent = document.getElementById('tab-content');
            if (!this.data.selectedEmployeeId) {
                if (tabContent) tabContent.innerHTML = '<div class="tab-loading">ì§ì›ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
                return;
            }
            
            if (tabContent) tabContent.innerHTML = '<div class="tab-loading">ë¡œë”© ì¤‘...</div>';
            
            if (tabType === 'info') {
                this.loadEmployeeInfo();
            } else if (tabType === 'history') {
                this.loadEmployeeHistory();
            } else if (tabType === 'license') {
                this.loadEmployeeLicense();
            }
        },
        
        // ì§ì› ìƒì„¸ ì •ë³´ ë¡œë“œ
        loadEmployeeInfo: function() {
            fetch('/fm/em_entry', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ c_type: 'detail', em_id: this.data.selectedEmployeeId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.renderEmployeeDetail(data.data);
                } else {
                    const tabContent = document.getElementById('tab-content');
                    if (tabContent) tabContent.innerHTML = '<div class="tab-error">ì§ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            })
            .catch(error => {
                console.error('ì§ì› ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                const tabContent = document.getElementById('tab-content');
                if (tabContent) tabContent.innerHTML = '<div class="tab-error">ì§ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            });
        },
        
        // ì§ì› ìƒì„¸ ì •ë³´ ë Œë”ë§
        renderEmployeeDetail: function(employee) {
            const html = `
                <table class="detail-table" style="width:100%; border-collapse:collapse; table-layout:fixed; font-size:12px;">
                    <tr>
                        <td class="detail-label">ì´ë¦„</td>
                        <td class="detail-value">${employee.name || ''}
                            <button type="button" class="btn btn-warning" style="float:right;padding:4px 8px;font-size:11px;" onclick="EmployeeModule.editEmployee('${employee.em_id}')">ìˆ˜ì •</button>
                        </td>
                        <td class="detail-label" rowspan="5" style="text-align:center;vertical-align:middle;">ì‚¬ì§„</td>
                        <td class="detail-value" rowspan="5" style="text-align:center;vertical-align:middle;">
                            <img 
                                src="/static/images/employees/${employee.maskname || 'noimg.gif'}" 
                                class="employee-photo" 
                                alt="ì§ì›ì‚¬ì§„" 
                                onerror="this.onerror=null; this.src='/static/images/common/noimg.gif';"
                            >
                        </td>
                    </tr>
                    <tr>
                        <td class="detail-label">ìƒì¼</td>
                        <td class="detail-value">${employee.birthday || ''}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">ì „í™”ë²ˆí˜¸</td>
                        <td class="detail-value">${employee.phone || ''}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">í•¸ë“œí°</td>
                        <td class="detail-value">${employee.mobile_phone || ''}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">ì´ë©”ì¼</td>
                        <td class="detail-value">${employee.email || ''}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">ì£¼ì†Œ</td>
                        <td class="detail-value" colspan="3">${employee.address || ''}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">ì†Œì†</td>
                        <td class="detail-value">${employee.prop_name || ''}</td>
                        <td class="detail-label">ê·¼ë¬´ì§€</td>
                        <td class="detail-value">${employee.work_address || ''}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">ì„±ë³„</td>
                        <td class="detail-value">${employee.sex || ''}</td>
                        <td class="detail-label">íŒŒíŠ¸</td>
                        <td class="detail-value">${employee.emclass_id || ''}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">íšŒì‚¬ëª…</td>
                        <td class="detail-value">${employee.com_id || ''}</td>
                        <td class="detail-label">ì§ê¸‰</td>
                        <td class="detail-value">${employee.emstd_id || ''}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">ë¶€ì„œëª…</td>
                        <td class="detail-value">${employee.dvp_id || ''}</td>
                        <td class="detail-label" rowspan="3" style="text-align: center; vertical-align: middle;">ì‚¬ì¸</td>
                        <td class="detail-value" rowspan="3" style="text-align: center; vertical-align: middle;">
                            ${employee.signature ? 
                                `<img 
                                src="/static/images/signatures/${employee.signature || 'nosign.gif'}" 
                                class="employee-signature" 
                                alt="ì‚¬ì¸" 
                                onerror="this.onerror=null; this.src='/static/images/common/nosign.gif';"
                            />` :
                                `<img src="/static/images/common/nosign.gif" class="employee-signature" alt="ì‚¬ì¸ì—†ìŒ">`
                            }
                        </td>
                    </tr>
                    <tr>
                        <td class="detail-label">ì…ì‚¬ì¼</td>
                        <td class="detail-value">${employee.date_start || ''}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">ë“±ë¡ì¼</td>
                        <td class="detail-value">${employee.date_reg || ''}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">ìƒì˜ ì‚¬ì´ì¦ˆ</td>
                        <td class="detail-value">${employee.top_size || ''}</td>
                        <td class="detail-label">í‡´ì‚¬ì¼</td>
                        <td class="detail-value">${employee.date_end || ''}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">í•˜ì˜ ì‚¬ì´ì¦ˆ</td>
                        <td class="detail-value">${employee.bottom_size || ''}</td>
                        <td class="detail-label">ìˆ˜ì •ì¼</td>
                        <td class="detail-value">${employee.date_modi || ''}</td>
                    </tr>
                </table>
            `;
            
            const tabContent = document.getElementById('tab-content');
            if (tabContent) tabContent.innerHTML = html;
        },
        
        // ì§ì› ì´ë ¥ ë¡œë“œ
        loadEmployeeHistory: function() {
            fetch('/fm/em_entry', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ c_type: 'history', em_id: this.data.selectedEmployeeId })
            })
            .then(response => response.json())
            .then(data => {
                let html = `
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="EmployeeModule.addHistory()">ì´ë ¥ ë“±ë¡</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr><th>ë²ˆí˜¸</th><th>ì„¤ëª…</th><th>íŒŒì¼</th><th>ë“±ë¡ì¼</th></tr>
                        </thead>
                        <tbody>
                `;
                
                if (data.success && data.data.length > 0) {
                    data.data.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.auto_number || ''}</td>
                                <td>${(item.filetype || '') + ' ' + (item.comments || '')}</td>
                                <td>${item.filename || ''}</td>
                                <td>${item.reg_date || ''}</td>
                            </tr>
                        `;
                    });
                } else {
                    html += '<tr><td colspan="4" class="text-center">ë“±ë¡ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                }
                
                html += '</tbody></table>';
                const tabContent = document.getElementById('tab-content');
                if (tabContent) tabContent.innerHTML = html;
            })
            .catch(error => {
                console.error('ì§ì› ì´ë ¥ ë¡œë“œ ì˜¤ë¥˜:', error);
                const tabContent = document.getElementById('tab-content');
                if (tabContent) tabContent.innerHTML = '<div class="tab-error">ì´ë ¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            });
        },
        
        // ì§ì› ìê²©ì¦ ë¡œë“œ
        loadEmployeeLicense: function() {
            fetch('/fm/em_entry', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ c_type: 'license', em_id: this.data.selectedEmployeeId })
            })
            .then(response => response.json())
            .then(data => {
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr><th>ë²ˆí˜¸</th><th>ì§ì›ID</th><th>ìê²©ì¦ëª…</th><th>ì·¨ë“ì¼ì</th><th>ë¹„ê³ </th></tr>
                        </thead>
                        <tbody>
                `;
                
                if (data.success && data.data.length > 0) {
                    data.data.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.licenceem_id || ''}</td>
                                <td>${item.em_id || ''}</td>
                                <td>${item.licence_id || ''}</td>
                                <td>${item.certici_date || ''}</td>
                                <td>${item.description || ''}</td>
                            </tr>
                        `;
                    });
                } else {
                    html += '<tr><td colspan="5" class="text-center">ë“±ë¡ëœ ìê²©ì¦ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                }
                
                html += '</tbody></table>';
                const tabContent = document.getElementById('tab-content');
                if (tabContent) tabContent.innerHTML = html;
            })
            .catch(error => {
                console.error('ì§ì› ìê²©ì¦ ë¡œë“œ ì˜¤ë¥˜:', error);
                const tabContent = document.getElementById('tab-content');
                if (tabContent) tabContent.innerHTML = '<div class="tab-error">ìê²©ì¦ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            });
        },
        
        // ì •ë ¬
        sortBy: function(field) {
            if (this.data.currentSort.field === field) {
                this.data.currentSort.direction = this.data.currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                this.data.currentSort.field = field;
                this.data.currentSort.direction = 'asc';
            }
            
            this.data.currentPage = 1;
            this.searchEmployees();
        },
        
        // í˜ì´ì§€ ë³€ê²½
        changePage: function(pageNo) {
            if (pageNo < 1 || pageNo > this.data.totalPages) return;
            this.data.currentPage = pageNo;
            this.searchEmployees();
        },
        
        // ê¸°íƒ€ ê¸°ëŠ¥ë“¤
        insertEmployee: function() {
            if (window.showStatus) {
                window.showStatus('ì§ì› ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
            } else {
                alert('ì§ì› ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
            }
        },
        
        exportExcel: function() {
            if (!this.data.searchParams.prop_id_chk) {
                alert('ì‚¬ì—…ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const excelParams = new URLSearchParams({
                prop_id_chk: this.data.searchParams.prop_id_chk,
                emclass_id: this.data.searchParams.emclass_id,
                emstd_id: this.data.searchParams.emstd_id,
                status: this.data.searchParams.status,
                name_sch: this.data.searchParams.name_sch
            });
            
            const downloadUrl = `/fm/em_list_excel?${excelParams.toString()}`;
            window.open(downloadUrl, '_blank');
            
            if (window.showStatus) {
                window.showStatus('ì—‘ì…€ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.');
            }
        },
        
        editEmployee: function(em_id) {
            if (window.showStatus) {
                window.showStatus(`ì§ì› ìˆ˜ì • ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤. ì§ì› ID: ${em_id}`);
            } else {
                alert(`ì§ì› ìˆ˜ì • ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤. ì§ì› ID: ${em_id}`);
            }
        },
        
        addHistory: function() {
            if (window.showStatus) {
                window.showStatus('ì´ë ¥ ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
            } else {
                alert('ì´ë ¥ ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
            }
        }
    };
    
    // ì „ì—­ í•¨ìˆ˜ë“¤ì„ ëª¨ë“ˆë¡œ ì—°ê²° (ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ì„±)
    window.searchEmployees = function() { window.EmployeeModule.searchEmployees(); };
    window.sortBy = function(field) { window.EmployeeModule.sortBy(field); };
    window.changePage = function(pageNo) { window.EmployeeModule.changePage(pageNo); };
    window.insertEmployee = function() { window.EmployeeModule.insertEmployee(); };
    window.exportExcel = function() { window.EmployeeModule.exportExcel(); };
    window.showTab = function(tabType, element) { window.EmployeeModule.showTab(tabType, element); };
    
    // ì „ì—­ ì´ˆê¸°í™” í•¨ìˆ˜ ë“±ë¡
    window.initEmployeePage = function() {
        window.EmployeeModule.init();
    };
    
    // ğŸ†• HiddenFrame: ìë™ ì´ˆê¸°í™” (ì¦‰ì‹œ ì‹¤í–‰)
    setTimeout(() => {
        if (!window.EmployeeModule.data.isInitialized) {
            console.log('ğŸ“ ìë™ ì´ˆê¸°í™” ì‹œì‘ (HiddenFrame)');
            window.EmployeeModule.init();
        }
    }, 500);
    
    console.log('ğŸ“ EmployeeModule ë¡œë“œ ì™„ë£Œ (HiddenFrame)');
    
})(); // ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ ë
</script>