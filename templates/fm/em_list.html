<!-- SPA íƒ­ìš© ì§ì›ì •ë³´ í˜ì´ì§€ -->
<link rel="stylesheet" href="/static/css/common.css">
<style>
    /* ì§ì›ì •ë³´ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
    .employee-row { 
        cursor: pointer; 
        transition: background-color 0.15s ease-in-out;
    }
    
    .employee-row:hover { 
        background-color: #f0f7fc !important; 
    }
    
    .employee-row.selected { 
        background-color: #e3f2fd !important; 
        border-left: 3px solid #007bff;
    }
    
    .detail-section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .employee-layout {
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 20px;
        margin-top: 20px;
    }
    
    .employee-list-container {
        position: relative;
    }
    
    .employee-count-info {
        margin-bottom: 10px;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 13px;
        color: #495057;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .employee-detail-placeholder {
        text-align: center; 
        line-height: 300px; 
        color: #6c757d;
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        font-size: 14px;
    }
    
    #employee-detail-content {
        animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
        font-style: italic;
    }
    
    .tab-loading {
        text-align: center; 
        padding: 50px; 
        color: #6c757d;
    }
    
    .tab-error {
        text-align: center; 
        padding: 50px; 
        color: #dc3545;
    }
    
    .employee-photo {
        max-width: 100px;
        max-height: 100px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    .employee-signature {
        max-width: 100px;
        max-height: 60px;
        object-fit: contain;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    @media (max-width: 992px) {
        .employee-layout {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .employee-count-info {
            flex-direction: column;
            gap: 5px;
            text-align: center;
        }
    }
    
    @media (max-width: 768px) {
        .detail-section {
            padding: 10px;
        }
        
        .employee-detail-placeholder {
            line-height: 200px;
            font-size: 12px;
        }
        
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .data-table {
            min-width: 600px;
        }
    }
</style>

<div id="em-list-container">
    <h2>ğŸ“ ì§ì›ì •ë³´ ê´€ë¦¬</h2>

    <!-- ê²€ìƒ‰ í¼ - ì‚¬ì—…ì†Œ ì„ íƒ ì œê±° -->
    <div class="search-form">
        <div class="form-row">
            <div class="form-group col-2">
                <label>íŒŒíŠ¸:</label>
                <select id="emclass_id" class="form-control" onchange="searchEmployees()">
                    <option value="">-ì „ì²´-</option>
                </select>
            </div>
            <div class="form-group col-2">
                <label>ì§ê¸‰:</label>
                <select id="emstd_id" class="form-control" onchange="searchEmployees()">
                    <option value="">-ì „ì²´-</option>
                </select>
            </div>
            <div class="form-group col-2">
                <label>ìƒíƒœ:</label>
                <select id="status" class="form-control" onchange="searchEmployees()">
                    <option value="">-ì „ì²´-</option>
                    <option value="ì¬ì§ì¤‘">ì¬ì§ì¤‘</option>
                    <option value="ì‹ ì²­ì¤‘">ì‹ ì²­ì</option>
                    <option value="í‡´ì§ì">í‡´ì§ì</option>
                    <option value="ê´€ë¦¬ì">ê´€ë¦¬ì</option>
                </select>
            </div>
            <div class="form-group col-3">
                <label>ì´ë¦„:</label>
                <input type="text" id="name_sch" class="form-control" onkeypress="if(event.keyCode==13) searchEmployees()" placeholder="ì´ë¦„ ê²€ìƒ‰">
            </div>
            <div class="form-group col-3" style="text-align: right; display: flex; align-items: end; gap: 5px;">
                <button type="button" class="btn btn-primary" onclick="searchEmployees()">ê²€ìƒ‰</button>
                <button type="button" class="btn btn-success" onclick="insertEmployee()">ë“±ë¡</button>
                <button type="button" class="btn btn-info" onclick="exportExcel()">ì—‘ì…€ì €ì¥</button>
            </div>
        </div>
    </div>

    <div class="employee-layout">
        <!-- ì§ì› ëª©ë¡ -->
        <div class="employee-list-container">
            <div class="employee-count-info">
                <span id="employee-count-text">ì´ 0ëª…</span>
                <span id="employee-page-text">1 / 1 í˜ì´ì§€</span>
            </div>

            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th onclick="sortBy('name')">ì´ë¦„ â†•</th>
                            <th onclick="sortBy('emstd_id')">ì§ê¸‰ â†•</th>
                            <th onclick="sortBy('emclass_id')">íŒŒíŠ¸ â†•</th>
                            <th onclick="sortBy('status')">ìƒíƒœ â†•</th>
                            <th onclick="sortBy('mobile_phone')">í•¸ë“œí° â†•</th>
                        </tr>
                    </thead>
                    <tbody id="employee-table-body">
                        <tr><td colspan="5" class="text-center">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- í˜ì´ì§• -->
            <div class="pagination" id="employee-pagination">
                <button onclick="changePage(1)" id="btn-first">ì²˜ìŒ</button>
                <button onclick="changePage(currentPage-1)" id="btn-prev">â—€ ì´ì „</button>
                <span id="page-info">1 / 1</span>
                <button onclick="changePage(currentPage+1)" id="btn-next">ë‹¤ìŒ â–¶</button>
                <button onclick="changePage(totalPages)" id="btn-last">ë§ˆì§€ë§‰</button>
            </div>
        </div>

        <!-- ì§ì› ìƒì„¸ ì •ë³´ -->
        <div class="detail-section">
            <div id="employee-detail-placeholder" class="employee-detail-placeholder">
                ì§ì›ì„ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤
            </div>
            <div id="employee-detail-content" style="display: none;">
                <!-- íƒ­ ë©”ë‰´ -->
                <div class="nav-tabs">
                    <div class="nav-tab active" onclick="showTab('info', this)">ì§ì›ì •ë³´</div>
                    <div class="nav-tab" onclick="showTab('history', this)">ì´ë ¥ê´€ë¦¬</div>
                    <div class="nav-tab" onclick="showTab('license', this)">ìê²©ì¦</div>
                </div>
                
                <!-- íƒ­ ë‚´ìš© -->
                <div class="tab-content" id="tab-content">
                    <!-- ì„ íƒëœ íƒ­ì˜ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜
console.log('ğŸ“ em_list.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');
console.log('ğŸ“ í˜„ì¬ window ê°ì²´:', {
    currentEmId: window.currentEmId,
    currentPropId: window.currentPropId,
    userInfo: window.userInfo
});

let selectedEmployeeId = null;
let currentSort = { field: 'basic', direction: 'asc' };
let currentPage = 1;
let totalPages = 1;
let totalCount = 0;
let searchParams = {
    prop_id_chk: '',
    emclass_id: '',
    emstd_id: '',
    status: '',
    name_sch: '',
    order: 'basic',
    desc: 'asc',
    page_no: 1
};

// í˜ì´ì§€ ì´ˆê¸°í™” - base.htmlì˜ em_id, prop_id ì§ì ‘ ì‚¬ìš©
function initEmployeePage() {
    console.log('ğŸ“ ì§ì›ì •ë³´ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
    
    // base.htmlì—ì„œ em_idì™€ prop_id ê°€ì ¸ì˜¤ê¸°
    const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
    const prop_id = window.currentPropId;
    
    console.log('ğŸ“ ë°›ì€ ë°ì´í„°:', { em_id, prop_id });
    
    if (!em_id) {
        console.error('ğŸ“ em_idê°€ ì—†ìŠµë‹ˆë‹¤.');
        document.getElementById('employee-table-body').innerHTML = 
            '<tr><td colspan="5" class="text-center text-danger">ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }
    
    if (!prop_id) {
        console.error('ğŸ“ prop_idê°€ ì—†ìŠµë‹ˆë‹¤.');
        document.getElementById('employee-table-body').innerHTML = 
            '<tr><td colspan="5" class="text-center text-danger">ì‚¬ì—…ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</td></tr>';
        return;
    }
    
    // ê²€ìƒ‰ íŒŒë¼ë¯¸í„°ì— ì„¤ì •
    searchParams.prop_id_chk = prop_id;
    
    console.log('ğŸ“ ê²€ìƒ‰ íŒŒë¼ë¯¸í„° ì„¤ì • ì™„ë£Œ:', searchParams);
    
    // í•„í„° ì˜µì…˜ ë¡œë“œ
    loadFilterOptions();
    
    // ê²€ìƒ‰ ì‹¤í–‰
    setTimeout(() => {
        console.log('ğŸ“ ì§ì› ê²€ìƒ‰ ì‹¤í–‰ ì‹œì‘');
        searchEmployees();
    }, 500);
}

// base.htmlì˜ ì‚¬ì—…ì†Œ ë³€ê²½ ê°ì§€ (ì „ì—­ í•¨ìˆ˜) - ë” ì•ˆì •ì ìœ¼ë¡œ ìˆ˜ì •
window.onEmployeePagePropChange = function(newPropId) {
    console.log('ğŸ“ ì‚¬ì—…ì†Œ ë³€ê²½ ê°ì§€:', newPropId);
    
    if (!newPropId) {
        console.warn('ğŸ“ ìƒˆë¡œìš´ prop_idê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    searchParams.prop_id_chk = newPropId;
    
    // ì„ íƒëœ ì§ì› ì´ˆê¸°í™”
    selectedEmployeeId = null;
    document.getElementById('employee-detail-placeholder').style.display = 'block';
    document.getElementById('employee-detail-content').style.display = 'none';
    
    // í•„í„° ì˜µì…˜ ë‹¤ì‹œ ë¡œë“œ
    loadFilterOptions();
    
    // ê²€ìƒ‰ ë‹¤ì‹œ ì‹¤í–‰
    setTimeout(() => {
        console.log('ğŸ“ ì‚¬ì—…ì†Œ ë³€ê²½ í›„ ê²€ìƒ‰ ì‹¤í–‰');
        searchEmployees();
    }, 300);
};

// í•„í„° ì˜µì…˜ ë¡œë“œ (íŒŒíŠ¸, ì§ê¸‰, ìƒíƒœ) - JSPì™€ ë™ì¼í•œ ë°©ì‹
function loadFilterOptions() {
    const propId = searchParams.prop_id_chk;
    if (!propId) return;

    // íŒŒíŠ¸ ëª©ë¡ - JSPì™€ ë™ì¼í•œ ì¡°íšŒ ë°©ì‹
    fetch('/common/get_select_options', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            table: 'emclass',
            id_field: 'emclass_id',
            text_field: 'emclass_id',
            conditions: { prop_id: propId },
            order_by: 'vieworder ASC'
        })
    })
    .then(response => response.json())
    .then(data => {
        const select = document.getElementById('emclass_id');
        select.innerHTML = '<option value="">-ì „ì²´-</option>';
        if (data.success) {
            data.data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.text;
                select.appendChild(option);
            });
        }
    });

    // ì§ê¸‰ ëª©ë¡ - JSPì™€ ë™ì¼í•œ ì¡°íšŒ ë°©ì‹
    fetch('/common/get_select_options', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            table: 'emstd',
            id_field: 'emstd_id',
            text_field: 'emstd_id',
            conditions: { prop_id: propId },
            order_by: 'vieworder ASC'
        })
    })
    .then(response => response.json())
    .then(data => {
        const select = document.getElementById('emstd_id');
        select.innerHTML = '<option value="">-ì „ì²´-</option>';
        if (data.success) {
            data.data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.text;
                select.appendChild(option);
            });
        }
    });
}

// ì§ì› ê²€ìƒ‰ - ë” ì•ˆì •ì ìœ¼ë¡œ ìˆ˜ì •
function searchEmployees() {
    console.log('ğŸ“ ì§ì› ê²€ìƒ‰ ì‹¤í–‰ ì‹œì‘');
    
    // prop_id í™•ì¸
    if (!searchParams.prop_id_chk) {
        // base.htmlì—ì„œ í˜„ì¬ ì„ íƒëœ ì‚¬ì—…ì†Œ ë‹¤ì‹œ í™•ì¸
        const prop_id = window.currentPropId;
        if (prop_id) {
            searchParams.prop_id_chk = prop_id;
            console.log('ğŸ“ base.htmlì—ì„œ prop_id ì¬ì„¤ì •:', prop_id);
        } else {
            console.error('ğŸ“ prop_idë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            document.getElementById('employee-table-body').innerHTML = 
                '<tr><td colspan="5" class="text-center text-danger">ì‚¬ì—…ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</td></tr>';
            return;
        }
    }
    
    // ê²€ìƒ‰ ì¡°ê±´ ìˆ˜ì§‘
    searchParams = {
        prop_id_chk: searchParams.prop_id_chk,
        emclass_id: document.getElementById('emclass_id').value,
        emstd_id: document.getElementById('emstd_id').value,
        status: document.getElementById('status').value,
        name_sch: document.getElementById('name_sch').value,
        order: currentSort.field,
        desc: currentSort.direction,
        page_no: currentPage
    };

    console.log('ğŸ“ ìµœì¢… ê²€ìƒ‰ íŒŒë¼ë¯¸í„°:', searchParams);

    // ë¡œë”© í‘œì‹œ
    document.getElementById('employee-table-body').innerHTML = 
        '<tr><td colspan="5" class="text-center">ê²€ìƒ‰ ì¤‘...</td></tr>';

    // AJAX ìš”ì²­
    fetch('/fm/em_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            c_type: 'list',
            ...searchParams
        })
    })
    .then(response => {
        console.log('ğŸ“ ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('ğŸ“ ì„œë²„ ì‘ë‹µ ë°ì´í„°:', data);
        
        if (data.success) {
            console.log('ğŸ“ ì§ì› ë°ì´í„° ìˆ˜ì‹  ì„±ê³µ, ê±´ìˆ˜:', data.data.length);
            renderEmployeeList(data.data);
            updatePagination(data.total_count, data.total_pages, data.current_page);
        } else {
            console.error('ğŸ“ ê²€ìƒ‰ ì‹¤íŒ¨:', data.message);
            document.getElementById('employee-table-body').innerHTML = 
                '<tr><td colspan="5" class="text-center text-danger">ê²€ìƒ‰ ì‹¤íŒ¨: ' + data.message + '</td></tr>';
        }
    })
    .catch(error => {
        console.error('ğŸ“ ì§ì› ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        document.getElementById('employee-table-body').innerHTML = 
            '<tr><td colspan="5" class="text-center text-danger">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</td></tr>';
    });
}

// ì§ì› ëª©ë¡ ë Œë”ë§
function renderEmployeeList(employees) {
    const tbody = document.getElementById('employee-table-body');
    
    if (employees.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }

    let html = '';
    employees.forEach(emp => {
        html += `
            <tr class="employee-row" onclick="selectEmployee('${emp.em_id}', this)">
                <td>${emp.name || ''}</td>
                <td>${emp.emstd_id || ''}</td>
                <td>${emp.emclass_id || ''}</td>
                <td>${emp.status || ''}</td>
                <td>${emp.mobile_phone || ''}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// í˜ì´ì§• ì •ë³´ ì—…ë°ì´íŠ¸
function updatePagination(total, pages, current) {
    totalCount = total;
    totalPages = pages;
    currentPage = current;

    // ì¹´ìš´íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
    document.getElementById('employee-count-text').textContent = `ì´ ${total}ëª…`;
    document.getElementById('employee-page-text').textContent = `${current} / ${pages} í˜ì´ì§€`;
    document.getElementById('page-info').textContent = `${current} / ${pages}`;

    // í˜ì´ì§• ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    document.getElementById('btn-first').disabled = current <= 1;
    document.getElementById('btn-prev').disabled = current <= 1;
    document.getElementById('btn-next').disabled = current >= pages;
    document.getElementById('btn-last').disabled = current >= pages;
}

// ì§ì› ì„ íƒ
function selectEmployee(em_id, element) {
    // ê¸°ì¡´ ì„ íƒ ì œê±°
    document.querySelectorAll('.employee-row').forEach(row => {
        row.classList.remove('selected');
    });
    
    // ìƒˆë¡œ ì„ íƒ
    element.classList.add('selected');
    selectedEmployeeId = em_id;
    
    // ìƒì„¸ ì •ë³´ í‘œì‹œ
    document.getElementById('employee-detail-placeholder').style.display = 'none';
    document.getElementById('employee-detail-content').style.display = 'block';
    
    // ê¸°ë³¸ì ìœ¼ë¡œ ì§ì›ì •ë³´ íƒ­ í‘œì‹œ
    showTab('info');
}

// íƒ­ í‘œì‹œ
function showTab(tabType, element) {
    // íƒ­ í™œì„±í™”
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    if (element) element.classList.add('active');
    
    const tabContent = document.getElementById('tab-content');
    if (!selectedEmployeeId) {
        tabContent.innerHTML = '<div class="tab-loading">ì§ì›ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
        return;
    }
    
    tabContent.innerHTML = '<div class="tab-loading">ë¡œë”© ì¤‘...</div>';
    
    if (tabType === 'info') {
        loadEmployeeInfo();
    } else if (tabType === 'history') {
        loadEmployeeHistory();
    } else if (tabType === 'license') {
        loadEmployeeLicense();
    }
}

// ì§ì› ìƒì„¸ ì •ë³´ ë¡œë“œ
function loadEmployeeInfo() {
    fetch('/fm/em_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ c_type: 'detail', em_id: selectedEmployeeId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderEmployeeDetail(data.data);
        } else {
            document.getElementById('tab-content').innerHTML = 
                '<div class="tab-error">ì§ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    })
    .catch(error => {
        console.error('ì§ì› ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('tab-content').innerHTML = 
            '<div class="tab-error">ì§ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    });
}

// ì§ì› ìƒì„¸ ì •ë³´ ë Œë”ë§
function renderEmployeeDetail(employee) {
    const html = `
        <table class="detail-table" style="width:100%; border-collapse:collapse; table-layout:fixed; font-size:12px;">
            <tr>
                <td class="detail-label">ì´ë¦„</td>
                <td class="detail-value">${employee.name || ''}
                    <button type="button" class="btn btn-warning" style="float:right;padding:4px 8px;font-size:11px;" onclick="editEmployee('${employee.em_id}')">ìˆ˜ì •</button>
                </td>
                <td class="detail-label" rowspan="5" style="text-align:center;vertical-align:middle;">ì‚¬ì§„</td>
                <td class="detail-value" rowspan="5" style="text-align:center;vertical-align:middle;">
                    ${employee.maskname ? 
                        `<img src="/static/images/employees/${employee.maskname}" class="employee-photo" alt="ì§ì›ì‚¬ì§„" onerror="this.src='/static/images/common/noimg.gif'">` :
                        `<img src="/static/images/common/noimg.gif" class="employee-photo" alt="ì‚¬ì§„ì—†ìŒ">`
                    }
                </td>
            </tr>
            <tr>
                <td class="detail-label">ìƒì¼</td>
                <td class="detail-value">${employee.birthday || ''}</td>
            </tr>
            <tr>
                <td class="detail-label">ì „í™”ë²ˆí˜¸</td>
                <td class="detail-value">${employee.phone || ''}</td>
            </tr>
            <tr>
                <td class="detail-label">í•¸ë“œí°</td>
                <td class="detail-value">${employee.mobile_phone || ''}</td>
            </tr>
            <tr>
                <td class="detail-label">ì´ë©”ì¼</td>
                <td class="detail-value">${employee.email || ''}</td>
            </tr>
            <tr>
                <td class="detail-label">ì£¼ì†Œ</td>
                <td class="detail-value" colspan="3">${employee.address || ''}</td>
            </tr>
            <tr>
                <td class="detail-label">ì†Œì†</td>
                <td class="detail-value">${employee.prop_name || ''}</td>
                <td class="detail-label">ê·¼ë¬´ì§€</td>
                <td class="detail-value">${employee.work_address || ''}</td>
            </tr>
            <tr>
                <td class="detail-label">ì„±ë³„</td>
                <td class="detail-value">${employee.sex || ''}</td>
                <td class="detail-label">íŒŒíŠ¸</td>
                <td class="detail-value">${employee.emclass_id || ''}</td>
            </tr>
            <tr>
                <td class="detail-label">íšŒì‚¬ëª…</td>
                <td class="detail-value">${employee.com_id || ''}</td>
                <td class="detail-label">ì§ê¸‰</td>
                <td class="detail-value">${employee.emstd_id || ''}</td>
            </tr>
            <tr>
                <td class="detail-label">ë¶€ì„œëª…</td>
                <td class="detail-value">${employee.dvp_id || ''}</td>
                <td class="detail-label" rowspan="3" style="text-align: center; vertical-align: middle;">ì‚¬ì¸</td>
                <td class="detail-value" rowspan="3" style="text-align: center; vertical-align: middle;">
                    ${employee.signature ? 
                        `<img src="/static/images/signatures/${employee.signature}" class="employee-signature" alt="ì‚¬ì¸" onerror="this.src='/static/images/common/nosign.gif'">` :
                        `<img src="/static/images/common/nosign.gif" class="employee-signature" alt="ì‚¬ì¸ì—†ìŒ">`
                    }
                </td>
            </tr>
            <tr>
                <td class="detail-label">ì…ì‚¬ì¼</td>
                <td class="detail-value">${employee.date_start || ''}</td>
            </tr>
            <tr>
                <td class="detail-label">ë“±ë¡ì¼</td>
                <td class="detail-value">${employee.date_reg || ''}</td>
            </tr>
            <tr>
                <td class="detail-label">ìƒì˜ ì‚¬ì´ì¦ˆ</td>
                <td class="detail-value">${employee.top_size || ''}</td>
                <td class="detail-label">í‡´ì‚¬ì¼</td>
                <td class="detail-value">${employee.date_end || ''}</td>
            </tr>
            <tr>
                <td class="detail-label">í•˜ì˜ ì‚¬ì´ì¦ˆ</td>
                <td class="detail-value">${employee.bottom_size || ''}</td>
                <td class="detail-label">ìˆ˜ì •ì¼</td>
                <td class="detail-value">${employee.date_modi || ''}</td>
            </tr>
        </table>
    `;
    
    document.getElementById('tab-content').innerHTML = html;
}

// ì§ì› ì´ë ¥ ë¡œë“œ
function loadEmployeeHistory() {
    fetch('/fm/em_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ c_type: 'history', em_id: selectedEmployeeId })
    })
    .then(response => response.json())
    .then(data => {
        let html = `
            <div style="margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="addHistory()">ì´ë ¥ ë“±ë¡</button>
            </div>
            <table class="data-table">
                <thead>
                    <tr><th>ë²ˆí˜¸</th><th>ì„¤ëª…</th><th>íŒŒì¼</th><th>ë“±ë¡ì¼</th></tr>
                </thead>
                <tbody>
        `;
        
        if (data.success && data.data.length > 0) {
            data.data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.auto_number || ''}</td>
                        <td>${(item.filetype || '') + ' ' + (item.comments || '')}</td>
                        <td>${item.filename || ''}</td>
                        <td>${item.reg_date || ''}</td>
                    </tr>
                `;
            });
        } else {
            html += '<tr><td colspan="4" class="text-center">ë“±ë¡ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
        
        html += '</tbody></table>';
        document.getElementById('tab-content').innerHTML = html;
    })
    .catch(error => {
        console.error('ì§ì› ì´ë ¥ ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('tab-content').innerHTML = 
            '<div class="tab-error">ì´ë ¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    });
}

// ì§ì› ìê²©ì¦ ë¡œë“œ
function loadEmployeeLicense() {
    fetch('/fm/em_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ c_type: 'license', em_id: selectedEmployeeId })
    })
    .then(response => response.json())
    .then(data => {
        let html = `
            <table class="data-table">
                <thead>
                    <tr><th>ë²ˆí˜¸</th><th>ì§ì›ID</th><th>ìê²©ì¦ëª…</th><th>ì·¨ë“ì¼ì</th><th>ë¹„ê³ </th></tr>
                </thead>
                <tbody>
        `;
        
        if (data.success && data.data.length > 0) {
            data.data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.licenceem_id || ''}</td>
                        <td>${item.em_id || ''}</td>
                        <td>${item.licence_id || ''}</td>
                        <td>${item.certici_date || ''}</td>
                        <td>${item.description || ''}</td>
                    </tr>
                `;
            });
        } else {
            html += '<tr><td colspan="5" class="text-center">ë“±ë¡ëœ ìê²©ì¦ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
        
        html += '</tbody></table>';
        document.getElementById('tab-content').innerHTML = html;
    })
    .catch(error => {
        console.error('ì§ì› ìê²©ì¦ ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('tab-content').innerHTML = 
            '<div class="tab-error">ìê²©ì¦ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    });
}

// ì •ë ¬
function sortBy(field) {
    if (currentSort.field === field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.field = field;
        currentSort.direction = 'asc';
    }
    
    currentPage = 1; // ì •ë ¬ ì‹œ ì²« í˜ì´ì§€ë¡œ
    searchEmployees();
}

// í˜ì´ì§€ ë³€ê²½
function changePage(pageNo) {
    if (pageNo < 1 || pageNo > totalPages) return;
    currentPage = pageNo;
    searchEmployees();
}

// JSP ê¸°ëŠ¥ - ê²€ìƒ‰, ë“±ë¡, ì—‘ì…€ì €ì¥
function insertEmployee() {
    if (window.showStatus) {
        window.showStatus('ì§ì› ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    } else {
        alert('ì§ì› ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    }
}

function exportExcel() {
    if (!searchParams.prop_id_chk) {
        alert('ì‚¬ì—…ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ íŒŒë¼ë¯¸í„° êµ¬ì„±
    const excelParams = new URLSearchParams({
        prop_id_chk: searchParams.prop_id_chk,
        emclass_id: searchParams.emclass_id,
        emstd_id: searchParams.emstd_id,
        status: searchParams.status,
        name_sch: searchParams.name_sch
    });
    
    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
    const downloadUrl = `/fm/em_list_excel?${excelParams.toString()}`;
    window.open(downloadUrl, '_blank');
    
    if (window.showStatus) {
        window.showStatus('ì—‘ì…€ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.');
    }
}

function editEmployee(em_id) {
    if (window.showStatus) {
        window.showStatus(`ì§ì› ìˆ˜ì • ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤. ì§ì› ID: ${em_id}`);
    } else {
        alert(`ì§ì› ìˆ˜ì • ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤. ì§ì› ID: ${em_id}`);
    }
}

function addHistory() {
    if (window.showStatus) {
        window.showStatus('ì´ë ¥ ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    } else {
        alert('ì´ë ¥ ë“±ë¡ ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
    }
}

// í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤í–‰ - ë” ì•ˆì •ì ìœ¼ë¡œ ìˆ˜ì •
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ“ em_list DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
    console.log('ğŸ“ í˜„ì¬ window ê°ì²´ ìƒíƒœ:');
    console.log('   - currentEmId:', window.currentEmId);
    console.log('   - currentPropId:', window.currentPropId);
    console.log('   - userInfo:', window.userInfo);
    
    // base.html ë°ì´í„° í™•ì¸ í•¨ìˆ˜
    function checkBaseData() {
        const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
        const prop_id = window.currentPropId;
        
        console.log('ğŸ“ base.html ë°ì´í„° í™•ì¸ ê²°ê³¼:', { em_id, prop_id });
        
        if (em_id && prop_id) {
            console.log('ğŸ“ âœ… base.html ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘');
            initEmployeePage();
            return true;
        } else {
            console.log('ğŸ“ âŒ base.html ë°ì´í„° ë¶€ì¡±:', {
                em_id_exists: !!em_id,
                prop_id_exists: !!prop_id
            });
        }
        
        return false;
    }
    
    // ì¦‰ì‹œ í™•ì¸
    if (checkBaseData()) {
        return;
    }
    
    console.log('ğŸ“ ë°ì´í„° ëŒ€ê¸° ì‹œì‘...');
    
    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ëŒ€ê¸°
    const checkUserInfo = setInterval(() => {
        if (checkBaseData()) {
            clearInterval(checkUserInfo);
        }
    }, 100);
    
    // ìµœëŒ€ 10ì´ˆ ëŒ€ê¸°
    setTimeout(() => {
        clearInterval(checkUserInfo);
        if (!window.currentEmId || !window.currentPropId) {
            console.error('ğŸ“ 10ì´ˆ ëŒ€ê¸° í›„ì—ë„ base.html ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í•¨');
            document.getElementById('employee-table-body').innerHTML = 
                '<tr><td colspan="5" class="text-center text-danger">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.</td></tr>';
        }
    }, 10000);
});

// ì´ˆê¸°í™” í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (íƒ­ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
window.initEmployeePage = initEmployeePage;
window.searchEmployees = searchEmployees;
// ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í™•ì¸
console.log('ğŸ“ em_list.html ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
console.log('ğŸ“ initEmployeePage í•¨ìˆ˜ ì¡´ì¬:', typeof initEmployeePage);

// ì¦‰ì‹œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
setTimeout(() => {
    console.log('ğŸ“ 3ì´ˆ í›„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰');
    if (window.currentEmId && window.currentPropId) {
        console.log('ğŸ“ ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œë„');
        initEmployeePage();
    } else {
        console.log('ğŸ“ ë°ì´í„° ì•„ì§ ì¤€ë¹„ ì•ˆë¨');
    }
}, 3000);
</script>