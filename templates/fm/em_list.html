{% extends "base.html" %}

{% block title %}직원정보 - FMS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
<style>
    /* 직원정보 페이지 전용 스타일 */
    
    /* 직원 목록 행 스타일 */
    .employee-row { 
        cursor: pointer; 
        transition: background-color 0.15s ease-in-out;
    }
    
    .employee-row:hover { 
        background-color: #f0f7fc !important; 
    }
    
    .employee-row.selected { 
        background-color: #e3f2fd !important; 
        border-left: 3px solid #007bff;
    }
    
    /* 직원 상세 정보 섹션 */
    .detail-section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    /* 직원정보 레이아웃 */
    .employee-layout {
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 20px;
        margin-top: 20px;
    }
    
    /* 직원 목록 컨테이너 */
    .employee-list-container {
        position: relative;
    }
    
    .employee-count-info {
        margin-bottom: 10px;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 13px;
        color: #495057;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* 직원 상세 정보 플레이스홀더 */
    .employee-detail-placeholder {
        text-align: center; 
        line-height: 300px; 
        color: #6c757d;
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        font-size: 14px;
    }
    
    /* 직원 상세 정보 활성화 상태 */
    #employee-detail-content {
        animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* 검색 결과 없음 메시지 */
    .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
        font-style: italic;
    }
    
    /* 탭 컨텐츠 로딩 상태 */
    .tab-loading {
        text-align: center; 
        padding: 50px; 
        color: #6c757d;
    }
    
    .tab-error {
        text-align: center; 
        padding: 50px; 
        color: #dc3545;
    }
    
    /* 직원 사진 스타일 */
    .employee-photo {
        max-width: 100px;
        max-height: 100px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    .employee-signature {
        max-width: 100px;
        max-height: 60px;
        object-fit: contain;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    /* 반응형 레이아웃 */
    @media (max-width: 992px) {
        .employee-layout {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .employee-count-info {
            flex-direction: column;
            gap: 5px;
            text-align: center;
        }
    }
    
    @media (max-width: 768px) {
        .detail-section {
            padding: 10px;
        }
        
        .employee-detail-placeholder {
            line-height: 200px;
            font-size: 12px;
        }
        
        /* 모바일에서 테이블 스크롤 */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .data-table {
            min-width: 600px;
        }
    }
</style>
{% endblock %}
{% block sidebar_menu %}
<a href="{{ url_for('em.em_list') }}" class="menu-item active">
    📝 직원정보

{% endblock %}

{% block content %}
<div>
    <h2>📝 직원정보 관리</h2>

    <form id="employee-search-form" method="GET">
        <div class="form-row">
            <div class="form-group col-2">
                <label>사업소:</label>
                <select name="prop_id_chk" class="form-control" onchange="this.form.submit()">
                    {% for p in prop_list %}
                    <option value="{{ p.prop_id }}" {% if search_params.prop_id_chk==p.prop_id %}selected{% endif %}>
                        {{ p.prop_id }} {{ p.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group col-2">
                <label>파트:</label>
                <select name="emclass_id" class="form-control" onchange="this.form.submit()">
                    <option value="">-전체-</option>
                    {% for c in emclass_list %}
                    <option value="{{ c.emclass_id }}" {% if search_params.emclass_id==c.emclass_id %}selected{% endif %}>
                        {{ c.emclass_id }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group col-2">
                <label>직급:</label>
                <select name="emstd_id" class="form-control" onchange="this.form.submit()">
                    <option value="">-전체-</option>
                    {% for s in emstd_list %}
                    <option value="{{ s.emstd_id }}" {% if search_params.emstd_id==s.emstd_id %}selected{% endif %}>
                        {{ s.emstd_id }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group col-2">
                <label>상태:</label>
                <select name="status" class="form-control" onchange="this.form.submit()">
                    <option value="">-전체-</option>
                    {% for s in status_list %}
                    <option value="{{ s.status }}" {% if search_params.status==s.status %}selected{% endif %}>
                        {{ s.status }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group col-3">
                <label>이름:</label>
                <input type="text" name="name_sch" class="form-control" value="{{ search_params.name_sch }}" onkeypress="if(event.keyCode==13) this.form.submit()">
            </div>
        </div>
        <input type="hidden" name="order" value="{{ search_params.order }}">
        <input type="hidden" name="desc" value="{{ search_params.desc }}">
        <input type="hidden" name="page_no" value="{{ current_page }}">
    </form>

    <div class="employee-count-info">
        <span>총 {{ total_count }}명</span>
        <span>{{ current_page }} / {{ total_pages }} 페이지</span>
    </div>

    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th onclick="sortBy('name')">이름</th>
                    <th onclick="sortBy('emstd_id')">직급</th>
                    <th onclick="sortBy('emclass_id')">파트</th>
                    <th onclick="sortBy('status')">상태</th>
                    <th onclick="sortBy('mobile_phone')">핸드폰</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in em_list %}
                <tr class="employee-row" onclick="selectEmployee('{{ emp.em_id }}', this)">
                    <td>{{ emp.name }}</td>
                    <td>{{ emp.emstd_id }}</td>
                    <td>{{ emp.emclass_id }}</td>
                    <td>{{ emp.status }}</td>
                    <td>{{ emp.mobile_phone }}</td>
                </tr>
                {% else %}
                <tr><td colspan="5">검색 결과가 없습니다.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 페이징 -->
    <div class="pagination">
        {% set prev = current_page-1 if current_page>1 else 1 %}
        {% set nxt = current_page+1 if current_page<total_pages else total_pages %}
        <button {% if current_page==1 %}disabled{% endif %} onclick="changePage('{{ prev }}')">◀ 이전</button>
        <span>{{ current_page }} / {{ total_pages }}</span>
        <button {% if current_page == total_pages %}disabled{% endif %} onclick="changePage('{{ nxt }}')">다음 ▶</button>
    </div>
</div>

<script>
function sortBy(field) {
    const form = document.getElementById('employee-search-form');
    let desc = form.order.value===field && form.desc.value==='asc' ? 'desc' : 'asc';
    form.order.value = field;
    form.desc.value = desc;
    form.page_no.value = 1;
    form.submit();
}
function changePage(page) {
    const form = document.getElementById('employee-search-form');
    form.page_no.value = page;
    form.submit();
}
</script>
<script>
let selectedEmployeeId = null;
let currentSort = { field: 'basic', direction: 'asc' };

// 직원 선택
function selectEmployee(em_id, element) {
    // 기존 선택 제거
    document.querySelectorAll('.employee-row').forEach(row => {
        row.classList.remove('selected');
    });
    
    // 새로 선택
    element.classList.add('selected');
    selectedEmployeeId = em_id;
    
    // 상세 정보 표시
    document.getElementById('employee-detail-placeholder').style.display = 'none';
    document.getElementById('employee-detail-content').style.display = 'block';
    
    // 기본적으로 직원정보 탭 표시
    showTab('info');
}

// 탭 표시
function showTab(tabType, element) {
    // 탭 활성화
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    if (element) element.classList.add('active');
    
    const tabContent = document.getElementById('tab-content');
    if (!selectedEmployeeId) {
        tabContent.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">직원을 먼저 선택해주세요.</div>';
        return;
    }
    
    tabContent.innerHTML = '<div style="text-align: center; padding: 50px;">로딩 중...</div>';
    
    if (tabType === 'info') {
        loadEmployeeInfo();
    } else if (tabType === 'history') {
        loadEmployeeHistory();
    } else if (tabType === 'license') {
        loadEmployeeLicense();
    }
}

// 직원 상세 정보 로드
function loadEmployeeInfo() {
    fetch(`/em/em_detail/${selectedEmployeeId}`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('tab-content').innerHTML = html;
        })
        .catch(error => {
            console.error('직원 정보 로드 오류:', error);
            document.getElementById('tab-content').innerHTML = 
                '<div style="text-align: center; padding: 50px; color: #dc3545;">직원 정보를 불러올 수 없습니다.</div>';
        });
}

// 직원 이력 로드
function loadEmployeeHistory() {
    fetch('/em/em_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ c_type: 'history', em_id: selectedEmployeeId })
    })
    .then(response => response.json())
    .then(data => {
        let html = `
            <div style="margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="addHistory()">이력 등록</button>
            </div>
            <table class="employee-table">
                <thead>
                    <tr><th>번호</th><th>설명</th><th>파일</th><th>등록일</th></tr>
                </thead>
                <tbody>
        `;
        
        if (data.success && data.data.length > 0) {
            data.data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.auto_number || ''}</td>
                        <td>${(item.filetype || '') + ' ' + (item.comments || '')}</td>
                        <td>${item.filename || ''}</td>
                        <td>${item.reg_date || ''}</td>
                    </tr>
                `;
            });
        } else {
            html += '<tr><td colspan="4">등록된 이력이 없습니다.</td></tr>';
        }
        
        html += '</tbody></table>';
        document.getElementById('tab-content').innerHTML = html;
    })
    .catch(error => {
        console.error('직원 이력 로드 오류:', error);
        document.getElementById('tab-content').innerHTML = 
            '<div style="text-align: center; padding: 50px; color: #dc3545;">이력 정보를 불러올 수 없습니다.</div>';
    });
}

// 직원 자격증 로드
function loadEmployeeLicense() {
    fetch('/em/em_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ c_type: 'license', em_id: selectedEmployeeId })
    })
    .then(response => response.json())
    .then(data => {
        let html = `
            <table class="employee-table">
                <thead>
                    <tr><th>번호</th><th>직원ID</th><th>자격증명</th><th>취득일자</th><th>비고</th></tr>
                </thead>
                <tbody>
        `;
        
        if (data.success && data.data.length > 0) {
            data.data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.licenceem_id || ''}</td>
                        <td>${item.em_id || ''}</td>
                        <td>${item.licence_id || ''}</td>
                        <td>${item.certici_date || ''}</td>
                        <td>${item.description || ''}</td>
                    </tr>
                `;
            });
        } else {
            html += '<tr><td colspan="5">등록된 자격증이 없습니다.</td></tr>';
        }
        
        html += '</tbody></table>';
        document.getElementById('tab-content').innerHTML = html;
    })
    .catch(error => {
        console.error('직원 자격증 로드 오류:', error);
        document.getElementById('tab-content').innerHTML = 
            '<div style="text-align: center; padding: 50px; color: #dc3545;">자격증 정보를 불러올 수 없습니다.</div>';
    });
}

// 정렬
function sortBy(field) {
    if (currentSort.field === field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.field = field;
        currentSort.direction = 'asc';
    }
    
    const form = document.getElementById('employee-search-form');
    form.querySelector('input[name="order"]').value = field;
    form.querySelector('input[name="desc"]').value = currentSort.direction;
    form.querySelector('input[name="page_no"]').value = '1';
    form.submit();
}

// 페이지 변경
function changePage(pageNo) {
    const form = document.getElementById('employee-search-form');
    form.querySelector('input[name="page_no"]').value = pageNo;
    form.submit();
}

// 검색 초기화
function resetSearch() {
    const form = document.getElementById('employee-search-form');
    form.reset();
    form.querySelector('input[name="page_no"]').value = '1';
    form.submit();
}

// 기타 함수들
function exportExcel() {
    if (window.showStatus) {
        window.showStatus('엑셀 저장 기능을 구현 중입니다.');
    } else {
        alert('엑셀 저장 기능을 구현 중입니다.');
    }
}

function addEmployee() {
    if (window.showStatus) {
        window.showStatus('직원 등록 기능을 구현 중입니다.');
    } else {
        alert('직원 등록 기능을 구현 중입니다.');
    }
}

function addHistory() {
    if (window.showStatus) {
        window.showStatus('이력 등록 기능을 구현 중입니다.');
    } else {
        alert('이력 등록 기능을 구현 중입니다.');
    }
}
</script>
{% endblock %}