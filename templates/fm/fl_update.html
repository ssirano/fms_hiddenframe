<link rel="stylesheet" href="/static/css/common.css">
<style>
    /* fl_update ìŠ¤íƒ€ì¼ - bl_updateì™€ ì¼ê´€ì„± ë§ì¶¤ */
    #fl_update_outer {
        padding: 20px;
        padding-bottom: 0;
        overflow-y: auto;
        background-color: #f8f9fa;
        font-size: 12px;
    }

    #fl_update_outer .button-area {
        text-align: right;
        margin-bottom: 15px;
        padding: 15px;
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    #fl_update_outer .button-area button {
        margin-left: 5px;
        padding: 6px 12px;
        background: #fff;
        color: #333;
        border: 1px solid #ced4da;
        font-size: 12px;
        font-family: inherit;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s ease-in-out;
    }

    #fl_update_outer .button-area button:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
    }

    #fl_update_outer .button-area button.btn-primary {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }

    #fl_update_outer .button-area button.btn-primary:hover {
        background: #0056b3;
        border-color: #004085;
    }

    #fl_update_outer .selection-area {
        margin-bottom: 15px;
    }

    #fl_update_outer .selection-area .table {
        margin-bottom: 0;
        background-color: white;
        border-collapse: collapse;
        font-size: 12px;
    }

    #fl_update_outer .selection-area .table td {
        padding: 8px;
        border: 1px solid #dee2e6;
        vertical-align: middle;
    }

    #fl_update_outer .selection-area .table-header {
        background-color: #f8f9fa;
        font-weight: bold;
        text-align: center;
        width: 10%;
    }

    #fl_update_outer .content-area {
        background-color: white;
        border-radius: 5px;
        border: 1px solid #dee2e6;
        min-height: 400px;
        padding: 20px;
    }

    #fl_update_outer .form-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        font-size: 12px;
    }

    #fl_update_outer .form-table td {
        padding: 8px;
        border: 1px solid #dee2e6;
        vertical-align: middle;
    }

    #fl_update_outer .form-table .label {
        background-color: #f8f9fa;
        font-weight: bold;
        text-align: center;
        width: 15%;
        min-width: 100px;
    }

    #fl_update_outer .form-table input,
    #fl_update_outer .form-table select,
    #fl_update_outer .form-table textarea {
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 4px 6px;
        font-size: 12px;
        width: 100%;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    #fl_update_outer .form-table input:focus,
    #fl_update_outer .form-table select:focus,
    #fl_update_outer .form-table textarea:focus {
        border-color: #007bff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    #fl_update_outer .form-table input[readonly] {
        background-color: #e9ecef;
        color: #6c757d;
    }

    #fl_update_outer .form-table .text-right {
        text-align: right;
    }

    /* ë©´ì  ê³„ì‚°ê¸° ìŠ¤íƒ€ì¼ */
    #fl_update_outer .area_calculator {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    #fl_update_outer .area_calculator input {
        width: 100px !important;
        text-align: right;
        padding-right: 8px;
    }

    #fl_update_outer .area_calculator span {
        font-size: 12px;
        color: #666;
        white-space: nowrap;
        font-weight: normal;
    }

    /* ì…ì£¼ì‚¬ í˜„í™© ìŠ¤íƒ€ì¼ */
    #fl_update_outer .tenant-status {
        min-height: 80px;
        max-height: 120px;
        overflow-y: auto;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background-color: #f8f9fa;
        font-size: 11px;
        line-height: 1.4;
        color: #495057;
    }

    /* ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ */
    .error-message {
        background-color: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 15px;
        border: 1px solid #f5c6cb;
        font-size: 12px;
        text-align: center;
    }

    .success-message {
        background-color: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 15px;
        border: 1px solid #c3e6cb;
        font-size: 12px;
        text-align: center;
    }

    /* ë¡œë”© ìŠ¤íƒ€ì¼ */
    .loading-message {
        text-align: center;
        padding: 50px;
        color: #6c757d;
        font-size: 14px;
    }

    .loading-message .spinner {
        width: 30px;
        height: 30px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
        #fl_update_outer {
            padding: 10px;
        }
        
        #fl_update_outer .area_calculator {
            flex-direction: column;
            align-items: stretch;
            gap: 5px;
        }
        
        #fl_update_outer .area_calculator input {
            width: 100% !important;
        }

        #fl_update_outer .form-table .label {
            width: 25%;
        }
    }
</style>

<div id="fl_update_outer">
    <!-- ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ -->
    <div class="button-area">
        <button type="button" id="rightSaveBtn" class="btn-primary">ì €ì¥</button>
        <button type="button" id="rightListBtn">ëª©ë¡ë³´ê¸°</button>
    </div>

    <!-- ì‚¬ì—…ì¥/ê±´ë¬¼/ì¸µ ì„ íƒ ì˜ì—­ -->
    <div class="selection-area">
        <table class="table">
            <tr>
                <td class="table-header">ì‚¬ì—…ì¥</td>
                <td id="prop_info">ë¡œë”© ì¤‘...</td>
                <td class="table-header">ê±´ë¬¼</td>
                <td id="bl_info">ë¡œë”© ì¤‘...</td>
                <td class="table-header">ì¸µ</td>
                <td id="fl_info">ë¡œë”© ì¤‘...</td>
            </tr>
        </table>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
    <div class="content-area" id="main_content_area">
        <table class="form-table">
            <tr>
                <td class="label">ì¸µì´ë¦„</td>
                <td style="width: 35%;">
                    <input type="text" id="fl_name" placeholder="ì¸µ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </td>
                <td class="label">ì¸µë©´ì </td>
                <td style="width: 35%;">
                    <div class="area_calculator">
                        <input type="text" id="area_fl" placeholder="0" class="text-right">
                        <span>ã¡</span>
                        <input type="text" id="area_pyeong" placeholder="0" class="text-right" readonly>
                        <span>í‰</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="label">ì¸µì½”ë“œ</td>
                <td>
                    <input type="text" id="fl_code" readonly>
                </td>
                
            </tr>
            <tr>
                <td class="label">ì…ì£¼ì‚¬ í˜„í™©</td>
                <td colspan="3">
                    <div class="tenant-status" id="tenant_status_text">
                        ì…ì£¼ì‚¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </td>
            </tr>
            
        </table>

        

    <!-- ìˆ¨ê²¨ì§„ í•„ë“œë“¤ -->
    <input type="hidden" id="prop_id">
    <input type="hidden" id="bl_id">
    <input type="hidden" id="fl_id">
</div>

<script>
// ğŸ›¡ï¸ ì™„ì „í•œ ìŠ¤ì½”í”„ ë¶„ë¦¬ - ë³€ìˆ˜ ì¶©ëŒ ë°©ì§€
(function() {
    'use strict';
    
    console.log('ğŸ—ï¸ fl_update.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');
    
    // ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± - ì¤‘ë³µ ë°©ì§€
    if (typeof window.FlUpdateModule !== 'undefined') {
        console.log('ğŸ—ï¸ ê¸°ì¡´ FlUpdateModule ì¬ì´ˆê¸°í™”');
        // ê¸°ì¡´ ëª¨ë“ˆì´ ìˆì–´ë„ ì¬ì„¤ì • í—ˆìš©
        if (window.FlUpdateModule.data) {
            window.FlUpdateModule.data.isInitialized = false;
            window.FlUpdateModule.data.currentFlData = null;
        }
    }
    
    // ëª¨ë“ˆ ìƒì„±
    window.FlUpdateModule = {
        // ë°ì´í„° ì €ì¥ì†Œ
        data: {
            isInitialized: false,
            currentFlData: null,
            isLoading: false,
            propId: null,
            blId: null,
            flId: null
        },
        
        // ğŸ”§ ì•ˆì „í•œ DOM ì ‘ê·¼ í—¬í¼
        safeGetElement: function(id) {
            try {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn('ğŸ—ï¸ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', id);
                }
                return element;
            } catch (error) {
                console.error('ğŸ—ï¸ DOM ì ‘ê·¼ ì˜¤ë¥˜:', error);
                return null;
            }
        },
        
        // ğŸ”§ ì•ˆì „í•œ ê°’ ì„¤ì • í—¬í¼
        safeSetValue: function(id, value) {
            try {
                const element = this.safeGetElement(id);
                if (element) {
                    element.value = value || '';
                }
            } catch (error) {
                console.error('ğŸ—ï¸ ê°’ ì„¤ì • ì˜¤ë¥˜:', error);
            }
        },
        
        // ğŸ”§ ì•ˆì „í•œ ê°’ ê°€ì ¸ì˜¤ê¸° í—¬í¼
        safeGetValue: function(id) {
            try {
                const element = this.safeGetElement(id);
                return element ? element.value : '';
            } catch (error) {
                console.error('ğŸ—ï¸ ê°’ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                return '';
            }
        },
        
        // ğŸ”§ ì•ˆì „í•œ í…ìŠ¤íŠ¸ ì„¤ì • í—¬í¼
        safeSetText: function(id, text) {
            try {
                const element = this.safeGetElement(id);
                if (element) {
                    element.textContent = text || '';
                }
            } catch (error) {
                console.error('ğŸ—ï¸ í…ìŠ¤íŠ¸ ì„¤ì • ì˜¤ë¥˜:', error);
            }
        },
        
        // ì´ˆê¸°í™”
        init: function() {
            try {
                console.log('ğŸ—ï¸ ì¸µì •ë³´ ìˆ˜ì • í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
                
                // ğŸ”§ ê°•ì œ ì¬ì´ˆê¸°í™” (íƒ­ ì¬ì§„ì… ë¬¸ì œ í•´ê²°)
                this.data.isInitialized = false;
                this.data.currentFlData = null;
                this.data.isLoading = false;
                
                // ğŸ”§ ì¸µ ì •ë³´ ë‹¤ì–‘í•œ ê²½ë¡œì—ì„œ í™•ì¸
                const propId = this.getFloorInfo('prop_id');
                const blId = this.getFloorInfo('bl_id');
                const flId = this.getFloorInfo('fl_id');
                
                console.log('ğŸ—ï¸ ì¸µ ì •ë³´ ìˆ˜ì§‘ ê²°ê³¼:', { propId, blId, flId });
                
                if (!propId || !blId || !flId) {
                    console.warn('ğŸ—ï¸ ì¸µ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    this.showError('ì¸µ ì •ë³´ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>ì¸µ ëª©ë¡ì—ì„œ ìˆ˜ì •í•  ì¸µì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // ë°ì´í„° ì €ì¥
                this.data.propId = propId;
                this.data.blId = blId;
                this.data.flId = flId;
                
                // ì „ì—­ ë³€ìˆ˜ ê°±ì‹ 
                window.selected_fl_prop_id = propId;
                window.selected_fl_bl_id = blId;
                window.selected_fl_id = flId;
                
                this.data.isInitialized = true;
                this.bindEvents();
                this.loadFloorData();
                
            } catch (error) {
                console.error('ğŸ—ï¸ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                this.showError('í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        },
        
        // ğŸ”§ ì¸µ ì •ë³´ ë‹¤ì–‘í•œ ê²½ë¡œì—ì„œ ìˆ˜ì§‘
        getFloorInfo: function(type) {
            try {
                // 1. URL íŒŒë¼ë¯¸í„°ì—ì„œ í™•ì¸
                const urlParams = new URLSearchParams(window.location.search);
                const fromUrl = urlParams.get(type);
                if (fromUrl) {
                    console.log(`ğŸ—ï¸ ${type} - URLì—ì„œ ë°œê²¬:`, fromUrl);
                    return fromUrl;
                }
                
                // 2. ì „ì—­ ë³€ìˆ˜ì—ì„œ í™•ì¸
                const globalVar = window[`selected_fl_${type}`];
                if (globalVar) {
                    console.log(`ğŸ—ï¸ ${type} - ì „ì—­ë³€ìˆ˜ì—ì„œ ë°œê²¬:`, globalVar);
                    return globalVar;
                }
                
                // 3. ê¸°ì¡´ ì €ì¥ëœ ë°ì´í„°ì—ì„œ í™•ì¸
                if (this.data[type]) {
                    console.log(`ğŸ—ï¸ ${type} - ì €ì¥ëœ ë°ì´í„°ì—ì„œ ë°œê²¬:`, this.data[type]);
                    return this.data[type];
                }
                
                // 4. ë‹¤ë¥¸ ì „ì—­ ë³€ìˆ˜ íŒ¨í„´ë“¤ í™•ì¸
                const patterns = [
                    `current_fl_${type}`,
                    `fl_${type}`,
                    `selected_${type}`,
                    type
                ];
                
                for (const pattern of patterns) {
                    if (window[pattern]) {
                        console.log(`ğŸ—ï¸ ${type} - ${pattern}ì—ì„œ ë°œê²¬:`, window[pattern]);
                        return window[pattern];
                    }
                }
                
                console.warn(`ğŸ—ï¸ ${type} - ì°¾ì„ ìˆ˜ ì—†ìŒ`);
                return null;
                
            } catch (error) {
                console.error(`ğŸ—ï¸ ${type} ì •ë³´ ìˆ˜ì§‘ ì˜¤ë¥˜:`, error);
                return null;
            }
        },
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        bindEvents: function() {
            try {
                // ì €ì¥ ë²„íŠ¼
                const saveBtn = this.safeGetElement('rightSaveBtn');
                if (saveBtn) {
                    saveBtn.onclick = () => this.saveFloorData();
                }
                
                // ëª©ë¡ë³´ê¸° ë²„íŠ¼
                const listBtn = this.safeGetElement('rightListBtn');
                if (listBtn) {
                    listBtn.onclick = () => this.navigateToFlList();
                }
                
                // ì¸µë©´ì  ë‹¨ìœ„ ë³€í™˜ (ã¡ -> í‰)
                const areaFlInput = this.safeGetElement('area_fl');
                if (areaFlInput) {
                    areaFlInput.oninput = () => {
                        try {
                            const areaM2 = parseFloat(areaFlInput.value) || 0;
                            const areaPyeong = (areaM2 * 0.3025).toFixed(2);
                            this.safeSetValue('area_pyeong', areaPyeong);
                        } catch (error) {
                            console.error('ğŸ—ï¸ ë©´ì  ë³€í™˜ ì˜¤ë¥˜:', error);
                        }
                    };
                }
                
                // ì—”í„°í‚¤ ì €ì¥
                const inputs = document.querySelectorAll('#fl_update_outer input[type="text"]:not([readonly])');
                inputs.forEach(input => {
                    input.onkeypress = (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.saveFloorData();
                        }
                    };
                });
                
                console.log('ğŸ—ï¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
            } catch (error) {
                console.error('ğŸ—ï¸ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì˜¤ë¥˜:', error);
            }
        },
        
        // ì¸µ ë°ì´í„° ë¡œë“œ
        loadFloorData: function() {
            try {
                if (this.data.isLoading) {
                    console.log('ğŸ—ï¸ ì´ë¯¸ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.');
                    return;
                }
                
                const propId = this.data.propId;
                const blId = this.data.blId;
                const flId = this.data.flId;
                
                if (!propId || !blId || !flId) {
                    console.warn('ğŸ—ï¸ ì¸µ ì •ë³´ê°€ ì—†ì–´ì„œ ë¡œë”©ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
                    this.showError('ì¸µ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                this.data.isLoading = true;
                this.showLoading();
                
                const requestData = {
                    prop_id: propId,
                    bl_id: blId,
                    fl_id: flId
                };
                
                console.log('ğŸ—ï¸ ì¸µ ë°ì´í„° ìš”ì²­:', requestData);
                
                fetch('/fm/fl_update/getInputTagData', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    console.log('ğŸ—ï¸ ì¸µ ë°ì´í„° ì‘ë‹µ ìƒíƒœ:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ—ï¸ ì¸µ ë°ì´í„° ì‘ë‹µ:', data);
                    
                    if (data && data.success && data.data) {
                        this.data.currentFlData = data.data;
                        this.renderFloorData(data.data);
                        console.log('ğŸ—ï¸ ì¸µ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                    } else {
                        this.showError(`ì¸µ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                    }
                })
                .catch(error => {
                    console.error('ğŸ—ï¸ ì¸µ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                    this.showError(`ì¸µ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>${error.message}`);
                })
                .finally(() => {
                    this.data.isLoading = false;
                });
                
            } catch (error) {
                console.error('ğŸ—ï¸ ì¸µ ë°ì´í„° ë¡œë“œ ì „ì²´ ì˜¤ë¥˜:', error);
                this.data.isLoading = false;
                this.showError('ì¸µ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        },
        
        // ì¸µ ë°ì´í„° ë Œë”ë§
        renderFloorData: function(data) {
            try {
                console.log('ğŸ—ï¸ ì¸µ ë°ì´í„° ë Œë”ë§ ì‹œì‘');
                
                // ğŸ”§ ë¨¼ì € í¼ ì˜ì—­ì„ ë³µì›
                this.restoreFormArea();
                
                // ìƒë‹¨ ì„ íƒ ì˜ì—­ ì •ë³´ í‘œì‹œ
                const propDisplay = data.prop_name ? `${data.prop_name} (${data.prop_id})` : (data.prop_id || '');
                this.safeSetText('prop_info', propDisplay);
                
                const blDisplay = data.bl_name ? `${data.bl_name} (${data.bl_id})` : (data.bl_id || '');
                this.safeSetText('bl_info', blDisplay);
                
                const flDisplay = data.fl_name ? `${data.fl_name} (${data.fl_id})` : (data.fl_id || '');
                this.safeSetText('fl_info', flDisplay);
                
                // í¼ í•„ë“œ ì„¤ì •
                this.safeSetValue('fl_code', data.fl_id || '');
                this.safeSetValue('fl_name', data.fl_name || '');
                
                // ì¸µë©´ì  ì„¤ì • (ã¡ -> í‰ ë³€í™˜)
                const areaM2 = parseFloat(data.area_fl) || 0;
                const areaPyeong = (areaM2 * 0.3025).toFixed(2);
                
                this.safeSetValue('area_fl', areaM2.toString());
                this.safeSetValue('area_pyeong', areaPyeong);
                
                // ì…ì£¼ì‚¬ í˜„í™© ì„¤ì •
                const tenantText = data.tenant_names || 'ì…ì£¼ì‚¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';
                this.safeSetText('tenant_status_text', tenantText);
                
                
                
                // ìˆ¨ê²¨ì§„ í•„ë“œë“¤ ì„¤ì •
                this.safeSetValue('prop_id', data.prop_id);
                this.safeSetValue('bl_id', data.bl_id);
                this.safeSetValue('fl_id', data.fl_id);
                
                console.log('ğŸ—ï¸ ì¸µ ë°ì´í„° ë Œë”ë§ ì™„ë£Œ');
                
            } catch (error) {
                console.error('ğŸ—ï¸ ì¸µ ë°ì´í„° ë Œë”ë§ ì˜¤ë¥˜:', error);
                this.showError('ë°ì´í„° ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        },
        
        // ğŸ”§ í¼ ì˜ì—­ ë³µì›
        restoreFormArea: function() {
            const contentArea = this.safeGetElement('main_content_area');
            if (!contentArea) return;
            
            // ì´ë¯¸ í¼ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€
            const existingForm = contentArea.querySelector('.form-table');
            if (existingForm) {
                console.log('ğŸ—ï¸ ê¸°ì¡´ í¼ ì˜ì—­ ìœ ì§€');
                return;
            }
            
            // í¼ ì˜ì—­ ë³µì›
            contentArea.innerHTML = `
                <table class="form-table">
                    <tr>
                        <td class="label">ì¸µì´ë¦„</td>
                        <td style="width: 35%;">
                            <input type="text" id="fl_name" placeholder="ì¸µ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </td>
                        <td class="label">ì¸µë©´ì </td>
                        <td style="width: 35%;">
                            <div class="area_calculator">
                                <input type="text" id="area_fl" placeholder="0" class="text-right">
                                <span>ã¡</span>
                                <input type="text" id="area_pyeong" placeholder="0" class="text-right" readonly>
                                <span>í‰</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">ì¸µì½”ë“œ</td>
                        <td>
                            <input type="text" id="fl_code" readonly>
                        </td>
                        
                    </tr>
                    <tr>
                        <td class="label">ì…ì£¼ì‚¬ í˜„í™©</td>
                        <td colspan="3">
                            <div class="tenant-status" id="tenant_status_text">
                                ì…ì£¼ì‚¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                            </div>
                        </td>
                    </tr>
                    <tr>
                        
                    </tr>
                </table>

                
            `;
            
            // ì´ë²¤íŠ¸ ë‹¤ì‹œ ë°”ì¸ë”©
            this.bindAreaCalculator();
        },
        
        // ğŸ”§ ë©´ì  ê³„ì‚°ê¸° ì´ë²¤íŠ¸ ë°”ì¸ë”©
        bindAreaCalculator: function() {
            const areaFlInput = this.safeGetElement('area_fl');
            if (areaFlInput) {
                areaFlInput.oninput = () => {
                    try {
                        const areaM2 = parseFloat(areaFlInput.value) || 0;
                        const areaPyeong = (areaM2 * 0.3025).toFixed(2);
                        this.safeSetValue('area_pyeong', areaPyeong);
                    } catch (error) {
                        console.error('ğŸ—ï¸ ë©´ì  ë³€í™˜ ì˜¤ë¥˜:', error);
                    }
                };
            }
        },
        
        // ì¸µ ë°ì´í„° ì €ì¥
        saveFloorData: function() {
            try {
                if (this.data.isLoading) {
                    console.log('ğŸ—ï¸ ì €ì¥ ìš”ì²­ ì¤‘ë³µ ë°©ì§€');
                    return;
                }
                
                const propId = this.data.propId;
                const blId = this.data.blId;
                const flId = this.data.flId;
                
                if (!propId || !blId || !flId) {
                    alert('ì¸µ ì •ë³´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // í¼ ë°ì´í„° ìˆ˜ì§‘
                const formData = {
                    prop_id: propId,
                    bl_id: blId,
                    fl_id: flId,
                    fl_name: this.safeGetValue('fl_name'),
                    area_fl: parseFloat(this.safeGetValue('area_fl')) || 0,
                };
                
                console.log('ğŸ—ï¸ ì €ì¥í•  ë°ì´í„°:', formData);
                
                // ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
                const saveBtn = this.safeGetElement('rightSaveBtn');
                const originalText = saveBtn ? saveBtn.textContent : 'ì €ì¥';
                if (saveBtn) {
                    saveBtn.textContent = 'ì €ì¥ ì¤‘...';
                    saveBtn.disabled = true;
                }
                
                this.data.isLoading = true;
                
                fetch('/fm/fl_update/save_fl_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ—ï¸ ì €ì¥ ì‘ë‹µ:', data);
                    
                    if (data.success) {
                        // í•„ìš”í•œ ê²½ìš° ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                        setTimeout(() => {
                            this.loadFloorData();
                        }, 1000);
                    } else {
                        alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                })
                .catch(error => {
                    console.error('ğŸ—ï¸ ì €ì¥ ì˜¤ë¥˜:', error);
                    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                })
                .finally(() => {
                    // ì €ì¥ ë²„íŠ¼ ë³µì›
                    if (saveBtn) {
                        saveBtn.textContent = originalText;
                        saveBtn.disabled = false;
                    }
                    this.data.isLoading = false;
                });
                
            } catch (error) {
                console.error('ğŸ—ï¸ ì €ì¥ ì „ì²´ ì˜¤ë¥˜:', error);
                this.data.isLoading = false;
            }
        },
        
        // ì¸µ ëª©ë¡ìœ¼ë¡œ ì´ë™
        navigateToFlList: function() {
            try {
                console.log('ğŸ—ï¸ ì¸µ ëª©ë¡ìœ¼ë¡œ ì´ë™');
                
                // ì„ íƒëœ ì¸µ ì •ë³´ ì´ˆê¸°í™”
                window.selected_fl_prop_id = null;
                window.selected_fl_bl_id = null;
                window.selected_fl_id = null;
                
                // HiddenFrame íƒ­ ì‹œìŠ¤í…œ ì‚¬ìš©
                if (window.tabManager && typeof window.tabManager.addTab === 'function') {
                    // ê¸°ì¡´ fl_update íƒ­ ì œê±°
                    const currentTabId = window.tabManager.activeTabId;
                    if (currentTabId) {
                        window.tabManager.removeTab(currentTabId);
                    }
                    
                    // fl_list íƒ­ ì¶”ê°€
                    setTimeout(() => {
                        window.tabManager.addTab('/fm/fl_list.html', 'ì¸µì •ë³´');
                        if (window.showStatus) {
                            window.showStatus('ì¸µì •ë³´ ëª©ë¡ì„ ì—´ì—ˆìŠµë‹ˆë‹¤.');
                        }
                    }, 100);
                    
                } else if (typeof window.loadContent === 'function') {
                    // Fallback: ê¸°ì¡´ ë°©ì‹
                    window.loadContent('/fm/fl_list.html', 'ì¸µì •ë³´');
                    
                } else {
                    console.error('ğŸ—ï¸ íƒ­ ìƒì„± í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ğŸ—ï¸ ëª©ë¡ ì´ë™ ì˜¤ë¥˜:', error);
            }
        },
        
        showLoading: function() {
            const contentArea = this.safeGetElement('main_content_area');
            if (contentArea) {
                contentArea.innerHTML = `
                    <div class="loading-message">
                        <div class="spinner"></div>
                        <p>ì¸µ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                `;
            }
        },
        
        showError: function(message) {
            console.error('ğŸ—ï¸ ì˜¤ë¥˜:', message);
            
            const contentArea = this.safeGetElement('main_content_area');
            if (contentArea) {
                contentArea.innerHTML = `
                    <div class="error-message">
                        <h3 style="margin: 0 0 10px 0;">ì˜¤ë¥˜ ë°œìƒ</h3>
                        <p style="margin: 0 0 15px 0;">${message}</p>
                        <button type="button" onclick="FlUpdateModule.navigateToFlList()" 
                                style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ì¸µ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                `;
            }
        },
        
        showSuccess: function(message) {
            console.log('ğŸ—ï¸ ì„±ê³µ:', message);
            
            // ê¸°ì¡´ ì„±ê³µ ë©”ì‹œì§€ ì œê±°
            const existingSuccess = document.querySelector('#fl_update_outer .success-message');
            if (existingSuccess) {
                existingSuccess.remove();
            }
            
            // ìƒˆ ì„±ê³µ ë©”ì‹œì§€ ì¶”ê°€
            const buttonArea = document.querySelector('#fl_update_outer .button-area');
            if (buttonArea) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success-message';
                successDiv.textContent = message;
                
                buttonArea.parentNode.insertBefore(successDiv, buttonArea.nextSibling);
                
                // 3ì´ˆ í›„ ìë™ ì œê±°
                setTimeout(() => {
                    successDiv.remove();
                }, 3000);
            }
            
            if (window.showStatus) {
                window.showStatus(message);
            }
        }
    };
    
    // ì „ì—­ ì´ˆê¸°í™” í•¨ìˆ˜ ë“±ë¡
    window.initializeFlUpdate = function() {
        window.FlUpdateModule.init();
    };
    
    // ìë™ ì´ˆê¸°í™” (ì¦‰ì‹œ ì‹¤í–‰)
    setTimeout(() => {
        console.log('ğŸ—ï¸ FlUpdate ìë™ ì´ˆê¸°í™” ì‹œì‘');
        window.FlUpdateModule.init();
    }, 500);
    
    console.log('ğŸ—ï¸ FlUpdateModule ë¡œë“œ ì™„ë£Œ');
    
})(); // ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ ë
</script>