<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì…ì£¼ì‚¬ ì •ë³´ ìˆ˜ì •</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        /* rmtenant_update ìŠ¤íƒ€ì¼ - rm_updateì™€ ì¼ê´€ì„± ë§ì¶¤ */
        #rmtenant_update_outer {
            padding: 20px;
            padding-bottom: 0;
            overflow-y: auto;
            background-color: #f8f9fa;
            font-size: 12px;
        }

        /* ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ */
        #rmtenant_update_outer .top-buttons {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        #rmtenant_update_outer .top-buttons button {
            height: 32px;
            padding: 0 16px;
            background: #fff;
            color: #333;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }

        #rmtenant_update_outer .top-buttons button:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        #rmtenant_update_outer .top-buttons button.btn-primary {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        #rmtenant_update_outer .top-buttons button.btn-primary:hover {
            background: #0056b3;
            border-color: #004085;
        }

        #rmtenant_update_outer .top-buttons button.btn-danger {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        #rmtenant_update_outer .top-buttons button.btn-danger:hover {
            background: #c82333;
            border-color: #bd2130;
        }

        /* ì…ì£¼ì‚¬ ì •ë³´ ì˜ì—­ */
        #rmtenant_update_outer .tenant-info-area {
            background-color: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            padding: 20px;
            margin-bottom: 15px;
        }

        #rmtenant_update_outer .tenant-info-table {
            width: 100%;
            border-collapse: collapse;
        }

        #rmtenant_update_outer .tenant-info-table td {
            padding: 12px;
            border: 1px solid #dee2e6;
            font-size: 12px;
            vertical-align: middle;
        }

        #rmtenant_update_outer .tenant-info-table .label-cell {
            background-color: #f7f7f7;
            text-align: center;
            font-weight: bold;
            width: 11%;
            position: relative;
        }

        #rmtenant_update_outer .tenant-info-table .value-cell {
            background-color: white;
            text-align: left;
            width: 22%;
            padding-left: 15px;
        }

        #rmtenant_update_outer .tenant-info-table .full-width {
            width: 85%;
        }

        #rmtenant_update_outer .tenant-info-table input[type="text"] {
            height: 32px;
            padding: 0 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
        }

        #rmtenant_update_outer .tenant-info-table input.large {
            width: 300px;
        }

        #rmtenant_update_outer .tenant-info-table input.small {
            width: 60px;
            text-align: right;
        }

        #rmtenant_update_outer .tenant-info-table input.medium {
            width: 100px;
        }

        #rmtenant_update_outer .tenant-info-table select {
            width: 200px;
            height: 32px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            padding: 4px 8px;
        }

        #rmtenant_update_outer .tenant-info-table textarea {
            width: 100%;
            min-height: 80px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            padding: 8px;
            resize: vertical;
        }

        /* í•„ìˆ˜ ì…ë ¥ í‘œì‹œ */
        .required::after {
            content: "*";
            color: red;
            margin-left: 2px;
        }

        /* ë‹¬ë ¥ ì…ë ¥ */
        .date-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .date-input-group input[type="date"] {
            width: 140px;
        }

        .date-input-group button {
            height: 32px;
            padding: 0 8px;
            background: #fff;
            color: #333;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        .date-input-group button:hover {
            background-color: #e9ecef;
        }

        /* ë©´ì  ì…ë ¥ ê·¸ë£¹ */
        .area-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .area-input-group span {
            font-size: 12px;
            color: #495057;
        }

        /* ì˜¤ë¥˜ ë©”ì‹œì§€ */
        .error-message {
            color: #dc3545;
            font-size: 11px;
            margin-top: 5px;
        }

        /* ë¡œë”© í‘œì‹œ */
        #rmtenant_update_outer .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 14px;
            color: #6c757d;
        }

        #rmtenant_update_outer .loading .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            #rmtenant_update_outer {
                padding: 10px;
            }
            
            #rmtenant_update_outer .tenant-info-table {
                font-size: 11px;
            }
            
            #rmtenant_update_outer .tenant-info-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="rmtenant_update_outer">
        <!-- ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ -->
        <div class="top-buttons">
            <button type="button" id="btn_save" class="btn-primary">ì €ì¥</button>
            <button type="button" id="btn_delete" class="btn-danger">ì‚­ì œ</button>
            <button type="button" id="btn_list">ëª©ë¡ë³´ê¸°</button>
        </div>

        <!-- ì…ì£¼ì‚¬ ì •ë³´ ìˆ˜ì • ì˜ì—­ -->
        <div class="tenant-info-area">
            <table class="tenant-info-table">
                <tr>
                    <td class="label-cell required">ì…ì£¼ì‚¬</td>
                    <td class="value-cell">
                        <input type="text" id="tenant_name" name="tenant_name" class="large">
                    </td>
                    <td class="label-cell required">ê±´ë¬¼</td>
                    <td class="value-cell">
                        <select id="bl_id" name="bl_id">
                            <option value="">ê±´ë¬¼ì„ íƒ</option>
                        </select>
                    </td>
                    <td class="label-cell">ì „ìš©ë©´ì </td>
                    <td class="value-cell">
                        <div class="area-input-group">
                            <input type="text" id="area_rm" name="area_rm" class="small">
                            <span>í‰</span>
                            <input type="text" id="area_rm_local" name="area_rm_local" class="small">
                            <span>ã¡</span>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="label-cell">ì…ì‹¤ì¼ì</td>
                    <td class="value-cell">
                        <div class="date-input-group">
                            <input type="date" id="move_in" name="move_in">
                            <button type="button" onclick="RmtenantUpdateModule.clearDate('move_in')">ì·¨ì†Œ</button>
                        </div>
                    </td>
                    <td class="label-cell required">ì¸µ</td>
                    <td class="value-cell">
                        <select id="fl_id" name="fl_id">
                            <option value="">ì¸µì„ íƒ</option>
                        </select>
                    </td>
                    <td class="label-cell">ê³„ì•½ë©´ì </td>
                    <td class="value-cell">
                        <div class="area-input-group">
                            <input type="text" id="area_contract" name="area_contract" class="small">
                            <span>í‰</span>
                            <input type="text" id="area_contract_local" name="area_contract_local" class="small">
                            <span>ã¡</span>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="label-cell">í‡´ì‹¤ì¼ì</td>
                    <td class="value-cell">
                        <div class="date-input-group">
                            <input type="date" id="move_out" name="move_out">
                            <button type="button" onclick="RmtenantUpdateModule.clearDate('move_out')">ì·¨ì†Œ</button>
                        </div>
                    </td>
                    <td class="label-cell">ì‹¤</td>
                    <td class="value-cell">
                        <select id="rm_id" name="rm_id">
                            <option value="">ì‹¤ì„ íƒ</option>
                        </select>
                    </td>
                    <td class="label-cell">ì„ëŒ€ë©´ì (í‰)</td>
                    <td class="value-cell">
                        <div class="area-input-group">
                            <input type="text" id="area_lease" name="area_lease" class="small">
                            <span>í‰</span>
                            <input type="text" id="area_lease_local" name="area_lease_local" class="small">
                            <span>ã¡</span>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="label-cell">ë¹„ê³ </td>
                    <td class="value-cell full-width" colspan="5">
                        <textarea id="comments" name="comments" placeholder="ë¹„ê³ ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <script>
    // ğŸ›¡ï¸ ì™„ì „í•œ ìŠ¤ì½”í”„ ë¶„ë¦¬
    (function() {
        'use strict';
        
        console.log('ğŸ—ï¸ rmtenant_update.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');
        
        // ğŸ”¥ ê¸°ì¡´ RmtenantUpdateModule ì™„ì „ ì œê±° í›„ ì¬ìƒì„±
        if (typeof window.RmtenantUpdateModule !== 'undefined') {
            console.log('ğŸ—ï¸ ê¸°ì¡´ RmtenantUpdateModule ì™„ì „ ì œê±°');
            if (window.RmtenantUpdateModule.cleanup && typeof window.RmtenantUpdateModule.cleanup === 'function') {
                window.RmtenantUpdateModule.cleanup();
            }
            delete window.RmtenantUpdateModule;
        }
        
        // ëª¨ë“ˆ ìƒì„±
        window.RmtenantUpdateModule = {
            // ë°ì´í„° ì €ì¥ì†Œ
            data: {
                rmtenantId: null,
                blList: [],
                flList: [],
                rmList: [],
                tenantData: {},
                isInitialized: false,
                moduleId: 'rmtenant_update_' + Date.now()
            },
            
            // ğŸ”§ ì•ˆì „í•œ DOM ì ‘ê·¼ í—¬í¼
            safeGetElement: function(id) {
                try {
                    const element = document.getElementById(id);
                    if (!element) {
                        console.warn('ğŸ—ï¸ [RU] DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', id);
                    }
                    return element;
                } catch (error) {
                    console.error('ğŸ—ï¸ [RU] DOM ì ‘ê·¼ ì˜¤ë¥˜:', error);
                    return null;
                }
            },

            // ì´ˆê¸°í™”
            init: function() {
                console.log('ğŸ—ï¸ [RU] ì…ì£¼ì‚¬ ìˆ˜ì • í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
                
                const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
                const prop_id = window.currentPropId;
                
                // ì „ì—­ ë³€ìˆ˜ì—ì„œ rmtenant_id ê°€ì ¸ì˜¤ê¸°
                this.data.rmtenantId = window.selected_rmtenant_id || null;
                
                // URL íŒŒë¼ë¯¸í„°ë„ ë°±ì—…ìœ¼ë¡œ ì‹œë„
                if (!this.data.rmtenantId) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const rawRmtenantId = urlParams.get('rmtenant_id');
                    this.data.rmtenantId = rawRmtenantId ? parseInt(parseFloat(rawRmtenantId)) : null;
                }
                
                console.log('ğŸ—ï¸ [RU] ë°›ì€ ë°ì´í„°:', { 
                    em_id, 
                    prop_id, 
                    rmtenant_id: this.data.rmtenantId, 
                    from_global: window.selected_rmtenant_id,
                    isReactivation: this.data.isInitialized  // ì¬í™œì„±í™” ê°ì§€
                });
                
                if (!em_id) {
                    console.error('ğŸ—ï¸ [RU] em_idê°€ ì—†ìŠµë‹ˆë‹¤.');
                    this.showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                if (!this.data.rmtenantId) {
                    console.error('ğŸ—ï¸ [RU] rmtenant_idê°€ ì—†ìŠµë‹ˆë‹¤.');
                    this.showError('ì…ì£¼ì‚¬ IDê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ì´ë¯¸ ì´ˆê¸°í™”ëœ ìƒíƒœì—ì„œ ë‹¤ë¥¸ IDë¡œ ì¬í˜¸ì¶œë˜ë©´ ë°ì´í„°ë§Œ ìƒˆë¡œ ë¡œë“œ
                if (this.data.isInitialized) {
                    console.log('ğŸ”„ [RU] ê¸°ì¡´ íƒ­ ì¬í™œì„±í™” - ìƒˆ ë°ì´í„° ë¡œë“œ');
                    this.loadTenantData();  // ìƒˆë¡œìš´ IDë¡œ ë°ì´í„°ë§Œ ë‹¤ì‹œ ë¡œë“œ
                    delete window.selected_rmtenant_id;  // ì‚¬ìš© í›„ ì •ë¦¬
                    return;
                }
                
                
                // ì‚¬ìš© í›„ ì „ì—­ ë³€ìˆ˜ ì •ë¦¬
                delete window.selected_rmtenant_id;
                
                this.data.isInitialized = true;
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                this.bindEvents();
                
                // ê±´ë¬¼ ëª©ë¡ ë¡œë“œ
                this.loadBuildingList();
                
                // ì…ì£¼ì‚¬ ì •ë³´ ë¡œë“œ
                this.loadTenantData();
            },
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            bindEvents: function() {
                // ì €ì¥ ë²„íŠ¼
                const btnSave = this.safeGetElement('btn_save');
                if (btnSave) {
                    btnSave.onclick = () => {
                        this.saveTenant();
                    };
                }
                
                // ì‚­ì œ ë²„íŠ¼
                const btnDelete = this.safeGetElement('btn_delete');
                if (btnDelete) {
                    btnDelete.onclick = () => {
                        this.deleteTenant();
                    };
                }
                
                // ëª©ë¡ë³´ê¸° ë²„íŠ¼
                const btnList = this.safeGetElement('btn_list');
                if (btnList) {
                    btnList.onclick = () => {
                        this.goToList();
                    };
                }
                
                // ê±´ë¬¼ ì„ íƒ ë³€ê²½
                const blSelect = this.safeGetElement('bl_id');
                if (blSelect) {
                    blSelect.onchange = () => {
                        this.loadFloorList(blSelect.value);
                        this.clearRoomList(); // ì‹¤ ëª©ë¡ ì´ˆê¸°í™”
                    };
                }
                
                // ì¸µ ì„ íƒ ë³€ê²½
                const flSelect = this.safeGetElement('fl_id');
                if (flSelect) {
                    flSelect.onchange = () => {
                        this.loadRoomList(flSelect.value);
                    };
                }
                
                console.log('ğŸ—ï¸ [RU] ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
            },
            
            // ì…ì£¼ì‚¬ ì •ë³´ ë¡œë“œ
            loadTenantData: function() {
                const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
                
                if (!em_id || !this.data.rmtenantId) {
                    console.error('ğŸ—ï¸ [RU] í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½');
                    return;
                }
                
                fetch('fm/rmtenant_update/get_tenant_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        em_id: em_id,
                        rmtenant_id: this.data.rmtenantId
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ—ï¸ [RU] ì…ì£¼ì‚¬ ì •ë³´ ì‘ë‹µ:', data);
                    if (data && data.success) {
                        this.data.tenantData = data.data;
                        this.populateForm(data.data);
                        
                        // ê±´ë¬¼/ì¸µ/ì‹¤ ì—°ë™ ë¡œë“œ
                        if (data.data.bl_id) {
                            this.loadFloorList(data.data.bl_id, data.data.fl_id);
                        }
                        if (data.data.fl_id) {
                            this.loadRoomList(data.data.fl_id, data.data.rm_id);
                        }
                    } else {
                        console.error('ğŸ—ï¸ [RU] ì…ì£¼ì‚¬ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', data ? data.message : 'Unknown error');
                        this.showError('ì…ì£¼ì‚¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                })
                .catch(error => {
                    console.error('ğŸ—ï¸ [RU] ì…ì£¼ì‚¬ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                    this.showError(`ì…ì£¼ì‚¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                });
            },
            
            // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
            populateForm: function(data) {
                this.safeSetValue('tenant_name', data.tenant_name);
                this.safeSetValue('bl_id', data.bl_id);
                this.safeSetValue('fl_id', data.fl_id);
                this.safeSetValue('rm_id', data.rm_id);
                this.safeSetValue('move_in', data.move_in);
                this.safeSetValue('move_out', data.move_out);
                this.safeSetValue('area_rm', data.area_rm);
                this.safeSetValue('area_rm_local', data.area_rm_local);
                this.safeSetValue('area_contract', data.area_contract);
                this.safeSetValue('area_contract_local', data.area_contract_local);
                this.safeSetValue('area_lease', data.area_lease);
                this.safeSetValue('area_lease_local', data.area_lease_local);
                this.safeSetValue('comments', data.comments);
                
                console.log('ğŸ—ï¸ [RU] í¼ ë°ì´í„° ì±„ìš°ê¸° ì™„ë£Œ');
            },
            
            // ì•ˆì „í•œ ê°’ ì„¤ì •
            safeSetValue: function(id, value) {
                const element = this.safeGetElement(id);
                if (element && value != null) {
                    element.value = value;
                }
            },
            
            // ê±´ë¬¼ ëª©ë¡ ë¡œë“œ
            loadBuildingList: function() {
                const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
                const prop_id = window.currentPropId;
                
                if (!em_id || !prop_id) {
                    console.error('ğŸ—ï¸ [RU] ê±´ë¬¼ ëª©ë¡ ë¡œë“œ íŒŒë¼ë¯¸í„° ëˆ„ë½');
                    return;
                }
                
                fetch('fm/rmtenant_list/get_bl_list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ em_id: em_id, prop_id: prop_id })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ—ï¸ [RU] ê±´ë¬¼ ëª©ë¡ ì‘ë‹µ:', data);
                    if (data && data.success) {
                        this.data.blList = data.data || [];
                        this.renderBuildingSelect(data.data || []);
                    } else {
                        console.error('ğŸ—ï¸ [RU] ê±´ë¬¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', data ? data.message : 'Unknown error');
                        this.renderBuildingSelect([]);
                    }
                })
                .catch(error => {
                    console.error('ğŸ—ï¸ [RU] ê±´ë¬¼ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                    this.renderBuildingSelect([]);
                });
            },
            
            // ê±´ë¬¼ ì„ íƒ ì˜µì…˜ ë Œë”ë§
            renderBuildingSelect: function(buildings) {
                const select = this.safeGetElement('bl_id');
                if (!select) return;
                select.innerHTML = '<option value="">ê±´ë¬¼ì„ íƒ</option>';
                
                buildings.forEach(building => {
                    const option = document.createElement('option');
                    option.value = building.bl_id;
                    option.textContent = `${building.bl_name} (${building.bl_id})`;
                    select.appendChild(option);
                });
                
                // ê¸°ì¡´ ì„ íƒê°’ ë³µì›
                if (this.data.tenantData && this.data.tenantData.bl_id) {
                    select.value = this.data.tenantData.bl_id;
                }
            },
            
            // ì¸µ ëª©ë¡ ë¡œë“œ
            loadFloorList: function(blId, selectedFlId = null) {
                const prop_id = window.currentPropId;
                const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
                
                const flSelect = this.safeGetElement('fl_id');
                if (!flSelect) return;
                flSelect.innerHTML = '<option value="">ì¸µì„ íƒ</option>';
                this.data.flList = [];

                if (!prop_id || !blId) {
                    console.warn('ğŸ—ï¸ [RU] ì¸µ ëª©ë¡ ë¡œë“œ íŒŒë¼ë¯¸í„° ë¶€ì¡±:', { prop_id, blId });
                    return;
                }

                fetch('fm/rmtenant_list/get_fl_list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prop_id: prop_id, em_id: em_id, bl_id: blId })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ—ï¸ [RU] ì¸µ ëª©ë¡ ì‘ë‹µ:', data);
                    if (data && data.success) {
                        this.data.flList = data.data || [];
                        this.renderFloorSelect(data.data || [], selectedFlId);
                    } else {
                        console.error('ğŸ—ï¸ [RU] ì¸µ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', data ? data.message : 'Unknown error');
                        this.renderFloorSelect([], selectedFlId);
                    }
                })
                .catch(error => {
                    console.error('ğŸ—ï¸ [RU] ì¸µ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                    this.renderFloorSelect([], selectedFlId);
                });
            },
            
            // ì¸µ ì„ íƒ ì˜µì…˜ ë Œë”ë§
            renderFloorSelect: function(floors, selectedFlId = null) {
                const select = this.safeGetElement('fl_id');
                if (!select) return;
                select.innerHTML = '<option value="">ì¸µì„ íƒ</option>';
                
                floors.forEach(floor => {
                    const option = document.createElement('option');
                    option.value = floor.fl_id;
                    option.textContent = `${floor.fl_name} (${floor.fl_id})`;
                    select.appendChild(option);
                });
                
                // ì„ íƒê°’ ì„¤ì •
                if (selectedFlId) {
                    select.value = selectedFlId;
                }
            },

            // ì‹¤ ëª©ë¡ ë¡œë“œ
            loadRoomList: function(flId, selectedRmId = null) {
                const prop_id = window.currentPropId;
                const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
                const blId = this.safeGetElement('bl_id').value;
                
                const rmSelect = this.safeGetElement('rm_id');
                if (!rmSelect) return;
                rmSelect.innerHTML = '<option value="">ì‹¤ì„ íƒ</option>';
                this.data.rmList = [];

                if (!prop_id || !blId || !flId) {
                    console.warn('ğŸ—ï¸ [RU] ì‹¤ ëª©ë¡ ë¡œë“œ íŒŒë¼ë¯¸í„° ë¶€ì¡±:', { prop_id, blId, flId });
                    return;
                }

                fetch('fm/rmtenant_list/get_rm_list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prop_id: prop_id, em_id: em_id, bl_id: blId, fl_id: flId })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ—ï¸ [RU] ì‹¤ ëª©ë¡ ì‘ë‹µ:', data);
                    if (data && data.success) {
                        this.data.rmList = data.data || [];
                        this.renderRoomSelect(data.data || [], selectedRmId);
                    } else {
                        console.error('ğŸ—ï¸ [RU] ì‹¤ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', data ? data.message : 'Unknown error');
                        this.renderRoomSelect([], selectedRmId);
                    }
                })
                .catch(error => {
                    console.error('ğŸ—ï¸ [RU] ì‹¤ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                    this.renderRoomSelect([], selectedRmId);
                });
            },

            // ì‹¤ ì„ íƒ ì˜µì…˜ ë Œë”ë§
            renderRoomSelect: function(rooms, selectedRmId = null) {
                const select = this.safeGetElement('rm_id');
                if (!select) return;
                select.innerHTML = '<option value="">ì‹¤ì„ íƒ</option>';
                
                rooms.forEach(room => {
                    const option = document.createElement('option');
                    option.value = room.rm_id;
                    option.textContent = `${room.rm_name} (${room.rm_id})`;
                    select.appendChild(option);
                });
                
                // ì„ íƒê°’ ì„¤ì •
                if (selectedRmId) {
                    select.value = selectedRmId;
                }
            },
            
            // ì‹¤ ëª©ë¡ ì´ˆê¸°í™”
            clearRoomList: function() {
                const rmSelect = this.safeGetElement('rm_id');
                if (rmSelect) {
                    rmSelect.innerHTML = '<option value="">ì‹¤ì„ íƒ</option>';
                }
                this.data.rmList = [];
            },
            
            // ë‚ ì§œ í´ë¦¬ì–´
            clearDate: function(fieldId) {
                const element = this.safeGetElement(fieldId);
                if (element) {
                    element.value = '';
                }
            },
            
            // ì…ì£¼ì‚¬ ì •ë³´ ì €ì¥
            saveTenant: function() {
                // ìœ íš¨ì„± ê²€ì‚¬
                const tenantName = this.safeGetElement('tenant_name').value.trim();
                const blId = this.safeGetElement('bl_id').value;
                const flId = this.safeGetElement('fl_id').value;
                
                if (!tenantName) {
                    alert('ì…ì£¼ì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    this.safeGetElement('tenant_name').focus();
                    return;
                }
                if (!blId) {
                    alert('ê±´ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    this.safeGetElement('bl_id').focus();
                    return;
                }
                if (!flId) {
                    alert('ì¸µì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    this.safeGetElement('fl_id').focus();
                    return;
                }
                
                if (!confirm('ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
                
                const requestData = {
                    em_id: window.currentEmId || (window.userInfo && window.userInfo.em_id),
                    rmtenant_id: this.data.rmtenantId,
                    tenant_name: tenantName,
                    bl_id: blId,
                    fl_id: flId,
                    rm_id: this.safeGetElement('rm_id').value,
                    move_in: this.safeGetElement('move_in').value,
                    move_out: this.safeGetElement('move_out').value,
                    area_rm: this.safeGetElement('area_rm').value,
                    area_rm_local: this.safeGetElement('area_rm_local').value,
                    area_contract: this.safeGetElement('area_contract').value,
                    area_contract_local: this.safeGetElement('area_contract_local').value,
                    area_lease: this.safeGetElement('area_lease').value,
                    area_lease_local: this.safeGetElement('area_lease_local').value,
                    comments: this.safeGetElement('comments').value
                };
                
                console.log('ğŸ—ï¸ [RU] ì…ì£¼ì‚¬ ì €ì¥ ìš”ì²­:', requestData);
                
                fetch('fm/rmtenant_update/save_tenant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ—ï¸ [RU] ì…ì£¼ì‚¬ ì €ì¥ ì‘ë‹µ:', data);
                    if (data && data.success) {
                        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');

                        const myTabId = window.tabManager.activeTabId || null; // í˜„ì¬ ìˆ˜ì •íƒ­ ID

                        if (window.tabManager && window.tabManager.tabs) {
                            let listTabId = null;

                            if (window.tabManager.tabs instanceof Map) {
                                for (const [tabId, tab] of window.tabManager.tabs.entries()) {
                                    if (tabId.includes('rmtenant_list') || 
                                        (tab.url && tab.url.includes('rmtenant_list.html')) || 
                                        (tab.title && tab.title === 'ì…ì£¼ì‚¬ ì •ë³´')) {
                                        listTabId = tabId;
                                        break;
                                    }
                                }
                            }

                            if (listTabId && typeof window.tabManager.switchToTab === 'function') {
                                window.tabManager.switchToTab(listTabId);

                                setTimeout(() => {
                                    if (window.RmtenantListModule && typeof window.RmtenantListModule.refreshData === 'function') {
                                        window.RmtenantListModule.refreshData();
                                    }
                                }, 200);
                            } else if (typeof window.tabManager.addTab === 'function') {
                                window.tabManager.addTab('fm/rmtenant_list.html', 'ì…ì£¼ì‚¬ ì •ë³´');
                            }

                            setTimeout(() => {
                                if (typeof window.tabManager.removeTab === 'function' && myTabId) {
                                    window.tabManager.removeTab(myTabId);
                                }
                            }, 300);

                        } else {
                            window.location.href = 'fm/rmtenant_list.html';
                        }

                    } else {
                        alert(`ì €ì¥ ì‹¤íŒ¨: ${data ? data.message : 'Unknown error'}`);
                    }
                })

                .catch(error => {
                    console.error('ğŸ—ï¸ [RU] ì…ì£¼ì‚¬ ì €ì¥ ì˜¤ë¥˜:', error);
                    alert(`ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                });
            },
            
            // ì…ì£¼ì‚¬ ì •ë³´ ì‚­ì œ
            deleteTenant: function() {
                if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
                
                const requestData = {
                    em_id: window.currentEmId || (window.userInfo && window.userInfo.em_id),
                    rmtenant_id: this.data.rmtenantId
                };
                
                console.log('ğŸ—ï¸ [RU] ì…ì£¼ì‚¬ ì‚­ì œ ìš”ì²­:', requestData);
                
                fetch('fm/rmtenant_update/delete_tenant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ—ï¸ [RU] ì…ì£¼ì‚¬ ì‚­ì œ ì‘ë‹µ:', data);
                    if (data && data.success) {
                        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        this.goToList();
                    } else {
                        alert(`ì‚­ì œ ì‹¤íŒ¨: ${data ? data.message : 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('ğŸ—ï¸ [RU] ì…ì£¼ì‚¬ ì‚­ì œ ì˜¤ë¥˜:', error);
                    alert(`ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                });
            },
            
            // ëª©ë¡ìœ¼ë¡œ ì´ë™
            goToList: function() {
                try {
                    // tabManagerê°€ ìˆëŠ” ê²½ìš°
                    if (window.tabManager && window.tabManager.tabs) {
                        let rmtenantListTabId = null;
                        
                        // tabsê°€ Map ê°ì²´ì¸ ê²½ìš°
                        if (window.tabManager.tabs instanceof Map) {
                            for (const [tabId, tab] of window.tabManager.tabs.entries()) {
                                if (tabId.includes('rmtenant_list') || 
                                    (tab.url && tab.url.includes('rmtenant_list.html')) ||
                                    (tab.title && tab.title === 'ì…ì£¼ì‚¬ ì •ë³´')) {
                                    rmtenantListTabId = tabId;
                                    console.log('ğŸŸ¢ [RU] ê¸°ì¡´ rmtenant_list íƒ­ ë°œê²¬:', rmtenantListTabId);
                                    break;
                                }
                            }
                        }
                        
                        // ê¸°ì¡´ íƒ­ì´ ìˆìœ¼ë©´ í™œì„±í™”
                        if (rmtenantListTabId && typeof window.tabManager.switchToTab === 'function') {
                            window.tabManager.switchToTab(rmtenantListTabId);
                            
                            // í˜„ì¬ rmtenant_update íƒ­ ë‹«ê¸°
                            setTimeout(() => {
                                if (typeof window.tabManager.removeCurrentTab === 'function') {
                                    window.tabManager.removeCurrentTab();
                                }
                            }, 100);
                            
                            // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                            setTimeout(() => {
                                if (window.RmtenantListModule && typeof window.RmtenantListModule.refreshData === 'function') {
                                    window.RmtenantListModule.refreshData();
                                }
                            }, 300);
                            
                            console.log('ğŸŸ¢ [RU] ê¸°ì¡´ rmtenant_list íƒ­ìœ¼ë¡œ ì´ë™ ì™„ë£Œ');
                            return;
                        }
                        
                        // ê¸°ì¡´ íƒ­ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                        if (typeof window.tabManager.addTab === 'function') {
                            window.tabManager.addTab('fm/rmtenant_list.html', 'ì…ì£¼ì‚¬ ì •ë³´');
                            
                            // í˜„ì¬ rmtenant_update íƒ­ ë‹«ê¸°
                            setTimeout(() => {
                                if (typeof window.tabManager.removeCurrentTab === 'function') {
                                    window.tabManager.removeCurrentTab();
                                }
                            }, 200);
                            
                            return;
                        }
                    }
                    
                    // fallback
                    if (typeof window.loadContent === 'function') {
                        window.loadContent('fm/rmtenant_list.html', 'ì…ì£¼ì‚¬ ì •ë³´');
                    } else {
                        window.location.href = 'fm/rmtenant_list.html';
                    }
                    
                } catch (error) {
                    console.error('ğŸ”´ [RU] ëª©ë¡ ì´ë™ ì¤‘ ì˜¤ë¥˜:', error);
                    
                    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê°•ì œë¡œ ìƒˆ íƒ­ ìƒì„±
                    if (window.tabManager && typeof window.tabManager.addTab === 'function') {
                        window.tabManager.addTab('fm/rmtenant_list.html', 'ì…ì£¼ì‚¬ ì •ë³´');
                    } else {
                        window.location.href = 'fm/rmtenant_list.html';
                    }
                }
            },
            
            // ì˜¤ë¥˜ í‘œì‹œ
            showError: function(message) {
                console.error('ğŸ”´ [RU] ì…ì£¼ì‚¬ ìˆ˜ì • ì˜¤ë¥˜:', message);
                alert(message);
            },
            
            // ì •ë¦¬ í•¨ìˆ˜
            cleanup: function() {
                console.log('ğŸ—ï¸ [RU] RmtenantUpdateModule ì •ë¦¬ ì¤‘...');
                this.data.isInitialized = false;
            }
        };
        
        // ì „ì—­ ì´ˆê¸°í™” í•¨ìˆ˜ ë“±ë¡
        window.initializeRmtenantUpdate = function() {
            window.RmtenantUpdateModule.init();
        };
        
        // ìë™ ì´ˆê¸°í™” (ì¦‰ì‹œ ì‹¤í–‰)
        setTimeout(() => {
            console.log('ğŸ—ï¸ [RU] RmtenantUpdate ìë™ ì´ˆê¸°í™” ì‹œì‘');
            window.RmtenantUpdateModule.init();
        }, 100);

        // ğŸ”¥ íƒ­ í™œì„±í™” ê°ì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        window.addEventListener('focus', function() {
            // íƒ­ì´ ë‹¤ì‹œ í¬ì»¤ìŠ¤ë  ë•Œë§ˆë‹¤ ìƒˆ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (window.selected_rmtenant_id && window.RmtenantUpdateModule) {
                console.log('ğŸ”„ [RU] íƒ­ í¬ì»¤ìŠ¤ ê°ì§€ - ìƒˆ ë°ì´í„° ì²´í¬:', window.selected_rmtenant_id);
                
                // í˜„ì¬ ë¡œë“œëœ IDì™€ ë‹¤ë¥´ë©´ ìƒˆë¡œ ë¡œë“œ
                if (window.RmtenantUpdateModule.data.rmtenantId !== window.selected_rmtenant_id) {
                    console.log('ğŸ”„ [RU] ë‹¤ë¥¸ ID ê°ì§€ - ë°ì´í„° ìƒˆë¡œ ë¡œë“œ');
                    window.RmtenantUpdateModule.data.rmtenantId = window.selected_rmtenant_id;
                    window.RmtenantUpdateModule.loadTenantData();
                    delete window.selected_rmtenant_id;
                }
            }
        });

        
        console.log('ğŸ—ï¸ [RU] RmtenantUpdateModule ë¡œë“œ ì™„ë£Œ');
        
    })(); // ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ ë
    </script>
</body>
</html>