<!-- SPA íƒ­ìš© ê±´ë¬¼ì´ë ¥ ìƒì„¸í¸ì§‘ í˜ì´ì§€ -->
<link rel="stylesheet" href="/static/css/common.css">
<style>
    /* blpds_update í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
    #blpds_update_outer {
        padding: 20px;
        padding-bottom: 0;
        overflow-y: auto;
        background-color: #f8f9fa;
        font-size: 12px;
    }

    #blpds_update_outer .button-area {
        text-align: right;
        margin-bottom: 15px;
        padding: 15px;
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    #blpds_update_outer .button-area button {
        margin-left: 5px;
        padding: 6px 12px;
        background: #fff;
        color: #333;
        border: 1px solid #ced4da;
        font-size: 12px;
        font-family: inherit;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s ease-in-out;
    }

    #blpds_update_outer .button-area button:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
    }

    #blpds_update_outer .button-area button.btn-primary {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }

    #blpds_update_outer .button-area button.btn-primary:hover {
        background: #0056b3;
        border-color: #004085;
    }

    #blpds_update_outer .button-area button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    #blpds_update_outer .content-area {
        background-color: white;
        border-radius: 5px;
        border: 1px solid #dee2e6;
        min-height: 400px;
    }

    #blpds_update_outer .form-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        font-size: 12px;
    }

    #blpds_update_outer .form-table td {
        padding: 8px;
        border: 1px solid #dee2e6;
        vertical-align: middle;
    }

    #blpds_update_outer .form-table .label {
        background-color: #f8f9fa;
        font-weight: bold;
        text-align: center;
        width: 15%;
        min-width: 80px;
    }

    #blpds_update_outer .form-table input,
    #blpds_update_outer .form-table textarea {
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 4px 6px;
        font-size: 12px;
        width: 100%;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    #blpds_update_outer .form-table input:focus,
    #blpds_update_outer .form-table textarea:focus {
        border-color: #007bff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    #blpds_update_outer .form-table input:disabled {
        background-color: #e9ecef;
    }

    #blpds_update_outer .image-container {
        text-align: center;
        height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }

    #blpds_update_outer .image-container img {
        max-width: 400px;
        max-height: 240px;
        object-fit: contain;
    }

    #blpds_update_outer .no-image {
        color: #6c757d;
        font-style: italic;
    }

    #blpds_update_outer .file-info {
        background-color: #e9ecef;
        padding: 8px;
        border-radius: 4px;
        margin-top: 5px;
    }

    #blpds_update_outer .file-info a {
        color: #007bff;
        text-decoration: none;
    }

    #blpds_update_outer .file-info a:hover {
        text-decoration: underline;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
        #blpds_update_outer {
            padding: 10px;
        }
        
        #blpds_update_outer .form-table .label {
            width: 25%;
        }
        
        #blpds_update_outer .image-container img {
            max-width: 100%;
        }
    }
</style>

<div id="blpds_update_outer">
    <!-- ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ -->
    <div class="button-area">
        <button type="button" id="btn_default_photo" onclick="BlpdsUpdateModule.setAsDefaultPhoto()">ê¸°ë³¸ì‚¬ì§„ë“±ë¡</button>
        <button type="button" id="btn_save" class="btn-primary" onclick="BlpdsUpdateModule.saveData()">ì €ì¥</button>
        <button type="button" id="btn_delete" onclick="BlpdsUpdateModule.deleteData()">ì‚­ì œ</button>
        <button type="button" id="btn_list" onclick="BlpdsUpdateModule.goToList()">ëª©ë¡ë³´ê¸°</button>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
    <div class="content-area">
        <table class="form-table">
            <tr>
                <td class="label">ì œëª©</td>
                <td style="width: 35%;">
                    <input type="text" id="title" name="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                </td>
                <td class="label">í˜•ì‹</td>
                <td style="width: 35%;">
                    <input type="text" id="type_name" readonly>
                </td>
            </tr>
            <tr>
                <td class="label">ë“±ë¡ì</td>
                <td colspan="3">
                    <span id="reg_man_name"></span>
                    <input type="hidden" id="reg_man" name="reg_man">
                </td>
            </tr>
            <!-- ì´ë¯¸ì§€ ê´€ë¦¬ (type=1) -->
            <tr id="image_row_1" style="display: none;">
                <td class="label" rowspan="2">ì´ë¯¸ì§€</td>
                <td colspan="3">
                    <div class="image-container" id="image_display">
                        <div class="no-image">ì´ë¯¸ì§€ ì—†ìŒ</div>
                    </div>
                </td>
            </tr>
            <tr id="image_row_2" style="display: none;">
                <td colspan="3" style="text-align: right;">
                    <input type="file" id="filename" name="filename" accept="image/*">
                </td>
            </tr>
            <!-- íŒŒì¼ ê´€ë¦¬ (type=3) -->
            <tr id="file_row" style="display: none;">
                <td class="label">íŒŒì¼ ì²¨ë¶€</td>
                <td colspan="3" style="text-align: right;">
                    <input type="file" id="file_upload" name="file_upload">
                    <div id="current_file_info" class="file-info" style="display: none;">
                        <a href="#" id="current_file_link" target="_blank">í˜„ì¬ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</a>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="label" style="vertical-align: top;">ë‚´ìš©</td>
                <td colspan="3">
                    <textarea id="contents" name="contents" rows="10" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </td>
            </tr>
        </table>
    </div>

    <!-- íˆë“  í•„ë“œë“¤ -->
    <input type="hidden" id="auto_number" value="">
    <input type="hidden" id="bl_id" value="">
    <input type="hidden" id="type_chk" value="">
    <input type="hidden" id="prop_search" value="">
    <input type="hidden" id="maskname" value="">
    <input type="hidden" id="current_filename" value="">
    <input type="hidden" id="has_permission" value="false">
</div>

<script>
// ğŸ›¡ï¸ ì™„ì „í•œ ìŠ¤ì½”í”„ ë¶„ë¦¬ - ë³€ìˆ˜ ì¶©ëŒ ë°©ì§€
(function() {
    'use strict';
    
    console.log('ğŸ¢ blpds_update.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');
    
    if (typeof window.BlpdsUpdateModule !== 'undefined') {
    console.log('ğŸ¢ ê¸°ì¡´ ëª¨ë“ˆ ì¡´ì¬, ë¬´ì¡°ê±´ ì¬ì´ˆê¸°í™” ì‹œë„');
    
    // URL íŒŒë¼ë¯¸í„° í™•ì¸ (ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ì‹œë„)
    const currentUrl = window.location.href;
    const urlParams = new URLSearchParams(window.location.search);
    const auto_number_from_url = urlParams.get('auto_number');
    
    console.log('ğŸ¢ í˜„ì¬ URL:', currentUrl);
    console.log('ğŸ¢ URL search:', window.location.search);
    console.log('ğŸ¢ ì¶”ì¶œëœ auto_number:', auto_number_from_url);
    
    // URL íŒŒë¼ë¯¸í„° ë˜ëŠ” ì „ì—­ ë³€ìˆ˜ì—ì„œ auto_number í™•ì¸
    if ((auto_number_from_url && auto_number_from_url !== 'null' && auto_number_from_url !== 'undefined') || 
        window.selected_auto_number) {
        
        const autoNumber = auto_number_from_url || window.selected_auto_number;
        console.log('ğŸ¢ auto_number ë°œê²¬:', autoNumber, '- ì¬ì´ˆê¸°í™” ì‹¤í–‰');
        
        // ì¬ì´ˆê¸°í™”ë¥¼ ìœ„í•´ í”Œë˜ê·¸ ë¦¬ì…‹
        window.BlpdsUpdateModule.data.isInitialized = false;
        
        // ìƒˆ íŒŒë¼ë¯¸í„°ë¡œ ì¦‰ì‹œ ì´ˆê¸°í™”
        window.BlpdsUpdateModule.init();
    } else {
        console.log('ğŸ¢ auto_number ì—†ìŒ, ì¬ì´ˆê¸°í™” ê±´ë„ˆëœ€');
    }
    return; // ê¸°ì¡´ ëª¨ë“ˆ ì‚¬ìš©
}
    
    // ëª¨ë“ˆ ìƒì„±
    window.BlpdsUpdateModule = {
        data: {
            autoNumber: null,
            blId: null,
            typeChk: null, // 1:ì¼ë°˜íŒŒì¼, 2:í…ìŠ¤íŠ¸, 3:ì´ë¯¸ì§€
            propSearch: null,
            hasPermission: false,
            isInitialized: false,
            currentFile: null // í˜„ì¬ ì„ íƒëœ íŒŒì¼ ê°ì²´ (ì—…ë¡œë“œìš©)
        },

        init: function(paramsFromCall) {
            console.log('ğŸ¢ [blpds_update] ê±´ë¬¼ì´ë ¥ ìƒì„¸í¸ì§‘ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
            console.log('ğŸ¢ [blpds_update] ë°›ì€ ì´ˆê¸°í™” í˜¸ì¶œ íŒŒë¼ë¯¸í„° (paramsFromCall):', paramsFromCall);

            const urlParams = new URLSearchParams(window.location.search);
            const auto_number_from_url = urlParams.get('auto_number');
            const bl_id_from_url = urlParams.get('bl_id');
            const type_from_url = urlParams.get('type');
            const prop_search_from_url = urlParams.get('prop_search');

            console.log('ğŸ¢ [blpds_update] URL íŒŒë¼ë¯¸í„° ì§ì ‘ í™•ì¸ - auto_number:', auto_number_from_url, 'type:', type_from_url);

            let finalAutoNumber = null;
            let finalBlId = null;
            let finalType = '2'; // ê¸°ë³¸ê°’ì€ í…ìŠ¤íŠ¸ ì´ë ¥
            let finalPropSearch = null;

            // URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ê°€ ìµœìš°ì„ 
            if (auto_number_from_url && auto_number_from_url !== 'null' && auto_number_from_url !== 'undefined') {
                finalAutoNumber = parseInt(parseFloat(auto_number_from_url), 10); // floatì„ ë¨¼ì € parseí•œ í›„ intë¡œ ë³€í™˜
                finalBlId = bl_id_from_url;
                finalType = type_from_url || '2';
                finalPropSearch = prop_search_from_url;
            }
            // paramsFromCallì—ì„œ ê°€ì ¸ì˜¤ê¸° (ì •ìˆ˜ ë³€í™˜)
            else if (paramsFromCall && (paramsFromCall.auto_number || paramsFromCall.auto_number === 0)) {
                finalAutoNumber = parseInt(parseFloat(paramsFromCall.auto_number), 10);
                finalBlId = paramsFromCall.bl_id;
                finalType = paramsFromCall.type || '2';
                finalPropSearch = paramsFromCall.prop_search;
            }
            // ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸° (ì •ìˆ˜ ë³€í™˜)
            else if (window.selected_auto_number || window.selected_auto_number === 0) {
                finalAutoNumber = parseInt(parseFloat(window.selected_auto_number), 10);
                finalBlId = window.selected_bl_id;
                finalType = window.selected_file_type || '2';
                finalPropSearch = window.currentPropId;
            }
            const finalParams = {
                auto_number: finalAutoNumber,
                bl_id: finalBlId,
                type: finalType,
                prop_search: finalPropSearch
            };
            console.log('ğŸ¢ [blpds_update] ìµœì¢… ê²°ì •ëœ ì´ˆê¸°í™” íŒŒë¼ë¯¸í„°:', finalParams);

            // ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆë”ë¼ë„, auto_number ë˜ëŠ” typeì´ ë³€ê²½ë˜ì—ˆë‹¤ë©´ ë‹¤ì‹œ ë¡œë“œ
            if (this.data.isInitialized &&
                (this.data.autoNumber === finalAutoNumber && this.data.typeChk === finalType)) {
                console.log('ğŸ¢ [blpds_update] ë™ì¼í•œ íŒŒë¼ë¯¸í„°ë¡œ ì´ë¯¸ ì´ˆê¸°í™”ë¨, ì¶”ê°€ ë¡œë“œ ë¶ˆí•„ìš”.');
                return; // ë³€ê²½ëœ íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™” ë¡œì§ì„ ê±´ë„ˆëœë‹ˆë‹¤.
            }
            // --- í•µì‹¬ ìˆ˜ì • ë¶€ë¶„ ë ---

            if (isNaN(finalAutoNumber) || finalAutoNumber === null || typeof finalAutoNumber === 'undefined') {
                console.error('ğŸ¢ [blpds_update] auto_numberê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜ì´ì§€ ë¡œë“œ ì¤‘ë‹¨.');
                alert('ì´ë ¥ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                const contentArea = document.getElementById('blpds_update_outer');
                if (contentArea) {
                    contentArea.innerHTML = '<div style="text-align: center; padding: 50px; color: #dc3545;">ğŸš¨ ì´ë ¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                this.data.isInitialized = false;
                return;
            }

            this.data.autoNumber = finalAutoNumber;
            this.data.blId = finalBlId;
            this.data.typeChk = finalType; // 1:ì¼ë°˜íŒŒì¼, 2:í…ìŠ¤íŠ¸, 3:ì´ë¯¸ì§€
            this.data.propSearch = finalPropSearch;

            document.getElementById('auto_number').value = this.data.autoNumber || '';
            document.getElementById('bl_id').value = this.data.blId || '';
            document.getElementById('type_chk').value = this.data.typeChk || '';
            document.getElementById('prop_search').value = this.data.propSearch || '';

            this.data.isInitialized = true; // ì´ì œ ì´ˆê¸°í™” ì™„ë£Œ í”Œë˜ê·¸ ì„¤ì •

            console.log('ğŸ¢ [blpds_update] ì´ˆê¸°í™”ëœ ë°ì´í„°:', {
                autoNumber: this.data.autoNumber,
                blId: this.data.blId,
                typeChk: this.data.typeChk,
                propSearch: this.data.propSearch
            });

            this.setupUI(); // UI ë¨¼ì € ì„¤ì •
            this.loadData(); // ë°ì´í„° ë¡œë“œ (ë³€ê²½ëœ ë°ì´í„°ë¡œ ë‹¤ì‹œ ë¡œë“œ)
        },
        
        // UI ì„¤ì •
        setupUI: function() {
            const typeChk = this.data.typeChk;
            const typeNameInput = document.getElementById('type_name');
            
            console.log('ğŸ¢ [blpds_update] setupUI í˜¸ì¶œë¨, typeChk:', typeChk);
            
            document.getElementById('image_row_1').style.display = 'table-row';
            document.getElementById('image_row_2').style.display = 'table-row';
            document.getElementById('file_row').style.display = 'table-row';
            
            let typeName = '';
            if (typeChk === '1') typeName = 'ì´ë¯¸ì§€ê´€ë¦¬';
            else if (typeChk === '2') typeName = 'ì´ë ¥ê´€ë¦¬';
            else if (typeChk === '3') typeName = 'íŒŒì¼ê´€ë¦¬';
            
            typeNameInput.value = typeName;
            console.log('ğŸ¢ [blpds_update] UI ìš”ì†Œë“¤ ê°•ì œ í‘œì‹œë¨');
            
            const defaultPhotoBtn = document.getElementById('btn_default_photo');
            if (defaultPhotoBtn) {
                defaultPhotoBtn.style.display = typeChk === '1' ? 'inline-block' : 'none';
            }
            
            const contentsTextarea = document.getElementById('contents');
            if (typeChk === '2') {
                contentsTextarea.rows = 15;
            } else {
                contentsTextarea.rows = 5;
            }
            
            console.log('ğŸ¢ [blpds_update] setupUI ì™„ë£Œ');
        },
        adjustUIAfterDataLoad: function(actualType) {
            console.log('ğŸ¢ [blpds_update] adjustUIAfterDataLoad í˜¸ì¶œë¨, actualType:', actualType);
            
            if (actualType === '1') {
                document.getElementById('image_row_1').style.display = 'table-row';
                document.getElementById('image_row_2').style.display = 'table-row';
                document.getElementById('file_row').style.display = 'none';
                
                const defaultPhotoBtn = document.getElementById('btn_default_photo');
                if (defaultPhotoBtn) {
                    defaultPhotoBtn.style.display = 'inline-block';
                }
                console.log('ğŸ¢ [blpds_update] ì´ë¯¸ì§€ê´€ë¦¬ UI í™œì„±í™”');
                
            } else if (actualType === '3') {
                document.getElementById('image_row_1').style.display = 'none';
                document.getElementById('image_row_2').style.display = 'none';
                document.getElementById('file_row').style.display = 'table-row';
                
                const defaultPhotoBtn = document.getElementById('btn_default_photo');
                if (defaultPhotoBtn) {
                    defaultPhotoBtn.style.display = 'none';
                }
                console.log('ğŸ¢ [blpds_update] íŒŒì¼ê´€ë¦¬ UI í™œì„±í™”');
                
            } else if (actualType === '2') {
                document.getElementById('image_row_1').style.display = 'none';
                document.getElementById('image_row_2').style.display = 'none';
                document.getElementById('file_row').style.display = 'none';
                console.log('ğŸ¢ [blpds_update] ì´ë ¥ê´€ë¦¬ UI í™œì„±í™”');
            }
            
            const typeNameInput = document.getElementById('type_name');
            let typeName = '';
            if (actualType === '1') typeName = 'ì´ë¯¸ì§€ê´€ë¦¬';
            else if (actualType === '2') typeName = 'ì´ë ¥ê´€ë¦¬';
            else if (actualType === '3') typeName = 'íŒŒì¼ê´€ë¦¬';
            typeNameInput.value = typeName;
        },
        
        // ë°ì´í„° ë¡œë“œ
        loadData: function() {
            if (!this.data.autoNumber) {
                console.error('ğŸ¢ auto_numberê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const autoNumber = parseInt(this.data.autoNumber, 10);

            console.log('ğŸ¢ ë°ì´í„° ë¡œë“œ ì‹œì‘:', autoNumber);

            fetch('/fm/blpds_update/get_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    auto_number: autoNumber,
                    bl_id: this.data.blId
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('ğŸ¢ ì„œë²„ ì‘ë‹µ ë°ì´í„°:', data);
                
                if (data.success) {
                    this.data.hasPermission = data.has_permission;
                    document.getElementById('has_permission').value = data.has_permission;
                    
                    this.populateForm(data.data);
                    this.updatePermissionUI();
                    
                    if (data.data.maskname) {
                        setTimeout(() => {
                            this.testBl_PdsFile(data.data.maskname);
                        }, 500);
                    }
                } else {
                    this.showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ğŸ¢ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                this.showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        },
        testBl_PdsFile: function(maskname) {
            if (!maskname) return;
            
            console.log('ğŸ§ª bl_pds íŒŒì¼ í…ŒìŠ¤íŠ¸ ì‹œì‘:', maskname);
            
            // 1. ë””ë²„ê¹… ì—”ë“œí¬ì¸íŠ¸ë¡œ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            fetch(`/debug/check_bl_pds_file/${maskname}`)
                .then(response => response.json())
                .then(data => {
                    console.log('ğŸ” bl_pds íŒŒì¼ ì²´í¬ ê²°ê³¼:', data);
                })
                .catch(error => {
                    console.error('ğŸ”´ bl_pds íŒŒì¼ ì²´í¬ ì‹¤íŒ¨:', error);
                });
            
            // 2. ì‹¤ì œ ì´ë¯¸ì§€ URL í…ŒìŠ¤íŠ¸
            const imageUrl = `/bl_pds/${maskname}`;
            fetch(imageUrl)
                .then(response => {
                    console.log('ğŸ§ª ì´ë¯¸ì§€ URL í…ŒìŠ¤íŠ¸ ê²°ê³¼:', {
                        url: imageUrl,
                        status: response.status,
                        statusText: response.statusText,
                        contentType: response.headers.get('content-type')
                    });
                    
                    if (response.ok) {
                        console.log('âœ… ì´ë¯¸ì§€ íŒŒì¼ ì ‘ê·¼ ì„±ê³µ!');
                    } else {
                        console.log('ğŸ”´ ì´ë¯¸ì§€ íŒŒì¼ ì ‘ê·¼ ì‹¤íŒ¨');
                    }
                })
                .catch(error => {
                    console.error('ğŸ”´ ì´ë¯¸ì§€ URL í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                });
        },
        
        // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        populateForm: function(data) {
            document.getElementById('title').value = data.title || '';
            document.getElementById('contents').value = data.contents || '';
            document.getElementById('reg_man').value = data.reg_man || '';
            document.getElementById('reg_man_name').textContent = data.reg_man_name || '';
            document.getElementById('maskname').value = data.maskname || '';
            document.getElementById('current_filename').value = data.filename || '';
            
            console.log('ğŸ¢ [blpds_update] populateForm ì „ì²´ ë°ì´í„°:', data);
            console.log('ğŸ¢ [blpds_update] ì´ˆê¸°í™”ëœ íƒ€ì… (this.data.typeChk):', this.data.typeChk);
            console.log('ğŸ¢ [blpds_update] ë°ì´í„°ë² ì´ìŠ¤ filetype:', data.filetype);
            console.log('ğŸ¢ [blpds_update] filename:', data.filename);
            console.log('ğŸ¢ [blpds_update] maskname:', data.maskname);
            
            const actualType = data.filetype || this.data.typeChk;
            console.log('ğŸ¢ [blpds_update] ì‹¤ì œ ì‚¬ìš©í•  íƒ€ì…:', actualType);
            
            // â­ ì‹¤ì œ íƒ€ì…ì— ë§ê²Œ UI ì¬ì¡°ì •
            this.adjustUIAfterDataLoad(actualType);
            
            if (actualType === '1') {
                console.log('ğŸ¢ [blpds_update] ì´ë¯¸ì§€ê´€ë¦¬ íƒ€ì…ìœ¼ë¡œ ì²˜ë¦¬');
                
                const imageDisplay = document.getElementById('image_display');
                console.log('ğŸ¢ [blpds_update] ì´ë¯¸ì§€ ë””ìŠ¤í”Œë ˆì´ ìš”ì†Œ:', imageDisplay);
                
                if (data.maskname) {
                    this.displayImage(data.maskname);
                    
                    setTimeout(() => {
                        const img = imageDisplay.querySelector('img');
                        console.log('ğŸ¢ [blpds_update] ì´ë¯¸ì§€ ìš”ì†Œ í™•ì¸:', img);
                        if (img) {
                            console.log('ğŸ¢ [blpds_update] ì´ë¯¸ì§€ src:', img.src);
                            console.log('ğŸ¢ [blpds_update] ì´ë¯¸ì§€ complete:', img.complete);
                            console.log('ğŸ¢ [blpds_update] ì´ë¯¸ì§€ naturalWidth:', img.naturalWidth);
                        }
                    }, 1000);
                }
            }
            
            if (actualType === '3') {
                console.log('ğŸ¢ [blpds_update] íŒŒì¼ê´€ë¦¬ íƒ€ì…ìœ¼ë¡œ ì²˜ë¦¬');
                this.displayFileInfoImproved(data.filename, this.data.autoNumber, data.maskname);
                
                if (data.filename && data.maskname) {
                    const extension = data.filename.split('.').pop().toLowerCase();
                    const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'];
                    
                    if (imageExtensions.includes(extension)) {
                        console.log('ğŸ¢ [blpds_update] íŒŒì¼ê´€ë¦¬ íƒ€ì…ì´ì§€ë§Œ ì´ë¯¸ì§€ íŒŒì¼ì´ë¯€ë¡œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ');
                        this.displayFileAsImage(data.maskname);
                    }
                }
            }
        },
        displayFileAsImage: function(maskname) {
            const fileRow = document.getElementById('file_row');
            
            // ê¸°ì¡´ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í–‰ì´ ìˆìœ¼ë©´ ì œê±°
            const existingImageRow = document.getElementById('file_image_preview_row');
            if (existingImageRow) {
                existingImageRow.remove();
            }
            
            if (maskname) {
                // JSPì™€ ë™ì¼í•œ ì§ì ‘ ê²½ë¡œ ì‚¬ìš©
                const imageUrl = `/bl_pds/${maskname}`;
                
                console.log('ğŸ¢ [blpds_update] íŒŒì¼ê´€ë¦¬ JSP ë°©ì‹ ì´ë¯¸ì§€ URL:', imageUrl);
                console.log('ğŸ¢ [blpds_update] íŒŒì¼ê´€ë¦¬ maskname:', maskname);
                
                // ìƒˆë¡œìš´ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í–‰ ìƒì„±
                const imageRow = document.createElement('tr');
                imageRow.id = 'file_image_preview_row';
                imageRow.innerHTML = `
                    <td class="label">ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</td>
                    <td colspan="3">
                        <div class="image-container" style="height: 200px;">
                            <img src="${imageUrl}" 
                                alt="ì´ë¯¸ì§€ ë¡œë”© ì¤‘..." 
                                style="max-width: 350px; max-height: 180px; object-fit: contain;"
                                onerror="console.log('ğŸ”´ [blpds_update] íŒŒì¼ê´€ë¦¬ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', '${imageUrl}'); this.style.display='none'; this.parentNode.innerHTML='<div class=\\"no-image\\">ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';"
                                onload="console.log('âœ… [blpds_update] íŒŒì¼ê´€ë¦¬ ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', '${imageUrl}');">
                        </div>
                    </td>
                `;
                
                // íŒŒì¼ ì²¨ë¶€ í–‰ ë‹¤ìŒì— ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í–‰ ì‚½ì…
                fileRow.parentNode.insertBefore(imageRow, fileRow.nextSibling);
            }
        },

        displayImage: function(maskname) {
            const imageDisplay = document.getElementById('image_display');
            
            console.log('ğŸ¢ [blpds_update] displayImage í˜¸ì¶œë¨, maskname:', maskname);
            console.log('ğŸ¢ [blpds_update] imageDisplay ìš”ì†Œ:', imageDisplay);
            
            if (maskname) {
                const imageUrl = `/bl_pds/${maskname}`;
                console.log('ğŸ¢ [blpds_update] JSP ë°©ì‹ ì´ë¯¸ì§€ URL:', imageUrl);

                const imageId = `img_${Date.now()}`;

                imageDisplay.innerHTML = `
                    <img id="${imageId}" 
                        src="${imageUrl}" 
                        alt="ì´ë¯¸ì§€ ë¡œë”© ì¤‘..." 
                        style="max-width: 400px; max-height: 240px; object-fit: contain; border: 2px solid #007bff;">`;

                setTimeout(() => {
                    const img = document.getElementById(imageId);
                    if (img) {
                        img.addEventListener('load', () => {
                            console.log('âœ… [blpds_update] ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', imageUrl, 'ID:', imageId, 'í¬ê¸°:', img.naturalWidth + 'x' + img.naturalHeight);
                            img.style.border = '2px solid #28a745';
                        });

                        img.addEventListener('error', () => {
                            console.log('ğŸ”´ [blpds_update] ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', imageUrl, 'ID:', imageId);
                            img.style.display = 'none';
                            imageDisplay.innerHTML = `<div class="no-image" style="padding: 20px; border: 2px solid #dc3545;">ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤<br>URL: ${imageUrl}</div>`;
                        });
                    }
                }, 100); 
            } else {
                console.log('ğŸ¢ [blpds_update] masknameì´ ì—†ìŒ, ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ');
                imageDisplay.innerHTML = '<div class="no-image" style="padding: 20px; border: 2px solid #dc3545;">ì´ë¯¸ì§€ ì—†ìŒ</div>';
            }
        },


        displayFileInfoImproved: function(filename, autoNumber, maskname) {
            const fileInfo = document.getElementById('current_file_info');
            const fileLink = document.getElementById('current_file_link');
            
            console.log('ğŸ¢ [blpds_update] displayFileInfoImproved í˜¸ì¶œë¨:', { filename, autoNumber, maskname });
            
            if (filename && autoNumber) {
                const parsedAutoNumber = parseInt(autoNumber, 10);
                fileLink.textContent = filename;
                fileLink.href = `/fm/blpds_update/download_file?auto_number=${parsedAutoNumber}`;
                fileInfo.style.display = 'block';
                
                console.log('ğŸ¢ [blpds_update] íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë§í¬ ì„¤ì •ë¨:', fileLink.href);
                
                if (maskname) {
                    const additionalInfo = document.createElement('div');
                    additionalInfo.style.fontSize = '11px';
                    additionalInfo.style.color = '#666';
                    additionalInfo.style.marginTop = '5px';
                    additionalInfo.textContent = `ì‹¤ì œ íŒŒì¼: ${maskname}`;
                    
                    const existingInfo = fileInfo.querySelector('.additional-file-info');
                    if (existingInfo) existingInfo.remove();
                    
                    additionalInfo.className = 'additional-file-info';
                    fileInfo.appendChild(additionalInfo);
                }
                
            } else {
                console.log('ğŸ”´ [blpds_update] íŒŒì¼ ì •ë³´ í‘œì‹œ ì‹¤íŒ¨');
                fileInfo.style.display = 'none';
            }
        },

        displayImageWithFile: function(filename) {
            const imageDisplay = document.getElementById('image_display');
            
            if (filename) {
                const imageUrl = `/bl_pds/${filename}`;
                
                console.log('ğŸ¢ [blpds_update] ì§ì ‘ íŒŒì¼ëª…ìœ¼ë¡œ ì´ë¯¸ì§€ URL:', imageUrl);
                
                imageDisplay.innerHTML = `
                    <img src="${imageUrl}" 
                        alt="ì´ë¯¸ì§€ ë¡œë”© ì¤‘..." 
                        style="max-width: 400px; max-height: 240px; object-fit: contain;"
                        onerror="console.log('ğŸ”´ [blpds_update] ì§ì ‘ íŒŒì¼ëª… ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', '${imageUrl}'); this.style.display='none'; this.parentNode.innerHTML='<div class=\\"no-image\\">ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';"
                        onload="console.log('âœ… [blpds_update] ì§ì ‘ íŒŒì¼ëª… ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', '${imageUrl}');">`;
            }
        },

        
        // íŒŒì¼ ì •ë³´ í‘œì‹œ
        displayFileInfo: function(filename, autoNumber) {
            const fileInfo = document.getElementById('current_file_info');
            const fileLink = document.getElementById('current_file_link');
            
            if (filename && autoNumber) {
                // ì •ìˆ˜ë¡œ ë³€í™˜ëœ auto_number ì‚¬ìš©
                const parsedAutoNumber = parseInt(autoNumber, 10);
                fileLink.textContent = filename;
                fileLink.href = `/fm/blpds_update/download_file?auto_number=${parsedAutoNumber}`;
                fileInfo.style.display = 'block';
                
                console.log('ğŸ¢ [blpds_update] íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë§í¬:', fileLink.href);
            } else {
                fileInfo.style.display = 'none';
            }
        },
        
        // ê¶Œí•œ UI ì—…ë°ì´íŠ¸
        updatePermissionUI: function() {
            const hasPermission = this.data.hasPermission;
            
            // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            document.getElementById('btn_save').disabled = !hasPermission;
            document.getElementById('btn_delete').disabled = !hasPermission;
            
            const defaultPhotoBtn = document.getElementById('btn_default_photo');
            if (defaultPhotoBtn) {
                defaultPhotoBtn.disabled = !hasPermission || this.data.typeChk !== '1';
            }
            
            // ì…ë ¥ í•„ë“œ ì½ê¸° ì „ìš© ì„¤ì •
            if (!hasPermission) {
                document.getElementById('title').readOnly = true;
                document.getElementById('contents').readOnly = true;
                document.getElementById('filename').disabled = true;
                
                const fileUpload = document.getElementById('file_upload');
                if (fileUpload) fileUpload.disabled = true;
                
                this.showWarning('í•´ë‹¹ ì‚¬ì—…ì¥ì˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ì¡°íšŒë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            }
        },
        
        // ë°ì´í„° ì €ì¥
        saveData: function() {
            if (!this.data.hasPermission) {
                alert('ì €ì¥ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!this.validateForm()) {
                return;
            }
            
            const formData = new FormData();
            formData.append('auto_number', this.data.autoNumber);
            formData.append('bl_id', this.data.blId);
            formData.append('title', document.getElementById('title').value);
            formData.append('contents', document.getElementById('contents').value);
            formData.append('type', this.data.typeChk);
            
            // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
            if (this.data.typeChk === '1') {
                const fileInput = document.getElementById('filename');
                if (fileInput.files[0]) {
                    formData.append('file', fileInput.files[0]);
                }
            } else if (this.data.typeChk === '3') {
                const fileInput = document.getElementById('file_upload');
                if (fileInput.files[0]) {
                    formData.append('file', fileInput.files[0]);
                }
            }
            
            console.log('ğŸ¢ ì €ì¥í•  ë°ì´í„°:', Object.fromEntries(formData));
            
            // ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
            const saveBtn = document.getElementById('btn_save');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'ì €ì¥ ì¤‘...';
            saveBtn.disabled = true;
            
            fetch('/fm/blpds_update/save_data', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showSuccess('ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // ì €ì¥ í›„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    setTimeout(() => {
                        this.loadData();
                    }, 1000);
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ğŸ¢ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            })
            .finally(() => {
                // ì €ì¥ ë²„íŠ¼ ë³µì›
                saveBtn.textContent = originalText;
                saveBtn.disabled = !this.data.hasPermission;
            });
        },
        
        // í¼ ìœ íš¨ì„± ê²€ì‚¬
        validateForm: function() {
            const title = document.getElementById('title').value.trim();
            
            if (!title) {
                alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                document.getElementById('title').focus();
                return false;
            }
            
            return true;
        },
        
        // ë°ì´í„° ì‚­ì œ
        deleteData: function() {
            if (!this.data.hasPermission) {
                alert('ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            fetch('/fm/blpds_update/delete_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    auto_number: this.data.autoNumber
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showSuccess('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // ì‚­ì œ í›„ ëª©ë¡ìœ¼ë¡œ ì´ë™
                    setTimeout(() => {
                        this.goToList();
                    }, 1000);
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ğŸ¢ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        },
        
        // ê¸°ë³¸ì‚¬ì§„ìœ¼ë¡œ ì„¤ì •
        setAsDefaultPhoto: function() {
            if (!this.data.hasPermission || this.data.typeChk !== '1') {
                alert('ê¸°ë³¸ì‚¬ì§„ ì„¤ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const maskname = document.getElementById('maskname').value;
            if (!maskname) {
                alert('ì„¤ì •í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm('ì´ ì´ë¯¸ì§€ë¥¼ ê¸°ë³¸ì‚¬ì§„ìœ¼ë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            fetch('/fm/blpds_update/set_default_photo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    bl_id: this.data.blId,
                    maskname: maskname
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showSuccess('ê¸°ë³¸ì‚¬ì§„ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ê¸°ë³¸ì‚¬ì§„ ì„¤ì • ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ğŸ¢ ê¸°ë³¸ì‚¬ì§„ ì„¤ì • ì˜¤ë¥˜:', error);
                alert('ê¸°ë³¸ì‚¬ì§„ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        },
        
        // ëª©ë¡ìœ¼ë¡œ ì´ë™
        goToList: function() {
            // ê±´ë¬¼ìˆ˜ì • í˜ì´ì§€ì˜ ì´ë ¥ íƒ­ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            window.selected_bl_id = this.data.blId;
            
            if (typeof window.loadContent === 'function') {
                window.loadContent('/fm/bl_update.html', `ê±´ë¬¼ìˆ˜ì •(${this.data.blId})`);
                
                // íƒ­ ì „í™˜ (ì´ë ¥ íƒ­)
                setTimeout(() => {
                    if (window.BlUpdateModule && typeof window.BlUpdateModule.showTab === 'function') {
                        window.BlUpdateModule.showTab(3);
                    }
                }, 500);
                
                window.showStatus && window.showStatus('ê±´ë¬¼ìˆ˜ì • í˜ì´ì§€ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
            } else {
                console.error('ğŸ¢ loadContent í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        },
        
        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        showSuccess: function(message) {
            console.log('ğŸ¢ ì„±ê³µ:', message);
            if (window.showStatus) {
                window.showStatus(message);
            } else {
                alert(message);
            }
        },
        
        // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
        showWarning: function(message) {
            console.warn('ğŸ¢ ê²½ê³ :', message);
            if (window.showStatus) {
                window.showStatus(message);
            }
        },
        
        // ì˜¤ë¥˜ í‘œì‹œ
        showError: function(message) {
            console.error('ğŸ¢ ì˜¤ë¥˜:', message);
            alert(message);
        }
    };
    
    // ì „ì—­ ì´ˆê¸°í™” í•¨ìˆ˜ ë“±ë¡
    window.initBlpdsUpdatePage = function(params) {
        console.log('ğŸ¢ [blpds_update] window.initBlpdsUpdatePage í˜¸ì¶œë¨ (ì™¸ë¶€ì—ì„œ):', params);
        // ì´ í•¨ìˆ˜ê°€ í˜¸ì¶œëœë‹¤ë©´, ì „ë‹¬ëœ paramsë¥¼ ì‚¬ìš©í•˜ì—¬ initì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
        window.BlpdsUpdateModule.init(params);
    };
    setTimeout(function() {
        const urlParams = new URLSearchParams(window.location.search);
        const auto_number_from_url = urlParams.get('auto_number');
        
        // URLì— auto_numberê°€ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ì´ˆê¸°í™”
        if (auto_number_from_url && auto_number_from_url !== 'null' && auto_number_from_url !== 'undefined') {
            console.log('ğŸ¢ [blpds_update] URL íŒŒë¼ë¯¸í„°ë¡œ ê°•ì œ ì´ˆê¸°í™”:', auto_number_from_url);
            window.BlpdsUpdateModule.data.isInitialized = false;
            window.BlpdsUpdateModule.init();
        } else if (!window.BlpdsUpdateModule.data.isInitialized) {
            console.log('ğŸ¢ [blpds_update] setTimeoutì„ í†µí•œ ìë™ ì´ˆê¸°í™” ì‹œë„');
            window.BlpdsUpdateModule.init();
        }
    }, 100);

    console.log('ğŸ¢ [blpds_update] BlpdsUpdateModule ë¡œë“œ ì™„ë£Œ');
})();
</script>