<link rel="stylesheet" href="/static/css/common.css">
<style>
    /* fl_list ìŠ¤íƒ€ì¼ - ë‹¤ë¥¸ í˜ì´ì§€ì™€ ì¼ê´€ì„± ë§ì¶¤ */
    #fl_list_outer {
        padding: 20px;
        padding-bottom: 0;
        overflow-y: auto;
        background-color: #f8f9fa;
        font-size: 12px;
    }

    /* ìƒë‹¨ ì˜ì—­ */
    #fl_list_outer .top-area {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 15px;
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    #fl_list_outer .top-area .left-section {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    #fl_list_outer .top-area label {
        font-size: 12px;
        font-weight: bold;
        color: #495057;
        white-space: nowrap;
    }

    #fl_list_outer .top-area select {
        height: 32px;
        border-radius: 4px;
        border: 1px solid #ced4da;
        min-width: 200px;
        font-size: 12px;
        padding: 4px 8px;
    }

    #fl_list_outer .top-area button {
        height: 32px;
        padding: 0 12px;
        background: #fff;
        color: #333;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.15s ease-in-out;
    }

    #fl_list_outer .top-area button:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
    }

    /* ë©”ì¸ ì˜ì—­ */
    #fl_list_outer .main-area {
        background-color: white;
        border-radius: 5px;
        border: 1px solid #dee2e6;
        padding: 20px;
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
    }

    /* ê²€ìƒ‰ ì˜ì—­ */
    #fl_list_outer .search-area {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
    }

    #fl_list_outer .search-area .search-left {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    #fl_list_outer .search-area input[type="text"] {
        height: 32px;
        padding: 0 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        min-width: 250px;
        font-size: 12px;
    }

    #fl_list_outer .search-area button {
        height: 32px;
        padding: 0 16px;
        background: #007bff;
        color: white;
        border: 1px solid #007bff;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
    }

    #fl_list_outer .search-area button:hover {
        background: #0056b3;
        border-color: #004085;
    }

    /* ë°ì´í„° í…Œì´ë¸” ì˜ì—­ */
    #fl_list_outer .data-table-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    #fl_list_outer .data-table {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 5px;
    }

    #fl_list_outer .data-table .table-header {
        display: flex;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: bold;
        font-size: 12px;
        height: 40px;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    #fl_list_outer .data-table .table-header .header-cell {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
        border-right: 1px solid #dee2e6;
        position: relative;
        cursor: pointer;
        transition: background-color 0.15s ease;
    }

    #fl_list_outer .data-table .table-header .header-cell:hover {
        background-color: #e9ecef;
    }

    #fl_list_outer .data-table .table-header .header-cell:last-child {
        border-right: none;
    }

    /* ì •ë ¬ ì•„ì´ì½˜ */
    #fl_list_outer .data-table .sort-icon {
        position: absolute;
        right: 8px;
        width: 12px;
        height: 12px;
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
        cursor: pointer;
    }

    /* ì •ë ¬ ì•„ì´ì½˜ - ì´ë¯¸ì§€ ëŒ€ì‹  CSSë¡œ êµ¬í˜„ */
    #fl_list_outer .data-table .sort-both::after { 
        content: 'â‡…'; 
        color: #999; 
        font-size: 10px;
    }
    #fl_list_outer .data-table .sort-asc::after { 
        content: 'â–²'; 
        color: #007bff; 
        font-size: 8px;
    }
    #fl_list_outer .data-table .sort-desc::after { 
        content: 'â–¼'; 
        color: #007bff; 
        font-size: 8px;
    }

    /* í…Œì´ë¸” ë³¸ë¬¸ */
    #fl_list_outer .data-table .table-content {
        display: block;
    }

    #fl_list_outer .data-table .table-row {
        display: flex;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        transition: background-color 0.15s ease;
        min-height: 36px;
        align-items: center;
    }

    #fl_list_outer .data-table .table-row:hover {
        background-color: #f8f9fa;
    }

    #fl_list_outer .data-table .table-row.selected {
        background-color: #e3f2fd;
        border-left: 3px solid #2196f3;
    }

    #fl_list_outer .data-table .table-cell {
        display: flex;
        align-items: center;
        padding: 8px;
        border-right: 1px solid #dee2e6;
        font-size: 12px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    #fl_list_outer .data-table .table-cell:last-child {
        border-right: none;
    }

    /* í…ìŠ¤íŠ¸ ì •ë ¬ */
    #fl_list_outer .data-table .text-center { justify-content: center; }
    #fl_list_outer .data-table .text-left { justify-content: flex-start; }
    #fl_list_outer .data-table .text-right { justify-content: flex-end; }

    /* ì»¬ëŸ¼ ë„ˆë¹„ */
    #fl_list_outer .data-table .col-prop { width: 20%; }
    #fl_list_outer .data-table .col-building { width: 20%; }
    #fl_list_outer .data-table .col-floor { width: 15%; }
    #fl_list_outer .data-table .col-area { width: 15%; }
    #fl_list_outer .data-table .col-tenant { width: 30%; }

    /* í•©ê³„ í–‰ */
    #fl_list_outer .data-table .total-row {
        background-color: #f8f9fa;
        font-weight: bold;
        border-top: 2px solid #007bff;
    }

    /* ë¹ˆ ë°ì´í„° ë©”ì‹œì§€ */
    #fl_list_outer .data-table .empty-message {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100px;
        color: #6c757d;
        font-size: 14px;
        border-bottom: none;
    }

    /* í˜ì´ì§€ë„¤ì´ì…˜ ì˜ì—­ */
    #fl_list_outer .pagination-area {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
        flex-shrink: 0;
    }

    #fl_list_outer .pagination-area .pagination-left {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    #fl_list_outer .pagination-area label {
        font-size: 12px;
        color: #495057;
        white-space: nowrap;
    }

    #fl_list_outer .pagination-area select {
        width: 80px;
        height: 32px;
        border-radius: 4px;
        border: 1px solid #ced4da;
        font-size: 12px;
    }

    #fl_list_outer .pagination-area .page-info {
        font-size: 12px;
        color: #495057;
    }

    #fl_list_outer .pagination-area .page-info .highlight {
        font-weight: bold;
        color: #007bff;
    }

    /* í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ */
    #fl_list_outer .pagination {
        display: flex;
        gap: 5px;
        align-items: center;
    }

    #fl_list_outer .pagination .page-btn {
        width: 32px;
        height: 32px;
        border: 1px solid #dee2e6;
        background: white;
        color: #495057;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.15s ease;
    }

    #fl_list_outer .pagination .page-btn:hover {
        background: #e9ecef;
        border-color: #adb5bd;
    }

    #fl_list_outer .pagination .page-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }

    #fl_list_outer .pagination .page-btn.disabled {
        background: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
    }

    /* ë¡œë”© í‘œì‹œ */
    #fl_list_outer .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        font-size: 14px;
        color: #6c757d;
    }

    #fl_list_outer .loading .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
        #fl_list_outer {
            padding: 10px;
        }
        
        #fl_list_outer .top-area {
            flex-direction: column;
            gap: 10px;
        }
        
        #fl_list_outer .search-area {
            flex-direction: column;
            gap: 10px;
        }
        
        #fl_list_outer .search-area .search-left {
            width: 100%;
        }
        
        #fl_list_outer .search-area input[type="text"] {
            width: 100%;
        }
    }
</style>

<div id="fl_list_outer">
    <!-- ìƒë‹¨ ì˜ì—­ -->
    <div class="top-area">
        <div class="left-section">
            <label for="bl_select">ê±´ë¬¼</label>
            <select id="bl_select">
                <option value="">ê±´ë¬¼ ì„ íƒ</option>
            </select>
        </div>
        <div class="right-section">
            <button type="button" id="btn_reset">ì´ˆê¸°í™”</button>
        </div>
    </div>

    <!-- ë©”ì¸ ì˜ì—­ -->
    <div class="main-area">
        <!-- ê²€ìƒ‰ ì˜ì—­ -->
        <div class="search-area">
            <div class="search-left">
                <input type="text" id="search_keyword" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì¸µëª…, ê±´ë¬¼ëª…, ì‚¬ì—…ì¥ëª… ë“±)">
            </div>
            <button type="button" id="btn_search">ì¡°íšŒ</button>
        </div>

        <!-- ë°ì´í„° í…Œì´ë¸” ì˜ì—­ -->
        <div class="data-table-wrapper">
            <div class="data-table">
                <!-- í…Œì´ë¸” í—¤ë” -->
                <div class="table-header">
                    <div class="header-cell col-prop text-center" data-sort="prop_name">
                        <span>ì‚¬ì—…ì¥</span>
                        <div class="sort-icon sort-both"></div>
                    </div>
                    <div class="header-cell col-building text-center" data-sort="bl_name">
                        <span>ê±´ë¬¼</span>
                        <div class="sort-icon sort-both"></div>
                    </div>
                    <div class="header-cell col-floor text-center" data-sort="fl_name">
                        <span>ì¸µ</span>
                        <div class="sort-icon sort-both"></div>
                    </div>
                    <div class="header-cell col-area text-center" data-sort="area_fl">
                        <span>ì¸µë©´ì </span>
                        <div class="sort-icon sort-both"></div>
                    </div>
                    <div class="header-cell col-tenant text-center" data-sort="tenant_names">
                        <span>ì…ì£¼ì‚¬ í˜„í™©</span>
                        <div class="sort-icon sort-both"></div>
                    </div>
                </div>

                <!-- í…Œì´ë¸” ë³¸ë¬¸ -->
                <div class="table-content" id="table_content">
                    <!-- ë¡œë”© í‘œì‹œ -->
                    <div class="loading">
                        <div class="spinner"></div>
                        ì¸µ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>
            </div>

            <!-- í˜ì´ì§€ë„¤ì´ì…˜ ì˜ì—­ -->
            <div class="pagination-area">
                <div class="pagination-left">
                    <label for="page_size">í˜ì´ì§€ë‹¹ ëª©ë¡ ìˆ˜:</label>
                    <select id="page_size">
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="All">ì „ì²´</option>
                    </select>
                </div>

                <div class="pagination" id="pagination">
                    <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>

                <div class="page-info">
                    ì „ì²´ <span class="highlight" id="total_count">0</span>ê°œ | 
                    <span class="highlight" id="current_page">1</span> / 
                    <span class="highlight" id="total_pages">1</span> í˜ì´ì§€
                </div>
            </div>
        </div>
    </div>

    <!-- íˆë“  í•„ë“œë“¤ -->
    <input type="hidden" id="current_sort_column" value="">
    <input type="hidden" id="current_sort_direction" value="">
</div>

<script>
// ğŸ›¡ï¸ ì™„ì „í•œ ìŠ¤ì½”í”„ ë¶„ë¦¬ - ë³€ìˆ˜ ì¶©ëŒ ë°©ì§€
(function() {
    'use strict';
    

    
    // ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± - ì¤‘ë³µ ë°©ì§€
  
Â  Â  console.log('ğŸ¢ fl_list.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');
Â  Â  
Â  Â  // ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± - ì¤‘ë³µ ë°©ì§€ ë° ì¬ì´ˆê¸°í™” ë¡œì§
Â  Â  if (typeof window.FlListModule !== 'undefined') {
Â  Â  Â  Â  console.log('ğŸ¢ ê¸°ì¡´ FlListModule ì¬ì´ˆê¸°í™” ì¤€ë¹„');
Â  Â  Â  Â  // ê¸°ì¡´ ëª¨ë“ˆì˜ dataë¥¼ ì´ˆê¸°í™”í•˜ì—¬ ë‹¤ìŒ init í˜¸ì¶œ ì‹œ ì™„ì „í•œ ì¬ë¡œë”©ì´ ì´ë£¨ì–´ì§€ë„ë¡ í•©ë‹ˆë‹¤.
Â  Â  Â  Â  if (window.FlListModule.data) {
Â  Â  Â  Â  Â  Â  window.FlListModule.data.isInitialized = false; // ì´ˆê¸°í™” í”Œë˜ê·¸ ë¦¬ì…‹
Â  Â  Â  Â  Â  Â  // ë‹¤ë¥¸ ìƒíƒœë“¤ë„ í•„ìš”í•˜ë‹¤ë©´ í•¨ê»˜ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
Â  Â  Â  Â  Â  Â  window.FlListModule.data.currentPage = 1;
Â  Â  Â  Â  Â  Â  window.FlListModule.data.sortColumn = null;
Â  Â  Â  Â  Â  Â  window.FlListModule.data.sortDirection = 'both';
Â  Â  Â  Â  Â  Â  window.FlListModule.data.blList = [];
Â  Â  Â  Â  Â  Â  window.FlListModule.data.flList = [];
Â  Â  Â  Â  Â  Â  window.FlListModule.data.lastClickTime = 0;
Â  Â  Â  Â  Â  Â  window.FlListModule.data.lastClickKey = null;
Â  Â  Â  Â  }
Â  Â  }
    
    // ëª¨ë“ˆ ìƒì„±
    window.FlListModule = {
        // ë°ì´í„° ì €ì¥ì†Œ
        data: {
            currentPage: 1,
            totalPages: 1,
            totalCount: 0,
            pageSize: 10,
            sortColumn: null,
            sortDirection: 'both',
            blList: [],
            flList: [],
            isInitialized: false,
            lastClickTime: 0,
            lastClickKey: null
        },
        
        // ì´ˆê¸°í™”
        init: function() {
            console.log('ğŸ¢ ì¸µì •ë³´ ëª©ë¡ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
            
            if (this.data.isInitialized) {
                console.log('ğŸ¢ ì´ë¯¸ ì´ˆê¸°í™”ë¨, ë°ì´í„°ë§Œ ìƒˆë¡œê³ ì¹¨');
                this.refreshData();
                return;
            }
            
            const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
            const prop_id = window.currentPropId;
            
            console.log('ğŸ¢ ë°›ì€ ë°ì´í„°:', { em_id, prop_id });
            
            if (!em_id) {
                console.error('ğŸ¢ em_idê°€ ì—†ìŠµë‹ˆë‹¤.');
                this.showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!prop_id) {
                console.error('ğŸ¢ prop_idê°€ ì—†ìŠµë‹ˆë‹¤.');
                this.showError('ì‚¬ì—…ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            this.data.isInitialized = true;
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            this.bindEvents();
            
            // ê±´ë¬¼ ëª©ë¡ ë¡œë“œ
            this.loadBuildingList();
            
            // ì¸µ ë°ì´í„° ë¡œë“œ
            this.loadFloorData('read');
        },
        
        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        refreshData: function() {
            console.log('ğŸ¢ ì¸µì •ë³´ ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
            this.loadBuildingList();
            this.loadFloorData('read');
        },
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        bindEvents: function() {
            // ê²€ìƒ‰ ë²„íŠ¼
            document.getElementById('btn_search').onclick = () => {
                this.data.currentPage = 1;
                this.loadFloorData('search');
            };
            
            // ê²€ìƒ‰ ì…ë ¥ ì—”í„°í‚¤
            document.getElementById('search_keyword').onkeypress = (e) => {
                if (e.key === 'Enter') {
                    this.data.currentPage = 1;
                    this.loadFloorData('search');
                }
            };
            
            // ì´ˆê¸°í™” ë²„íŠ¼
            document.getElementById('btn_reset').onclick = () => {
                this.resetFilters();
            };
            
            // ê±´ë¬¼ ì„ íƒ ë³€ê²½
            document.getElementById('bl_select').onchange = () => {
                this.data.currentPage = 1;
                this.loadFloorData('search');
            };
            
            // í˜ì´ì§€ í¬ê¸° ë³€ê²½
            document.getElementById('page_size').onchange = () => {
                this.data.currentPage = 1;
                this.data.pageSize = document.getElementById('page_size').value;
                this.loadFloorData('search');
            };
            
            // ì •ë ¬ í´ë¦­ ì´ë²¤íŠ¸
            document.querySelectorAll('.header-cell[data-sort]').forEach(header => {
                header.onclick = () => {
                    const sortColumn = header.dataset.sort;
                    this.handleSort(sortColumn);
                };
            });
            
            console.log('ğŸ¢ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
        },
        
        // ê±´ë¬¼ ëª©ë¡ ë¡œë“œ
        loadBuildingList: function() {
            const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
            const prop_id = window.currentPropId;
            
            if (!em_id || !prop_id) {
                console.error('ğŸ¢ í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½:', { em_id, prop_id });
                this.showError('í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            fetch('/fm/fl_list/get_bl_list', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ em_id: em_id, prop_id: prop_id })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('ğŸ¢ ê±´ë¬¼ ëª©ë¡ ì‘ë‹µ:', data);
                if (data && data.success) {
                    this.data.blList = data.data || [];
                    this.renderBuildingSelect(data.data || []);
                    console.log('ğŸ¢ ê±´ë¬¼ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', (data.data || []).length, 'ê°œ');
                } else {
                    console.error('ğŸ¢ ê±´ë¬¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', data ? data.message : 'Unknown error');
                    this.renderBuildingSelect([]); // ë¹ˆ ëª©ë¡ìœ¼ë¡œ ë Œë”ë§
                }
            })
            .catch(error => {
                console.error('ğŸ¢ ê±´ë¬¼ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                this.renderBuildingSelect([]); // ë¹ˆ ëª©ë¡ìœ¼ë¡œ ë Œë”ë§
                this.showError(`ê±´ë¬¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}`);
            });
        },
        
        // ê±´ë¬¼ ì„ íƒ ì˜µì…˜ ë Œë”ë§
        renderBuildingSelect: function(buildings) {
            const select = document.getElementById('bl_select');
            select.innerHTML = '<option value="">ê±´ë¬¼ ì„ íƒ</option>';
            
            buildings.forEach(building => {
                const option = document.createElement('option');
                option.value = building.bl_id;
                option.textContent = `${building.bl_name} (${building.bl_id})`;
                select.appendChild(option);
            });
        },
        
        // ì¸µ ë°ì´í„° ë¡œë“œ
        loadFloorData: function(mode = 'read') {
            const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
            const prop_id = window.currentPropId;
            
            if (!em_id || !prop_id) {
                console.warn('ğŸ¢ í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½:', { em_id, prop_id });
                this.showError('ì‚¬ìš©ì ì •ë³´ ë˜ëŠ” ì‚¬ì—…ì¥ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            this.showLoading();
            
            const requestData = {
                em_id: em_id,
                prop_id: prop_id,
                page_size: this.data.pageSize,
                page_number: this.data.currentPage,
                is_first_page: this.data.currentPage === 1,
                is_last_page: this.data.currentPage === this.data.totalPages
            };
            
            // ê²€ìƒ‰ ì¡°ê±´ ì¶”ê°€
            if (mode === 'search') {
                const keyword = document.getElementById('search_keyword');
                const blSelect = document.getElementById('bl_select');
                
                if (keyword && keyword.value.trim()) {
                    requestData.keyword = keyword.value.trim();
                }
                if (blSelect && blSelect.value) {
                    requestData.bl_id = blSelect.value;
                }
            }
            
            // ì •ë ¬ ì¡°ê±´ ì¶”ê°€
            if (this.data.sortColumn && this.data.sortDirection !== 'both') {
                requestData.sort_column = this.data.sortColumn;
                requestData.sort_direction = this.data.sortDirection;
            }
            
            const url = mode === 'search' ? 
                '/fm/fl_list/searchDataSheet_flList_data' : 
                '/fm/fl_list/readDataSheet_flList_data';
            
            console.log('ğŸ¢ ì¸µ ë°ì´í„° ìš”ì²­:', { url, requestData });
            
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('ğŸ¢ ì¸µ ë°ì´í„° ì‘ë‹µ:', data);
                if (data && data.success) {
                    this.data.flList = data.result_data || [];
                    this.data.currentPage = data.current_page || 1;
                    this.data.totalPages = data.total_pages || 1;
                    this.data.totalCount = data.total_count || 0;
                    
                    this.renderFloorTable(data.result_data || [], data.total_area);
                    this.renderPagination();
                    this.updateCountInfo();
                    
                    console.log('ğŸ¢ ì¸µ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', (data.result_data || []).length, 'ê°œ');
                } else {
                    console.error('ğŸ¢ ì¸µ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', data ? data.message : 'Unknown error');
                    this.showError(`ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${data ? data.message : 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('ğŸ¢ ì¸µ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                this.showError(`ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            });
        },
        
        // ì¸µ í…Œì´ë¸” ë Œë”ë§
        renderFloorTable: function(floorData, totalArea) {
            const tableContent = document.getElementById('table_content');
            
            if (!floorData || floorData.length === 0) {
                tableContent.innerHTML = `
                    <div class="empty-message">
                        ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            floorData.forEach(floor => {
                const propDisplay = floor.prop_name ? `${floor.prop_name} (${floor.prop_id})` : '';
                const blDisplay = floor.bl_name ? `${floor.bl_name} (${floor.bl_id})` : '';
                const flDisplay = floor.fl_name ? `${floor.fl_name} (${floor.fl_id})` : '';
                const areaDisplay = floor.area_fl_formatted ? `${floor.area_fl_formatted}ã¡` : '';
                
                html += `
                    <div class="table-row" 
                         data-prop-id="${floor.prop_id}" 
                         data-bl-id="${floor.bl_id}" 
                         data-fl-id="${floor.fl_id}"
                         data-prop-name="${floor.prop_name || ''}"
                         data-bl-name="${floor.bl_name || ''}"
                         data-fl-name="${floor.fl_name || ''}"
                         onclick="FlListModule.selectFloor(this)">
                        <div class="table-cell col-prop text-left">${propDisplay}</div>
                        <div class="table-cell col-building text-left">${blDisplay}</div>
                        <div class="table-cell col-floor text-center">${flDisplay}</div>
                        <div class="table-cell col-area text-right">${areaDisplay}</div>
                        <div class="table-cell col-tenant text-left">${floor.tenant_names || ''}</div>
                    </div>
                `;
            });
            
            // í•©ê³„ í–‰ ì¶”ê°€
           
            
            tableContent.innerHTML = html;
        },
        
        // ì¸µ ì„ íƒ
        selectFloor: function(element) {
            const propId = element.dataset.propId;
            const blId = element.dataset.blId;
            const flId = element.dataset.flId;
            
            if (!propId || !blId || !flId) {
                console.log('ğŸ”´ í•„ìˆ˜ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì¤‘ë³µ í´ë¦­ ë°©ì§€
            const clickKey = `${propId}_${blId}_${flId}`;
            if (this.data.lastClickKey === clickKey && (Date.now() - this.data.lastClickTime) < 1000) {
                console.log('ğŸŸ¡ ì¤‘ë³µ í´ë¦­ ë°©ì§€');
                return;
            }
            
            this.data.lastClickKey = clickKey;
            this.data.lastClickTime = Date.now();
            
            console.log('ğŸ”µ ì¸µ ì„ íƒë¨:', { propId, blId, flId });
            
            // ì„ íƒëœ ì¸µ ì •ë³´ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            window.selected_fl_prop_id = propId;
            window.selected_fl_bl_id = blId;
            window.selected_fl_id = flId;
            window.selected_prop_name = element.dataset.propName;
            window.selected_bl_name = element.dataset.blName;
            window.selected_fl_name = element.dataset.flName;
            
            // ì„ íƒ í‘œì‹œ
            document.querySelectorAll('.table-row').forEach(row => {
                row.classList.remove('selected');
            });
            element.classList.add('selected');
            
            // fl_update í˜ì´ì§€ë¡œ ì´ë™
            this.navigateToFlUpdate(propId, blId, flId);
        },
        
        // fl_updateë¡œ ì´ë™
        navigateToFlUpdate: function(propId, blId, flId) {
            try {
                console.log('ğŸŸ¢ fl_updateë¡œ ì´ë™:', { propId, blId, flId });
                
                // ğŸ’¡ í•µì‹¬: HiddenFrame íƒ­ ì‹œìŠ¤í…œ ì‚¬ìš©
                if (window.tabManager && typeof window.tabManager.addTab === 'function') {
                    const url = `/fm/fl_update.html?prop_id=${propId}&bl_id=${blId}&fl_id=${flId}`;
                    const title = `ì¸µìˆ˜ì •(${flId})`;
                    
                    // ê¸°ì¡´ íƒ­ ì œê±° í›„ ìƒˆ íƒ­ ìƒì„±
                    const existingTabId = 'tab__fm_fl_update_html';
                    window.tabManager.removeTab(existingTabId);
                    
                    setTimeout(() => {
                        window.tabManager.addTab(url, title);
                        if (window.showStatus) {
                            window.showStatus(`ì¸µìˆ˜ì • í˜ì´ì§€(${flId})ë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤.`);
                        }
                    }, 100);
                    
                } else if (typeof window.loadContent === 'function') {
                    // Fallback: ê¸°ì¡´ ë°©ì‹
                    const url = `/fm/fl_update.html?prop_id=${propId}&bl_id=${blId}&fl_id=${flId}`;
                    window.loadContent(url, `ì¸µìˆ˜ì •(${flId})`);
                    
                } else {
                    console.error('ğŸ”´ íƒ­ ìƒì„± í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('ğŸ”´ fl_update ì´ë™ ì¤‘ ì˜¤ë¥˜:', error);
            }
        },
        
        // ì •ë ¬ ì²˜ë¦¬
        handleSort: function(column) {
            if (this.data.sortColumn === column) {
                // ê°™ì€ ì»¬ëŸ¼ í´ë¦­ì‹œ ì •ë ¬ ë°©í–¥ ë³€ê²½
                if (this.data.sortDirection === 'both') {
                    this.data.sortDirection = 'asc';
                } else if (this.data.sortDirection === 'asc') {
                    this.data.sortDirection = 'desc';
                } else {
                    this.data.sortDirection = 'both';
                }
            } else {
                // ë‹¤ë¥¸ ì»¬ëŸ¼ í´ë¦­ì‹œ ìƒˆë¡œ ì •ë ¬
                this.data.sortColumn = column;
                this.data.sortDirection = 'asc';
            }
            
            this.updateSortIcons();
            this.data.currentPage = 1;
            this.loadFloorData('search');
            
            console.log('ğŸ”„ ì •ë ¬ ë³€ê²½:', { column, direction: this.data.sortDirection });
        },
        
        // ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
        updateSortIcons: function() {
            // ëª¨ë“  ì •ë ¬ ì•„ì´ì½˜ ì´ˆê¸°í™”
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'sort-icon sort-both';
            });
            
            // í˜„ì¬ ì •ë ¬ ì»¬ëŸ¼ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            if (this.data.sortColumn) {
                const headerCell = document.querySelector(`[data-sort="${this.data.sortColumn}"]`);
                if (headerCell) {
                    const icon = headerCell.querySelector('.sort-icon');
                    if (icon) {
                        icon.className = `sort-icon sort-${this.data.sortDirection}`;
                    }
                }
            }
        },
        
        // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
        renderPagination: function() {
            const pagination = document.getElementById('pagination');
            
            if (this.data.pageSize === 'All' || this.data.totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            const currentPage = this.data.currentPage;
            const totalPages = this.data.totalPages;
            
            // ì´ì „ ë²„íŠ¼
            html += `
                <button class="page-btn ${currentPage <= 1 ? 'disabled' : ''}" 
                        onclick="FlListModule.goToPage(${currentPage - 1})" 
                        ${currentPage <= 1 ? 'disabled' : ''}>â€¹</button>
            `;
            
            // í˜ì´ì§€ ë²ˆí˜¸ë“¤
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                html += `<button class="page-btn" onclick="FlListModule.goToPage(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span style="padding: 0 5px;">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <button class="page-btn ${i === currentPage ? 'active' : ''}" 
                            onclick="FlListModule.goToPage(${i})">${i}</button>
                `;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span style="padding: 0 5px;">...</span>`;
                }
                html += `<button class="page-btn" onclick="FlListModule.goToPage(${totalPages})">${totalPages}</button>`;
            }
            
            // ë‹¤ìŒ ë²„íŠ¼
            html += `
                <button class="page-btn ${currentPage >= totalPages ? 'disabled' : ''}" 
                        onclick="FlListModule.goToPage(${currentPage + 1})" 
                        ${currentPage >= totalPages ? 'disabled' : ''}>â€º</button>
            `;
            
            pagination.innerHTML = html;
        },
        
        // í˜ì´ì§€ ì´ë™
        goToPage: function(page) {
            if (page < 1 || page > this.data.totalPages || page === this.data.currentPage) {
                return;
            }
            
            this.data.currentPage = page;
            this.loadFloorData('search');
        },
        
        // ì¹´ìš´íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
        updateCountInfo: function() {
            document.getElementById('total_count').textContent = this.data.totalCount.toLocaleString();
            document.getElementById('current_page').textContent = this.data.currentPage;
            document.getElementById('total_pages').textContent = this.data.totalPages;
        },
        
        // í•„í„° ì´ˆê¸°í™”
        resetFilters: function() {
            document.getElementById('bl_select').value = '';
            document.getElementById('search_keyword').value = '';
            
            this.data.currentPage = 1;
            this.data.sortColumn = null;
            this.data.sortDirection = 'both';
            
            this.updateSortIcons();
            this.loadFloorData('read');
            
            console.log('ğŸ”„ í•„í„° ì´ˆê¸°í™” ì™„ë£Œ');
        },
        
        // ë¡œë”© í‘œì‹œ
        showLoading: function() {
            const tableContent = document.getElementById('table_content');
            tableContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    ì¸µ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            `;
        },
        
        // ì˜¤ë¥˜ í‘œì‹œ
        showError: function(message) {
            const tableContent = document.getElementById('table_content');
            tableContent.innerHTML = `
                <div class="empty-message" style="color: #dc3545;">
                    ${message}
                </div>
            `;
            console.error('ğŸ”´ ì¸µì •ë³´ ì˜¤ë¥˜:', message);
        }
    };
    
    // ì „ì—­ ì´ˆê¸°í™” í•¨ìˆ˜ ë“±ë¡
    window.initializeFlList = function() {
        window.FlListModule.init();
    };
    
    // ìë™ ì´ˆê¸°í™” (ì¦‰ì‹œ ì‹¤í–‰)
    setTimeout(() => {
        if (!window.FlListModule.data.isInitialized) {
            console.log('ğŸ¢ FlList ìë™ ì´ˆê¸°í™” ì‹œì‘');
            window.FlListModule.init();
        }
    }, 500);
    
    console.log('ğŸ¢ FlListModule ë¡œë“œ ì™„ë£Œ');
    
})(); // ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ ë
</script>