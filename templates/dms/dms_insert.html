<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„ë©´ì •ë³´ ë“±ë¡</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        /* dms_insert ìŠ¤íƒ€ì¼ - JSP ì›ë³¸ ê¸°ë°˜ */
        #dms_insert_outer {
            padding: 20px;
            padding-bottom: 0;
            overflow-y: auto;
            background-color: #f8f9fa;
            font-size: 12px;
        }

        #dms_insert_outer .top-buttons {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        #dms_insert_outer .top-buttons button {
            height: 32px;
            padding: 0 16px;
            background: #fff;
            color: #333;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }

        #dms_insert_outer .top-buttons button:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        #dms_insert_outer .top-buttons button.btn-primary {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        #dms_insert_outer .top-buttons button.btn-primary:hover {
            background: #0056b3;
            border-color: #004085;
        }

        #dms_insert_outer .info-area {
            background-color: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            padding: 20px;
            margin-bottom: 15px;
        }

        #dms_insert_outer .info-table {
            width: 100%;
            border-collapse: collapse;
        }

        #dms_insert_outer .info-table td {
            padding: 12px;
            border: 1px solid #dee2e6;
            font-size: 12px;
            vertical-align: middle;
        }

        #dms_insert_outer .info-table .label-cell {
            background-color: #f7f7f7;
            text-align: center;
            font-weight: bold;
            width: 15%;
            position: relative;
        }

        #dms_insert_outer .info-table .value-cell {
            background-color: white;
            text-align: left;
            width: 35%;
            padding-left: 15px;
        }

        #dms_insert_outer .info-table input[type="text"] {
            width: 400px;
            height: 32px;
            padding: 0 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
        }

        #dms_insert_outer .info-table input.readonly {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        #dms_insert_outer .info-table select {
            width: 220px;
            height: 32px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            padding: 4px 8px;
        }

        #dms_insert_outer .info-table input[type="file"] {
            width: 200px;
            font-size: 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 4px;
        }

        .required::after {
            content: "*";
            color: red;
            margin-left: 2px;
        }

        #dms_insert_outer .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 14px;
            color: #6c757d;
        }

        #dms_insert_outer .loading .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ì—ëŸ¬ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .error-message {
            color: #dc3545;
            font-size: 11px;
            margin-top: 5px;
            display: none;
        }

        .form-group {
            position: relative;
        }

        .form-group.error input,
        .form-group.error select {
            border-color: #dc3545;
        }

        .form-group.error .error-message {
            display: block;
        }
    </style>
</head>
<body>
    <div id="dms_insert_outer">
        <!-- ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ -->
        <div class="top-buttons">
            <button type="button" id="btn_save" class="btn-primary">ì €ì¥</button>
            <button type="button" id="btn_list">ëª©ë¡ë³´ê¸°</button>
        </div>

        <!-- ë„ë©´ ì •ë³´ ë“±ë¡ ì˜ì—­ - JSPì™€ ì™„ì „íˆ ë™ì¼í•œ êµ¬ì¡° -->
        <div class="info-area">
            <table class="info-table">
                <!-- ì²« ë²ˆì§¸ í–‰: ë„ë©´ëª…, ì‘ì„±ì -->
                <tr>
                    <td class="label-cell required">ë„ë©´ëª…</td>
                    <td class="value-cell">
                        <div class="form-group">
                            <input type="text" id="contents" name="contents" placeholder="ë„ë©´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
                            <div class="error-message">ë„ë©´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
                        </div>
                    </td>
                    <td class="label-cell required">ì‘ì„±ì</td>
                    <td class="value-cell">
                        <div class="form-group">
                            <input type="text" id="em_name" name="em_name" class="readonly" readonly>
                            <div class="error-message">ì‘ì„±ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        </div>
                    </td>
                </tr>
                <!-- ë‘ ë²ˆì§¸ í–‰: ë¹ˆ ì…€, ê±´ë¬¼ì½”ë“œ -->
                <tr>
                    <td class="label-cell">&nbsp;</td>
                    <td class="value-cell">&nbsp;</td>
                    <td class="label-cell">ê±´ë¬¼ì½”ë“œ</td>
                    <td class="value-cell">
                        <select id="bl_id" name="bl_id">
                            <option value="">ê±´ë¬¼ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </td>
                </tr>
                <!-- ì„¸ ë²ˆì§¸ í–‰: íŒŒíŠ¸ì½”ë“œ, ì¸µì½”ë“œ -->
                <tr>
                    <td class="label-cell">íŒŒíŠ¸ì½”ë“œ</td>
                    <td class="value-cell">
                        <select id="emclass_id" name="emclass_id">
                            <option value="">íŒŒíŠ¸ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </td>
                    <td class="label-cell">ì¸µì½”ë“œ</td>
                    <td class="value-cell">
                        <select id="fl_id" name="fl_id">
                            <option value="">ì¸µì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </td>
                </tr>
                <!-- ì²« ë²ˆì§¸ ì²¨ë¶€íŒŒì¼ í–‰: ì²¨ë¶€íŒŒì¼1, ì²¨ë¶€íŒŒì¼2 -->
                <tr>
                    <td class="label-cell">ì²¨ë¶€íŒŒì¼1</td>
                    <td class="value-cell">
                        <input type="file" id="filename1" name="filename1">
                    </td>
                    <td class="label-cell">ì²¨ë¶€íŒŒì¼2</td>
                    <td class="value-cell">
                        <input type="file" id="filename2" name="filename2">
                    </td>
                </tr>
                <!-- ë‘ ë²ˆì§¸ ì²¨ë¶€íŒŒì¼ í–‰: ì²¨ë¶€íŒŒì¼3, ì²¨ë¶€íŒŒì¼4 -->
                <tr>
                    <td class="label-cell">ì²¨ë¶€íŒŒì¼3</td>
                    <td class="value-cell">
                        <input type="file" id="filename3" name="filename3">
                    </td>
                    <td class="label-cell">ì²¨ë¶€íŒŒì¼4</td>
                    <td class="value-cell">
                        <input type="file" id="filename4" name="filename4">
                    </td>
                </tr>
                <!-- ì„¸ ë²ˆì§¸ ì²¨ë¶€íŒŒì¼ í–‰: ì²¨ë¶€íŒŒì¼5, ì²¨ë¶€íŒŒì¼6 -->
                <tr>
                    <td class="label-cell">ì²¨ë¶€íŒŒì¼5</td>
                    <td class="value-cell">
                        <input type="file" id="filename5" name="filename5">
                    </td>
                    <td class="label-cell">ì²¨ë¶€íŒŒì¼6</td>
                    <td class="value-cell">
                        <input type="file" id="filename6" name="filename6">
                    </td>
                </tr>
            </table>
            
            <!-- ìˆ¨ê²¨ì§„ í•„ë“œë“¤ -->
            <input type="hidden" id="em_id" name="em_id">
            <input type="hidden" id="prop_id" name="prop_id">
        </div>
    </div>

    <script>
    (function() {
        'use strict';
        
        console.log('ğŸ“ dms_insert.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');
        
        if (typeof window.DmsInsertModule !== 'undefined') {
            if (window.DmsInsertModule.cleanup && typeof window.DmsInsertModule.cleanup === 'function') {
                window.DmsInsertModule.cleanup();
            }
            delete window.DmsInsertModule;
        }
        
        window.DmsInsertModule = {
            data: {
                blList: [],
                flList: [],
                partList: [],
                isInitialized: false,
                isSubmitting: false,
                moduleId: 'dms_insert_' + Date.now()
            },
            
            safeGetElement: function(id) {
                try {
                    const element = document.getElementById(id);
                    if (!element) {
                        console.warn('ğŸ“ [DMS Insert] DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', id);
                    }
                    return element;
                } catch (error) {
                    console.error('ğŸ“ [DMS Insert] DOM ì ‘ê·¼ ì˜¤ë¥˜:', error);
                    return null;
                }
            },

            init: function() {
                console.log('ğŸ“ [DMS Insert] ë„ë©´ ë“±ë¡ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
                
                const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
                const prop_id = window.currentPropId;
                const user_name = window.userInfo && window.userInfo.name;
                
                if (!em_id) {
                    console.error('ğŸ“ [DMS Insert] em_idê°€ ì—†ìŠµë‹ˆë‹¤.');
                    this.showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                if (!prop_id) {
                    console.error('ğŸ“ [DMS Insert] prop_idê°€ ì—†ìŠµë‹ˆë‹¤.');
                    this.showError('ì‚¬ì—…ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // ì´ˆê¸° ë°ì´í„° ì„¤ì •
                this.safeSetValue('em_id', em_id);
                this.safeSetValue('prop_id', prop_id);
                this.safeSetValue('em_name', user_name || '');
                
                this.data.isInitialized = true;
                this.bindEvents();
                
                // ğŸ”¥ ì¦‰ì‹œ ê¸°ë³¸ê°’ ë Œë”ë§ (ì‚¬ìš©ìê°€ ë¹ˆ í™”ë©´ì„ ë³´ì§€ ì•Šë„ë¡)
                this.renderPartSelectDefault();
                
                // ë°ì´í„° ë¡œë“œ
                this.loadData();
            },
            
            bindEvents: function() {
                const btnSave = this.safeGetElement('btn_save');
                if (btnSave) {
                    btnSave.onclick = () => { this.validateAndSave(); };
                }
                
                const btnList = this.safeGetElement('btn_list');
                if (btnList) {
                    btnList.onclick = () => { this.goToList(); };
                }

                // ê±´ë¬¼ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸
                const blSelect = this.safeGetElement('bl_id');
                if (blSelect) {
                    blSelect.onchange = () => {
                        this.loadFloorList(blSelect.value);
                    };
                }

                // Enter í‚¤ ì²˜ë¦¬ (ì €ì¥)
                const contentsInput = this.safeGetElement('contents');
                if (contentsInput) {
                    contentsInput.onkeypress = (e) => {
                        if (e.key === 'Enter') {
                            this.validateAndSave();
                        }
                    };
                }
                
                console.log('ğŸ“ [DMS Insert] ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
            },

            loadData: function() {
                console.log('ğŸ“ [DMS Insert] ê¸°ì´ˆ ë°ì´í„° ë¡œë“œ ì‹œì‘');
                
                // ë³‘ë ¬ë¡œ ë°ì´í„° ë¡œë“œ
                Promise.allSettled([
                    this.loadBuildingList(),
                    this.loadPartList()
                ]).then(results => {
                    console.log('ğŸ“ [DMS Insert] ëª¨ë“  ê¸°ì´ˆ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                    
                    // ë¡œë“œ ê²°ê³¼ í™•ì¸
                    results.forEach((result, index) => {
                        const names = ['ê±´ë¬¼ ëª©ë¡', 'íŒŒíŠ¸ì½”ë“œ ëª©ë¡'];
                        if (result.status === 'rejected') {
                            console.warn(`ğŸ“ [DMS Insert] ${names[index]} ë¡œë“œ ì‹¤íŒ¨:`, result.reason);
                        }
                    });
                });
            },

            renderPartSelectDefault: function() {
                console.log('ğŸ”¥ [DMS Insert] íŒŒíŠ¸ì½”ë“œ ê¸°ë³¸ê°’ ë Œë”ë§ ì‹œì‘');
                
                const attemptRender = (attempt = 1) => {
                    const select = document.getElementById('emclass_id');
                    
                    if (!select) {
                        console.warn(`ğŸŸ¡ [DMS Insert] emclass_id ìš”ì†Œ ì—†ìŒ (ì‹œë„ ${attempt}/5)`);
                        if (attempt < 5) {
                            setTimeout(() => attemptRender(attempt + 1), 200);
                        }
                        return;
                    }
                    
                    const defaultParts = [
                        'ê±´ì¶•', 'ê´€ì œ', 'ê¸°ê³„', 'ê¸°íƒ€', 'ë¯¸í™”', 'ë°©ì¬', 'ì „ê¸°', 'ì£¼ì°¨', 'í–‰ì •'
                    ];
                    
                    select.innerHTML = '<option value="">íŒŒíŠ¸ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                    
                    defaultParts.forEach(part => {
                        const option = document.createElement('option');
                        option.value = part;
                        option.textContent = part;
                        select.appendChild(option);
                    });
                    
                    console.log('ğŸŸ¢ [DMS Insert] íŒŒíŠ¸ì½”ë“œ ê¸°ë³¸ê°’ ë Œë”ë§ ì™„ë£Œ:', defaultParts.length, 'ê°œ');
                };
                
                attemptRender();
            },

            loadPartList: function() {
                return new Promise((resolve, reject) => {
                    const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
                    const prop_id = window.currentPropId;
                    
                    if (!em_id) {
                        console.warn('ğŸŸ¡ [DMS Insert] em_id ëˆ„ë½, ê¸°ë³¸ê°’ë§Œ ì‚¬ìš©');
                        resolve();
                        return;
                    }
                    
                    fetch('fm/dms_insert/get_part_list', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            em_id: em_id, 
                            prop_id: prop_id || ''
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.success && data.data && data.data.length > 0) {
                            console.log('ğŸŸ¢ [DMS Insert] APIì—ì„œ íŒŒíŠ¸ì½”ë“œ ë°ì´í„° ìˆ˜ì‹ , ì¬ë Œë”ë§');
                            this.renderPartSelect(data.data);
                            this.data.partList = data.data;
                        } else {
                            console.log('ğŸŸ¡ [DMS Insert] API ì‘ë‹µ ë¬´íš¨, ê¸°ë³¸ê°’ ìœ ì§€');
                        }
                        resolve();
                    })
                    .catch(error => {
                        console.error('ğŸ”´ [DMS Insert] íŒŒíŠ¸ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                        reject(error);
                    });
                });
            },

            renderPartSelect: function(parts) {
                const select = this.safeGetElement('emclass_id');
                if (!select) return;
                
                console.log('ğŸ” [DMS Insert] íŒŒíŠ¸ì½”ë“œ ì˜µì…˜ ë Œë”ë§ (API ë°ì´í„°):', parts);
                
                select.innerHTML = '<option value="">íŒŒíŠ¸ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                parts.forEach(part => {
                    const option = document.createElement('option');
                    option.value = part.emclass_id;
                    option.textContent = part.emclass_id;
                    select.appendChild(option);
                });
                
                console.log('ğŸŸ¢ [DMS Insert] íŒŒíŠ¸ì½”ë“œ ì˜µì…˜ ë Œë”ë§ ì™„ë£Œ (API):', parts.length, 'ê°œ');
            },

            loadBuildingList: function() {
                return new Promise((resolve, reject) => {
                    const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
                    const prop_id = window.currentPropId;
                    
                    if (!em_id || !prop_id) {
                        resolve();
                        return;
                    }
                    
                    fetch('fm/dms_insert/get_bl_list', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ em_id: em_id, prop_id: prop_id })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.success) {
                            this.data.blList = data.data || [];
                            this.renderBuildingSelect(data.data || []);
                        }
                        resolve();
                    })
                    .catch(error => {
                        console.error('ğŸ“ [DMS Insert] ê±´ë¬¼ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                        reject(error);
                    });
                });
            },

            renderBuildingSelect: function(buildings) {
                const select = this.safeGetElement('bl_id');
                if (!select) return;
                
                select.innerHTML = '<option value="">ê±´ë¬¼ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                buildings.forEach(building => {
                    const option = document.createElement('option');
                    option.value = building.bl_id;
                    option.textContent = `${building.bl_name}(${building.bl_id})`;
                    select.appendChild(option);
                });
            },

            loadFloorList: function(blId) {
                const prop_id = window.currentPropId;
                const flSelect = this.safeGetElement('fl_id');
                if (!flSelect) return;
                
                flSelect.innerHTML = '<option value="">ì¸µì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                this.data.flList = [];

                if (!prop_id || !blId) return;

                fetch('fm/dms_insert/get_fl_list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prop_id: prop_id, bl_id: blId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data && data.success) {
                        this.data.flList = data.data || [];
                        this.renderFloorSelect(data.data || []);
                    }
                })
                .catch(error => {
                    console.error('ğŸ“ [DMS Insert] ì¸µ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                });
            },

            renderFloorSelect: function(floors) {
                const select = this.safeGetElement('fl_id');
                if (!select) return;
                
                select.innerHTML = '<option value="">ì¸µì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                floors.forEach(floor => {
                    const option = document.createElement('option');
                    option.value = floor.fl_id;
                    option.textContent = floor.fl_name;
                    select.appendChild(option);
                });
            },
            
            validateAndSave: function() {
                if (this.data.isSubmitting) {
                    console.log('ğŸŸ¡ [DMS Insert] ì´ë¯¸ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤.');
                    return;
                }

                console.log('ğŸ“ [DMS Insert] ì €ì¥ ìœ íš¨ì„± ê²€ì‚¬ ì‹œì‘');
                
                // ê¸°ì¡´ ì—ëŸ¬ í‘œì‹œ ì œê±°
                this.clearErrors();
                
                let hasError = false;
                
                // í•„ìˆ˜ í•„ë“œ ê²€ì¦ (JSP ì›ë³¸ ë¡œì§ê³¼ ë™ì¼)
                const contentsElement = this.safeGetElement('contents');
                if (!contentsElement || !contentsElement.value.trim()) {
                    this.showFieldError('contents', 'ë„ë©´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    hasError = true;
                }

                const emIdElement = this.safeGetElement('em_id');
                if (!emIdElement || !emIdElement.value.trim()) {
                    this.showFieldError('em_name', 'ì‘ì„±ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                    hasError = true;
                }

                if (hasError) {
                    // ì²« ë²ˆì§¸ ì—ëŸ¬ í•„ë“œì— í¬ì»¤ìŠ¤
                    if (contentsElement && !contentsElement.value.trim()) {
                        contentsElement.focus();
                    }
                    return;
                }

                if (confirm('ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    this.saveData();
                }
            },

            clearErrors: function() {
                const errorGroups = document.querySelectorAll('#dms_insert_outer .form-group.error');
                errorGroups.forEach(group => {
                    group.classList.remove('error');
                });
            },

            showFieldError: function(fieldId, message) {
                const field = this.safeGetElement(fieldId);
                if (!field) return;
                
                const formGroup = field.closest('.form-group');
                if (formGroup) {
                    formGroup.classList.add('error');
                    const errorMsg = formGroup.querySelector('.error-message');
                    if (errorMsg) {
                        errorMsg.textContent = message;
                    }
                }
            },
            
            saveData: function() {
                this.data.isSubmitting = true;
                
                // ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
                const btnSave = this.safeGetElement('btn_save');
                if (btnSave) {
                    btnSave.disabled = true;
                    btnSave.textContent = 'ì €ì¥ ì¤‘...';
                }
                
                console.log('ğŸ“ [DMS Insert] ë°ì´í„° ì €ì¥ ì‹œì‘');
                
                // FormData ìƒì„± (íŒŒì¼ ì—…ë¡œë“œ í¬í•¨)
                const formData = new FormData();
                
                // í…ìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€
                formData.append('em_id', this.safeGetElement('em_id').value || '');
                formData.append('prop_id', this.safeGetElement('prop_id').value || '');
                formData.append('contents', this.safeGetElement('contents').value.trim());
                formData.append('bl_id', this.safeGetElement('bl_id').value || '');
                formData.append('fl_id', this.safeGetElement('fl_id').value || '');
                formData.append('emclass_id', this.safeGetElement('emclass_id').value || '');
                
                // íŒŒì¼ ë°ì´í„° ì¶”ê°€ (6ê°œ ìŠ¬ë¡¯)
                for (let i = 1; i <= 6; i++) {
                    const fileInput = this.safeGetElement(`filename${i}`);
                    if (fileInput && fileInput.files && fileInput.files[0]) {
                        formData.append(`filename${i}`, fileInput.files[0]);
                        console.log(`ğŸ“ [DMS Insert] íŒŒì¼ ${i} ì¶”ê°€ë¨:`, fileInput.files[0].name);
                    }
                }
                
                console.log('ğŸ“ [DMS Insert] FormData ì¤€ë¹„ ì™„ë£Œ');
                
                fetch('fm/dms_insert/save_data', {
                    method: 'POST',
                    body: formData  // Content-Typeì€ ìë™ ì„¤ì •ë¨
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ“ [DMS Insert] ì €ì¥ ì‘ë‹µ:', data);
                    
                    this.data.isSubmitting = false;
                    
                    // ì €ì¥ ë²„íŠ¼ ë³µì›
                    if (btnSave) {
                        btnSave.disabled = false;
                        btnSave.textContent = 'ì €ì¥';
                    }
                    
                    if (data && data.success) {
                        if (confirm(data.message || 'ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\në„ë©´ë“±ë¡í˜„í™©ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.')) {

                            const myTabId = window.tabManager.activeTabId || null; // í˜„ì¬ íƒ­ ID ê¸°ì–µ

                            // ë„ë©´í˜„í™©íƒ­ ì°¾ê¸°
                            if (window.tabManager && window.tabManager.tabs) {
                                let listTabId = null;

                                if (window.tabManager.tabs instanceof Map) {
                                    for (const [tabId, tab] of window.tabManager.tabs.entries()) {
                                        if (tabId.includes('dms_list') || (tab.url && tab.url.includes('dms_list.html'))) {
                                            listTabId = tabId;
                                            break;
                                        }
                                    }
                                }

                                if (listTabId && typeof window.tabManager.switchToTab === 'function') {
                                    window.tabManager.switchToTab(listTabId);

                                    setTimeout(() => {
                                        if (window.DmsListModule && typeof window.DmsListModule.loadData === 'function') {
                                            window.DmsListModule.loadData('read');
                                        }
                                    }, 200);

                                } else if (typeof window.tabManager.addTab === 'function') {
                                    window.tabManager.addTab('/dms/dms_list.html', 'ë„ë©´ì •ë³´ê´€ë¦¬');
                                }

                                // í˜„ì¬ 'ë“±ë¡' íƒ­ ì •í™•íˆ ë‹«ê¸°
                                setTimeout(() => {
                                    if (typeof window.tabManager.removeTab === 'function' && myTabId) {
                                        window.tabManager.removeTab(myTabId);
                                    }
                                }, 300);

                            } else {
                                window.location.href = '/dms/dms_list.html';
                            }
                        }
                    }
                    else {
                        alert(`ì €ì¥ ì‹¤íŒ¨: ${data ? data.message : 'Unknown error'}`);
                    }
                })

                .catch(error => {
                    console.error('ğŸ“ [DMS Insert] ì €ì¥ ì˜¤ë¥˜:', error);
                    
                    this.data.isSubmitting = false;
                    
                    // ì €ì¥ ë²„íŠ¼ ë³µì›
                    if (btnSave) {
                        btnSave.disabled = false;
                        btnSave.textContent = 'ì €ì¥';
                    }
                    
                    alert(`ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                });
            },
            
            goToList: function() {
                try {
                    if (window.tabManager && window.tabManager.tabs) {
                        let listTabId = null;
                        
                        // ê¸°ì¡´ ëª©ë¡ íƒ­ ì°¾ê¸°
                        if (window.tabManager.tabs instanceof Map) {
                            for (const [tabId, tab] of window.tabManager.tabs.entries()) {
                                if (tabId.includes('dms_list') || 
                                    (tab.url && tab.url.includes('dms_list.html'))) {
                                    listTabId = tabId;
                                    break;
                                }
                            }
                        }
                        
                        if (listTabId && typeof window.tabManager.switchToTab === 'function') {
                            // ê¸°ì¡´ ëª©ë¡ íƒ­ìœ¼ë¡œ ì´ë™
                            window.tabManager.switchToTab(listTabId);
                            
                            // í˜„ì¬ íƒ­ ì œê±°
                            setTimeout(() => {
                                if (typeof window.tabManager.removeCurrentTab === 'function') {
                                    window.tabManager.removeCurrentTab();
                                }
                            }, 100);
                            
                            // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                            setTimeout(() => {
                                if (window.DmsListModule && typeof window.DmsListModule.loadData === 'function') {
                                    window.DmsListModule.loadData('read');
                                }
                            }, 300);
                            
                            return;
                        }
                        
                        // ëª©ë¡ íƒ­ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                        if (typeof window.tabManager.addTab === 'function') {
                            window.tabManager.addTab('fm/dms_list.html', 'ë„ë©´ì •ë³´ê´€ë¦¬');
                            
                            // í˜„ì¬ íƒ­ ì œê±°
                            setTimeout(() => {
                                if (typeof window.tabManager.removeCurrentTab === 'function') {
                                    window.tabManager.removeCurrentTab();
                                }
                            }, 200);
                            
                            return;
                        }
                    }
                    
                    // íƒ­ ë§¤ë‹ˆì €ê°€ ì—†ìœ¼ë©´ ì§ì ‘ ì´ë™
                    window.location.href = 'fm/dms_list.html';
                    
                } catch (error) {
                    console.error('ğŸ”´ [DMS Insert] ëª©ë¡ ì´ë™ ì¤‘ ì˜¤ë¥˜:', error);
                    window.location.href = 'fm/dms_list.html';
                }
            },
            
            safeSetValue: function(id, value) {
                const element = this.safeGetElement(id);
                if (element && value != null) {
                    element.value = value;
                }
            },
            
            showError: function(message) {
                console.error('ğŸ”´ [DMS Insert] ì˜¤ë¥˜:', message);
                
                const infoArea = document.querySelector('#dms_insert_outer .info-area');
                if (infoArea) {
                    infoArea.innerHTML = `
                        <div style="text-align: center; padding: 50px; color: #dc3545; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px;">
                            <h4 style="margin-bottom: 20px;">âš ï¸ ì˜¤ë¥˜ ë°œìƒ</h4>
                            <p style="margin-bottom: 30px; font-size: 14px;">${message}</p>
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button onclick="location.reload()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    ë‹¤ì‹œ ì‹œë„
                                </button>
                                <button onclick="DmsInsertModule.goToList()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                                </button>
                            </div>
                        </div>
                    `;
                }
            },
            
            cleanup: function() {
                console.log('ğŸ“ [DMS Insert] DmsInsertModule ì •ë¦¬ ì¤‘...');
                this.data.isInitialized = false;
                this.data.isSubmitting = false;
                this.data.blList = [];
                this.data.flList = [];
                this.data.partList = [];
            }
        };
        
        setTimeout(() => {
            if (!window.DmsInsertModule.data.isInitialized) {
                console.log('ğŸ“ [DMS Insert] ìë™ ì´ˆê¸°í™” ì‹œì‘');
                window.DmsInsertModule.init();
            }
        }, 100);
        
        console.log('ğŸ“ [DMS Insert] DmsInsertModule ë¡œë“œ ì™„ë£Œ');
        
    })();
    </script>
</body>
</html>