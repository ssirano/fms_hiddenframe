<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„ë©´ì •ë³´ ìˆ˜ì •</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        /* dms_update ìŠ¤íƒ€ì¼ */
        #dms_update_outer {
            padding: 20px;
            padding-bottom: 0;
            overflow-y: auto;
            background-color: #f8f9fa;
            font-size: 12px;
        }

        #dms_update_outer .top-buttons {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        #dms_update_outer .top-buttons button {
            height: 32px;
            padding: 0 16px;
            background: #fff;
            color: #333;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }

        #dms_update_outer .top-buttons button:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        #dms_update_outer .top-buttons button.btn-primary {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        #dms_update_outer .top-buttons button.btn-primary:hover {
            background: #0056b3;
            border-color: #004085;
        }

        #dms_update_outer .top-buttons button.btn-danger {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        #dms_update_outer .top-buttons button.btn-danger:hover {
            background: #c82333;
            border-color: #bd2130;
        }

        #dms_update_outer .info-area {
            background-color: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            padding: 20px;
            margin-bottom: 15px;
        }

        #dms_update_outer .info-table {
            width: 100%;
            border-collapse: collapse;
        }

        #dms_update_outer .info-table td {
            padding: 12px;
            border: 1px solid #dee2e6;
            font-size: 12px;
            vertical-align: middle;
        }

        #dms_update_outer .info-table .label-cell {
            background-color: #f7f7f7;
            text-align: center;
            font-weight: bold;
            width: 15%;
            position: relative;
        }

        #dms_update_outer .info-table .value-cell {
            background-color: white;
            text-align: left;
            width: 35%;
            padding-left: 15px;
        }

        #dms_update_outer .info-table input[type="text"],
        #dms_update_outer .info-table input[type="date"],
        #dms_update_outer .info-table input[type="number"] {
            width: 200px;
            height: 32px;
            padding: 0 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
        }

        #dms_update_outer .info-table input.large {
            width: 400px;
        }

        #dms_update_outer .info-table input.medium {
            width: 200px;
        }

        #dms_update_outer .info-table input.small {
            width: 100px;
        }

        #dms_update_outer .info-table select {
            width: 220px;
            height: 32px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            padding: 4px 8px;
        }

        .required::after {
            content: "*";
            color: red;
            margin-left: 2px;
        }

        #dms_update_outer .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 14px;
            color: #6c757d;
        }

        #dms_update_outer .loading .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ì²¨ë¶€íŒŒì¼ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .attachment-cell {
            text-align: right !important;
            vertical-align: top;
        }

        .file-input {
            width: 200px;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .existing-file {
            margin-top: 5px;
            font-size: 12px;
        }

        .file-name {
            color: #495057;
            margin-right: 10px;
        }

        .btn-download, .btn-delete {
            height: 24px;
            padding: 0 8px;
            margin-left: 5px;
            font-size: 11px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }

        .btn-download {
            background: #fff;
            color: #333;
        }

        .btn-download:hover {
            background: #e9ecef;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .btn-delete:hover {
            background: #c82333;
            border-color: #bd2130;
        }
    </style>
</head>
<body>
    <div id="dms_update_outer">
        <!-- ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ -->
        <div class="top-buttons">
            <button type="button" id="btn_save" class="btn-primary">ì €ì¥</button>
            <button type="button" id="btn_delete" class="btn-danger">ì‚­ì œ</button>
            <button type="button" id="btn_list">ëª©ë¡ë³´ê¸°</button>
        </div>

        <!-- ë„ë©´ ì •ë³´ ìˆ˜ì • ì˜ì—­ - JSPì™€ ì™„ì „íˆ ë™ì¼í•œ êµ¬ì¡° -->
        <div class="info-area">
            <table class="info-table">
                <!-- ì²« ë²ˆì§¸ í–‰: ë„ë©´ëª…, ê±´ë¬¼ì½”ë“œ -->
                <tr>
                    <td class="label-cell required">ë„ë©´ëª…</td>
                    <td class="value-cell">
                        <input type="text" id="contents" name="contents" class="large" placeholder="ë„ë©´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
                    </td>
                    <td class="label-cell">ê±´ë¬¼ì½”ë“œ</td>
                    <td class="value-cell">
                        <select id="bl_id" name="bl_id">
                            <option value="">ê±´ë¬¼ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </td>
                </tr>
                <!-- ë‘ ë²ˆì§¸ í–‰: íŒŒíŠ¸ì½”ë“œ, ì¸µì½”ë“œ -->
                <tr>
                    <td class="label-cell">íŒŒíŠ¸ì½”ë“œ</td>
                    <td class="value-cell">
                        <select id="emclass_id" name="emclass_id">
                            <option value="">íŒŒíŠ¸ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </td>
                    <td class="label-cell">ì¸µì½”ë“œ</td>
                    <td class="value-cell">
                        <select id="fl_id" name="fl_id">
                            <option value="">ì¸µì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </td>
                </tr>
                <!-- ì²« ë²ˆì§¸ ì²¨ë¶€íŒŒì¼ í–‰: ì²¨ë¶€íŒŒì¼1, ì²¨ë¶€íŒŒì¼2 -->
                <tr>
                    <td class="label-cell">ì²¨ë¶€íŒŒì¼1</td>
                    <td class="value-cell attachment-cell">
                        <input type="file" id="filename1" name="filename1" class="file-input">
                        <div class="existing-file" id="existing_file_0" style="display: none;">
                            <span class="file-name" id="file_name_0"></span>
                            <button type="button" class="btn-download" onclick="DmsUpdateModule.downloadFile(0)">ë‹¤ìš´ë°›ê¸°</button>
                            <button type="button" class="btn-delete" onclick="DmsUpdateModule.deleteFile(0)">ì‚­ì œ</button>
                        </div>
                    </td>
                    <td class="label-cell">ì²¨ë¶€íŒŒì¼2</td>
                    <td class="value-cell attachment-cell">
                        <input type="file" id="filename2" name="filename2" class="file-input">
                        <div class="existing-file" id="existing_file_1" style="display: none;">
                            <span class="file-name" id="file_name_1"></span>
                            <button type="button" class="btn-download" onclick="DmsUpdateModule.downloadFile(1)">ë‹¤ìš´ë°›ê¸°</button>
                            <button type="button" class="btn-delete" onclick="DmsUpdateModule.deleteFile(1)">ì‚­ì œ</button>
                        </div>
                    </td>
                </tr>
                <!-- ë‘ ë²ˆì§¸ ì²¨ë¶€íŒŒì¼ í–‰: ì²¨ë¶€íŒŒì¼3, ì²¨ë¶€íŒŒì¼4 -->
                <tr>
                    <td class="label-cell">ì²¨ë¶€íŒŒì¼3</td>
                    <td class="value-cell attachment-cell">
                        <input type="file" id="filename3" name="filename3" class="file-input">
                        <div class="existing-file" id="existing_file_2" style="display: none;">
                            <span class="file-name" id="file_name_2"></span>
                            <button type="button" class="btn-download" onclick="DmsUpdateModule.downloadFile(2)">ë‹¤ìš´ë°›ê¸°</button>
                            <button type="button" class="btn-delete" onclick="DmsUpdateModule.deleteFile(2)">ì‚­ì œ</button>
                        </div>
                    </td>
                    <td class="label-cell">ì²¨ë¶€íŒŒì¼4</td>
                    <td class="value-cell attachment-cell">
                        <input type="file" id="filename4" name="filename4" class="file-input">
                        <div class="existing-file" id="existing_file_3" style="display: none;">
                            <span class="file-name" id="file_name_3"></span>
                            <button type="button" class="btn-download" onclick="DmsUpdateModule.downloadFile(3)">ë‹¤ìš´ë°›ê¸°</button>
                            <button type="button" class="btn-delete" onclick="DmsUpdateModule.deleteFile(3)">ì‚­ì œ</button>
                        </div>
                    </td>
                </tr>
                <!-- ì„¸ ë²ˆì§¸ ì²¨ë¶€íŒŒì¼ í–‰: ì²¨ë¶€íŒŒì¼5, ì²¨ë¶€íŒŒì¼6 -->
                <tr>
                    <td class="label-cell">ì²¨ë¶€íŒŒì¼5</td>
                    <td class="value-cell attachment-cell">
                        <input type="file" id="filename5" name="filename5" class="file-input">
                        <div class="existing-file" id="existing_file_4" style="display: none;">
                            <span class="file-name" id="file_name_4"></span>
                            <button type="button" class="btn-download" onclick="DmsUpdateModule.downloadFile(4)">ë‹¤ìš´ë°›ê¸°</button>
                            <button type="button" class="btn-delete" onclick="DmsUpdateModule.deleteFile(4)">ì‚­ì œ</button>
                        </div>
                    </td>
                    <td class="label-cell">ì²¨ë¶€íŒŒì¼6</td>
                    <td class="value-cell attachment-cell">
                        <input type="file" id="filename6" name="filename6" class="file-input">
                        <div class="existing-file" id="existing_file_5" style="display: none;">
                            <span class="file-name" id="file_name_5"></span>
                            <button type="button" class="btn-download" onclick="DmsUpdateModule.downloadFile(5)">ë‹¤ìš´ë°›ê¸°</button>
                            <button type="button" class="btn-delete" onclick="DmsUpdateModule.deleteFile(5)">ì‚­ì œ</button>
                        </div>
                    </td>
                </tr>
            </table>
            
            <!-- ìˆ¨ê²¨ì§„ í•„ë“œë“¤ -->
            <input type="hidden" id="dms_id" name="dms_id">
            <input type="hidden" id="prop_id" name="prop_id">
            <input type="hidden" id="em_id" name="em_id">
            <input type="hidden" id="prop_name" name="prop_name">
            <input type="hidden" id="em_name" name="em_name">
            <input type="hidden" id="date_reg" name="date_reg">
        </div>
    </div>

    <script>
    (function() {
        'use strict';
        
        console.log('ğŸ—ï¸ dms_update.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');
        
        if (typeof window.DmsUpdateModule !== 'undefined') {
            if (window.DmsUpdateModule.cleanup && typeof window.DmsUpdateModule.cleanup === 'function') {
                window.DmsUpdateModule.cleanup();
            }
            delete window.DmsUpdateModule;
        }
        
        window.DmsUpdateModule = {
            data: {
                dmsId: null,
                itemData: {},
                blList: [],
                flList: [],
                originalFormHTML: null,
                isInitialized: false,
                moduleId: 'dms_update_' + Date.now()
            },
            
            safeGetElement: function(id) {
                try {
                    const container = document.querySelector('#dms_update_outer');
                    const element = container ? container.querySelector(`#${id}`) : null;
                    
                    if (!element) {
                        console.warn('ğŸ—ï¸ [DMS Update] DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', id);
                    }
                    return element;
                } catch (error) {
                    console.error('ğŸ—ï¸ [DMS Update] DOM ì ‘ê·¼ ì˜¤ë¥˜:', error);
                    return null;
                }
            },


            renderPartSelectDefault: function() {
                console.log('ğŸ”¥ [DMS Update] íŒŒíŠ¸ì½”ë“œ ê¸°ë³¸ê°’ ë Œë”ë§ ì‹œì‘');
                
                // ì—¬ëŸ¬ ë²ˆ ì‹œë„ (DOMì´ ì¤€ë¹„ë  ë•Œê¹Œì§€)
                const attemptRender = (attempt = 1) => {
                    const select = document.getElementById('emclass_id');
                    
                    if (!select) {
                        console.warn(`ğŸŸ¡ [DMS Update] emclass_id ìš”ì†Œ ì—†ìŒ (ì‹œë„ ${attempt}/5)`);
                        if (attempt < 5) {
                            setTimeout(() => attemptRender(attempt + 1), 200);
                        } else {
                            console.error('ğŸ”´ [DMS Update] emclass_id ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ - ìµœì¢… ì‹¤íŒ¨');
                        }
                        return;
                    }
                    
                    console.log('ğŸŸ¢ [DMS Update] emclass_id ìš”ì†Œ ë°œê²¬, ì˜µì…˜ ë Œë”ë§ ì‹œì‘');
                    
                    const defaultParts = [
                        'ê±´ì¶•', 'ê´€ì œ', 'ê¸°ê³„', 'ê¸°íƒ€', 'ë¯¸í™”', 'ë°©ì¬', 'ì „ê¸°', 'ì£¼ì°¨', 'í–‰ì •'
                    ];
                    
                    select.innerHTML = '<option value="">íŒŒíŠ¸ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                    
                    defaultParts.forEach(part => {
                        const option = document.createElement('option');
                        option.value = part;
                        option.textContent = part;
                        select.appendChild(option);
                    });
                    
                    console.log('ğŸŸ¢ [DMS Update] íŒŒíŠ¸ì½”ë“œ ê¸°ë³¸ê°’ ë Œë”ë§ ì™„ë£Œ:', defaultParts.length, 'ê°œ');
                };
                
                // ì¦‰ì‹œ ì‹œë„
                attemptRender();
                
                // ì¶”ê°€ë¡œ 1ì´ˆ í›„ì—ë„ ì‹œë„ (ì•ˆì „ì¥ì¹˜)
                setTimeout(() => attemptRender(), 1000);
            },

            init: function() {
                console.log('ğŸ—ï¸ [DMS Update] ë„ë©´ ìˆ˜ì • í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
                
                const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
                const prop_id = window.currentPropId;
                
                // 1. ì „ì—­ ë³€ìˆ˜ì—ì„œ ID ê°€ì ¸ì˜¤ê¸° (ìš°ì„ ìˆœìœ„ 1)
                this.data.dmsId = window.selected_dms_id || null;
                
                // 2. URL íŒŒë¼ë¯¸í„°ì—ì„œ ID ê°€ì ¸ì˜¤ê¸° (ìš°ì„ ìˆœìœ„ 2)
                if (!this.data.dmsId) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const rawId = urlParams.get('dms_id');
                    this.data.dmsId = rawId ? parseInt(parseFloat(rawId)) : null;
                }
                
                console.log('ğŸ—ï¸ [DMS Update] ë°›ì€ ë°ì´í„°:', { 
                    em_id, 
                    prop_id, 
                    dmsId: this.data.dmsId,
                    from_global: window.selected_dms_id,
                    from_url: new URLSearchParams(window.location.search).get('dms_id')
                });
                
                if (!em_id) {
                    console.error('ğŸ—ï¸ [DMS Update] em_idê°€ ì—†ìŠµë‹ˆë‹¤.');
                    this.showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                if (!this.data.dmsId) {
                    console.error('ğŸ—ï¸ [DMS Update] dms_idê°€ ì—†ìŠµë‹ˆë‹¤.');
                    this.showError('ë„ë©´ IDê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ëª©ë¡ì—ì„œ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    
                    // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ëª©ë¡ìœ¼ë¡œ ì´ë™
                    setTimeout(() => {
                        this.goToList();
                    }, 3000);
                    return;
                }
                
                // ì „ì—­ ë³€ìˆ˜ ì •ë¦¬ (ì‚¬ìš© í›„)
                if (window.selected_dms_id) {
                    delete window.selected_dms_id;
                }
                
                this.data.isInitialized = true;
                this.bindEvents();
                
                // ğŸ”¥ ì¦‰ì‹œ ê¸°ë³¸ê°’ ë Œë”ë§ (ì‚¬ìš©ìê°€ ë¹ˆ í™”ë©´ì„ ë³´ì§€ ì•Šë„ë¡)
                this.renderPartSelectDefault();
                
                // ë°ì´í„° ë¡œë“œ (ë‚´ë¶€ì—ì„œ API í˜¸ì¶œí•˜ì—¬ ì‹¤ì œ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸)
                this.loadData();
            },
            
            bindEvents: function() {
                const btnSave = this.safeGetElement('btn_save');
                if (btnSave) {
                    btnSave.onclick = () => { this.saveData(); };
                }
                
                const btnDelete = this.safeGetElement('btn_delete');
                if (btnDelete) {
                    btnDelete.onclick = () => { this.deleteData(); };
                }
                
                const btnList = this.safeGetElement('btn_list');
                if (btnList) {
                    btnList.onclick = () => { this.goToList(); };
                }

                // ê±´ë¬¼ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸ - DOM ë³µì› í›„ì— ë‹¤ì‹œ ë°”ì¸ë”©
                setTimeout(() => {
                    const blSelect = this.safeGetElement('bl_id');
                    if (blSelect) {
                        blSelect.onchange = () => {
                            this.loadFloorList(blSelect.value);
                        };
                    }
                }, 200);
                
                console.log('ğŸ—ï¸ [DMS Update] ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
            },

            // íŒŒíŠ¸ì½”ë“œ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜
            loadPartList: function(callback) {
                const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
                const prop_id = window.currentPropId;
                
                console.log('ğŸ” [DMS Update] loadPartList í˜¸ì¶œë¨:', { em_id, prop_id });
                
                // ğŸ”¥ ì¼ë‹¨ ê¸°ë³¸ê°’ë¶€í„° ë Œë”ë§ (ì¦‰ì‹œ ë³´ì´ë„ë¡)
                this.renderPartSelectDefault();
                
                if (!em_id) {
                    console.warn('ğŸŸ¡ [DMS Update] em_id ëˆ„ë½, ê¸°ë³¸ê°’ë§Œ ì‚¬ìš©');
                    if (callback) callback();
                    return;
                }
                
                console.log('ğŸ” [DMS Update] íŒŒíŠ¸ì½”ë“œ API í˜¸ì¶œ ì‹œì‘');
                
                fetch('fm/dms_update/get_part_list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        em_id: em_id, 
                        prop_id: prop_id || '' // prop_idê°€ ì—†ì–´ë„ ì „ì†¡
                    })
                })
                .then(response => {
                    console.log('ğŸ” [DMS Update] íŒŒíŠ¸ì½”ë“œ API ì‘ë‹µ ìƒíƒœ:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ” [DMS Update] íŒŒíŠ¸ì½”ë“œ API ì‘ë‹µ ë°ì´í„°:', data);
                    if (data && data.success && data.data && data.data.length > 0) {
                        // APIì—ì„œ ë°ì´í„°ë¥¼ ë°›ìœ¼ë©´ ë‹¤ì‹œ ë Œë”ë§
                        console.log('ğŸŸ¢ [DMS Update] APIì—ì„œ íŒŒíŠ¸ì½”ë“œ ë°ì´í„° ìˆ˜ì‹ , ì¬ë Œë”ë§');
                        this.renderPartSelect(data.data);
                    } else {
                        console.log('ğŸŸ¡ [DMS Update] API ì‘ë‹µ ë¬´íš¨, ê¸°ë³¸ê°’ ìœ ì§€');
                    }
                    if (callback) callback();
                })
                .catch(error => {
                    console.error('ğŸ”´ [DMS Update] íŒŒíŠ¸ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                    console.log('ğŸŸ¡ [DMS Update] API ì˜¤ë¥˜ë¡œ ê¸°ë³¸ê°’ ìœ ì§€');
                    if (callback) callback();
                });
            },

            // ê¸°ë³¸ íŒŒíŠ¸ì½”ë“œ ë Œë”ë§ í•¨ìˆ˜ ì¶”ê°€
            renderPartSelect: function(parts) {
                const select = this.safeGetElement('emclass_id');
                if (!select) {
                    console.error('ğŸ”´ [DMS Update] emclass_id ì…€ë ‰íŠ¸ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    return;
                }
                
                console.log('ğŸ” [DMS Update] íŒŒíŠ¸ì½”ë“œ ì˜µì…˜ ë Œë”ë§ (API ë°ì´í„°):', parts);
                
                select.innerHTML = '<option value="">íŒŒíŠ¸ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                parts.forEach(part => {
                    const option = document.createElement('option');
                    option.value = part.emclass_id;
                    option.textContent = part.emclass_id;
                    select.appendChild(option);
                });
                
                console.log('ğŸŸ¢ [DMS Update] íŒŒíŠ¸ì½”ë“œ ì˜µì…˜ ë Œë”ë§ ì™„ë£Œ (API):', parts.length, 'ê°œ');
            },


            

            // ê±´ë¬¼ ëª©ë¡ ë¡œë“œ
            loadBuildingList: function(callback) {
                const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
                const prop_id = window.currentPropId;
                
                if (!em_id || !prop_id) {
                    if (callback) callback();
                    return;
                }
                
                fetch('fm/dms_update/get_bl_list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ em_id: em_id, prop_id: prop_id })
                })
                .then(response => response.json())
                .then(data => {
                    if (data && data.success) {
                        this.data.blList = data.data || [];
                        this.renderBuildingSelect(data.data || []);
                    }
                    if (callback) callback();
                })
                .catch(error => {
                    console.error('ğŸ—ï¸ [DMS Update] ê±´ë¬¼ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                    if (callback) callback();
                });
            },

            // ê±´ë¬¼ ì„ íƒ ì˜µì…˜ ë Œë”ë§
            renderBuildingSelect: function(buildings) {
                const select = this.safeGetElement('bl_id');
                if (!select) return;
                
                select.innerHTML = '<option value="">ê±´ë¬¼ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                buildings.forEach(building => {
                    const option = document.createElement('option');
                    option.value = building.bl_id;
                    option.textContent = `${building.bl_name}(${building.bl_id})`;
                    select.appendChild(option);
                });
            },

            // ì¸µ ëª©ë¡ ë¡œë“œ
            loadFloorList: function(blId, callback) {
                const prop_id = window.currentPropId;
                const flSelect = this.safeGetElement('fl_id');
                if (!flSelect) {
                    if (callback) callback();
                    return;
                }
                
                flSelect.innerHTML = '<option value="">ì¸µì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                this.data.flList = [];

                if (!prop_id || !blId) {
                    if (callback) callback();
                    return;
                }

                fetch('fm/dms_update/get_fl_list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prop_id: prop_id, bl_id: blId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data && data.success) {
                        this.data.flList = data.data || [];
                        this.renderFloorSelect(data.data || []);
                    }
                    if (callback) callback();
                })
                .catch(error => {
                    console.error('ğŸ—ï¸ [DMS Update] ì¸µ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                    if (callback) callback();
                });
            },

            // ì¸µ ì„ íƒ ì˜µì…˜ ë Œë”ë§
            renderFloorSelect: function(floors) {
                const select = this.safeGetElement('fl_id');
                if (!select) return;
                
                select.innerHTML = '<option value="">ì¸µì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                floors.forEach(floor => {
                    const option = document.createElement('option');
                    option.value = floor.fl_id;
                    option.textContent = floor.fl_name;
                    select.appendChild(option);
                });
            },
            
            loadData: function() {
                const em_id = window.currentEmId || (window.userInfo && window.userInfo.em_id);
                
                if (!em_id || !this.data.dmsId) {
                    console.error('ğŸ—ï¸ [DMS Update] í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½:', { em_id, dmsId: this.data.dmsId });
                    this.showError('í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                console.log('ğŸ—ï¸ [DMS Update] ë°ì´í„° ë¡œë“œ ì‹œì‘:', { em_id, dmsId: this.data.dmsId });
                
                this.showLoading();
                
                fetch('fm/dms_update/get_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        em_id: em_id,
                        dms_id: this.data.dmsId
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ—ï¸ [DMS Update] ë°ì´í„° ì‘ë‹µ:', data);
                    if (data && data.success) {
                        this.data.itemData = data.data;
                        
                        // ğŸ”¥ í¼ ë³µì› í›„ ë°ì´í„° ì±„ìš°ê¸° (ì²¨ë¶€íŒŒì¼ í¬í•¨)
                        this.populateForm(data.data);
                        
                    } else {
                        console.error('ğŸ—ï¸ [DMS Update] ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', data ? data.message : 'Unknown error');
                        this.showError(`ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${data ? data.message : 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('ğŸ—ï¸ [DMS Update] ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                    this.showError(`ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                });
            },

            showLoading: function() {
                const infoArea = document.querySelector('#dms_update_outer .info-area');
                if (infoArea) {
                    // ì›ë³¸ HTMLì„ ë°±ì—…
                    if (!this.data.originalFormHTML) {
                        this.data.originalFormHTML = infoArea.innerHTML;
                    }
                    
                    infoArea.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    `;
                }
            },

            restoreForm: function() {
                const infoArea = document.querySelector('#dms_update_outer .info-area');
                if (infoArea && this.data.originalFormHTML) {
                    infoArea.innerHTML = this.data.originalFormHTML;
                }
            },
            
            populateForm: function(data) {
                this.restoreForm();

                setTimeout(() => {
                    this.safeSetValue('dms_id', data.dms_id);
                    this.safeSetValue('prop_id', data.prop_id);
                    this.safeSetValue('em_id', data.em_id);
                    this.safeSetValue('prop_name', data.prop_name);
                    this.safeSetValue('em_name', data.em_name);
                    this.safeSetValue('date_reg', data.date_reg);
                    this.safeSetValue('contents', data.contents);

                    // ë°˜ë“œì‹œ í¼ ë³µì› í›„ì— loadPartList í˜¸ì¶œ
                    this.loadPartList(() => {
                        console.log('ğŸ”¥ [DMS Update] íŒŒíŠ¸ì½”ë“œ ë¡œë“œ ì™„ë£Œ, ê°’ ì„¤ì •:', data.emclass_id);
                        this.safeSetValue('emclass_id', data.emclass_id);

                        // ê±´ë¬¼ ë¡œë“œ ë° ì¸µ ë¡œë“œë„ ìˆœì°¨ ì§„í–‰
                        this.loadBuildingList(() => {
                            this.safeSetValue('bl_id', data.bl_id);
                            
                            if (data.bl_id) {
                                this.loadFloorList(data.bl_id, () => {
                                    this.safeSetValue('fl_id', data.fl_id);
                                    setTimeout(() => {
                                        this.renderAttachments(data.attachments || []);
                                    }, 200);
                                });
                            } else {
                                setTimeout(() => {
                                    this.renderAttachments(data.attachments || []);
                                }, 200);
                            }
                        });
                    });

                    // ğŸŸ¢ ì¤‘ìš”: ë³µì› í›„ ì´ë²¤íŠ¸ ì¬ë°”ì¸ë”©
                    this.bindEvents();

                }, 100);
            },


            renderAttachments: function(attachments) {
                console.log('ğŸ—ï¸ [DMS Update] ì²¨ë¶€íŒŒì¼ ë Œë”ë§ ì‹œì‘:', attachments);
                console.log('ğŸ—ï¸ [DMS Update] ì²¨ë¶€íŒŒì¼ ë°ì´í„° íƒ€ì…:', typeof attachments);
                console.log('ğŸ—ï¸ [DMS Update] ì²¨ë¶€íŒŒì¼ ê¸¸ì´:', attachments ? attachments.length : 'null');

                // DOM ìš”ì†Œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                for (let i = 0; i < 6; i++) {
                    const existingDiv = document.getElementById(`existing_file_${i}`);
                    const fileNameSpan = document.getElementById(`file_name_${i}`);
                    console.log(`ğŸ—ï¸ [DMS Update] DOM í™•ì¸ ${i}:`, {
                        existingDiv: !!existingDiv,
                        fileNameSpan: !!fileNameSpan
                    });
                }

                // ê¸°ì¡´ íŒŒì¼ ì •ë³´ ì´ˆê¸°í™”
                for (let i = 0; i < 6; i++) {
                    const existingDiv = document.getElementById(`existing_file_${i}`);
                    if (existingDiv) {
                        existingDiv.style.display = 'none';
                        console.log(`ğŸ—ï¸ [DMS Update] íŒŒì¼ ìŠ¬ë¡¯ ${i} ì´ˆê¸°í™”ë¨`);
                    }
                }

                if (!attachments || attachments.length === 0) {
                    console.log('ğŸ—ï¸ [DMS Update] ì²¨ë¶€íŒŒì¼ ì—†ìŒ ë˜ëŠ” ë¹ˆ ë°°ì—´');
                    return;
                }

                // ğŸ”¥ ì²¨ë¶€íŒŒì¼ ìƒì„¸ ì •ë³´ ë¡œê¹…
                attachments.forEach((file, index) => {
                    console.log(`ğŸ—ï¸ [DMS Update] ì²¨ë¶€íŒŒì¼ ${index}:`, {
                        dms_image_id: file.dms_image_id,
                        filename: file.filename,
                        file_id: file.file_id,
                        ì „ì²´ê°ì²´: file
                    });
                });

                // ì²¨ë¶€íŒŒì¼ì´ ìˆëŠ” ê²½ìš° JSP dms_image_idë¥¼ indexë¡œ ì‚¬ìš©
                attachments.forEach(file => {
                    const imageId = file.dms_image_id || file.file_id; // ğŸ”¥ ë°±ì—…ìœ¼ë¡œ file_idë„ í™•ì¸
                    let fileIndex = -1;
                    
                    console.log(`ğŸ—ï¸ [DMS Update] ì²˜ë¦¬ ì¤‘ì¸ íŒŒì¼:`, { imageId, type: typeof imageId });
                    
                    // ğŸ”¥ ë” ìœ ì—°í•œ ë§¤í•‘ (ë¬¸ìì—´ê³¼ ìˆ«ì ëª¨ë‘ ì²˜ë¦¬)
                    if (imageId === '0' || imageId === 0 || imageId === '0E-10') fileIndex = 0;
                    else if (imageId === '1' || imageId === 1) fileIndex = 1;
                    else if (imageId === '2' || imageId === 2) fileIndex = 2;
                    else if (imageId === '3' || imageId === 3) fileIndex = 3;
                    else if (imageId === '4' || imageId === 4) fileIndex = 4;
                    else if (imageId === '5' || imageId === 5) fileIndex = 5;
                    else {
                        // ğŸ”¥ íŠ¹ìˆ˜í•œ ID íŒ¨í„´ ì²˜ë¦¬ (ì˜ˆ: 0E-10 ê°™ì€ ê²½ìš°)
                        const idStr = String(imageId);
                        if (idStr.includes('0') || idStr.startsWith('0')) fileIndex = 0;
                        else if (idStr.includes('1')) fileIndex = 1;
                        else if (idStr.includes('2')) fileIndex = 2;
                        else if (idStr.includes('3')) fileIndex = 3;
                        else if (idStr.includes('4')) fileIndex = 4;
                        else if (idStr.includes('5')) fileIndex = 5;
                    }
                    
                    console.log(`ğŸ—ï¸ [DMS Update] ë§¤í•‘ ê²°ê³¼:`, { imageId, fileIndex });
                    
                    if (fileIndex >= 0 && fileIndex < 6) {
                        const existingDiv = document.getElementById(`existing_file_${fileIndex}`);
                        const fileNameSpan = document.getElementById(`file_name_${fileIndex}`);
                        
                        if (existingDiv && fileNameSpan) {
                            const fileName = file.filename || 'íŒŒì¼ëª… ì—†ìŒ';
                            fileNameSpan.textContent = fileName;
                            existingDiv.style.display = 'block';
                            
                            // íŒŒì¼ ì •ë³´ ì €ì¥ (ë‹¤ìš´ë¡œë“œ/ì‚­ì œìš©)
                            existingDiv.setAttribute('data-dms-id', this.data.dmsId);
                            existingDiv.setAttribute('data-file-id', imageId);
                            
                            console.log(`ğŸŸ¢ [DMS Update] íŒŒì¼ í‘œì‹œ ì™„ë£Œ:`, { 
                                fileIndex, 
                                fileName, 
                                imageId,
                                dmsId: this.data.dmsId 
                            });
                        } else {
                            console.error(`ğŸ”´ [DMS Update] DOM ìš”ì†Œ ì—†ìŒ:`, { 
                                fileIndex, 
                                existingDiv: !!existingDiv, 
                                fileNameSpan: !!fileNameSpan 
                            });
                        }
                    } else {
                        console.warn(`ğŸŸ¡ [DMS Update] ìœ íš¨í•˜ì§€ ì•Šì€ íŒŒì¼ ì¸ë±ìŠ¤:`, { imageId, fileIndex });
                    }
                });

                console.log('ğŸ—ï¸ [DMS Update] ì²¨ë¶€íŒŒì¼ ë Œë”ë§ ì™„ë£Œ:', attachments.length, 'ê°œ');
            },
            
            safeSetValue: function(id, value) {
                const element = this.safeGetElement(id);
                if (element && value != null) {
                    element.value = value;
                }
            },
            
            saveData: function() {
                // í•„ìˆ˜ í•„ë“œ ê²€ì¦
                const contentsElement = this.safeGetElement('contents');
                if (!contentsElement || !contentsElement.value.trim()) {
                    alert('ë„ë©´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    if (contentsElement) contentsElement.focus();
                    return;
                }

                if (!confirm('ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

                const requestData = {
                    em_id: window.currentEmId || (window.userInfo && window.userInfo.em_id),
                    dms_id: this.data.dmsId,
                    contents: contentsElement.value.trim(),
                    bl_id: this.safeGetElement('bl_id').value,
                    fl_id: this.safeGetElement('fl_id').value,
                    emclass_id: this.safeGetElement('emclass_id').value
                };
                
                console.log('ğŸ—ï¸ [DMS Update] ì €ì¥ ìš”ì²­:', requestData);
                
                fetch('fm/dms_update/save_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('ğŸ—ï¸ [DMS Update] ì €ì¥ ì‘ë‹µ:', data);
                    if (data && data.success) {
                        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');

                        const myTabId = window.tabManager.activeTabId || null; // í˜„ì¬ íƒ­ ID ê¸°ì–µ

                        if (window.tabManager && window.tabManager.tabs) {
                            let listTabId = null;

                            if (window.tabManager.tabs instanceof Map) {
                                for (const [tabId, tab] of window.tabManager.tabs.entries()) {
                                    if (tabId.includes('dms_list') || (tab.url && tab.url.includes('dms_list.html'))) {
                                        listTabId = tabId;
                                        break;
                                    }
                                }
                            }

                            if (listTabId && typeof window.tabManager.switchToTab === 'function') {
                                window.tabManager.switchToTab(listTabId);

                                setTimeout(() => {
                                    if (window.DmsListModule && typeof window.DmsListModule.loadData === 'function') {
                                        window.DmsListModule.loadData('read');
                                    }
                                }, 200);

                            } else if (typeof window.tabManager.addTab === 'function') {
                                window.tabManager.addTab('fm/dms_list.html', 'ë„ë©´ì •ë³´ê´€ë¦¬');
                            }

                            // í˜„ì¬ ìˆ˜ì • íƒ­ ë‹«ê¸°
                            setTimeout(() => {
                                if (typeof window.tabManager.removeTab === 'function' && myTabId) {
                                    window.tabManager.removeTab(myTabId);
                                }
                            }, 300);

                        } else {
                            window.location.href = 'fm/dms_list.html';
                        }

                    } else {
                        alert(`ì €ì¥ ì‹¤íŒ¨: ${data ? data.message : 'Unknown error'}`);
                    }
                })

                .catch(error => {
                    console.error('ğŸ—ï¸ [DMS Update] ì €ì¥ ì˜¤ë¥˜:', error);
                    alert(`ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                });
            },
            
            deleteData: function() {
                if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì²¨ë¶€íŒŒì¼ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;
                
                const requestData = {
                    em_id: window.currentEmId || (window.userInfo && window.userInfo.em_id),
                    dms_id: this.data.dmsId
                };
                
                console.log('ğŸ—ï¸ [DMS Update] ì‚­ì œ ìš”ì²­:', requestData);
                
                fetch('fm/dms_update/delete_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('ğŸ—ï¸ [DMS Update] ì‚­ì œ ì‘ë‹µ:', data);
                    if (data && data.success) {
                        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        this.goToList();
                    } else {
                        alert(`ì‚­ì œ ì‹¤íŒ¨: ${data ? data.message : 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('ğŸ—ï¸ [DMS Update] ì‚­ì œ ì˜¤ë¥˜:', error);
                    alert(`ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                });
            },

            downloadFile: function(fileIndex) {
                try {
                    const existingDiv = document.getElementById(`existing_file_${fileIndex}`);
                    if (!existingDiv || existingDiv.style.display === 'none') {
                        alert('ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    const dmsId = existingDiv.getAttribute('data-dms-id');
                    const fileId = existingDiv.getAttribute('data-file-id');
                    
                    if (!dmsId || !fileId) {
                        alert('íŒŒì¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    console.log('ğŸ”½ [DMS Update] íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œì‘:', { dmsId, fileId, fileIndex });
                    
                    const downloadUrl = `fm/dms_update/download?dms_id=${dmsId}&file_id=${fileId}`;
                    
                    // ìƒˆ ì°½ì—ì„œ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
                    const downloadWindow = window.open(downloadUrl, '_blank');
                    
                    // ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
                    setTimeout(() => {
                        if (!downloadWindow || downloadWindow.closed) {
                            console.warn('ğŸŸ¡ [DMS Update] íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                            // í˜„ì¬ ì°½ì—ì„œ ë‹¤ìš´ë¡œë“œ ì‹œë„
                            window.location.href = downloadUrl;
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error('ğŸ”´ [DMS Update] íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                    alert('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            },

            deleteFile: function(fileIndex) {
                try {
                    const existingDiv = document.getElementById(`existing_file_${fileIndex}`);
                    if (!existingDiv || existingDiv.style.display === 'none') {
                        alert('ì‚­ì œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    const fileName = document.getElementById(`file_name_${fileIndex}`).textContent;
                    
                    if (!confirm(`'${fileName}' íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        return;
                    }
                    
                    const dmsId = existingDiv.getAttribute('data-dms-id');
                    const fileId = existingDiv.getAttribute('data-file-id');
                    
                    console.log('ğŸ—‘ï¸ [DMS Update] íŒŒì¼ ì‚­ì œ ì‹œì‘:', { dmsId, fileId, fileIndex });
                    
                    fetch('fm/dms_update/delete_file', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            em_id: window.currentEmId || (window.userInfo && window.userInfo.em_id),
                            dms_id: dmsId,
                            file_id: fileId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('ğŸ—‘ï¸ [DMS Update] íŒŒì¼ ì‚­ì œ ì‘ë‹µ:', data);
                        if (data && data.success) {
                            alert('íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            existingDiv.style.display = 'none';
                            // íŒŒì¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                            const fileInput = document.getElementById(`filename${fileIndex + 1}`);
                            if (fileInput) {
                                fileInput.value = '';
                            }
                        } else {
                            alert(`íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: ${data ? data.message : 'Unknown error'}`);
                        }
                    })
                    .catch(error => {
                        console.error('ğŸ”´ [DMS Update] íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', error);
                        alert(`íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                    });
                    
                } catch (error) {
                    console.error('ğŸ”´ [DMS Update] íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', error);
                    alert('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            },
            
            goToList: function() {
                try {
                    if (window.tabManager && window.tabManager.tabs) {
                        let listTabId = null;
                        
                        if (window.tabManager.tabs instanceof Map) {
                            for (const [tabId, tab] of window.tabManager.tabs.entries()) {
                                if (tabId.includes('dms_list') || 
                                    (tab.url && tab.url.includes('dms_list.html'))) {
                                    listTabId = tabId;
                                    break;
                                }
                            }
                        }
                        
                        if (listTabId && typeof window.tabManager.switchToTab === 'function') {
                            window.tabManager.switchToTab(listTabId);
                            
                            setTimeout(() => {
                                if (typeof window.tabManager.removeCurrentTab === 'function') {
                                    window.tabManager.removeCurrentTab();
                                }
                            }, 100);
                            
                            // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                            setTimeout(() => {
                                if (window.DmsListModule && typeof window.DmsListModule.loadData === 'function') {
                                    window.DmsListModule.loadData('read');
                                }
                            }, 300);
                            
                            return;
                        }
                        
                        if (typeof window.tabManager.addTab === 'function') {
                            window.tabManager.addTab('fm/dms_list.html', 'ë„ë©´ì •ë³´ê´€ë¦¬');
                            
                            setTimeout(() => {
                                if (typeof window.tabManager.removeCurrentTab === 'function') {
                                    window.tabManager.removeCurrentTab();
                                }
                            }, 200);
                            
                            return;
                        }
                    }
                    
                    window.location.href = 'fm/dms_list.html';
                    
                } catch (error) {
                    console.error('ğŸ”´ [DMS Update] ëª©ë¡ ì´ë™ ì¤‘ ì˜¤ë¥˜:', error);
                    window.location.href = 'fm/dms_list.html';
                }
            },
            
            showError: function(message) {
                console.error('ğŸ”´ [DMS Update] ì˜¤ë¥˜:', message);
                
                const infoArea = document.querySelector('#dms_update_outer .info-area');
                if (infoArea) {
                    // ì›ë³¸ HTML ë°±ì—… (ì•„ì§ ë°±ì—…ë˜ì§€ ì•Šì•˜ë‹¤ë©´)
                    if (!this.data.originalFormHTML) {
                        this.data.originalFormHTML = infoArea.innerHTML;
                    }
                    
                    infoArea.innerHTML = `
                        <div style="text-align: center; padding: 50px; color: #dc3545; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px;">
                            <h4 style="margin-bottom: 20px;">âš ï¸ ì˜¤ë¥˜ ë°œìƒ</h4>
                            <p style="margin-bottom: 30px; font-size: 14px;">${message}</p>
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button onclick="DmsUpdateModule.retryLoad()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    ë‹¤ì‹œ ì‹œë„
                                </button>
                                <button onclick="DmsUpdateModule.goToList()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                                </button>
                            </div>
                        </div>
                    `;
                }
            },

            retryLoad: function() {
                console.log('ğŸ”„ [DMS Update] ë°ì´í„° ë¡œë“œ ì¬ì‹œë„');
                this.loadData();
            },
            
            cleanup: function() {
                console.log('ğŸ—ï¸ [DMS Update] DmsUpdateModule ì •ë¦¬ ì¤‘...');
                this.data.isInitialized = false;
                this.data.originalFormHTML = null;
                this.data.itemData = {};
                this.data.blList = [];
                this.data.flList = [];
            }
        };
        
        setTimeout(() => {
            if (!window.DmsUpdateModule.data.isInitialized) {
                console.log('ğŸ—ï¸ [DMS Update] ìë™ ì´ˆê¸°í™” ì‹œì‘');
                window.DmsUpdateModule.init();
            }
        }, 100);
        
        console.log('ğŸ—ï¸ [DMS Update] DmsUpdateModule ë¡œë“œ ì™„ë£Œ');
        
    })();
    </script>
</body>
</html>