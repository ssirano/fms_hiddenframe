<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Python_FMS{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    {% block extra_css %}{% endblock %}
   
    <script>
        // ì „ì—­ ìƒíƒœ ë³€ìˆ˜
        window.headerPinned = true;
        window.sidebarPinned = true;
        window.currentModule = null;
        window.menuData = [];
        window.userInfo = null;
        window.propList = [];
        
        // íƒ­ ê´€ë¦¬ ì‹œìŠ¤í…œ
        window.tabManager = {
            tabs: new Map(), // íƒ­ ë°ì´í„° ì €ì¥ì†Œ
            activeTabId: null,
            
            // íƒ­ ì¶”ê°€
            addTab: function(url, title) {
                const tabId = this.generateTabId(url);
                
                if (!this.tabs.has(tabId)) {
                    this.tabs.set(tabId, {
                        id: tabId,
                        url: url,
                        title: title,
                        content: null,
                        loaded: false,
                        formData: new Map() // í¼ ë°ì´í„° ì €ì¥
                    });
                    this.renderTabHeaders();
                }
                
                this.switchToTab(tabId);
                return tabId;
            },
            
            // íƒ­ ì œê±°
            removeTab: function(tabId) {
                if (this.tabs.has(tabId)) {
                    this.tabs.delete(tabId);
                    
                    if (this.activeTabId === tabId) {
                        // ë‹¤ë¥¸ íƒ­ìœ¼ë¡œ ì „í™˜
                        const remainingTabs = Array.from(this.tabs.keys());
                        if (remainingTabs.length > 0) {
                            this.switchToTab(remainingTabs[remainingTabs.length - 1]);
                        } else {
                            this.showDashboard();
                        }
                    }
                    
                    this.renderTabHeaders();
                }
            },
            
            // íƒ­ ì „í™˜
            switchToTab: function(tabId) {
                if (!this.tabs.has(tabId)) return;
                
                // í˜„ì¬ íƒ­ì˜ ìƒíƒœ ì €ì¥
                this.saveCurrentTabState();
                
                this.activeTabId = tabId;
                const tab = this.tabs.get(tabId);
                
                // íƒ­ í—¤ë” ì—…ë°ì´íŠ¸
                this.updateTabHeaders();
                
                if (tab.loaded && tab.content) {
                    // ìºì‹œëœ ë‚´ìš© í‘œì‹œ
                    this.displayTabContent(tab.content);
                    this.restoreTabState(tab);
                } else {
                    // ìƒˆë¡œ ë¡œë“œ
                    this.loadTabContent(tab);
                }
            },
            
            // íƒ­ ID ìƒì„±
            generateTabId: function(url) {
                return 'tab_' + url.replace(/[^a-zA-Z0-9]/g, '_');
            },
            
            // íƒ­ í—¤ë” ë Œë”ë§
            renderTabHeaders: function() {
                const container = document.getElementById('tab-headers-container');
                if (!container) return;
                
                let html = '';
                this.tabs.forEach((tab, tabId) => {
                    const isActive = tabId === this.activeTabId ? 'active' : '';
                    html += `
                        <div class="tab-header ${isActive}" data-tab-id="${tabId}" onclick="window.tabManager.switchToTab('${tabId}')">
                            <span class="tab-title">${tab.title}</span>
                            <span class="tab-close" onclick="event.stopPropagation(); window.tabManager.removeTab('${tabId}')">&times;</span>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                container.style.display = this.tabs.size > 0 ? 'flex' : 'none';
            },
            
            // íƒ­ í—¤ë” í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
            updateTabHeaders: function() {
                document.querySelectorAll('.tab-header').forEach(header => {
                    const tabId = header.dataset.tabId;
                    header.classList.toggle('active', tabId === this.activeTabId);
                });
            },
            
            // íƒ­ ì½˜í…ì¸  ë¡œë“œ
            loadTabContent: function(tab) {
                this.showLoading();
                
                fetch('/common/load_container', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ menuUrl: tab.url })
                })
                .then(response => response.text())
                .then(html => {
                    tab.content = html;
                    tab.loaded = true;
                    this.displayTabContent(html);
                    this.hideLoading();
                })
                .catch(error => {
                    console.error('íƒ­ ì½˜í…ì¸  ë¡œë“œ ì˜¤ë¥˜:', error);
                    const errorHtml = `
                        <div style="text-align: center; padding: 50px;">
                            <h3 style="color: #dc3545;">í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p style="color: #6c757d; margin: 20px 0;">URL: ${tab.url}</p>
                            <button class="btn btn-primary" onclick="window.tabManager.reloadTab('${tab.id}')">ë‹¤ì‹œ ì‹œë„</button>
                        </div>
                    `;
                    this.displayTabContent(errorHtml);
                    this.hideLoading();
                });
            },
           

            
            // íƒ­ ì½˜í…ì¸  í‘œì‹œ
            displayTabContent: function(html) {
                const container = document.getElementById('dynamic-content');
                if (container) {
                    container.innerHTML = html;

                    // ğŸ”¥ HTML ì‚½ì… í›„ script ì¬ì‹¤í–‰
                    setTimeout(() => {
                        // <script>ë¥¼ ë™ì ìœ¼ë¡œ ì‹¤í–‰
                        executeScriptsInContainer(container);

                        // âœ… í•¨ìˆ˜ê°€ ì¤€ë¹„ëëŠ”ì§€ í™•ì¸ í›„ ì‹¤í–‰
                        setTimeout(() => {
                            if (typeof window.initEmployeePage === 'function') {
                                console.log('ğŸ“„ initEmployeePage ìë™ í˜¸ì¶œ');
                                window.initEmployeePage();
                            } else {
                                console.warn('ğŸ“„ initEmployeePage í•¨ìˆ˜ ì—†ìŒ');
                            }
                        }, 300); // ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ í›„ ì•½ê°„ ëŒ€ê¸°
                    }, 200);
                }
            },

            
            // í˜„ì¬ íƒ­ ìƒíƒœ ì €ì¥
            saveCurrentTabState: function() {
                if (!this.activeTabId) return;
                
                const tab = this.tabs.get(this.activeTabId);
                if (!tab) return;
                
                // í¼ ë°ì´í„° ì €ì¥
                const forms = document.querySelectorAll('#dynamic-content form');
                forms.forEach((form, index) => {
                    const formData = new FormData(form);
                    const formObj = {};
                    for (let [key, value] of formData.entries()) {
                        formObj[key] = value;
                    }
                    tab.formData.set(`form_${index}`, formObj);
                });
                
                // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
                const contentArea = document.getElementById('dynamic-content');
                if (contentArea) {
                    tab.scrollTop = contentArea.scrollTop;
                }
            },
            
            // íƒ­ ìƒíƒœ ë³µì›
            restoreTabState: function(tab) {
                // í¼ ë°ì´í„° ë³µì›
                setTimeout(() => {
                    const forms = document.querySelectorAll('#dynamic-content form');
                    forms.forEach((form, index) => {
                        const formData = tab.formData.get(`form_${index}`);
                        if (formData) {
                            Object.entries(formData).forEach(([key, value]) => {
                                const element = form.querySelector(`[name="${key}"]`);
                                if (element) {
                                    element.value = value;
                                }
                            });
                        }
                    });
                    
                    // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì›
                    const contentArea = document.getElementById('dynamic-content');
                    if (contentArea && tab.scrollTop) {
                        contentArea.scrollTop = tab.scrollTop;
                    }
                }, 100);
            },
            
            // íƒ­ ë¦¬ë¡œë“œ
            reloadTab: function(tabId) {
                const tab = this.tabs.get(tabId);
                if (tab) {
                    tab.loaded = false;
                    tab.content = null;
                    tab.formData.clear();
                    if (this.activeTabId === tabId) {
                        this.loadTabContent(tab);
                    }
                }
            },
            
            // ëŒ€ì‹œë³´ë“œ í‘œì‹œ
            showDashboard: function() {
                this.activeTabId = null;
                const dashboardHtml = `
                    <h2>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
                            <h4 style="margin: 0 0 10px 0; color: #155724;">Flask ì„œë²„</h4>
                            <p style="font-size: 24px; font-weight: bold; margin: 0; color: #155724;">ì—°ë™ ì¤€ë¹„</p>
                        </div>
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff;">
                            <h4 style="margin: 0 0 10px 0; color: #004085;">ì§ì› ê´€ë¦¬</h4>
                            <p style="font-size: 24px; font-weight: bold; margin: 0; color: #004085;">ì‹œìŠ¤í…œ</p>
                        </div>
                        <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <h4 style="margin: 0 0 10px 0; color: #856404;">SPA ëª¨ë“œ</h4>
                            <p style="font-size: 24px; font-weight: bold; margin: 0; color: #856404;">í™œì„±í™”</p>
                        </div>
                        <div style="background: #f8d7da; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
                            <h4 style="margin: 0 0 10px 0; color: #721c24;">íƒ­ ë©”ëª¨ë¦¬</h4>
                            <p style="font-size: 24px; font-weight: bold; margin: 0; color: #721c24;">ì§€ì›</p>
                        </div>
                    </div>
                    
                    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px;">
                        <h3 style="margin: 0 0 20px 0;">âš¡ ë¹ ë¥¸ ì‘ì—…</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <button style="padding: 15px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; text-align: left;" onclick="window.loadContent('/fm/em_list.html', 'ğŸ“ ì§ì›ì •ë³´')">
                                ğŸ“ ì§ì› ì •ë³´ ê´€ë¦¬
                            </button>
                        </div>
                    </div>
                `;
                this.displayTabContent(dashboardHtml);
                this.updateTabHeaders();
            },
            
            // ë¡œë”© í‘œì‹œ
            showLoading: function() {
                const container = document.getElementById('dynamic-content');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <div class="spinner" style="margin: 0 auto 20px;"></div>
                            <p>í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                    `;
                }
            },
            
            // ë¡œë”© ìˆ¨ê¹€
            hideLoading: function() {
                // ë¡œë”©ì€ ì½˜í…ì¸ ë¡œ ëŒ€ì²´ë˜ë¯€ë¡œ ë³„ë„ ì²˜ë¦¬ ë¶ˆí•„ìš”
            }
        };
        
        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        window.loadUserInfo = function() {
            return fetch('/common/get_user_info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.userInfo = data;
                    
                    // ì „ì—­ ë³€ìˆ˜ë¡œ ë…¸ì¶œ (ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
                    window.currentEmId = data.em_id;
                    window.currentPropId = data.prop_id;
                    
                    const userInfoElement = document.getElementById('user-info-text');
                    if (userInfoElement) {
                        userInfoElement.innerHTML = `ì‚¬ìš©ì: ${data.name} ë‹˜ [${data.emclass_id}]`;
                    }
                    
                    console.log('ğŸ” ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì™„ë£Œ:', {
                        em_id: data.em_id,
                        prop_id: data.prop_id,
                        name: data.name
                    });
                    
                    return data;
                } else {
                    window.showStatus('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + data.message);
                    return null;
                }
            })
            .catch(error => {
                window.showStatus('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                return null;
            });
        };
        
        // ì‚¬ì—…ì†Œ ëª©ë¡ ë¡œë“œ
        window.loadPropList = function(em_id) {
            return fetch('/common/get_prop_list', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ em_id: em_id })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && Array.isArray(data.data)) {
                    window.propList = data.data;
                    window.renderPropList();
                    return data.data;
                } else {
                    window.showStatus('ì‚¬ì—…ì†Œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                    return [];
                }
            })
            .catch(error => {
                window.showStatus('ì‚¬ì—…ì†Œ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                return [];
            });
        };
        
        // ì‚¬ì—…ì†Œ ëª©ë¡ ë Œë”ë§
        window.renderPropList = function() {
            const propSelect = document.getElementById('sel_business_place');
            if (!propSelect) return;
            
            propSelect.innerHTML = '';
            
            if (!window.propList || window.propList.length === 0) {
                propSelect.innerHTML = '<option value="">ì‚¬ì—…ì†Œ ì—†ìŒ</option>';
                return;
            }
            
            propSelect.innerHTML = '<option value="">ì‚¬ì—…ì†Œ ì„ íƒ</option>';
            
            window.propList.forEach(prop => {
                const option = document.createElement('option');
                option.value = prop.prop_id;
                option.textContent = `${prop.prop_name} (${prop.prop_id})`;
                propSelect.appendChild(option);
            });
            
            if (window.propList.length > 0) {
                propSelect.value = window.propList[0].prop_id;
                
                // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
                window.currentPropId = window.propList[0].prop_id;
                
                console.log('ğŸ¢ ì²« ë²ˆì§¸ ì‚¬ì—…ì†Œ ìë™ ì„ íƒ:', {
                    prop_id: window.propList[0].prop_id,
                    prop_name: window.propList[0].prop_name
                });
            }
        };
        
        // ì‚¬ì—…ì†Œ ë³€ê²½ ì´ë²¤íŠ¸
        window.onBusinessPlaceChange = function() {
            const propSelect = document.getElementById('sel_business_place');
            const selectedPropId = propSelect.value;
            const selectedPropName = propSelect.options[propSelect.selectedIndex].text;
            
            if (selectedPropId && window.userInfo) {
                console.log('ğŸ¢ ì‚¬ì—…ì†Œ ë³€ê²½ë¨:', selectedPropId, selectedPropName);
                
                // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                window.currentPropId = selectedPropId;
                
                window.showStatus('ì„ íƒëœ ì‚¬ì—…ì†Œ: ' + selectedPropName);
                
                // ë©”ë‰´ ë°ì´í„° ìƒˆë¡œ ë¡œë“œ
                window.loadMenuData();
                
                // í˜„ì¬ í™œì„±í™”ëœ íƒ­ì´ ì§ì›ì •ë³´ë¼ë©´ ìƒˆë¡œê³ ì¹¨
                if (window.tabManager.activeTabId) {
                    const activeTab = window.tabManager.tabs.get(window.tabManager.activeTabId);
                    if (activeTab && activeTab.url.includes('em_list')) {
                        console.log('ğŸ“ ì§ì›ì •ë³´ íƒ­ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰');
                        
                        // íƒ­ ë°ì´í„° ì´ˆê¸°í™”
                        activeTab.loaded = false;
                        activeTab.content = null;
                        activeTab.formData.clear();
                        
                        // íƒ­ ë‹¤ì‹œ ë¡œë“œ
                        window.tabManager.loadTabContent(activeTab);
                    }
                }
                
                // ì „ì—­ì ìœ¼ë¡œ ì‚¬ì—…ì†Œ ë³€ê²½ ì•Œë¦¼ (ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œë„ ì‚¬ìš© ê°€ëŠ¥)
                if (typeof window.onEmployeePagePropChange === 'function') {
                    window.onEmployeePagePropChange(selectedPropId);
                }
            }
        };
        
        // ë©”ë‰´ ë°ì´í„° ë¡œë“œ
        window.loadMenuData = function() {
            if (!window.userInfo || !window.userInfo.em_id) {
                return Promise.resolve([]);
            }
            
            return fetch('/get_menu_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ em_id: window.userInfo.em_id })
            })
            .then(response => response.json())
            .then(data => {
                if (Array.isArray(data)) {
                    window.menuData = data;
                    window.renderModuleMenu();
                    window.renderSidebarMenu();
                    return data;
                } else {
                    window.showStatus('ë©”ë‰´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                    return [];
                }
            })
            .catch(() => []);
        };
        
        // ëª¨ë“ˆ ë©”ë‰´ ë Œë”ë§
        window.renderModuleMenu = function() {
            const moduleMenu = document.querySelector('.module-menu');
            if (!moduleMenu) return;
            
            if (!window.menuData || window.menuData.length === 0) {
                moduleMenu.innerHTML = '<div style="color: #666;">ì ‘ê·¼ ê°€ëŠ¥í•œ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let moduleHtml = '';
            window.menuData.forEach(module => {
                moduleHtml += `
                    <div class="module-item" data-module-id="${module.menu_01_module_id}" onclick="clickModule(this)">
                        ${module.menu_01_title}
                    </div>
                `;
            });
            
            moduleMenu.innerHTML = moduleHtml;
        };

        // ì‚¬ì´ë“œë°” ë©”ë‰´ ë Œë”ë§
        window.renderSidebarMenu = function() {
            const menuContainer = document.getElementById('menuContainer');
            if (!menuContainer) return;
            
            if (!window.menuData || window.menuData.length === 0) {
                menuContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">ì ‘ê·¼ ê°€ëŠ¥í•œ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            // ì²« ë²ˆì§¸ ëª¨ë“ˆì˜ ë©”ë‰´ë¡œ ì´ˆê¸°í™”
            if (window.menuData.length > 0) {
                const firstModule = window.menuData[0];
                window.loadModuleMenus(firstModule.menu_01_module_id, firstModule.menu_01_title);
            }
        };
        
        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        window.showStatus = function(message) {
            const statusIndicator = document.getElementById('statusIndicator');
            if (statusIndicator) {
                statusIndicator.textContent = message;
                statusIndicator.classList.add('show');
                setTimeout(() => {
                    statusIndicator.classList.remove('show');
                }, 2000);
            }
        };
        
        // í—¤ë” í•€ í† ê¸€ í•¨ìˆ˜
        window.toggleHeaderPin = function(button) {
            window.headerPinned = !window.headerPinned;
            const headerFrame = document.getElementById('headerFrame');
            
            if (window.headerPinned) {
                button.classList.add('pinned');
                button.textContent = 'ğŸ“Œ';
                if (headerFrame) headerFrame.classList.remove('hidden');
                window.showStatus('í—¤ë”ê°€ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                button.classList.remove('pinned');
                button.textContent = 'ğŸ“';
                if (headerFrame) headerFrame.classList.add('hidden');
                window.showStatus('í—¤ë”ê°€ ë¹„ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒë‹¨ì— ë§ˆìš°ìŠ¤ë¥¼ ëŒ€ë©´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.');
            }
        };
        
        // ì‚¬ì´ë“œë°” í•€ í† ê¸€ í•¨ìˆ˜
        window.toggleSidebarPin = function(button) {
            window.sidebarPinned = !window.sidebarPinned;
            const sidebarFrame = document.getElementById('sidebarFrame');
            
            if (window.sidebarPinned) {
                button.classList.add('pinned');
                button.textContent = 'ğŸ“Œ';
                if (sidebarFrame) sidebarFrame.classList.remove('hidden');
                window.showStatus('ì‚¬ì´ë“œë°”ê°€ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                button.classList.remove('pinned');
                button.textContent = 'ğŸ“';
                if (sidebarFrame) sidebarFrame.classList.add('hidden');
                window.showStatus('ì‚¬ì´ë“œë°”ê°€ ë¹„ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ì¢Œì¸¡ì— ë§ˆìš°ìŠ¤ë¥¼ ëŒ€ë©´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.');
            }
        };
        
        // ëª¨ë“ˆ ë©”ë‰´ í´ë¦­ í•¨ìˆ˜
        window.clickModule = function(element) {
            const moduleId = element.dataset.moduleId;
            const moduleTitle = element.textContent.trim();
            
            // ëª¨ë“  ëª¨ë“ˆ ë©”ë‰´ ë¹„í™œì„±í™”
            document.querySelectorAll('.module-item').forEach(m => m.classList.remove('active'));
            element.classList.add('active');
            
            window.currentModule = moduleId;
            window.loadModuleMenus(moduleId, moduleTitle);
            window.showStatus(`${moduleTitle} ëª¨ë“ˆì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`);
        };
        
        // í•˜ìœ„ ë©”ë‰´ í´ë¦­ í•¨ìˆ˜ (SPA ì „ìš©)
        window.clickMenu = function(element) {
            const url = element.dataset.menuUrl;
            const title = element.textContent.trim();
            
            if (!url) {
                window.showStatus('ë©”ë‰´ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            window.loadContent(url, title);
            
            // í™œì„± ë©”ë‰´ í‘œì‹œ
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            element.classList.add('active');
        };
        
        // ëª¨ë“ˆì˜ í•˜ìœ„ ë©”ë‰´ ë¡œë“œ
        window.loadModuleMenus = function(moduleId, moduleTitle) {
            const sidebarTitle = document.getElementById('sidebarTitle');
            const sidebarSubtitle = document.getElementById('sidebarSubtitle');
            const menuContainer = document.getElementById('menuContainer');
            
            const moduleData = window.menuData.find(module => module.menu_01_module_id === moduleId);
            
            if (!moduleData) {
                if (menuContainer) menuContainer.innerHTML = '<p>ë©”ë‰´ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            if (sidebarTitle) sidebarTitle.textContent = moduleData.menu_01_title;
            if (sidebarSubtitle) sidebarSubtitle.textContent = moduleData.menu_01_title_eng || 'Management';
            
            let menuHtml = '';
            
            moduleData.menu_02_data.forEach(menu2 => {
                if (menu2.menu_03_data && menu2.menu_03_data.length > 0) {
                    // í•˜ìœ„ ë©”ë‰´ê°€ ìˆëŠ” ê²½ìš°
                    menuHtml += `
                        <div class="menu-group">
                            <div class="menu-item-parent" onclick="toggleSubMenu(this)">
                                <span>${menu2.menu_02_name}</span>
                                <span class="menu-arrow">â–¶</span>
                            </div>
                            <div class="sub-menu-container" style="display: none;">
                    `;
                    
                    menu2.menu_03_data.forEach(menu3 => {
                        menuHtml += `
                            <div class="menu-item sub-menu" data-menu-url="${menu3.menu_03_url || ''}" onclick="clickMenu(this)">
                                ${menu3.menu_03_name}
                            </div>
                        `;
                    });
                    
                    menuHtml += `
                            </div>
                        </div>
                    `;
                } else {
                    // í•˜ìœ„ ë©”ë‰´ê°€ ì—†ëŠ” ê²½ìš°
                    menuHtml += `
                        <div class="menu-item" data-menu-url="${menu2.menu_02_url || ''}" onclick="clickMenu(this)">
                            ${menu2.menu_02_name}
                        </div>
                    `;
                }
            });
            
            if (menuContainer) {
                menuContainer.innerHTML = menuHtml;
            }
        };
        
        // í•˜ìœ„ ë©”ë‰´ í† ê¸€
        window.toggleSubMenu = function(element) {
            const subMenuContainer = element.nextElementSibling;
            const arrow = element.querySelector('.menu-arrow');
            
            if (subMenuContainer.style.display === 'none') {
                subMenuContainer.style.display = 'block';
                arrow.textContent = 'â–¼';
            } else {
                subMenuContainer.style.display = 'none';
                arrow.textContent = 'â–¶';
            }
        };
        
        // ì½˜í…ì¸  ë¡œë“œ í•¨ìˆ˜ (SPA ì „ìš©)
        window.loadContent = function(url, title) {
            console.log('ğŸ”— loadContent í˜¸ì¶œë¨:', { url, title });
            
            if (!url) {
                console.error('ğŸ”— URLì´ ì—†ìŠµë‹ˆë‹¤');
                window.showStatus('ë©”ë‰´ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            console.log('ğŸ”— tabManager ì¡´ì¬ í™•ì¸:', typeof window.tabManager);
            console.log('ğŸ”— tabManager.addTab ì¡´ì¬ í™•ì¸:', typeof window.tabManager.addTab);
            
            try {
                console.log('ğŸ”— íƒ­ ì¶”ê°€ ì‹œë„ ì‹œì‘');
                // íƒ­ ì¶”ê°€ ë° ì „í™˜
                window.tabManager.addTab(url, title);
                console.log('ğŸ”— íƒ­ ì¶”ê°€ ì™„ë£Œ');
                window.showStatus(`${title} íƒ­ì„ ì—´ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error('ğŸ”— íƒ­ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜:', error);
                console.error('ğŸ”— ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
            }
        };
        
        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        window.logout = function() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                fetch('/login/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = data.redirect;
                    }
                })
                .catch(error => {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                    alert('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
            }
        };
        
        // ì‹œê³„ ì—…ë°ì´íŠ¸
        window.updateClock = function() {
            const now = new Date();
            const timeStr = now.getFullYear() + '-' +
                           String(now.getMonth() + 1).padStart(2, '0') + '-' +
                           String(now.getDate()).padStart(2, '0') + ' (' +
                           ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][now.getDay()] + ') ' +
                           String(now.getHours()).padStart(2, '0') + ':' +
                           String(now.getMinutes()).padStart(2, '0') + ':' +
                           String(now.getSeconds()).padStart(2, '0');
            const clockElement = document.getElementById('current-datetime');
            if (clockElement) {
                clockElement.textContent = timeStr;
            }
        };
        
        // í˜¸ë²„ ì´ë²¤íŠ¸ í•¨ìˆ˜ë“¤
        window.onHeaderHover = function() {
            if (!window.headerPinned) {
                const headerFrame = document.getElementById('headerFrame');
                if (headerFrame) {
                    headerFrame.classList.add('hover-show');
                }
            }
        };
        
        window.onHeaderLeave = function() {
            if (!window.headerPinned) {
                const headerFrame = document.getElementById('headerFrame');
                setTimeout(() => {
                    if (headerFrame && !headerFrame.matches(':hover')) {
                        headerFrame.classList.remove('hover-show');
                    }
                }, 300);
            }
        };
        
        window.onSidebarHover = function() {
            if (!window.sidebarPinned) {
                const sidebarFrame = document.getElementById('sidebarFrame');
                if (sidebarFrame) {
                    sidebarFrame.classList.add('hover-show');
                }
            }
        };
        
        window.onSidebarLeave = function() {
            if (!window.sidebarPinned) {
                const sidebarFrame = document.getElementById('sidebarFrame');
                setTimeout(() => {
                    if (sidebarFrame && !sidebarFrame.matches(':hover')) {
                        sidebarFrame.classList.remove('hover-show');
                    }
                }, 300);
            }
        };
        
        // ì´ˆê¸°í™” í•¨ìˆ˜
        window.initialize = function() {
            console.log('=== SPA ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘ ===');
            
            // ì‹œê³„ ì‹œì‘
            window.updateClock();
            setInterval(window.updateClock, 1000);
            
            window.loadUserInfo()
                .then(userInfo => {
                    if (userInfo && userInfo.em_id) {
                        return window.loadPropList(userInfo.em_id)
                            .then(propList => {
                                return window.loadMenuData();
                            });
                    }
                    throw new Error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨');
                })
                .then(menuData => {
                    if (menuData && menuData.length > 0) {
                        // ë©”ë‰´ ë Œë”ë§ ì™„ë£Œ í›„ ì²« ë²ˆì§¸ ëª¨ë“ˆ ì„ íƒ
                        setTimeout(() => {
                            const firstModuleElement = document.querySelector('.module-item');
                            if (firstModuleElement) {
                                window.clickModule(firstModuleElement);
                            }
                        }, 300);
                        
                        // ì§ì›ì •ë³´ íƒ­ì„ ì²« í˜ì´ì§€ë¡œ ìë™ ì˜¤í”ˆ
                        setTimeout(() => {
                            console.log('ğŸ“ ì§ì›ì •ë³´ íƒ­ì„ ì²« í˜ì´ì§€ë¡œ ì˜¤í”ˆ');
                            window.loadContent('/fm/em_list.html', 'ğŸ“ ì§ì›ì •ë³´');
                        }, 800);
                        
                        console.log('=== SPA ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ ===');
                        window.showStatus('SPA ëª¨ë“œë¡œ ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                })
                .catch(error => {
                    console.error('=== SPA ì´ˆê¸°í™” ì˜¤ë¥˜ ===', error);
                    window.showStatus('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    
                    // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì§ì›ì •ë³´ íƒ­ ì—´ê¸° ì‹œë„
                    setTimeout(() => {
                        window.loadContent('/fm/em_list.html', 'ğŸ“ ì§ì›ì •ë³´');
                    }, 1000);
                });
        };
        function executeScriptsInContainer(container) {
            const scripts = container.querySelectorAll('script');
            scripts.forEach(script => {
                const newScript = document.createElement('script');
                if (script.src) {
                    newScript.src = script.src;
                    newScript.async = false;
                } else {
                    newScript.textContent = script.textContent;
                }
                script.parentNode.replaceChild(newScript, script);
            });
        }
        
    </script>

    <style>
        /* íƒ­ í—¤ë” ìŠ¤íƒ€ì¼ */
        .tab-headers-container {
            display: none;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 0 20px;
            gap: 2px;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .tab-header {
            display: inline-flex;
            align-items: center;
            padding: 8px 12px;
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 13px;
            max-width: 200px;
            min-width: 120px;
        }
        
        .tab-header:hover {
            background: #f8f9fa;
        }
        
        .tab-header.active {
            background: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            z-index: 1;
            position: relative;
        }
        
        .tab-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
        }
        
        .tab-close {
            color: #6c757d;
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 2px;
            transition: all 0.15s ease;
        }
        
        .tab-close:hover {
            background: #dc3545;
            color: white;
        }
        
        /* ì½˜í…ì¸  ì˜ì—­ ì¡°ì • */
        .content-area {
            padding: 0;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        #dynamic-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- í—¤ë” í˜¸ë²„ íŠ¸ë¦¬ê±° -->
        <div class="header-hover-trigger" id="headerHoverTrigger" 
             onmouseenter="onHeaderHover()" 
             title="í—¤ë” í˜¸ë²„ ì˜ì—­"></div>
        
        <!-- ì‚¬ì´ë“œë°” í˜¸ë²„ íŠ¸ë¦¬ê±° -->
        <div class="sidebar-hover-trigger" id="sidebarHoverTrigger" 
             onmouseenter="onSidebarHover()" 
             title="ì‚¬ì´ë“œë°” í˜¸ë²„ ì˜ì—­"></div>
        
        <!-- í—¤ë” í”„ë ˆì„ -->
        <div class="header-frame" id="headerFrame" onmouseleave="onHeaderLeave()">
            <button class="pin-button header-pin pinned" id="headerPin" onclick="toggleHeaderPin(this)" title="í—¤ë” ê³ ì •/í•´ì œ">ğŸ“Œ</button>
            
            <div class="topheader-left">
                <label for="sel_business_place"><b>ì‚¬ì—…ì†Œ ì„ íƒ:</b></label>
                <select id="sel_business_place" onchange="onBusinessPlaceChange()">
                    <option value="">ì‚¬ì—…ì†Œ ë¡œë”© ì¤‘...</option>
                </select>
            </div>
            
            <!-- ëª¨ë“ˆ ë©”ë‰´ -->
            <div class="module-menu">
                <!-- DBì—ì„œ ë¡œë“œëœ ëª¨ë“ˆ ë©”ë‰´ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
            
            <div class="user-info">
                <span id="current-datetime">2025-06-17 (í™”) 15:30:45</span>
                <span><b id="user-info-text">ì‚¬ìš©ì: ë¡œë”© ì¤‘...</b></span>
                <button type="button" id="btn_logout" class="toggle-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <!-- ì‚¬ì´ë“œë°” í”„ë ˆì„ -->
        <div class="sidebar-frame" id="sidebarFrame" onmouseleave="onSidebarLeave()">
            <button class="pin-button sidebar-pin pinned" id="sidebarPin" onclick="toggleSidebarPin(this)" title="ì‚¬ì´ë“œë°” ê³ ì •/í•´ì œ">ğŸ“Œ</button>
            
            <div class="sidebar-content">
                <h3 id="sidebarTitle">ì‹œìŠ¤í…œê´€ë¦¬</h3>
                <p id="sidebarSubtitle">System Management</p>
                <hr style="margin: 15px 0; border-color: #6c757d;">
                
                <div id="menuContainer">
                    <div style="text-align: center; padding: 20px; color: #6c757d;">
                        ë©”ë‰´ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
                    </div>
                </div>
            </div>
        </div>

        <!-- ì½˜í…ì¸  í”„ë ˆì„ -->
        <div class="content-frame" id="contentFrame">
            <!-- íƒ­ í—¤ë” -->
            <div class="tab-headers-container" id="tab-headers-container">
                <!-- íƒ­ í—¤ë”ê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
            
            <div class="content-area">
                <div id="dynamic-content">
                    {% block content %}
                    <!-- ì´ˆê¸°í™” ì¤‘ ë©”ì‹œì§€ -->
                    <div style="display: flex; align-items: center; justify-content: center; height: 400px; text-align: center;">
                        <div>
                            <div class="spinner" style="margin: 0 auto 20px;"></div>
                            <h3 style="color: #6c757d; margin-bottom: 10px;">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</h3>
                            <p style="color: #868e96;">ì§ì›ì •ë³´ í˜ì´ì§€ë¥¼ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                    {% endblock %}
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒíƒœ ì¸ë””ì¼€ì´í„° -->
    <div class="status-indicator" id="statusIndicator">
        ìƒíƒœ ë©”ì‹œì§€
    </div>

    {% block extra_js %}{% endblock %}

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof window.initialize === 'function') {
                window.initialize();
            }
        });
        
        // ì´ë¯¸ ë¡œë“œëœ ê²½ìš°ë¥¼ ìœ„í•œ ë°±ì—…
        if (document.readyState !== 'loading') {
            setTimeout(function() {
                if (typeof window.initialize === 'function') {
                    window.initialize();
                }
            }, 100);
        }
    </script>
</body>
</html>