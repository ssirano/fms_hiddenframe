<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Python_FMS{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    {% block extra_css %}{% endblock %}
   
    <script>
        // ì „ì—­ ìƒíƒœ ë³€ìˆ˜
        window.headerPinned = true;
        window.sidebarPinned = true;
        window.currentModule = null;
        window.menuData = [];
        window.userInfo = null;
        window.propList = [];
        
        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ (base API ì‚¬ìš©)
        window.loadUserInfo = function() {
            console.log('BASE: loadUserInfo í˜¸ì¶œë¨');
            return fetch('/common/get_user_info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                console.log('BASE: ì‚¬ìš©ì ì •ë³´ ì‘ë‹µ:', data);
                if (data.success) {
                    window.userInfo = data;
                    const userInfoElement = document.getElementById('user-info-text');
                    if (userInfoElement) {
                        userInfoElement.innerHTML = `ì‚¬ìš©ì: ${data.name} ë‹˜ [${data.emclass_id}]`;
                        console.log('BASE: ì‚¬ìš©ì ì •ë³´ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                    }
                    return data;
                } else {
                    console.error('BASE: ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', data.message);
                    window.showStatus('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + data.message);
                    return null;
                }
            })
            .catch(error => {
                console.error('BASE: ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                window.showStatus('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                return null;
            });
        };
        
        // ì‚¬ì—…ì†Œ ëª©ë¡ ë¡œë“œ
        window.loadPropList = function(em_id) {
            console.log('BASE: loadPropList í˜¸ì¶œë¨, em_id:', em_id);
            return fetch('/common/get_prop_list', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ em_id: em_id })
            })
            .then(response => response.json())
            .then(data => {
                console.log('BASE: ì‚¬ì—…ì†Œ ëª©ë¡ ì‘ë‹µ:', data);
                if (data.success && Array.isArray(data.data)) {
                    window.propList = data.data;
                    window.renderPropList();
                    console.log('BASE: ì‚¬ì—…ì†Œ ëª©ë¡ ë¡œë“œ ì™„ë£Œ, ê°œìˆ˜:', data.data.length);
                    return data.data;
                } else {
                    console.error('BASE: ì‚¬ì—…ì†Œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', data);
                    window.showStatus('ì‚¬ì—…ì†Œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                    return [];
                }
            })
            .catch(error => {
                console.error('BASE: ì‚¬ì—…ì†Œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                window.showStatus('ì‚¬ì—…ì†Œ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                return [];
            });
        };
        
        // ì‚¬ì—…ì†Œ ëª©ë¡ ë Œë”ë§
        window.renderPropList = function() {
            const propSelect = document.getElementById('sel_business_place');
            if (!propSelect) {
                console.error('ì‚¬ì—…ì†Œ ì„ íƒ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            propSelect.innerHTML = '';
            
            if (!window.propList || window.propList.length === 0) {
                propSelect.innerHTML = '<option value="">ì‚¬ì—…ì†Œ ì—†ìŒ</option>';
                console.warn('BASE: ì‚¬ì—…ì†Œ ëª©ë¡ì´ ë¹„ì–´ìˆìŒ');
                return;
            }
            
            console.log('BASE: ì‚¬ì—…ì†Œ ëª©ë¡ ë Œë”ë§ ì‹œì‘, ê°œìˆ˜:', window.propList.length);
            
            propSelect.innerHTML = '<option value="">ì‚¬ì—…ì†Œ ì„ íƒ</option>';
            
            window.propList.forEach((prop, index) => {
                console.log(`ì‚¬ì—…ì†Œ ${index}: ${prop.prop_name} (${prop.prop_id})`);
                const option = document.createElement('option');
                option.value = prop.prop_id;
                option.textContent = `${prop.prop_name} (${prop.prop_id})`;
                propSelect.appendChild(option);
            });
            
            if (window.propList.length > 0) {
                propSelect.value = window.propList[0].prop_id;
                console.log('BASE: ì²« ë²ˆì§¸ ì‚¬ì—…ì†Œ ìë™ ì„ íƒ:', window.propList[0].prop_name);
            }
            
            console.log('BASE: ì‚¬ì—…ì†Œ ëª©ë¡ ë Œë”ë§ ì™„ë£Œ');
        };
        
        // ì‚¬ì—…ì†Œ ë³€ê²½ ì´ë²¤íŠ¸
        window.onBusinessPlaceChange = function() {
            const propSelect = document.getElementById('sel_business_place');
            const selectedPropId = propSelect.value;
            const selectedPropName = propSelect.options[propSelect.selectedIndex].text;
            console.log('BASE: ì‚¬ì—…ì†Œ ë³€ê²½ë¨:', selectedPropId, selectedPropName);
            
            if (selectedPropId && window.userInfo) {
                window.showStatus('ì„ íƒëœ ì‚¬ì—…ì†Œ: ' + selectedPropName);
                window.loadMenuData();
            }
        };
        
        // ë©”ë‰´ ë°ì´í„° ë¡œë“œ
        window.loadMenuData = function() {
            if (!window.userInfo || !window.userInfo.em_id) {
                console.error('BASE: ì‚¬ìš©ì ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                return Promise.resolve([]);
            }
            
            console.log('BASE: loadMenuData í˜¸ì¶œë¨, em_id:', window.userInfo.em_id);
            
            return fetch('/get_menu_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ em_id: window.userInfo.em_id })
            })
            .then(response => response.json())
            .then(data => {
                console.log('BASE: ë©”ë‰´ ë°ì´í„° ì‘ë‹µ:', data);
                if (Array.isArray(data)) {
                    window.menuData = data;
                    window.renderModuleMenu();
                    window.renderSidebarMenu();
                    console.log('BASE: ë©”ë‰´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ, ê°œìˆ˜:', data.length);
                    return data;
                } else {
                    console.error('BASE: ë©”ë‰´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                    window.showStatus('ë©”ë‰´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                    return [];
                }
            })
            .catch(error => {
                console.error('BASE: ë©”ë‰´ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                window.showStatus('ë©”ë‰´ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                return [];
            });
        };
        
        // ëª¨ë“ˆ ë©”ë‰´ ë Œë”ë§
        window.renderModuleMenu = function() {
            const moduleMenu = document.querySelector('.module-menu');
            if (!moduleMenu) {
                console.error('ëª¨ë“ˆ ë©”ë‰´ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!window.menuData || window.menuData.length === 0) {
                console.log('ë©”ë‰´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                moduleMenu.innerHTML = '<div style="color: #666;">ì ‘ê·¼ ê°€ëŠ¥í•œ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            console.log('BASE: ëª¨ë“ˆ ë©”ë‰´ ë Œë”ë§ ì‹œì‘. ë©”ë‰´ ê°œìˆ˜:', window.menuData.length);
            
            let moduleHtml = '';
            window.menuData.forEach((module, index) => {
                console.log(`ëª¨ë“ˆ ${index}:`, module.menu_01_title, module.menu_01_module_id);
                moduleHtml += `
                    <div class="module-item" data-module-id="${module.menu_01_module_id}" onclick="clickModule(this)">
                        ${module.menu_01_title}
                    </div>
                `;
            });
            
            moduleMenu.innerHTML = moduleHtml;
            console.log('BASE: ëª¨ë“ˆ ë©”ë‰´ ë Œë”ë§ ì™„ë£Œ');
        };

        // ì‚¬ì´ë“œë°” ë©”ë‰´ ë Œë”ë§ (DB ë°ì´í„° ê¸°ë°˜)
        window.renderSidebarMenu = function() {
            const menuContainer = document.getElementById('menuContainer');
            if (!menuContainer) {
                console.error('ì‚¬ì´ë“œë°” ë©”ë‰´ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!window.menuData || window.menuData.length === 0) {
                console.log('ë©”ë‰´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                menuContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">ì ‘ê·¼ ê°€ëŠ¥í•œ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            // ì²« ë²ˆì§¸ ëª¨ë“ˆì˜ ë©”ë‰´ë¡œ ì´ˆê¸°í™”
            if (window.menuData.length > 0) {
                const firstModule = window.menuData[0];
                window.loadModuleMenus(firstModule.menu_01_module_id, firstModule.menu_01_title);
            }
        };

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        window.showStatus = function(message) {
            const statusIndicator = document.getElementById('statusIndicator');
            if (statusIndicator) {
                statusIndicator.textContent = message;
                statusIndicator.classList.add('show');
                setTimeout(() => {
                    statusIndicator.classList.remove('show');
                }, 2000);
            }
        };
        
        // í—¤ë” í•€ í† ê¸€ í•¨ìˆ˜
        window.toggleHeaderPin = function(button) {
            console.log('í—¤ë” í•€ í´ë¦­ë¨!', window.headerPinned);
            
            window.headerPinned = !window.headerPinned;
            const headerFrame = document.getElementById('headerFrame');
            
            if (window.headerPinned) {
                button.classList.add('pinned');
                button.textContent = 'ğŸ“Œ';
                if (headerFrame) headerFrame.classList.remove('hidden');
                window.showStatus('í—¤ë”ê°€ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                button.classList.remove('pinned');
                button.textContent = 'ğŸ“';
                if (headerFrame) headerFrame.classList.add('hidden');
                window.showStatus('í—¤ë”ê°€ ë¹„ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒë‹¨ì— ë§ˆìš°ìŠ¤ë¥¼ ëŒ€ë©´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.');
            }
            
            console.log('í—¤ë” í•€ ìƒíƒœ ë³€ê²½ë¨:', window.headerPinned);
        };
        
        // ì‚¬ì´ë“œë°” í•€ í† ê¸€ í•¨ìˆ˜
        window.toggleSidebarPin = function(button) {
            console.log('ì‚¬ì´ë“œë°” í•€ í´ë¦­ë¨!', window.sidebarPinned);
            
            window.sidebarPinned = !window.sidebarPinned;
            const sidebarFrame = document.getElementById('sidebarFrame');
            
            if (window.sidebarPinned) {
                button.classList.add('pinned');
                button.textContent = 'ğŸ“Œ';
                if (sidebarFrame) sidebarFrame.classList.remove('hidden');
                window.showStatus('ì‚¬ì´ë“œë°”ê°€ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                button.classList.remove('pinned');
                button.textContent = 'ğŸ“';
                if (sidebarFrame) sidebarFrame.classList.add('hidden');
                window.showStatus('ì‚¬ì´ë“œë°”ê°€ ë¹„ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ì¢Œì¸¡ì— ë§ˆìš°ìŠ¤ë¥¼ ëŒ€ë©´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.');
            }
            
            console.log('ì‚¬ì´ë“œë°” í•€ ìƒíƒœ ë³€ê²½ë¨:', window.sidebarPinned);
        };
        
        // ëª¨ë“ˆ ë©”ë‰´ í´ë¦­ í•¨ìˆ˜
        window.clickModule = function(element) {
            const moduleId = element.dataset.moduleId;
            const moduleTitle = element.textContent.trim();
            
            // ëª¨ë“  ëª¨ë“ˆ ë©”ë‰´ ë¹„í™œì„±í™”
            document.querySelectorAll('.module-item').forEach(m => m.classList.remove('active'));
            element.classList.add('active');
            
            window.currentModule = moduleId;
            window.loadModuleMenus(moduleId, moduleTitle);
            window.showStatus(`${moduleTitle} ëª¨ë“ˆì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`);
        };
        
        // í•˜ìœ„ ë©”ë‰´ í´ë¦­ í•¨ìˆ˜
        window.clickMenu = function(element) {
            const url = element.dataset.menuUrl;
            const title = element.textContent.trim();
            window.loadContent(url, title);
            
            // í™œì„± ë©”ë‰´ í‘œì‹œ
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            element.classList.add('active');
        };
        
        // ëª¨ë“ˆì˜ í•˜ìœ„ ë©”ë‰´ ë¡œë“œ (DB ë°ì´í„° ì‚¬ìš©)
        window.loadModuleMenus = function(moduleId, moduleTitle) {
            const sidebarTitle = document.getElementById('sidebarTitle');
            const sidebarSubtitle = document.getElementById('sidebarSubtitle');
            const menuContainer = document.getElementById('menuContainer');
            
            const moduleData = window.menuData.find(module => module.menu_01_module_id === moduleId);
            
            if (!moduleData) {
                if (menuContainer) menuContainer.innerHTML = '<p>ë©”ë‰´ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            if (sidebarTitle) sidebarTitle.textContent = moduleData.menu_01_title;
            if (sidebarSubtitle) sidebarSubtitle.textContent = moduleData.menu_01_title_eng || 'Management';
            
            let menuHtml = '';
            
            moduleData.menu_02_data.forEach(menu2 => {
                // 2ë ˆë²¨ ë©”ë‰´ (ìƒìœ„ ë©”ë‰´)
                if (menu2.menu_03_data && menu2.menu_03_data.length > 0) {
                    // í•˜ìœ„ ë©”ë‰´ê°€ ìˆëŠ” ê²½ìš° - í™•ì¥ ê°€ëŠ¥í•œ ë©”ë‰´
                    menuHtml += `
                        <div class="menu-group">
                            <div class="menu-item-parent" onclick="toggleSubMenu(this)">
                                <span>${menu2.menu_02_name}</span>
                                <span class="menu-arrow">â–¶</span>
                            </div>
                            <div class="sub-menu-container" style="display: none;">
                    `;
                    
                    menu2.menu_03_data.forEach(menu3 => {
                        menuHtml += `
                            <div class="menu-item sub-menu" data-menu-url="${menu3.menu_03_url || ''}" onclick="clickMenu(this)">
                                ${menu3.menu_03_name}
                            </div>
                        `;
                    });
                    
                    menuHtml += `
                            </div>
                        </div>
                    `;
                } else {
                    // í•˜ìœ„ ë©”ë‰´ê°€ ì—†ëŠ” ê²½ìš° - ì§ì ‘ í´ë¦­ ê°€ëŠ¥í•œ ë©”ë‰´
                    menuHtml += `
                        <div class="menu-item" data-menu-url="${menu2.menu_02_url || ''}" onclick="clickMenu(this)">
                            ${menu2.menu_02_name}
                        </div>
                    `;
                }
            });
            
            if (menuContainer) {
                menuContainer.innerHTML = menuHtml;
            }
        };
        
        // í•˜ìœ„ ë©”ë‰´ í† ê¸€
        window.toggleSubMenu = function(element) {
            const subMenuContainer = element.nextElementSibling;
            const arrow = element.querySelector('.menu-arrow');
            
            if (subMenuContainer.style.display === 'none') {
                subMenuContainer.style.display = 'block';
                arrow.textContent = 'â–¼';
            } else {
                subMenuContainer.style.display = 'none';
                arrow.textContent = 'â–¶';
            }
        };
        
        // ì½˜í…ì¸  ë¡œë“œ í•¨ìˆ˜ (ì‹¤ì œ URL ê¸°ë°˜)
        window.loadContent = function(url, title) {
            if (!url) {
                window.showStatus('ë©”ë‰´ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const contentLoader = document.getElementById('content-loader');
            const dynamicContent = document.getElementById('dynamic-content');
            
            if (contentLoader) contentLoader.style.display = 'block';
            
            // Flask ì»¨í…Œì´ë„ˆ ë¡œë“œ ìš”ì²­
            fetch('/common/load_container', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ menuUrl: url })
            })
            .then(response => {
                if (response.headers.get('content-type')?.includes('application/json')) {
                    return response.json();
                } else {
                    return response.text();
                }
            })
            .then(data => {
                if (typeof data === 'object' && data.redirect) {
                    // MPA ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬
                    window.location.href = data.url;
                } else {
                    // SPA í…œí”Œë¦¿ ë¡œë“œ
                    if (dynamicContent) {
                        dynamicContent.innerHTML = data;
                    }
                    if (contentLoader) contentLoader.style.display = 'none';
                    window.addTab(title, url);
                }
            })
            .catch(error => {
                console.error('ì½˜í…ì¸  ë¡œë“œ ì˜¤ë¥˜:', error);
                if (dynamicContent) {
                    dynamicContent.innerHTML = `
                        <h2>${title}</h2>
                        <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 4px;">
                            <h4>ì˜¤ë¥˜ ë°œìƒ</h4>
                            <p>ì½˜í…ì¸ ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}</p>
                            <p>URL: ${url}</p>
                        </div>
                    `;
                }
                if (contentLoader) contentLoader.style.display = 'none';
                window.showStatus(`ì½˜í…ì¸  ë¡œë“œ ì‹¤íŒ¨: ${title}`);
            });
        };
        
        // íƒ­ ì¶”ê°€ í•¨ìˆ˜
        window.addTab = function(title, url) {
            const tabContainer = document.querySelector('.tab-container');
            if (!tabContainer) {
                console.warn('íƒ­ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const existingTab = tabContainer.querySelector(`[data-tab-url="${url}"]`);
            
            if (!existingTab) {
                // ìƒˆ íƒ­ ìƒì„±
                const newTab = document.createElement('div');
                newTab.className = 'tab';
                newTab.dataset.tabUrl = url;
                newTab.innerHTML = `${title} <span class="close-tab" style="margin-left: 10px; cursor: pointer;" onclick="closeTab(this)">Ã—</span>`;
                
                // ê¸°ì¡´ íƒ­ë“¤ ë¹„í™œì„±í™”
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                newTab.classList.add('active');
                
                // íƒ­ í´ë¦­ ì´ë²¤íŠ¸
                newTab.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('close-tab')) {
                        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                        this.classList.add('active');
                        
                        const tabUrl = this.dataset.tabUrl;
                        const tabTitle = this.textContent.replace('Ã—', '').trim();
                        window.loadContent(tabUrl, tabTitle);
                    }
                });
                
                tabContainer.appendChild(newTab);
                console.log('ìƒˆ íƒ­ ì¶”ê°€ë¨:', title);
            } else {
                // ê¸°ì¡´ íƒ­ í™œì„±í™”
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                existingTab.classList.add('active');
                console.log('ê¸°ì¡´ íƒ­ í™œì„±í™”ë¨:', title);
            }
        };
        
        // íƒ­ ë‹«ê¸° í•¨ìˆ˜
        window.closeTab = function(closeButton) {
            const tab = closeButton.parentElement;
            const isActive = tab.classList.contains('active');
            
            tab.remove();
            
            // í™œì„±í™”ëœ íƒ­ì„ ë‹«ì•˜ë‹¤ë©´ ë‹¤ë¥¸ íƒ­ì„ í™œì„±í™”
            if (isActive) {
                const remainingTabs = document.querySelectorAll('.tab');
                if (remainingTabs.length > 0) {
                    const lastTab = remainingTabs[remainingTabs.length - 1];
                    lastTab.classList.add('active');
                    
                    const tabUrl = lastTab.dataset.tabUrl;
                    const tabTitle = lastTab.textContent.replace('Ã—', '').trim();
                    window.loadContent(tabUrl, tabTitle);
                } else {
                    // ëª¨ë“  íƒ­ì´ ë‹«í˜”ë‹¤ë©´ ê¸°ë³¸ ëŒ€ì‹œë³´ë“œ í‘œì‹œ
                    const dynamicContent = document.getElementById('dynamic-content');
                    if (dynamicContent) {
                        dynamicContent.innerHTML = `
                            <h2>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
                                    <h4 style="margin: 0 0 10px 0; color: #155724;">Flask ì„œë²„</h4>
                                    <p style="font-size: 24px; font-weight: bold; margin: 0; color: #155724;">ì—°ë™ ì¤€ë¹„</p>
                                </div>
                                <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff;">
                                    <h4 style="margin: 0 0 10px 0; color: #004085;">ì§ì› ê´€ë¦¬</h4>
                                    <p style="font-size: 24px; font-weight: bold; margin: 0; color: #004085;">ì‹œìŠ¤í…œ</p>
                                </div>
                                <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                                    <h4 style="margin: 0 0 10px 0; color: #856404;">í˜¸ë²„ ë©”ë‰´</h4>
                                    <p style="font-size: 24px; font-weight: bold; margin: 0; color: #856404;">í™œì„±í™”</p>
                                </div>
                                <div style="background: #f8d7da; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
                                    <h4 style="margin: 0 0 10px 0; color: #721c24;">ì‹¤ì‹œê°„</h4>
                                    <p style="font-size: 24px; font-weight: bold; margin: 0; color: #721c24;">ë°ì´í„°</p>
                                </div>
                            </div>
                            
                            <div style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px;">
                                <h3 style="margin: 0 0 20px 0;">âš¡ ë¹ ë¥¸ ì‘ì—…</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    <button style="padding: 15px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; text-align: left;" onclick="loadContent('/fm/em_list', 'ğŸ“ ì§ì›ì •ë³´')">
                                        ğŸ“ ì§ì› ì •ë³´ ê´€ë¦¬
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }
            }
        };
        
        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        window.logout = function() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                fetch('/login/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = data.redirect;
                    }
                })
                .catch(error => {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                    alert('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
            }
        };
        
        // ì‹œê³„ ì—…ë°ì´íŠ¸
        window.updateClock = function() {
            const now = new Date();
            const timeStr = now.getFullYear() + '-' +
                           String(now.getMonth() + 1).padStart(2, '0') + '-' +
                           String(now.getDate()).padStart(2, '0') + ' (' +
                           ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][now.getDay()] + ') ' +
                           String(now.getHours()).padStart(2, '0') + ':' +
                           String(now.getMinutes()).padStart(2, '0') + ':' +
                           String(now.getSeconds()).padStart(2, '0');
            const clockElement = document.getElementById('current-datetime');
            if (clockElement) {
                clockElement.textContent = timeStr;
            }
        };
        
        // í˜¸ë²„ ì´ë²¤íŠ¸ í•¨ìˆ˜ë“¤
        window.onHeaderHover = function() {
            console.log('í—¤ë” í˜¸ë²„ íŠ¸ë¦¬ê±°!', window.headerPinned);
            if (!window.headerPinned) {
                const headerFrame = document.getElementById('headerFrame');
                if (headerFrame) {
                    headerFrame.classList.add('hover-show');
                    console.log('í—¤ë” í‘œì‹œë¨');
                }
            }
        };
        
        window.onHeaderLeave = function() {
            console.log('í—¤ë” ë– ë‚¨');
            if (!window.headerPinned) {
                const headerFrame = document.getElementById('headerFrame');
                setTimeout(() => {
                    if (headerFrame && !headerFrame.matches(':hover')) {
                        headerFrame.classList.remove('hover-show');
                        console.log('í—¤ë” ìˆ¨ê²¨ì§');
                    }
                }, 300);
            }
        };
        
        window.onSidebarHover = function() {
            console.log('ì‚¬ì´ë“œë°” í˜¸ë²„ íŠ¸ë¦¬ê±°!', window.sidebarPinned);
            if (!window.sidebarPinned) {
                const sidebarFrame = document.getElementById('sidebarFrame');
                if (sidebarFrame) {
                    sidebarFrame.classList.add('hover-show');
                    console.log('ì‚¬ì´ë“œë°” í‘œì‹œë¨');
                }
            }
        };
        
        window.onSidebarLeave = function() {
            console.log('ì‚¬ì´ë“œë°” ë– ë‚¨');
            if (!window.sidebarPinned) {
                const sidebarFrame = document.getElementById('sidebarFrame');
                setTimeout(() => {
                    if (sidebarFrame && !sidebarFrame.matches(':hover')) {
                        sidebarFrame.classList.remove('hover-show');
                        console.log('ì‚¬ì´ë“œë°” ìˆ¨ê²¨ì§');
                    }
                }, 300);
            }
        };
        
        // ì´ˆê¸°í™” í•¨ìˆ˜
        window.initialize = function() {
            console.log('=== BASE ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘ ===');
            
            // ì‹œê³„ ì‹œì‘
            window.updateClock();
            setInterval(window.updateClock, 1000);
            
            console.log('BASE: 1ë‹¨ê³„ - ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹œì‘');
            
            window.loadUserInfo()
                .then(userInfo => {
                    console.log('BASE: 2ë‹¨ê³„ - ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì™„ë£Œ', userInfo);
                    if (userInfo && userInfo.em_id) {
                        console.log('BASE: 3ë‹¨ê³„ - ì‚¬ì—…ì†Œ ëª©ë¡ ë¡œë“œ ì‹œì‘');
                        return window.loadPropList(userInfo.em_id)
                            .then(propList => {
                                console.log('BASE: 4ë‹¨ê³„ - ì‚¬ì—…ì†Œ ëª©ë¡ ë¡œë“œ ì™„ë£Œ', propList ? propList.length : 0, 'ê°œ');
                                console.log('BASE: 5ë‹¨ê³„ - ë©”ë‰´ ë°ì´í„° ë¡œë“œ ì‹œì‘');
                                return window.loadMenuData();
                            });
                    }
                    throw new Error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨');
                })
                .then(menuData => {
                    console.log('BASE: 6ë‹¨ê³„ - ë©”ë‰´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ', menuData ? menuData.length : 0, 'ê°œ');
                    if (menuData && menuData.length > 0) {
                        console.log('BASE: 7ë‹¨ê³„ - ì²« ë²ˆì§¸ ëª¨ë“ˆ ì„ íƒ');
                        setTimeout(() => {
                            const firstModuleElement = document.querySelector('.module-item');
                            if (firstModuleElement) {
                                console.log('BASE: 8ë‹¨ê³„ - ì²« ë²ˆì§¸ ëª¨ë“ˆ í´ë¦­', firstModuleElement.textContent);
                                window.clickModule(firstModuleElement);
                            }
                        }, 300);
                        console.log('=== BASE ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ ===');
                        window.showStatus('ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. DBì—ì„œ ë©”ë‰´ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');
                    }
                })
                .catch(error => {
                    console.error('=== BASE ì´ˆê¸°í™” ì˜¤ë¥˜ ===', error);
                    window.showStatus('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                });
        };
    </script>
</head>
<body>
    <div class="main-container">
        <!-- í—¤ë” í˜¸ë²„ íŠ¸ë¦¬ê±° -->
        <div class="header-hover-trigger" id="headerHoverTrigger" 
             onmouseenter="onHeaderHover()" 
             title="í—¤ë” í˜¸ë²„ ì˜ì—­"></div>
        
        <!-- ì‚¬ì´ë“œë°” í˜¸ë²„ íŠ¸ë¦¬ê±° -->
        <div class="sidebar-hover-trigger" id="sidebarHoverTrigger" 
             onmouseenter="onSidebarHover()" 
             title="ì‚¬ì´ë“œë°” í˜¸ë²„ ì˜ì—­"></div>
        
        <!-- í—¤ë” í”„ë ˆì„ -->
        <div class="header-frame" id="headerFrame" onmouseleave="onHeaderLeave()">
            <button class="pin-button header-pin pinned" id="headerPin" onclick="toggleHeaderPin(this)" title="í—¤ë” ê³ ì •/í•´ì œ">ğŸ“Œ</button>
            
            <div class="topheader-left">
                <label for="sel_business_place"><b>ì‚¬ì—…ì†Œ ì„ íƒ:</b></label>
                <select id="sel_business_place" onchange="onBusinessPlaceChange()">
                    <option value="">ì‚¬ì—…ì†Œ ë¡œë”© ì¤‘...</option>
                </select>
            </div>
            
            <!-- ëª¨ë“ˆ ë©”ë‰´ (ë™ì ìœ¼ë¡œ ìƒì„±ë¨) -->
            <div class="module-menu">
                <!-- DBì—ì„œ ë¡œë“œëœ ëª¨ë“ˆ ë©”ë‰´ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
            
            <div class="user-info">
                <span id="current-datetime">2025-06-17 (í™”) 15:30:45</span>
                <span><b id="user-info-text">ì‚¬ìš©ì: ë¡œë”© ì¤‘...</b></span>
                <button type="button" id="btn_logout" class="toggle-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <!-- ì‚¬ì´ë“œë°” í”„ë ˆì„ -->
        <div class="sidebar-frame" id="sidebarFrame" onmouseleave="onSidebarLeave()">
            <button class="pin-button sidebar-pin pinned" id="sidebarPin" onclick="toggleSidebarPin(this)" title="ì‚¬ì´ë“œë°” ê³ ì •/í•´ì œ">ğŸ“Œ</button>
            
            <div class="sidebar-content">
                <h3 id="sidebarTitle">ì‹œìŠ¤í…œê´€ë¦¬</h3>
                <p id="sidebarSubtitle">System Management</p>
                <hr style="margin: 15px 0; border-color: #6c757d;">
                
                <div id="menuContainer">
                    <!-- DBì—ì„œ ë¡œë“œëœ ë™ì  ë©”ë‰´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    <div style="text-align: center; padding: 20px; color: #6c757d;">
                        ë©”ë‰´ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
                    </div>
                </div>
            </div>
        </div>

        <!-- ì½˜í…ì¸  í”„ë ˆì„ -->
        <div class="content-frame" id="contentFrame">
            <div class="content-area">
                
                
                <div id="dynamic-content">
                    {% block content %}
                    <h2>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>
                    
                    <!-- ìš”ì•½ ì¹´ë“œ -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
                            <h4 style="margin: 0 0 10px 0; color: #155724;">Flask ì„œë²„</h4>
                            <p style="font-size: 24px; font-weight: bold; margin: 0; color: #155724;">ì—°ë™ ì¤€ë¹„</p>
                        </div>
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff;">
                            <h4 style="margin: 0 0 10px 0; color: #004085;">ì§ì› ê´€ë¦¬</h4>
                            <p style="font-size: 24px; font-weight: bold; margin: 0; color: #004085;">ì‹œìŠ¤í…œ</p>
                        </div>
                        <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <h4 style="margin: 0 0 10px 0; color: #856404;">í˜¸ë²„ ë©”ë‰´</h4>
                            <p style="font-size: 24px; font-weight: bold; margin: 0; color: #856404;">í™œì„±í™”</p>
                        </div>
                        <div style="background: #f8d7da; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
                            <h4 style="margin: 0 0 10px 0; color: #721c24;">ì‹¤ì‹œê°„</h4>
                            <p style="font-size: 24px; font-weight: bold; margin: 0; color: #721c24;">ë°ì´í„°</p>
                        </div>
                    </div>
                    
                    <!-- ë¹ ë¥¸ ì‘ì—… -->
                    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px;">
                        <h3 style="margin: 0 0 20px 0;">âš¡ ë¹ ë¥¸ ì‘ì—…</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <button style="padding: 15px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; text-align: left;" onclick="loadContent('/fm/em_list', 'ğŸ“ ì§ì›ì •ë³´')">
                                ğŸ“ ì§ì› ì •ë³´ ê´€ë¦¬
                            </button>
                        </div>
                    </div>
                    {% endblock %}
                    
                    <div id="content-loader" style="display: none;">
                        <p>ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒíƒœ ì¸ë””ì¼€ì´í„° -->
    <div class="status-indicator" id="statusIndicator">
        ìƒíƒœ ë©”ì‹œì§€
    </div>

    {% block extra_js %}{% endblock %}

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
            if (typeof window.initialize === 'function') {
                window.initialize();
            } else {
                console.error('initialize í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        });
        
        // ì´ë¯¸ ë¡œë“œëœ ê²½ìš°ë¥¼ ìœ„í•œ ë°±ì—…
        if (document.readyState === 'loading') {
            console.log('ë¬¸ì„œ ë¡œë”© ì¤‘ - DOMContentLoaded ëŒ€ê¸°');
        } else {
            console.log('ë¬¸ì„œ ì´ë¯¸ ë¡œë“œë¨ - ì¦‰ì‹œ ì´ˆê¸°í™”');
            setTimeout(function() {
                if (typeof window.initialize === 'function') {
                    window.initialize();
                } else {
                    console.error('initialize í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            }, 100);
        }
    </script>
</body>
</html>